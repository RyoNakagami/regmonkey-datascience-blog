<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>regmonkey datascience blog</title>
<link>https://ryonakagami.github.io/regmonkey-datascience-blog/</link>
<atom:link href="https://ryonakagami.github.io/regmonkey-datascience-blog/index.xml" rel="self" type="application/rss+xml"/>
<description>日々の徒然勉強日記</description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Sat, 27 Dec 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>parquet-toolsコマンド</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-27-parquet-tools-query/</link>
  <description><![CDATA[ 






<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>実行例について
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>コマンド実行の引数で用いているファイルは<a href="https://drive.google.com/drive/folders/1WiDWRdg_of25CIiVE-kAMS_ykgjwa_gt?usp=sharing">こちらのGoogle Drive</a>に格納しています</li>
<li>コマンドを試す場合は事前にダウンロードしてください</li>
</ul>
</div>
</div>
<section id="parquet-toolsとは" class="level2">
<h2 class="anchored" data-anchor-id="parquet-toolsとは">parquet-toolsとは？</h2>
<ul>
<li><a href="https://github.com/RyoNakagami/parquet-tools">parquet-tools</a>は，Parquetファイルを操作するためのコマンドラインツール</li>
<li>Pythonで実装</li>
</ul>
<p><span class="mini-section">主な機能</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<caption>parquet-toolsのコマンド一覧</caption>
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド</th>
<th>機能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>head</code></td>
<td>Parquetファイルの先頭N行を表示</td>
</tr>
<tr class="even">
<td><code>info</code></td>
<td>メタデータとスキーマ情報を表示</td>
</tr>
<tr class="odd">
<td><code>merge</code></td>
<td>複数のParquetファイルを1つに統合</td>
</tr>
<tr class="even">
<td><code>csv2parquet</code></td>
<td>CSVファイルをParquet形式に変換</td>
</tr>
<tr class="odd">
<td><code>query</code></td>
<td>DuckDBを使用してSQLクエリを実行</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">インストール</span></p>
<p><code>uv</code>を使用してインストールすることを想定しています</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> tool install https://github.com/RyoNakagami/parquet-tools.git</span></code></pre></div></div>
<p>または、<code>uvx</code>を使って直接実行することも可能です．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uvx</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--from</span> git+https://github.com/RyoNakagami/parquet-tools.git parquet-tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>command<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
</section>
<section id="headコマンド" class="level2">
<h2 class="anchored" data-anchor-id="headコマンド">headコマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title"><code>head</code> コマンド</span></p>
<ul>
<li>Parquetファイルの先頭N行を表示</li>
<li>デフォルトでは10行を表示</li>
<li>スペース区切り</li>
<li>基本的には簡易的に値を確認するデバッグ用のコマンド</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 先頭10行を表示（デフォルト）</span></span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 先頭5行を表示</span></span>
<span id="cb3-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> head <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVファイルとして出力</span></span>
<span id="cb3-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> head <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 100 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> -o output.csv</span></code></pre></div></div>
<p><span class="mini-section">Options</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-n</code>, <code>--rows</code></td>
<td>表示する行数を指定（デフォルト: 10）</td>
</tr>
<tr class="even">
<td><code>-o</code>, <code>--output</code></td>
<td>出力先のCSVファイルパス</td>
</tr>
</tbody>
</table>
</section>
<section id="infoコマンド" class="level2">
<h2 class="anchored" data-anchor-id="infoコマンド">infoコマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>info</code> コマンド</span></p>
<ul>
<li>Parquetファイルのメタデータとスキーマ情報を表示</li>
<li>yaml, json形式での出力が可能</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基本的な使用方法</span></span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># YAML形式で出力</span></span>
<span id="cb4-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> info <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--yaml</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># JSON形式で出力</span></span>
<span id="cb4-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> info <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--json</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>parquet-file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p><span class="mini-section">options</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--yaml</code></td>
<td>YAML形式で出力</td>
</tr>
<tr class="even">
<td><code>--json</code></td>
<td>JSON形式で出力</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (全国医療施設情報のスキーマ確認)</strong></span> <br></p>
<p>以下のコマンドから次のような情報が読み取れます</p>
<ul>
<li>Rows = 7,640</li>
<li>Columns = 65</li>
<li>Row Groups = 1
<ul>
<li>Parquet ファイルは 1つの Row Group（行グループ） で構成されている</li>
<li>Parquet の物理ストレージ単位(並列処理の単位)</li>
</ul></li>
<li>Compression = SNAPPY</li>
<li>Apache Arrow C++ v22.0.0 を使って Parquet ファイルが作成</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> parquet-tools info 01-1_hospital_facility_info_20251201.parquet </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">===</span> File Info ===</span>
<span id="cb5-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Path:</span> 01-1_hospital_facility_info_20251201.parquet</span>
<span id="cb5-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Rows:</span> 7,640</span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Columns:</span> 65</span>
<span id="cb5-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Row</span> Groups: 1</span>
<span id="cb5-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Compression:</span> SNAPPY</span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Created</span> By: parquet-cpp-arrow version 22.0.0</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">===</span> Schema ===</span>
<span id="cb5-11">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ID:</span> string</span>
<span id="cb5-12">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">正式名称:</span> string</span>
<span id="cb5-13">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">正式名称（フリガナ）:</span> string</span>
<span id="cb5-14">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">略称:</span> string</span>
<span id="cb5-15">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">略称（フリガナ）:</span> string</span>
<span id="cb5-16">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">英語表記（ローマ字表記）:</span> string</span>
<span id="cb5-17">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">機関区分:</span> string</span>
<span id="cb5-18">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">都道府県コード:</span> string</span>
<span id="cb5-19">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">市区町村コード:</span> string</span>
<span id="cb5-20">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">所在地:</span> string</span>
<span id="cb5-21">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">所在地座標（緯度）:</span> double</span>
<span id="cb5-22">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">所在地座標（経度）:</span> double</span>
<span id="cb5-23">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">案内用ホームページアドレス:</span> string</span>
<span id="cb5-24">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（月）:</span> bool</span>
<span id="cb5-25">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（火）:</span> bool</span>
<span id="cb5-26">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（水）:</span> bool</span>
<span id="cb5-27">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（木）:</span> bool</span>
<span id="cb5-28">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（金）:</span> bool</span>
<span id="cb5-29">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（土）:</span> bool</span>
<span id="cb5-30">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">毎週決まった曜日に休診（日）:</span> bool</span>
<span id="cb5-31">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（月）:</span> bool</span>
<span id="cb5-32">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（火）:</span> bool</span>
<span id="cb5-33">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（水）:</span> bool</span>
<span id="cb5-34">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（木）:</span> bool</span>
<span id="cb5-35">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（金）:</span> bool</span>
<span id="cb5-36">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（土）:</span> bool</span>
<span id="cb5-37">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第1週（日）:</span> bool</span>
<span id="cb5-38">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（月）:</span> bool</span>
<span id="cb5-39">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（火）:</span> bool</span>
<span id="cb5-40">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（水）:</span> bool</span>
<span id="cb5-41">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（木）:</span> bool</span>
<span id="cb5-42">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（金）:</span> bool</span>
<span id="cb5-43">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（土）:</span> bool</span>
<span id="cb5-44">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第2週（日）:</span> bool</span>
<span id="cb5-45">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（月）:</span> bool</span>
<span id="cb5-46">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（火）:</span> bool</span>
<span id="cb5-47">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（水）:</span> bool</span>
<span id="cb5-48">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（木）:</span> bool</span>
<span id="cb5-49">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（金）:</span> bool</span>
<span id="cb5-50">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（土）:</span> bool</span>
<span id="cb5-51">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第3週（日）:</span> bool</span>
<span id="cb5-52">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（月）:</span> bool</span>
<span id="cb5-53">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（火）:</span> bool</span>
<span id="cb5-54">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（水）:</span> bool</span>
<span id="cb5-55">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（木）:</span> bool</span>
<span id="cb5-56">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（金）:</span> bool</span>
<span id="cb5-57">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（土）:</span> bool</span>
<span id="cb5-58">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第4週（日）:</span> bool</span>
<span id="cb5-59">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（月）:</span> bool</span>
<span id="cb5-60">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（火）:</span> bool</span>
<span id="cb5-61">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（水）:</span> bool</span>
<span id="cb5-62">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（木）:</span> bool</span>
<span id="cb5-63">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（金）:</span> bool</span>
<span id="cb5-64">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（土）:</span> bool</span>
<span id="cb5-65">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">決まった週に休診（定期週）第5週（日）:</span> bool</span>
<span id="cb5-66">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">祝日に休診:</span> bool</span>
<span id="cb5-67">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">その他の休診日（gw、お盆等）:</span> string</span>
<span id="cb5-68">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">一般病床:</span> int64</span>
<span id="cb5-69">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">療養病床:</span> int64</span>
<span id="cb5-70">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">療養病床のうち医療保険適用:</span> int64</span>
<span id="cb5-71">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">療養病床のうち介護保険適用:</span> int64</span>
<span id="cb5-72">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">精神病床:</span> int64</span>
<span id="cb5-73">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">結核病床:</span> int64</span>
<span id="cb5-74">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">感染症病床:</span> int64</span>
<span id="cb5-75">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">一般病床:</span> int64</span></code></pre></div></div>
</div>
<hr>
</section>
<section id="csv2parquetコマンド" class="level2">
<h2 class="anchored" data-anchor-id="csv2parquetコマンド">csv2parquetコマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title"><code>csv2parquet</code> コマンド</span></p>
<ul>
<li>CSVファイルをParquet形式に変換</li>
<li>スキーマファイルを指定することで，列の型を明示的に定義可能</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基本的な使用方法（型は自動推論）</span></span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> csv2parquet input.csv <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> output.parquet</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スキーマファイルを指定</span></span>
<span id="cb6-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> csv2parquet input.csv <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> output.parquet <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--schema</span> schema.yaml</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 圧縮コーデックを指定</span></span>
<span id="cb6-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> csv2parquet input.csv <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> output.parquet <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--compression</span> zstd</span></code></pre></div></div>
<p><span class="mini-section">Options</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-o</code>, <code>--output</code></td>
<td>出力ファイルパス（必須）</td>
</tr>
<tr class="even">
<td><code>--schema</code></td>
<td>スキーマファイルパス（YAML または JSON）</td>
</tr>
<tr class="odd">
<td><code>--compression</code></td>
<td>圧縮コーデック（snappy, zstd, gzip, lz4, none）</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">スキーマファイルの例（YAML）</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fields</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb7-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> id</span></span>
<span id="cb7-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> int64</span></span>
<span id="cb7-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> name</span></span>
<span id="cb7-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> string</span></span>
<span id="cb7-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> price</span></span>
<span id="cb7-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> float64</span></span>
<span id="cb7-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> is_available</span></span>
<span id="cb7-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> boolean</span></span>
<span id="cb7-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> created_at</span></span>
<span id="cb7-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> timestamp</span></span>
<span id="cb7-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> birth_date</span></span>
<span id="cb7-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> date</span></span></code></pre></div></div>
<p><span class="mini-section">対応する型</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>string</code></td>
<td>文字列型</td>
</tr>
<tr class="even">
<td><code>int64</code></td>
<td>64ビット整数型</td>
</tr>
<tr class="odd">
<td><code>float64</code></td>
<td>64ビット浮動小数点型</td>
</tr>
<tr class="even">
<td><code>boolean</code></td>
<td>真偽値型</td>
</tr>
<tr class="odd">
<td><code>timestamp</code></td>
<td>タイムスタンプ型</td>
</tr>
<tr class="even">
<td><code>date</code></td>
<td>日付型</td>
</tr>
</tbody>
</table>
<p>空文字列，<code>NA</code>、<code>null</code>などは自動的にnull値に変換されます</p>
</section>
<section id="queryコマンド" class="level2">
<h2 class="anchored" data-anchor-id="queryコマンド">queryコマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title"><code>query</code> コマンド</span></p>
<ul>
<li>DuckDBを使用して，ParquetファイルにSQLクエリを実行するコマンド</li>
<li>Parquetファイルは <code>data</code> というテーブル名で参照</li>
<li><code>--sql-file</code> をつかうことでSQLファイルを実行させることができる</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基本的なクエリ</span></span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> query <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM data LIMIT 10"</span> data.parquet</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 条件付きクエリ</span></span>
<span id="cb8-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> query <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT id, name FROM data WHERE value &gt; 100"</span> data.parquet</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 集計クエリ</span></span>
<span id="cb8-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> query <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT category, COUNT(*) as cnt FROM data GROUP BY category"</span> data.parquet</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 結果をCSVに出力</span></span>
<span id="cb8-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parquet-tools</span> query <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM data"</span> data.parquet <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> result.csv</span></code></pre></div></div>
<p><span class="mini-section">Options</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-o</code>, <code>--output</code></td>
<td>結果をCSVファイルに出力</td>
</tr>
<tr class="even">
<td><code>--sql-file</code></td>
<td>実行するSQLをファイルから読み込む</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (全国医療施設情報のデータ確認)</strong></span> <br></p>
<p>都道府県ごとに</p>
<ul>
<li>医療施設の数（distinct，クリニックは除く）</li>
<li>病床数の合計</li>
<li>1施設あたり平均病床数</li>
<li>病床数の母標準偏差（施設間のばらつき）</li>
</ul>
<p>を計算して，都道府県コード順に並べてみたいと思います．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> parquet-tools query 01-1_hospital_facility_info_20251201.parquet <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb9-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">SELECT</span></span>
<span id="cb9-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CAST(都道府県コード AS INT) AS prefecture_code,</span></span>
<span id="cb9-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  COUNT(DISTINCT ID) AS facility_count,</span></span>
<span id="cb9-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SUM(一般病床) AS total_beds,</span></span>
<span id="cb9-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  AVG(一般病床) AS avg_beds_per_facility,</span></span>
<span id="cb9-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  STDDEV_POP(一般病床) AS std_beds_per_facility</span></span>
<span id="cb9-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">FROM data</span></span>
<span id="cb9-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">GROUP BY 都道府県コード</span></span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">UNION ALL</span></span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-- 全国</span></span>
<span id="cb9-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">SELECT</span></span>
<span id="cb9-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  0 AS prefecture_code,          -- 全国を 0 として表現</span></span>
<span id="cb9-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  COUNT(DISTINCT ID) AS facility_count,</span></span>
<span id="cb9-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SUM(一般病床) AS total_beds,</span></span>
<span id="cb9-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  AVG(一般病床) AS avg_beds_per_facility,</span></span>
<span id="cb9-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  STDDEV_POP(一般病床) AS std_beds_per_facility</span></span>
<span id="cb9-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">FROM data</span></span>
<span id="cb9-21"></span>
<span id="cb9-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ORDER BY prefecture_code</span></span>
<span id="cb9-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb9-24"></span>
<span id="cb9-25">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefecture_code</span>  facility_count  total_beds  avg_beds_per_facility  std_beds_per_facility</span>
<span id="cb9-26"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0</span>                 0            7640    842371.0             132.115903             163.389970</span>
<span id="cb9-27"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span>                 1             436     41523.0             129.759375             134.619283</span>
<span id="cb9-28"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2</span>                 2              83      8942.0             154.172414             151.051731</span>
<span id="cb9-29"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3</span>                 3              84      9454.0             113.903614             147.797697</span>
<span id="cb9-30"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">4</span>                 4             134     14829.0             154.468750             175.811568</span>
<span id="cb9-31"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5</span>                 5              63      7699.0             202.605263             158.547941</span>
<span id="cb9-32"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">6</span>                 6              66      7955.0             122.384615             166.080026</span>
<span id="cb9-33"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">7</span>                 7             119     14408.0             169.505882             185.842857</span>
<span id="cb9-34"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">8</span>                 8             164     17379.0             126.854015             148.012257</span>
<span id="cb9-35"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">9</span>                 9              59      7354.0             222.848485             276.448924</span>
<span id="cb9-36"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">10</span>               10             127     14097.0             121.525862             128.509792</span>
<span id="cb9-37"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">11</span>               11             327     37466.0             153.549180             168.478952</span>
<span id="cb9-38"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">12</span>               12             269     35469.0             177.345000             171.913833</span>
<span id="cb9-39"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">13</span>               13             592     80034.0             145.781421             197.228695</span>
<span id="cb9-40"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">14</span>               14             310     45187.0             195.614719             184.881976</span>
<span id="cb9-41"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">15</span>               15             114     14961.0             170.011364             155.021809</span>
<span id="cb9-42"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">16</span>               16             102      7759.0             146.396226             158.023564</span>
<span id="cb9-43"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">17</span>               17              88      9442.0             162.793103             174.859624</span>
<span id="cb9-44"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">18</span>               18              67      6117.0              91.298507             132.949437</span>
<span id="cb9-45"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">19</span>               19              60      6216.0             135.130435             129.769965</span>
<span id="cb9-46"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">20</span>               20             121     14679.0             149.785714             141.969834</span>
<span id="cb9-47"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">21</span>               21              94     12628.0             134.340426             169.380382</span>
<span id="cb9-48"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">22</span>               22             167     20819.0             129.310559             183.584301</span>
<span id="cb9-49"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">23</span>               23             303     39329.0             189.081731             220.297260</span>
<span id="cb9-50"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">24</span>               24              91     10898.0             167.661538             157.961269</span>
<span id="cb9-51"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">25</span>               25              57      8946.0             208.046512             173.366926</span>
<span id="cb9-52"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">26</span>               26             127     19116.0             178.654206             184.586180</span>
<span id="cb9-53"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">27</span>               27             482     63012.0             130.730290             167.346071</span>
<span id="cb9-54"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">28</span>               28             332     39045.0             151.337209             154.044638</span>
<span id="cb9-55"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">29</span>               29              72      9856.0             158.967742             159.517717</span>
<span id="cb9-56"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">30</span>               30              80      8110.0             128.730159             137.651182</span>
<span id="cb9-57"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">31</span>               31              39      4401.0             169.269231             156.062748</span>
<span id="cb9-58"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">32</span>               32              46      4969.0             150.575758             140.275493</span>
<span id="cb9-59"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">33</span>               33             155     17420.0             113.116883             181.092319</span>
<span id="cb9-60"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">34</span>               34             224     20617.0             128.856250             141.973318</span>
<span id="cb9-61"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">35</span>               35             133     10274.0             133.428571             145.708250</span>
<span id="cb9-62"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">36</span>               36             103      6217.0              60.950980             107.673014</span>
<span id="cb9-63"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">37</span>               37              86      8477.0             136.725806             149.489148</span>
<span id="cb9-64"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">38</span>               38             131     11284.0             120.042553             138.629916</span>
<span id="cb9-65"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">39</span>               39             118      7615.0             101.533333             115.125709</span>
<span id="cb9-66"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">40</span>               40             444     43096.0              97.063063             149.968137</span>
<span id="cb9-67"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">41</span>               41              93      6121.0              66.532609             102.199767</span>
<span id="cb9-68"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">42</span>               42             143     11296.0              80.113475             124.087712</span>
<span id="cb9-69"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">43</span>               43             199     16210.0              81.457286             120.348017</span>
<span id="cb9-70"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">44</span>               44             147     11663.0              80.434483              98.114628</span>
<span id="cb9-71"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">45</span>               45             118      8452.0              73.495652              99.268750</span>
<span id="cb9-72"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">46</span>               46             207     13721.0              66.931707             106.618743</span>
<span id="cb9-73"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">47</span>               47              64      7809.0             177.477273             158.422692</span></code></pre></div></div>
<p><span class="mini-section">結果の解釈</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>観点</th>
<th>結果(数値)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>施設数が多い都道府県</td>
<td>東京（592），大阪（482），福岡（444），北海道（436）</td>
</tr>
<tr class="even">
<td>施設数が少ない都道府県</td>
<td>鳥取（39），島根（46），滋賀（57）</td>
</tr>
<tr class="odd">
<td>平均一般病床数が多い都道府県</td>
<td>栃木（222.8），滋賀（208.0），秋田（202.6）</td>
</tr>
<tr class="even">
<td>平均一般病床数が少ない都道府県</td>
<td>徳島（61.0），佐賀（66.5），鹿児島（66.9）</td>
</tr>
<tr class="odd">
<td>標準偏差が大きい都道府県</td>
<td>栃木（276.4），愛知（220.3），東京（197.2）</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>施設数は人口規模に概ね比例しており，東京・大阪・福岡などの大都市圏で多い</li>
<li>平均一般病床数は地域差が大きく，栃木県が最も高い（222.8床/施設）</li>
<li>栃木県（9）は標準偏差が276.4と突出して大きく，施設間格差が大きい
<ul>
<li>大規模な急性期病院と中小病院が混在している可能性</li>
</ul></li>
<li>九州地方（福岡(40)，佐賀(41)，長崎(42)，熊本(43)，大分(44)，宮崎(45)，鹿児島(46)）は平均一般病床数が低い傾向</li>
<li>北海道（1）は施設数436で全国4位だが，平均一般病床数は129.8床/施設と全国平均（132.1床）を下回る</li>
<li>沖縄（47）は平均一般病床数177.5床/施設と比較的高い
<ul>
<li>離島が多く本島の基幹病院に急性期医療が集約されている可能性</li>
</ul></li>
</ul>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (都道府県別中心座標からの平均距離及び分散)</strong></span> <br></p>
<ul>
<li>各都道府県内の医療施設が地理的にどの程度分散しているかを確認するため，都道府県内の施設座標の重心（centroid）からの平均距離と標準偏差を計算</li>
<li>座標データには異常値が含まれている可能性があるため，日本の緯度経度範囲（緯度: 24〜46度，経度: 122〜154度）でフィルタリング
<ul>
<li>そのため，施設数について上記の結果と比べ変動あり</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> parquet-tools query 01-1_hospital_facility_info_20251201.parquet <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">WITH base AS (</span></span>
<span id="cb10-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SELECT</span></span>
<span id="cb10-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CAST(都道府県コード AS INT) AS prefecture_code,</span></span>
<span id="cb10-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ID,</span></span>
<span id="cb10-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    "</span>所在地座標（緯度）<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" AS lat,</span></span>
<span id="cb10-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    "</span>所在地座標（経度）<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" AS lon</span></span>
<span id="cb10-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  FROM data</span></span>
<span id="cb10-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  WHERE "</span>所在地座標（緯度）<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" BETWEEN 24 AND 46   -- 日本の緯度範囲</span></span>
<span id="cb10-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    AND "</span>所在地座標（経度）<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" BETWEEN 122 AND 154 -- 日本の経度範囲</span></span>
<span id="cb10-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">centroid AS (</span></span>
<span id="cb10-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SELECT</span></span>
<span id="cb10-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    prefecture_code,</span></span>
<span id="cb10-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    AVG(lat) AS mean_lat,</span></span>
<span id="cb10-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    AVG(lon) AS mean_lon</span></span>
<span id="cb10-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  FROM base</span></span>
<span id="cb10-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  GROUP BY prefecture_code</span></span>
<span id="cb10-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">distance_calc AS (</span></span>
<span id="cb10-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  SELECT</span></span>
<span id="cb10-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    b.prefecture_code,</span></span>
<span id="cb10-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    -- Haversine distance (km)</span></span>
<span id="cb10-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    6371.0 * 2 * ASIN(</span></span>
<span id="cb10-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      SQRT(</span></span>
<span id="cb10-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        POWER(SIN(RADIANS(b.lat - c.mean_lat) / 2), 2)</span></span>
<span id="cb10-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        + COS(RADIANS(c.mean_lat))</span></span>
<span id="cb10-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * COS(RADIANS(b.lat))</span></span>
<span id="cb10-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * POWER(SIN(RADIANS(b.lon - c.mean_lon) / 2), 2)</span></span>
<span id="cb10-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      )</span></span>
<span id="cb10-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ) AS distance_km</span></span>
<span id="cb10-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  FROM base b</span></span>
<span id="cb10-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  JOIN centroid c</span></span>
<span id="cb10-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ON b.prefecture_code = c.prefecture_code</span></span>
<span id="cb10-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-38"></span>
<span id="cb10-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">SELECT</span></span>
<span id="cb10-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  prefecture_code,</span></span>
<span id="cb10-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  COUNT(1) AS facility_count,</span></span>
<span id="cb10-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ROUND(AVG(distance_km), 2) AS avg_distance_km,</span></span>
<span id="cb10-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ROUND(STDDEV_POP(distance_km), 2) AS std_distance_km</span></span>
<span id="cb10-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">FROM distance_calc</span></span>
<span id="cb10-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">GROUP BY prefecture_code</span></span>
<span id="cb10-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ORDER BY prefecture_code;"</span></span>
<span id="cb10-47"></span>
<span id="cb10-48">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefecture_code</span>  facility_count  avg_distance_km  std_distance_km</span>
<span id="cb10-49"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">0</span>                 1             290            93.77            60.94</span>
<span id="cb10-50"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span>                 2              83            38.81            13.98</span>
<span id="cb10-51"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2</span>                 3              80            40.96            22.72</span>
<span id="cb10-52"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3</span>                 4             134            23.42            16.30</span>
<span id="cb10-53"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">4</span>                 5              63            37.75            20.52</span>
<span id="cb10-54"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5</span>                 6              64            34.52            17.36</span>
<span id="cb10-55"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">6</span>                 7             119            37.82            19.74</span>
<span id="cb10-56"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">7</span>                 8             162            31.90            15.44</span>
<span id="cb10-57"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">8</span>                 9              56            20.43            14.87</span>
<span id="cb10-58"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">9</span>                10             126            18.65            12.69</span>
<span id="cb10-59"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">10</span>               11             326            19.11             9.78</span>
<span id="cb10-60"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">11</span>               12             268            24.78            16.60</span>
<span id="cb10-61"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">12</span>               13             591            15.57            13.64</span>
<span id="cb10-62"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">13</span>               14             307            15.80             8.60</span>
<span id="cb10-63"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">14</span>               15             100            42.09            25.37</span>
<span id="cb10-64"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">15</span>               16             102            15.35             9.29</span>
<span id="cb10-65"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">16</span>               17              88            23.06            22.74</span>
<span id="cb10-66"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">17</span>               18              67            19.22            16.72</span>
<span id="cb10-67"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">18</span>               19              59            13.29            10.62</span>
<span id="cb10-68"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">19</span>               20             120            36.25            20.10</span>
<span id="cb10-69"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">20</span>               21              93            25.78            19.02</span>
<span id="cb10-70"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">21</span>               22             167            43.71            21.01</span>
<span id="cb10-71"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">22</span>               23             301            21.03            13.13</span>
<span id="cb10-72"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">23</span>               24              91            27.51            20.31</span>
<span id="cb10-73"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">24</span>               25              57            17.71             8.90</span>
<span id="cb10-74"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">25</span>               26             127            18.87            18.05</span>
<span id="cb10-75"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">26</span>               27             482            13.63             8.94</span>
<span id="cb10-76"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">27</span>               28             313            27.50            16.74</span>
<span id="cb10-77"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">28</span>               29              72            10.69             4.60</span>
<span id="cb10-78"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">29</span>               30              80            27.67            18.25</span>
<span id="cb10-79"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">30</span>               31              31            32.39            13.85</span>
<span id="cb10-80"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">31</span>               32              31            48.39            30.18</span>
<span id="cb10-81"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">32</span>               33             153            22.29            13.41</span>
<span id="cb10-82"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">33</span>               34             224            34.46            14.96</span>
<span id="cb10-83"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">34</span>               35             133            35.52            18.83</span>
<span id="cb10-84"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">35</span>               36             103            17.86            13.18</span>
<span id="cb10-85"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">36</span>               37              86            16.33             8.85</span>
<span id="cb10-86"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">37</span>               38             131            32.28            22.05</span>
<span id="cb10-87"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">38</span>               39             118            26.81            23.16</span>
<span id="cb10-88"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">39</span>               40             444            27.91            13.92</span>
<span id="cb10-89"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">40</span>               41              90            19.54             8.50</span>
<span id="cb10-90"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">41</span>               42             142            34.57            26.55</span>
<span id="cb10-91"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">42</span>               43             199            25.12            18.66</span>
<span id="cb10-92"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">43</span>               44             147            24.79            16.57</span>
<span id="cb10-93"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">44</span>               45             117            34.82            20.59</span>
<span id="cb10-94"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">45</span>               46             204            51.76            81.11</span>
<span id="cb10-95"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">46</span>               47              34            25.00            49.11</span></code></pre></div></div>
<p><span class="mini-section">結果の解釈</span></p>
<p>座標フィルタリング後は，各都道府県の地理的特性を反映した妥当な値が得られます．</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 40%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>観点</th>
<th>都道府県（prefecture_code）</th>
<th>平均距離</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>施設が分散（広域）</td>
<td>北海道（1），鹿児島（46），島根（32），静岡（22），新潟（15）</td>
<td>40〜94km</td>
</tr>
<tr class="even">
<td>施設が集中（コンパクト）</td>
<td>奈良（29），大阪（27），山梨（19），東京（13），富山（16）</td>
<td>10〜16km</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>大阪府(27)は府域が狭く施設が密集しているため，平均距離が小さいと思われる</li>
<li>北海道(1)は広大な面積に施設が分散しているため，平均距離が大きいという仮設と整合的</li>
<li>離島を持つ都道府県（沖縄(47)，長崎(42)，鹿児島(46)など）は標準偏差が大きくなる傾向があると思われる</li>
</ul>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://github.com/RyoNakagami/parquet-tools">GitHub &gt; RyoNakagami/parquet-tools</a></li>
<li><a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/iryou/newpage_43373.html">厚生労働省 &gt; 医療情報ネットのオープンデータ</a></li>
</ul>


</section>

 ]]></description>
  <category>前処理</category>
  <category>parquet</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-27-parquet-tools-query/</guid>
  <pubDate>Sat, 27 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>2つcsvファイルのカラムのsumをmarkdown形式で出力する</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-24-compare-two-csv/</link>
  <description><![CDATA[ 






<section id="概要" class="level2">
<h2 class="anchored" data-anchor-id="概要">概要</h2>
<p><code>verify_diff.py</code> は，2つのCSVファイルを比較して差分を表示するPythonスクリプトです． グループ別に集計したデータ同士を比較し，マークダウンテーブルまたはCSV形式で出力します．</p>
</section>
<section id="使い方" class="level2">
<h2 class="anchored" data-anchor-id="使い方">使い方</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基本的な使い方（マークダウン出力）</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run python verify_diff.py file1.csv file2.csv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSV出力</span></span>
<span id="cb1-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run python verify_diff.py file1.csv file2.csv <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> output.csv</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カラム指定</span></span>
<span id="cb1-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run python verify_diff.py file1.csv file2.csv <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--group-col1</span> group_col1 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--value-col1</span> value_col1 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--group-col2</span> group_col2 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--value-col2</span> value_col2</span></code></pre></div></div>
</section>
<section id="コマンドライン引数" class="level2">
<h2 class="anchored" data-anchor-id="コマンドライン引数">コマンドライン引数</h2>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>引数</th>
<th>説明</th>
<th>デフォルト値</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>file1</code></td>
<td>1つ目のCSVファイル（詳細データ）</td>
<td>必須</td>
</tr>
<tr class="even">
<td><code>file2</code></td>
<td>2つ目のCSVファイル（集計データ）</td>
<td>必須</td>
</tr>
<tr class="odd">
<td><code>--group-col1</code></td>
<td>file1のグループカラム名</td>
<td><code>group_col1</code></td>
</tr>
<tr class="even">
<td><code>--value-col1</code></td>
<td>file1の値カラム名</td>
<td><code>value_col1</code></td>
</tr>
<tr class="odd">
<td><code>--group-col2</code></td>
<td>file2のグループカラム名</td>
<td>1列目</td>
</tr>
<tr class="even">
<td><code>--value-col2</code></td>
<td>file2の値カラム名</td>
<td>2列目</td>
</tr>
<tr class="odd">
<td><code>--output</code>, <code>-o</code></td>
<td>出力ファイルパス（CSV形式）</td>
<td>なし（マークダウン出力）</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="コード解説" class="level2">
<h2 class="anchored" data-anchor-id="コード解説">コード解説</h2>
<section id="インポート" class="level3">
<h3 class="anchored" data-anchor-id="インポート">1. インポート</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> argparse</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> csv</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span></code></pre></div></div>
<ul>
<li><code>argparse</code>: コマンドライン引数処理</li>
<li><code>csv</code>: CSV読み書き</li>
<li><code>defaultdict</code>: 存在しないキーにデフォルト値を返す辞書</li>
</ul>
</section>
<section id="マークダウンテーブル生成" class="level3">
<h3 class="anchored" data-anchor-id="マークダウンテーブル生成">2. マークダウンテーブル生成</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> to_markdown_table(headers, rows):</span>
<span id="cb3-2">    lines <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-3">    lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(h) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> headers) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb3-4">    lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"---"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> headers) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb3-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows:</span>
<span id="cb3-6">        lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(v) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> row) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(lines)</span></code></pre></div></div>
<p><strong>出力例:</strong></p>
<pre><code>| グループ | file1 | file2 | 差分 |
| --- | --- | --- | --- |
| ウエルシア薬局 | 2497 | 2487 | -10 |</code></pre>
</section>
<section id="csv読み込み" class="level3">
<h3 class="anchored" data-anchor-id="csv読み込み">3. CSV読み込み</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> read_csv(filepath):</span>
<span id="cb5-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(filepath, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb5-3">        reader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> csv.DictReader(f)</span>
<span id="cb5-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(reader), reader.fieldnames</span></code></pre></div></div>
<ul>
<li><code>csv.DictReader</code>: 各行を辞書として読み込み（キー=ヘッダー名）</li>
<li>戻り値: (行リスト, カラム名リスト)</li>
</ul>
</section>
<section id="file1の読み込みと集計" class="level3">
<h3 class="anchored" data-anchor-id="file1の読み込みと集計">4. file1の読み込みと集計</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">rows1, cols1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_csv(args.file1)</span>
<span id="cb6-2">file1_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb6-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows1:</span>
<span id="cb6-4">    group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[args.group_col1]</span>
<span id="cb6-5">    value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(row[args.value_col1]))</span>
<span id="cb6-6">    file1_sum[group] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> value</span></code></pre></div></div>
<p><strong>処理:</strong></p>
<ol type="1">
<li>CSVを読み込み</li>
<li><code>defaultdict(int)</code>: 未登録キーは0を返す</li>
<li>グループごとに値を合計</li>
</ol>
<p><strong>なぜ <code>int(float(...))</code>?</strong></p>
<ul>
<li>CSVの値が <code>"123.0"</code> の場合、直接 <code>int()</code> はエラー</li>
<li><code>float()</code> で一度変換してから <code>int()</code> に</li>
</ul>
</section>
<section id="file2の読み込み" class="level3">
<h3 class="anchored" data-anchor-id="file2の読み込み">5. file2の読み込み</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">rows2, cols2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_csv(args.file2)</span>
<span id="cb7-2">group_col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args.group_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.group_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cols2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb7-3">value_col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args.value_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.value_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cols2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb7-4">file2_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows2:</span>
<span id="cb7-6">    group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[group_col2]</span>
<span id="cb7-7">    value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(row[value_col2]))</span>
<span id="cb7-8">    file2_data[group] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value</span></code></pre></div></div>
<ul>
<li>カラム未指定時は1列目・2列目を使用</li>
<li>file2は集計済みデータなので単純な辞書に格納</li>
</ul>
</section>
<section id="マージと差分計算" class="level3">
<h3 class="anchored" data-anchor-id="マージと差分計算">6. マージと差分計算</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">all_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(file1_sum.keys()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(file2_data.keys())</span>
<span id="cb8-2"></span>
<span id="cb8-3">merged <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb8-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_groups:</span>
<span id="cb8-5">    v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> file1_sum.get(group)</span>
<span id="cb8-6">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> file2_data.get(group)</span>
<span id="cb8-7">    diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb8-8">    merged.append((group, v1, v2, diff))</span></code></pre></div></div>
<p><strong>処理:</strong></p>
<ol type="1">
<li>両ファイルの全グループを集合演算で取得</li>
<li>各グループの値を取得（存在しなければ <code>None</code>）</li>
<li>差分計算: <code>None</code> は 0 として扱う</li>
</ol>
</section>
<section id="ソート" class="level3">
<h3 class="anchored" data-anchor-id="ソート">7. ソート</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">merged.sort(key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: (x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span></code></pre></div></div>
<p><strong>ソートキー:</strong></p>
<ul>
<li><code>x[1] is None</code>: <code>True</code>=1, <code>False</code>=0 → Noneは後ろへ</li>
<li><code>-(x[1] or 0)</code>: 値の降順</li>
</ul>
</section>
<section id="データ分類" class="level3">
<h3 class="anchored" data-anchor-id="データ分類">8. データ分類</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">both <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1, v2, d) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged</span>
<span id="cb10-2">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb10-3">only_file1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb10-4">only_file2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v2) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb10-5">diff_only <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1, v2, d) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> both <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div></div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>変数</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>both</code></td>
<td>両方に存在</td>
</tr>
<tr class="even">
<td><code>only_file1</code></td>
<td>file1のみに存在</td>
</tr>
<tr class="odd">
<td><code>only_file2</code></td>
<td>file2のみに存在</td>
</tr>
<tr class="even">
<td><code>diff_only</code></td>
<td>差分があるもの</td>
</tr>
</tbody>
</table>
</section>
<section id="出力" class="level3">
<h3 class="anchored" data-anchor-id="出力">9. 出力</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.output:</span>
<span id="cb11-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSV出力</span></span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(args.output, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>, newline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb11-4">        writer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> csv.writer(f)</span>
<span id="cb11-5">        writer.writerow([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"差分"</span>])</span>
<span id="cb11-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged:</span>
<span id="cb11-7">            writer.writerow([g, v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, d])</span>
<span id="cb11-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb11-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># マークダウン出力</span></span>
<span id="cb11-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"## 両方のファイルに存在するグループ</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(to_markdown_table([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"差分"</span>], both))</span>
<span id="cb11-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...</span></span></code></pre></div></div>
</section>
</section>
<section id="使用している標準ライブラリの機能" class="level2">
<h2 class="anchored" data-anchor-id="使用している標準ライブラリの機能">使用している標準ライブラリの機能</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>機能</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>csv.DictReader</code></td>
<td>CSVをヘッダー付き辞書として読み込み</td>
</tr>
<tr class="even">
<td><code>csv.writer</code></td>
<td>CSVファイルへの書き込み</td>
</tr>
<tr class="odd">
<td><code>defaultdict(int)</code></td>
<td>未登録キーに0を返す辞書</td>
</tr>
<tr class="even">
<td><code>set()</code> の <code>\|</code></td>
<td>和集合（両方のキーを取得）</td>
</tr>
<tr class="odd">
<td><code>dict.get()</code></td>
<td>キーがなければNoneを返す</td>
</tr>
</tbody>
</table>
</section>
<section id="コード" class="level2">
<h2 class="anchored" data-anchor-id="コード">コード</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> argparse</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> csv</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb12-4"></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> to_markdown_table(headers, rows):</span>
<span id="cb12-7">    lines <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb12-8">    lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(h) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> headers) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb12-9">    lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"---"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> headers) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb12-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows:</span>
<span id="cb12-11">        lines.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"| "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" | "</span>.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(v) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> row) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" |"</span>)</span>
<span id="cb12-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(lines)</span>
<span id="cb12-13"></span>
<span id="cb12-14"></span>
<span id="cb12-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> read_csv(filepath):</span>
<span id="cb12-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(filepath, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb12-17">        reader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> csv.DictReader(f)</span>
<span id="cb12-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(reader), reader.fieldnames</span>
<span id="cb12-19"></span>
<span id="cb12-20"></span>
<span id="cb12-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb12-22">    parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> argparse.ArgumentParser(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2つのCSVファイルを比較して差分を表示します"</span>)</span>
<span id="cb12-23">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1つ目のCSVファイル（詳細データ）"</span>)</span>
<span id="cb12-24">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2つ目のCSVファイル（集計データ）"</span>)</span>
<span id="cb12-25">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--group-col1"</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group_col1"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1のグループカラム名"</span>)</span>
<span id="cb12-26">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--value-col1"</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value_col1"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1の値カラム名"</span>)</span>
<span id="cb12-27">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--group-col2"</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2のグループカラム名 (default: 1列目)"</span>)</span>
<span id="cb12-28">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--value-col2"</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2の値カラム名 (default: 2列目)"</span>)</span>
<span id="cb12-29">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--output"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-o"</span>, default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"出力ファイルパス（CSV形式）"</span>)</span>
<span id="cb12-30">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse_args()</span>
<span id="cb12-31"></span>
<span id="cb12-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># file1 を読み込み・グループ別に集計</span></span>
<span id="cb12-33">    rows1, cols1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_csv(args.file1)</span>
<span id="cb12-34">    file1_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb12-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows1:</span>
<span id="cb12-36">        group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[args.group_col1]</span>
<span id="cb12-37">        value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(row[args.value_col1]))</span>
<span id="cb12-38">        file1_sum[group] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> value</span>
<span id="cb12-39"></span>
<span id="cb12-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># file2 を読み込み</span></span>
<span id="cb12-41">    rows2, cols2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_csv(args.file2)</span>
<span id="cb12-42">    group_col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args.group_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.group_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cols2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb12-43">    value_col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args.value_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.value_col2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cols2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb12-44">    file2_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb12-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> rows2:</span>
<span id="cb12-46">        group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[group_col2]</span>
<span id="cb12-47">        value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(row[value_col2]))</span>
<span id="cb12-48">        file2_data[group] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value</span>
<span id="cb12-49"></span>
<span id="cb12-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全グループを取得</span></span>
<span id="cb12-51">    all_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(file1_sum.keys()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(file2_data.keys())</span>
<span id="cb12-52"></span>
<span id="cb12-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># マージして差分計算</span></span>
<span id="cb12-54">    merged <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb12-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_groups:</span>
<span id="cb12-56">        v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> file1_sum.get(group)</span>
<span id="cb12-57">        v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> file2_data.get(group)</span>
<span id="cb12-58">        diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb12-59">        merged.append((group, v1, v2, diff))</span>
<span id="cb12-60"></span>
<span id="cb12-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># file1の値で降順ソート（Noneは末尾）</span></span>
<span id="cb12-62">    merged.sort(key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: (x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb12-63"></span>
<span id="cb12-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 分類</span></span>
<span id="cb12-65">    both <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1, v2, d) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb12-66">    only_file1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb12-67">    only_file2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v2) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb12-68">    diff_only <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(g, v1, v2, d) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> both <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb12-69"></span>
<span id="cb12-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSV出力</span></span>
<span id="cb12-71">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> args.output:</span>
<span id="cb12-72">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(args.output, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>, newline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb12-73">            writer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> csv.writer(f)</span>
<span id="cb12-74">            writer.writerow([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"差分"</span>])</span>
<span id="cb12-75">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> g, v1, v2, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> merged:</span>
<span id="cb12-76">                writer.writerow([g, v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, d])</span>
<span id="cb12-77">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"CSVファイルを出力しました: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-78">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-79">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># マークダウンテーブル生成</span></span>
<span id="cb12-80">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"## 両方のファイルに存在するグループ</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-81">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(to_markdown_table([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"差分"</span>], both))</span>
<span id="cb12-82"></span>
<span id="cb12-83">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> only_file1:</span>
<span id="cb12-84">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">## </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>file1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">にのみ存在するグループ</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-85">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(to_markdown_table([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>], only_file1))</span>
<span id="cb12-86"></span>
<span id="cb12-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> only_file2:</span>
<span id="cb12-88">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">## </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>file2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">にのみ存在するグループ</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-89">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(to_markdown_table([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>], only_file2))</span>
<span id="cb12-90"></span>
<span id="cb12-91">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> diff_only:</span>
<span id="cb12-92">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">## 差分があるグループのみ</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-93">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(to_markdown_table([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"グループ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"差分"</span>], diff_only))</span>
<span id="cb12-94"></span>
<span id="cb12-95"></span>
<span id="cb12-96"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb12-97">    main()</span></code></pre></div></div>


</section>

 ]]></description>
  <category>python</category>
  <category>前処理</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-24-compare-two-csv/</guid>
  <pubDate>Wed, 24 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>CPUとDRAMの「メモリチャネル」とは何か？</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-23-memory-channel/</link>
  <description><![CDATA[ 






<section id="メモリチャネルとは" class="level2">
<h2 class="anchored" data-anchor-id="メモリチャネルとは">メモリチャネルとは？</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">メモリチャネル</span></p>
<ul>
<li>CPUとメインメモリ（RAM）間の64bit データ伝送経路(物理バス)の数のこと</li>
<li>チャネル数が多ければ多いほど，一度に転送できるデータ量が増え，結果的にシステムのパフォーマンスが向上</li>
<li>扱えるチャネル数はCPU側で決まる</li>
</ul>
</div>
<p>CPUがメモリにアクセスする際に，CPU上のメモリコントローラを介して，このチャネルを通してデータの読み書きを行います． 複数のチャネルが同時に動作（＝マルチチャネル）することで，メモリの帯域幅が増加します．</p>
<p><span class="mini-section">Question: メモリスロットとは違うのか？</span></p>
<ul>
<li>Answer: <span class="regmonkey-bold">メモリスロット数 ≠ メモリチャネル数</span></li>
<li>メモリチャネルはCPU内蔵メモリコントローラ（IMC）が持つ独立した通信路</li>
<li>メモリスロットとはDIMMを挿すための物理的な差し込み口</li>
</ul>
<p><span class="mini-section">Question: どのメモリがどのチャネルを利用しているのか</span></p>
<p>どのメモリがどのチャネルを使用しているかは <code>dmidecode</code> で確認することが出来ます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> sudo dmidecode <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> memory <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">less</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Handle</span> 0x0013, DMI type 17, 92 bytes</span>
<span id="cb1-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Memory</span> Device</span>
<span id="cb1-5">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Array</span> Handle: 0x000E</span>
<span id="cb1-6">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Error</span> Information Handle: 0x0012</span>
<span id="cb1-7">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Total</span> Width: 64 bits</span>
<span id="cb1-8">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Data</span> Width: 64 bits</span>
<span id="cb1-9">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Size:</span> 32 GB</span>
<span id="cb1-10">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Form</span> Factor: DIMM</span>
<span id="cb1-11">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Set:</span> None</span>
<span id="cb1-12">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Locator:</span> DIMMA2</span>
<span id="cb1-13">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Bank</span> Locator: P0 CHANNEL A</span>
<span id="cb1-14">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Type:</span> DDR5</span>
<span id="cb1-15">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Type</span> Detail: Synchronous Unbuffered <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Unregistered</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb1-16">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Speed:</span> 4800 MT/s</span>
<span id="cb1-17">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Manufacturer:</span> A-DATA Technology</span>
<span id="cb1-18">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Serial</span> Number: 00xxxxxx</span>
<span id="cb1-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Asset</span> Tag: Not Specified</span>
<span id="cb1-20">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Part</span> Number: AD5U480032G-B       </span>
<span id="cb1-21">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Rank:</span> 2</span>
<span id="cb1-22">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Configured</span> Memory Speed: 4800 MT/s</span>
<span id="cb1-23">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span></code></pre></div></div>
<p>上記から以下の情報を読み取ることが出来ます</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 21%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>dmidecode項目</th>
<th>表示例</th>
<th>何を意味するか</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Bank Locator</strong></td>
<td><code>P0 CHANNEL A</code></td>
<td><strong>CPUソケット0 (P0)</strong> の <strong>メモリチャネルA</strong> に接続</td>
</tr>
<tr class="even">
<td><strong>Locator</strong></td>
<td><code>DIMMA2</code></td>
<td>マザーボード上の <strong>物理メモリスロット名</strong></td>
</tr>
<tr class="odd">
<td><strong>Total Width</strong></td>
<td><code>64 bits</code></td>
<td>DIMM全体のバス幅</td>
</tr>
<tr class="even">
<td><strong>Data Width</strong></td>
<td><code>64 bits</code></td>
<td>CPUから見える <strong>有効データ幅</strong></td>
</tr>
<tr class="odd">
<td><strong>Rank</strong></td>
<td><code>2</code></td>
<td><strong>Dual Rank DIMM</strong>（1枚のDIMM内に2 Rank）</td>
</tr>
<tr class="even">
<td><strong>Type</strong></td>
<td><code>DDR5</code></td>
<td>メモリ世代（DDR5）</td>
</tr>
<tr class="odd">
<td><strong>Speed</strong></td>
<td><code>4800 MT/s</code></td>
<td>メモリ転送レート（メガトランスファ/秒）</td>
</tr>
<tr class="even">
<td><strong>Configured Memory Speed</strong></td>
<td><code>4800 MT/s</code></td>
<td>実際に動作している速度</td>
</tr>
<tr class="odd">
<td><strong>Form Factor</strong></td>
<td><code>DIMM</code> / <code>SODIMM</code></td>
<td>モジュール形状</td>
</tr>
<tr class="even">
<td><strong>Memory Technology</strong></td>
<td><code>DRAM</code></td>
<td>揮発性メモリ</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">ランクとは？</span></p>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">ランク</span></p>
<p>上記のメモリは DIMM となっています．DIMMとは Dual Inline Memory Moduleの略で，複数のDRAMチップをプリント基板上に搭載したメモリモジュールのことです． DIMM内のDRAMチップのうち，メモリコントローラとのアクセスに用いられるアドレス・ラインを共有し，同時に選択される DRAM チップの集合を <strong>Rank（ランク）</strong>と呼びます．</p>
</div>
<p>１つのランクは64ビットの単位で入出力をします．１つのメモリチャネルが64 bitであることに対応しており， 1 Rank がちょうど 1 メモリチャネルを占有して通信する構造になっています．</p>
<p>そのため，</p>
<ul>
<li>1 チャネルあたり同時にアクセスできる Rank は 1 つのみ</li>
<li>Dual Rank DIMM では，Rank 0 と Rank 1 を 時間的に切り替えて使用する</li>
</ul>
<p>という動作になります．</p>
</section>
<section id="ddr5-と-サブチャネル" class="level2">
<h2 class="anchored" data-anchor-id="ddr5-と-サブチャネル">DDR5 と サブチャネル</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-23-memory-channel/DDR5-subchannel.png" class="img-fluid figure-img"></p>
<figcaption>DDR RDIMMモジュール</figcaption>
</figure>
</div>
<p>「DDR5メモリは1枚でデュアルチャネル」という言葉をよく耳にしますが，たしかに標準のDDR5モジュールは 2 つの独立型 32 bit サブチャネルを備えています． これはDDR5が 1つの64 bitメモリチャネルを内部的に分けて使用することを意味します．</p>
<p>つまり，</p>
<ul>
<li>DDR5は「メモリバス幅を広げた」のではなく64bit バスを 2 つの 32bit に分割して“使い勝手を良くしただけで，1つのDDR5メモリで２つのCPUメモリチャネルを専有するわけではない</li>
<li>DDR5 モジュールは，CPU からは 64bit 幅のメモリチャネルとして接続されているが，DIMM 内部ではこの 64bit データ経路が 2 つの独立した 32bit サブチャネルとして論理的に分割 されているだけ</li>
<li>デュアルチャネルはあくまでDIMMの中の話</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb2-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">CPU メモリチャネル（64bit）</span></span>
<span id="cb2-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">        │</span></span>
<span id="cb2-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">        ├─ Sub-channel A : 32bit</span></span>
<span id="cb2-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">        └─ Sub-channel B : 32bit</span></span></code></pre></div></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>image図ではなぜ40 bitなのか？
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>ECCメモリを用いた例のため（Error Correcting Code）</li>
<li>ECCメモリは，メモリ故障などに起因して 1 bitの反転エラーが発生したときに，それを検知・自動補正ができるようにするための誤り訂正符号(ECC)と呼ばれるパリティ情報が付与されたメモリ
<ul>
<li>メモリ故障が発生するとECCメモリではない場合，OSレベルの異常終了になってしまうが，ECCメモリの場合ではOSが以上を検知してアラートを出してくれる</li>
<li>アラート発報後，通常終了を行いメモリを交換というアクションが可能</li>
</ul></li>
<li>40 bit = 32 data bit + 8 ECC bit</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (AMD Ryzen Threadripper PRO 9975Wと理論メモリ帯域)</strong></span> <br></p>
<p><a href="https://www.amd.com/ja/products/processors/workstations/ryzen-threadripper/9000-wx-series/amd-ryzen-threadripper-pro-9975wx.html">公式仕様</a>を確認すると</p>
<ul>
<li>メモリ規格：DDR5 RDIMM</li>
<li>メモリチャネル数：8 チャネル</li>
<li>最大転送レート：6400 MT/s</li>
</ul>
<p>まず１チャネルあたりのメモリ帯域は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A6,400%20%5Coperatorname%7BMT/s%7D%20%5Ctimes%2064%20%5Coperatorname%7Bbits%7D%20=%2051,200%20%5Coperatorname%7BMB/s%7D%0A"></p>
<p>これを合計 8 チャネルで使用できるとすると</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A51,200%20%5Coperatorname%7BMB/s%7D%20%5Ctimes%208%20=%20409.6%20%5Coperatorname%7BGB/s%7D%0A"></p>
</div>
<hr>
</section>
<section id="appendix-メモリテクノロジー" class="level2">
<h2 class="anchored" data-anchor-id="appendix-メモリテクノロジー">Appendix: メモリテクノロジー</h2>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 36%">
<col style="width: 33%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>観点</th>
<th>SRAM</th>
<th>DRAM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>名称</td>
<td>static random access memory</td>
<td>dynamic random access memory</td>
</tr>
<tr class="even">
<td>特徴</td>
<td>速度</td>
<td>容量・SRAMより安価</td>
</tr>
<tr class="odd">
<td>どこにある？</td>
<td>CPUの中</td>
<td>CPUの外</td>
</tr>
<tr class="even">
<td>データサイエンス/数値計算</td>
<td>キャッシュヒット率が重要</td>
<td>帯域・チャネル数が重要</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">random accessとは？</span></p>
<ul>
<li>磁気テープ装置は順を追ってしか読み書きできない</li>
<li>RAMでは，どの部分を読み出すにもかかる時間は同じ</li>
</ul>
<p><span class="mini-section">DRAMはなぜSRAMよりも容量が大きいのか？</span></p>
<ul>
<li><strong>1ビットあたりの回路が極めて小さい</strong></li>
<li>同じシリコン面積ならDRAMの方が圧倒的に多くのビットを実装できる</li>
<li>ビットあたりのトランジスタもDRAMは1ビットあたり1トランジスタ，SRAMは1ビットあたり6トランジスタを必要 → 製造コスト・歩留まりの面でもDRAMが有利</li>
</ul>
<p><span class="mini-section">Dynamic vs static</span></p>
<p>DRAMはキャパシタに電荷を蓄えることで情報を保持します．電荷は時間とともに漏れるため，<strong>一定周期でのリフレッシュ（再書き込み） = Dynamic</strong>が必要となります． 一方，SRAMは電源が供給されている限り状態を保持できるため，このリフレッシュが不要のため，静的 = static と呼ばれます．</p>
<p><span class="mini-section">メモリテクノロジー別アクセス時間・コストテーブル</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 22%">
<col style="width: 20%">
<col style="width: 26%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>種類</th>
<th>代表例</th>
<th>代表的アクセス時間（レイテンシ）</th>
<th><strong>1GiBあたりのコスト感<br>(2012年)</strong></th>
<th>主な用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>SRAM</strong></td>
<td>CPU L1/L2/L3 Cache</td>
<td><strong>0.5〜2.5 ns</strong></td>
<td><strong>500 ~ 1,000ドル / GiB</strong></td>
<td>キャッシュ，レジスタ</td>
</tr>
<tr class="even">
<td><strong>DRAM</strong></td>
<td>DDR4 / DDR5</td>
<td><strong>50〜70 ns</strong></td>
<td><strong>10 ~ 20ドル / GiB</strong></td>
<td>メインメモリ</td>
</tr>
<tr class="odd">
<td><strong>フラッシュ半導体メモリ</strong></td>
<td>NAND（SSD, NVMe）</td>
<td><strong>50〜500 µs</strong></td>
<td><strong>0.75 ~ 1ドル / GiB</strong></td>
<td>ストレージ（高速）</td>
</tr>
<tr class="even">
<td><strong>磁気ディスク</strong></td>
<td>HDD</td>
<td><strong>5〜20 ms</strong></td>
<td><strong>0.05 ~ 0.1ドル / GiB</strong></td>
<td>大容量保存</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.reddit.com/r/hardware/comments/1q8d9v/can_someone_please_explain_ram_channels_to_me/">Can someone please explain RAM Channels to me?</a></li>
</ul>


</section>

 ]]></description>
  <category>general</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-23-memory-channel/</guid>
  <pubDate>Tue, 23 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Fisher’s Exact Test</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-19-fishers-exact-test/</link>
  <description><![CDATA[ 






<section id="fishers-exact-testfisherの正確検定" class="level2">
<h2 class="anchored" data-anchor-id="fishers-exact-testfisherの正確検定">Fisher’s exact test(Fisherの正確検定)</h2>
<p>体外式膜型人工肺（ECMO）は，重度の呼吸不全を抱える新生児を治療するための処置です．</p>
<p>ある実験<sup>1</sup>にて</p>
<ul>
<li>29人の新生児がECMOで治療</li>
<li>10人の新生児が従来の内科的治療（CMT）で治療</li>
</ul>
<p>が実施された結果，以下のような主要評価項目が得られました．</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Treatment</th>
<th>Die</th>
<th>Live</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ECMO</td>
<td>1</td>
<td>28</td>
<td>29</td>
</tr>
<tr class="even">
<td style="text-align: center;">CMT</td>
<td>4</td>
<td>6</td>
<td>10</td>
</tr>
<tr class="odd">
<td style="text-align: center;">total</td>
<td>5</td>
<td>34</td>
<td>39</td>
</tr>
</tbody>
</table>
<p>このデータに対して，ECMOとCMTで死亡率に差があるかどうかを検定したいという問題を考えます．</p>
<section id="nhstフレームワーク" class="level3">
<h3 class="anchored" data-anchor-id="nhstフレームワーク">NHSTフレームワーク</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>検証仮説
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%0AH_0:%20%5Ctext%7B%E6%B2%BB%E7%99%82%E6%B3%95%EF%BC%88ECMO%20or%20CMT%EF%BC%89%E3%81%A8%E7%B5%90%E6%9E%9C%EF%BC%88Die%20or%20Live%EF%BC%89%E3%81%AF%E7%8B%AC%E7%AB%8B%E3%81%A7%E3%81%82%E3%82%8B%7D%0A"></p>
<p>つまり，ECMOで治療しようがCMTで治療しようが，死亡率は同じであるという仮説．</p>
</div>
</div>
<p>このときの対立仮説は，両側検定の場合</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AH_1:%20%5Ctext%7B%E6%B2%BB%E7%99%82%E6%B3%95%E3%81%A8%E7%B5%90%E6%9E%9C%E3%81%AF%E7%8B%AC%E7%AB%8B%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84%EF%BC%88%E9%96%A2%E9%80%A3%E3%81%8C%E3%81%82%E3%82%8B%EF%BC%89%7D%0A"></p>
<p>片側検定の場合は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AH_1:%20%5Ctext%7BCMT%E3%81%A8%E6%AF%94%E3%81%B9ECMO%E3%81%AF%E6%AD%BB%E4%BA%A1%E7%8E%87%E3%81%AE%E4%BD%8E%E3%81%84%E6%B2%BB%E7%99%82%E6%B3%95%E3%81%A7%E3%81%82%E3%82%8B%7D%0A"></p>
<p>となります．</p>
<p><span class="mini-section"><img src="https://latex.codecogs.com/png.latex?H_0"> が真のときの分布</span></p>
<p>Fisher’s exact testでは (ECMOの人数, CMTの人数) = (29, 10) はstudy designによって固定されていると考えます．<img src="https://latex.codecogs.com/png.latex?H_0">が真であるとき，39人の患者のうち5人が死亡し34人が生存するという<strong>周辺度数は固定</strong>されていると考えます．</p>
<p>このとき，ECMO群29人の中で死亡する人数 <img src="https://latex.codecogs.com/png.latex?X"> は超幾何分布に従うと考え</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AX%20%5Csim%20%5Ctext%7BHypergeometric%7D(N=39,%20M=5,%20K=29)%0A"></p>
<p>ここで，</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?N%20=%2039">: 全患者数</li>
<li><img src="https://latex.codecogs.com/png.latex?M%20=%205">: 全死亡者数</li>
<li><img src="https://latex.codecogs.com/png.latex?K%20=%2029">: ECMO群の患者数</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?H_0">の下で，ECMO群の死亡者数 <img src="https://latex.codecogs.com/png.latex?X%20=%20x"> となる確率は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(X%20=%20x%20%5Cmid%20H_0)%20=%20%5Cfrac%7B%5Cbinom%7B5%7D%7Bx%7D%5Cbinom%7B34%7D%7B29-x%7D%7D%7B%5Cbinom%7B39%7D%7B29%7D%7D%0A"></p>
<p><span class="mini-section">検定統計量とp値</span></p>
<p>観測されたECMO群の死亡者数は <img src="https://latex.codecogs.com/png.latex?x%20=%201"> です．</p>
<p><strong>片側検定</strong>（ECMOの方が死亡率が低い）のp値は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap_%7B%5Ctext%7Bone-sided%7D%7D%20=%20P(X%20%5Cleq%201%20%5Cmid%20H_0)%20=%20%5Csum_%7Bk=0%7D%5E%7B1%7D%20%5Cfrac%7B%5Cbinom%7B5%7D%7Bk%7D%5Cbinom%7B34%7D%7B29-k%7D%7D%7B%5Cbinom%7B39%7D%7B29%7D%7D%0A"></p>
<p><strong>両側検定</strong>のp値の計算方法はいくつかありますが，<code>scipy.stats.fisher_exact</code>では観測値の確率以下となるすべての<img src="https://latex.codecogs.com/png.latex?x">の確率を合計する方法を採用しています：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap_%7B%5Ctext%7Btwo-sided%7D%7D%20=%20%5Csum_%7Bx:%20P(X=x%20%5Cmid%20H_0)%20%5Cleq%20P(X=1%20%5Cmid%20H_0)%7D%20P(X%20=%20x%20%5Cmid%20H_0)%0A"></p>
<p>つまり，観測された <img src="https://latex.codecogs.com/png.latex?x=1"> の確率 <img src="https://latex.codecogs.com/png.latex?P(X=1%20%5Cmid%20H_0)"> を計算し，それ以下の確率を持つすべての <img src="https://latex.codecogs.com/png.latex?x"> の値について確率を合計します．</p>
<div id="aceecfe3" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hypergeom, fisher_exact</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats.contingency <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> odds_ratio <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> odds_ratio_ci</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ</span></span>
<span id="cb1-6">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全患者数</span></span>
<span id="cb1-7">R <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全死亡者数</span></span>
<span id="cb1-8">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ECMO群の患者数</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># P(X &lt;= 1) を計算</span></span>
<span id="cb1-11">p_value_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.cdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, R, K)</span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"P(X &lt;= 1 | H_0) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_value_left<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scipy.stats.fisher_exact で確認</span></span>
<span id="cb1-15">table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb1-16">odds_ratio, p_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'two-sided'</span>)</span>
<span id="cb1-17">_, p_less <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># オッズ比の信頼区間（exact method）</span></span>
<span id="cb1-20">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> odds_ratio_ci(table)</span>
<span id="cb1-21">ci_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.confidence_interval(confidence_level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb1-22">ci_less <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.confidence_interval(confidence_level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fisher's exact test (scipy):"</span>)</span>
<span id="cb1-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Odds ratio: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>odds_ratio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  95% CI (two-sided): (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>low<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>high<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb1-27"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  95% CI (less): (0, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_less<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>high<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb1-28"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (two-sided): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_less<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>P(X &lt;= 1 | H_0) = 0.011015

Fisher's exact test (scipy):
  Odds ratio: 0.0536
  95% CI (two-sided): (0.0011, 0.7319)
  95% CI (less): (0, 0.5453)
  p-value (two-sided): 0.011015
  p-value (less): 0.011015</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>上記のscipyによる計算結果は R における <code>fisher.test()</code> とほぼ同じ計算結果となっています</li>
<li>one-sided testにおけるOdds ratioのCIは OR &lt; 1 をベースに計算しています</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (両側検定で計算される領域)</strong></span> <br></p>
<p><img src="https://latex.codecogs.com/png.latex?N=45,%20M=12,%20K=30">, 観測値 <img src="https://latex.codecogs.com/png.latex?x=5"> における両側検定のp値計算領域を可視化します．</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">outcome 1</th>
<th style="text-align: center;">outcome 2</th>
<th style="text-align: center;">total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">group 1</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">25</td>
<td style="text-align: center;">30</td>
</tr>
<tr class="even">
<td style="text-align: center;">group 2</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">15</td>
</tr>
<tr class="odd">
<td style="text-align: center;">total</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">33</td>
<td style="text-align: center;">45</td>
</tr>
</tbody>
</table>
<div id="3d4c651e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hypergeom</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ</span></span>
<span id="cb3-6">N, M, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb3-7">obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x の範囲</span></span>
<span id="cb3-10">x_min <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> M))</span>
<span id="cb3-11">x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(M, K)</span>
<span id="cb3-12">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(x_min, x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PMF の計算</span></span>
<span id="cb3-15">pmf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.pmf(x, N, M, K)</span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 観測値の確率</span></span>
<span id="cb3-18">p_obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.pmf(obs, N, M, K)</span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 両側検定: 観測値の確率以下となる x を特定</span></span>
<span id="cb3-21">two_sided_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pmf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> p_obs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 数値誤差を考慮</span></span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 色分け</span></span>
<span id="cb3-24">colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> two_sided_mask[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steelblue'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x))]</span>
<span id="cb3-25"></span>
<span id="cb3-26">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb3-27">bars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.bar(x, pmf, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>)</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 観測値にマーカー</span></span>
<span id="cb3-30">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>obs, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkred'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Observed x=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>obs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb3-31"></span>
<span id="cb3-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># P(X=obs) の水平線</span></span>
<span id="cb3-33">ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p_obs, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">':'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'P(X=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>obs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_obs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb3-34"></span>
<span id="cb3-35">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-36">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P(X = x)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-37">ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Hypergeometric Distribution under $H_0$ (N=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, M=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>M<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, K=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Red: two-sided p-value region'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>)</span>
<span id="cb3-38">ax.set_xticks(x)</span>
<span id="cb3-39">ax.legend(loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper right'</span>)</span>
<span id="cb3-40">ax.grid(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-41"></span>
<span id="cb3-42">plt.tight_layout()</span>
<span id="cb3-43">plt.show()</span>
<span id="cb3-44"></span>
<span id="cb3-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># p値の計算</span></span>
<span id="cb3-46">p_one_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.cdf(obs, N, M, K)</span>
<span id="cb3-47">p_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pmf[two_sided_mask].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb3-48"></span>
<span id="cb3-49"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"P(X=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>obs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_obs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-50"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Two-sided region: x ∈ </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(xi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x[two_sided_mask])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-51"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"p-value (one-sided, less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_one_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-52"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"p-value (two-sided): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-19-fishers-exact-test/index_files/figure-html/cell-3-output-1.png" width="759" height="467" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>P(X=5) = 0.031885
Two-sided region: x ∈ {0, 1, 2, 3, 4, 5, 11, 12}
p-value (one-sided, less): 0.038771
p-value (two-sided): 0.070269</code></pre>
</div>
</div>
<p>赤色の領域が両側検定のp値に寄与する部分です．観測値 <img src="https://latex.codecogs.com/png.latex?x=1"> の確率 <img src="https://latex.codecogs.com/png.latex?P(X=1%20%5Cmid%20H_0)"> 以下の確率を持つすべての <img src="https://latex.codecogs.com/png.latex?x"> の値（この場合 <img src="https://latex.codecogs.com/png.latex?x=0,%201,%202,%203,%204,%205,%2011,%2012">）の確率を合計します．</p>
</div>
<p><span class="mini-section">検定統計量とp値</span></p>
<p>観測されたECMO群の死亡者数は <img src="https://latex.codecogs.com/png.latex?x%20=%201"> である．片側検定（ECMOの方が死亡率が低い）のp値は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap%20=%20P(X%20%5Cleq%201%20%5Cmid%20H_0)%20=%20%5Csum_%7Bk=0%7D%5E%7B1%7D%20%5Cfrac%7B%5Cbinom%7B5%7D%7Bk%7D%5Cbinom%7B34%7D%7B29-k%7D%7D%7B%5Cbinom%7B39%7D%7B29%7D%7D%0A"></p>
<div id="8e1c1e40" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hypergeom, fisher_exact</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats.contingency <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> odds_ratio <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> odds_ratio_ci</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ</span></span>
<span id="cb5-6">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全患者数</span></span>
<span id="cb5-7">R <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全死亡者数</span></span>
<span id="cb5-8">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ECMO群の患者数</span></span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># P(X &lt;= 1) を計算</span></span>
<span id="cb5-11">p_value_left <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.cdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, R, K)</span>
<span id="cb5-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"P(X &lt;= 1 | H_0) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_value_left<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-13"></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scipy.stats.fisher_exact で確認</span></span>
<span id="cb5-15">table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb5-16">odds_ratio, p_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'two-sided'</span>)</span>
<span id="cb5-17">_, p_less <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb5-18"></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># オッズ比の信頼区間（exact method）</span></span>
<span id="cb5-20">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> odds_ratio_ci(table)</span>
<span id="cb5-21">ci_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.confidence_interval(confidence_level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb5-22">ci_less <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.confidence_interval(confidence_level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fisher's exact test (scipy):"</span>)</span>
<span id="cb5-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Odds ratio: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>odds_ratio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  95% CI (two-sided): (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>low<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>high<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb5-27"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  95% CI (less): (0, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_less<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>high<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb5-28"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (two-sided): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_less<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>P(X &lt;= 1 | H_0) = 0.011015

Fisher's exact test (scipy):
  Odds ratio: 0.0536
  95% CI (two-sided): (0.0011, 0.7319)
  95% CI (less): (0, 0.5453)
  p-value (two-sided): 0.011015
  p-value (less): 0.011015</code></pre>
</div>
</div>
</section>
<section id="サンプルサイズと周辺度数のバランス" class="level3">
<h3 class="anchored" data-anchor-id="サンプルサイズと周辺度数のバランス">サンプルサイズと周辺度数のバランス</h3>
<p>Fisher’s exact testでは，<strong>サンプルサイズが大きくても周辺度数のバランスが悪いと検出力が下がる</strong>ことがあります．</p>
<p>以下の2つのテーブルを比較してみます（どちらもオッズ比は同じ0.5）：</p>
<div id="347dfe44" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fisher_exact</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 1: バランスの取れた周辺度数 (N=40)</span></span>
<span id="cb7-5">table1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>]]</span>
<span id="cb7-6">or1, p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table1, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 2: アンバランスな周辺度数 (N=50)</span></span>
<span id="cb7-9">table2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb7-10">or2, p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table2, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'less'</span>)</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case 1: バランスの取れた周辺度数"</span>)</span>
<span id="cb7-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Table: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  N = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(row) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> table1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, 行比 = 20:20 (50%:50%)"</span>)</span>
<span id="cb7-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Odds ratio: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>or1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Case 2: アンバランスな周辺度数"</span>)</span>
<span id="cb7-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Table: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  N = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(row) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> table2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, 行比 = 40:10 (80%:20%)"</span>)</span>
<span id="cb7-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Odds ratio: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>or2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  p-value (less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Case 1: バランスの取れた周辺度数
  Table: [[5, 15], [8, 12]]
  N = 40, 行比 = 20:20 (50%:50%)
  Odds ratio: 0.5000
  p-value (less): 0.250302

Case 2: アンバランスな周辺度数
  Table: [[10, 30], [4, 6]]
  N = 50, 行比 = 40:10 (80%:20%)
  Odds ratio: 0.5000
  p-value (less): 0.283076</code></pre>
</div>
</div>
<p><strong>なぜCase 2の方がp値が大きい（検出力が低い）のか？</strong></p>
<p>超幾何分布の観点から説明すると：</p>
<ul>
<li><strong>Case 1</strong>: 行2（対照群）が20人いるため，死亡者13人の配分パターンが多様</li>
<li><strong>Case 2</strong>: 行2（対照群）がわずか10人のため，死亡者14人のうち最大でも10人しか行2に配分できない</li>
</ul>
<div id="3038017d" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hypergeom</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 1: N=40, M=13(死亡), K=20(行1)</span></span>
<span id="cb9-6">N1, M1, K1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb9-7">x1_min, x1_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(N1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>M1)), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(M1, K1)</span>
<span id="cb9-8">x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(x1_min, x1_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-9">pmf1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.pmf(x1, N1, M1, K1)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 2: N=50, M=14(死亡), K=40(行1)</span></span>
<span id="cb9-12">N2, M2, K2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span></span>
<span id="cb9-13">x2_min, x2_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(N2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>M2)), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(M2, K2)</span>
<span id="cb9-14">x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(x2_min, x2_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-15">pmf2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.pmf(x2, N2, M2, K2)</span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 観測値</span></span>
<span id="cb9-18">obs1, obs2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb9-19"></span>
<span id="cb9-20">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>))</span>
<span id="cb9-21"></span>
<span id="cb9-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 1</span></span>
<span id="cb9-23">colors1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> xi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> obs1 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steelblue'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x1]</span>
<span id="cb9-24">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].bar(x1, pmf1, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors1, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>)</span>
<span id="cb9-25">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Case 1: N=40, group ratio 50:50'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb9-26">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Die in treated'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb9-27">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P(X=x)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb9-28">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xticks(x1)</span>
<span id="cb9-29">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].grid(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb9-30"></span>
<span id="cb9-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case 2</span></span>
<span id="cb9-32">colors2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> xi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> obs2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steelblue'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x2]</span>
<span id="cb9-33">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].bar(x2, pmf2, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors2, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>)</span>
<span id="cb9-34">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Case 2: N=50, group ratio 80:20'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb9-35">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Die in treated'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb9-36">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xticks(x2)</span>
<span id="cb9-37">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].grid(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb9-38"></span>
<span id="cb9-39">fig.suptitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hypergeometric distribution under $H_0$'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb9-40">plt.tight_layout()</span>
<span id="cb9-41">plt.show()</span>
<span id="cb9-42"></span>
<span id="cb9-43"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Case 1: P(X ≤ </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>obs1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>hypergeom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cdf(obs1, N1, M1, K1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-44"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Case 2: P(X ≤ </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>obs2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>hypergeom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>cdf(obs2, N2, M2, K2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-19-fishers-exact-test/index_files/figure-html/cell-6-output-1.png" width="949" height="427" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Case 1: P(X ≤ 5) = 0.250302
Case 2: P(X ≤ 10) = 0.283076</code></pre>
</div>
</div>
<p>Case 2では，分布の取りうる範囲が狭く（<img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20%5B4,%2014%5D">），観測値10が分布の中央付近に位置するため，p値が大きくなります．</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>実験計画への示唆
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fisher’s exact testの検出力を高めるには：</p>
<ol type="1">
<li><strong>サンプルサイズを増やす</strong>だけでなく</li>
<li><strong>群間のバランスを取る</strong>（できれば1:1に近づける）ことが重要</li>
</ol>
<p>特に対照群のサンプルサイズが小さいと，効果量が同じでも検出力が大幅に低下します．</p>
</div>
</div>
</section>
<section id="table-matrixの転置に対する頑健性" class="level3">
<h3 class="anchored" data-anchor-id="table-matrixの転置に対する頑健性">Table Matrixの転置に対する頑健性</h3>
<p>Fisher’s exact testは<strong>行と列を対称に扱う</strong>ため，テーブルを転置しても検定結果は変わりません．</p>
<p><img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202"> テーブルを以下のように表記します：</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?Y=1"></th>
<th style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?Y=2"></th>
<th style="text-align: center;">sum</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?X=1"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B11%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B12%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B1+%7D"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?X=2"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B21%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B22%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B2+%7D"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">sum</td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B+1%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n_%7B+2%7D"></td>
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?n"></td>
</tr>
</tbody>
</table>
<p>超幾何分布の確率は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(n_%7B11%7D)%20=%20%5Cfrac%7B%5Cbinom%7Bn_%7B+1%7D%7D%7Bn_%7B11%7D%7D%5Cbinom%7Bn_%7B+2%7D%7D%7Bn_%7B12%7D%7D%7D%7B%5Cbinom%7Bn%7D%7Bn_%7B1+%7D%7D%7D%20=%20%5Cfrac%7B%5Cbinom%7Bn_%7B1+%7D%7D%7Bn_%7B11%7D%7D%5Cbinom%7Bn_%7B2+%7D%7D%7Bn_%7B21%7D%7D%7D%7B%5Cbinom%7Bn%7D%7Bn_%7B+1%7D%7D%7D%20=%20%5Cfrac%7Bn_%7B1+%7D!%20%5C,%20n_%7B2+%7D!%20%5C,%20n_%7B+1%7D!%20%5C,%20n_%7B+2%7D!%7D%7Bn!%20%5C,%20n_%7B11%7D!%20%5C,%20n_%7B12%7D!%20%5C,%20n_%7B21%7D!%20%5C,%20n_%7B22%7D!%7D%0A"></p>
<p>と表され，<img src="https://latex.codecogs.com/png.latex?n_%7B11%7D"> セルの値で与えられます．この式は行と列について完全に対称であるため：</p>
<ul>
<li><strong>行を入れ替えても</strong>（<img src="https://latex.codecogs.com/png.latex?X=1%20%5Cleftrightarrow%20X=2">）</li>
<li><strong>列を入れ替えても</strong>（<img src="https://latex.codecogs.com/png.latex?Y=1%20%5Cleftrightarrow%20Y=2">）</li>
<li><strong>行と列を転置しても</strong>（<img src="https://latex.codecogs.com/png.latex?X%20%5Cleftrightarrow%20Y">）</li>
</ul>
<p>超幾何分布に基づくPMFの値は変わりません．</p>
<div id="2f7a5be1" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fisher_exact</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 元のテーブル</span></span>
<span id="cb11-4">table_original <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 転置したテーブル</span></span>
<span id="cb11-7">table_transposed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 行を入れ替えたテーブル</span></span>
<span id="cb11-10">table_row_swap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>]]</span>
<span id="cb11-11"></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 列を入れ替えたテーブル</span></span>
<span id="cb11-13">table_col_swap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]]</span>
<span id="cb11-14"></span>
<span id="cb11-15">tables <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb11-16">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original"</span>, table_original),</span>
<span id="cb11-17">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transposed"</span>, table_transposed),</span>
<span id="cb11-18">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Row swapped"</span>, table_row_swap),</span>
<span id="cb11-19">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Column swapped"</span>, table_col_swap),</span>
<span id="cb11-20">]</span>
<span id="cb11-21"></span>
<span id="cb11-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, table <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tables:</span>
<span id="cb11-23">    odds_ratio, p_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'two-sided'</span>)</span>
<span id="cb11-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:15s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: table=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, OR=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>odds_ratio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, p=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Original       : table=[[1, 28], [4, 6]], OR=0.0536, p=0.011015
Transposed     : table=[[1, 4], [28, 6]], OR=0.0536, p=0.011015
Row swapped    : table=[[4, 6], [1, 28]], OR=18.6667, p=0.011015
Column swapped : table=[[28, 1], [6, 4]], OR=18.6667, p=0.011015</code></pre>
</div>
</div>
<p>この性質により，Fisher’s exact testは<strong>説明変数と応答変数を区別しない</strong>ため，前向き研究（prospective study）でも後ろ向き研究（retrospective study）でも適用可能です．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>前向き研究と後ろ向き研究
</div>
</div>
<div class="callout-body-container callout-body">
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 44%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">研究デザイン</th>
<th style="text-align: left;">説明</th>
<th style="text-align: left;">例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>前向き研究</strong><br>(Prospective)</td>
<td style="text-align: left;">曝露（治療法など）を先に決め，その後の結果（アウトカム）を追跡観察する</td>
<td style="text-align: left;">ECMO vs CMT の患者を登録し，死亡/生存を追跡</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>後ろ向き研究</strong><br>(Retrospective)</td>
<td style="text-align: left;">結果（アウトカム）が既に判明している集団から，過去の曝露を調べる</td>
<td style="text-align: left;">死亡/生存の患者記録から，過去にどの治療を受けたか調査</td>
</tr>
</tbody>
</table>
</div>
<p>Fisher’s exact testは超幾何確率の対称性により，どちらのデザインでも同じ検定が適用できます：</p>
<ul>
<li>前向き研究：行（治療群）を固定 → 列（結果）の分布を見る</li>
<li>後ろ向き研究：列（結果）を固定 → 行（治療群）の分布を見る</li>
</ul>
<p>どちらの場合も <img src="https://latex.codecogs.com/png.latex?n_%7B11%7D"> の超幾何確率は同じ値になるため，p値も同一です．</p>
</div>
</div>
</section>
</section>
<section id="power-analuysis-for-fishers-extact-test" class="level2">
<h2 class="anchored" data-anchor-id="power-analuysis-for-fishers-extact-test">Power Analuysis for Fishers extact test</h2>
<p>Fisher’s exact testのpower analysisは Mainland and Sutcliffe (1953) に基づくと, <img src="https://latex.codecogs.com/png.latex?N%20=%202n">, <img src="https://latex.codecogs.com/png.latex?M%20=%20r">, <img src="https://latex.codecogs.com/png.latex?K%20=%20n"> と対応する形で</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta(n,%20p_1,%20p_2)%20=%20%5Csum_%7Br=0%7D%5E%7B2n%7D%20%5Csum_%7Bx%20%5Cin%20C_r%7D%20%5Cbinom%7Bn%7D%7Bx%7D%5Cbinom%7Bn%7D%7Br-x%7D%20p_1%5Ex(1-p_1)%5E%7Bn-x%7D%20p_2%5E%7Br-x%7D(1-p_2)%5E%7Bn-r+x%7D%0A"></p>
<p>で計算することが出来ます．これは2つの独立な二項分布の積，及び同時分布のうち棄却域を満たす事象の総和を取っていると解釈することが出来ます．</p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>記号</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?r"></td>
<td>両群の成功数の合計（<img src="https://latex.codecogs.com/png.latex?0%E3%80%9Cn1+n2">）</td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?x"></td>
<td>第1群の成功数</td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?C_r"></td>
<td>臨界領域（p値 &lt; αとなるxの集合）</td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?p_1,%20p_2"></td>
<td>各群の真の成功確率</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">pseudocode</span></p>
<p>上記のPower analysis計算関数を踏まえると以下のように整理できます</p>
<div class="pseudocode-container quarto-float" data-no-end="false" data-indent-size="1.2em" data-caption-prefix="Algorithm" data-pseudocode-number="1" data-comment-delimiter="$\qquad$ #" data-line-number-punc=":" data-line-number="true">
<div class="pseudocode">
\begin{algorithm} \caption{Power of Fisher's Exact Test} \begin{algorithmic} \Procedure{PowerFisherExact}{$n_1, n_2, p_1, p_2, \alpha$} \State $\beta \gets 0$ \Comment{検出力を初期化} \State $n \gets n_1 + n_2$ \Comment{総サンプルサイズ} \For{$r = 0$ \To $n$} \Comment{両群の成功数の合計} \State $x_{min} \gets \max(0, r - n_2)$ \State $x_{max} \gets \min(n_1, r)$ \For{$x = x_{min}$ \To $x_{max}$} \Comment{群1の成功数} \State $T \gets \begin{pmatrix} x &amp; n_1 - x \\ r - x &amp; n_2 - r + x \end{pmatrix}$ \Comment{2×2分割表} \State $p_{value} \gets$ \Call{FisherExactTest}{$T$} \If{$p_{value} &lt; \alpha$} \Comment{ 臨界領域の判定} \State $P_1 \gets \binom{n_1}{x} p_1^x (1-p_1)^{n_1-x}$ \Comment{群1の二項確率} \State $P_2 \gets \binom{n_2}{r-x} p_2^{r-x} (1-p_2)^{n_2-r+x}$ \Comment{群2の二項確率} \State $\beta \gets \beta + P_1 \cdot P_2$ \Comment{同時確率を加算} \EndIf \EndFor \EndFor \State \Return $\beta$ \EndProcedure \end{algorithmic} \end{algorithm}
</div>
</div>
<p>上記を見てみると，各 <img src="https://latex.codecogs.com/png.latex?r"> の計算は完全に独立のため，最後に任意の順番で各チャンクの <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7Bchunk%7D"> を足すことで最終的な検出力が計算できるので，並列化できることがわかります．</p>
<section id="実装" class="level3">
<h3 class="anchored" data-anchor-id="実装">実装</h3>
<div id="807d709a" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal, Iterable</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> multiprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Pool, cpu_count</span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _power_contribution(</span>
<span id="cb13-6">    r_values: Iterable[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>],</span>
<span id="cb13-7">    n1: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb13-8">    n2: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb13-9">    p1: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb13-10">    p2: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb13-11">    alpha: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb13-12">    alternative: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb13-13">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb13-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""r の集合に対する検出力寄与を計算"""</span></span>
<span id="cb13-15">    power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb13-16"></span>
<span id="cb13-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Binomial PMF を事前計算</span></span>
<span id="cb13-18">    binom1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.binom(n1, p1)</span>
<span id="cb13-19">    binom2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.binom(n2, p2)</span>
<span id="cb13-20"></span>
<span id="cb13-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> r_values:</span>
<span id="cb13-22">        x_min <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n2)</span>
<span id="cb13-23">        x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(n1, r)</span>
<span id="cb13-24"></span>
<span id="cb13-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(x_min, x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb13-26">            table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[x, n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x], [r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x, n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x)]]</span>
<span id="cb13-27">            _, p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.fisher_exact(table, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alternative)</span>
<span id="cb13-28"></span>
<span id="cb13-29">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> alpha:</span>
<span id="cb13-30">                power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> binom1.pmf(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> binom2.pmf(r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x)</span>
<span id="cb13-31"></span>
<span id="cb13-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> power</span>
<span id="cb13-33"></span>
<span id="cb13-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> power_fisher_exact(</span>
<span id="cb13-35">    p1: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb13-36">    p2: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb13-37">    n1: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb13-38">    n2: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>,</span>
<span id="cb13-39">    alpha: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb13-40">    alternative: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"less"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span>,</span>
<span id="cb13-41">    multi: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb13-42">    n_workers: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb13-43">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb13-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Fisher正確検定の検出力を解析的に計算する。</span></span>
<span id="cb13-46"></span>
<span id="cb13-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Mainland and Sutcliffe (1953) の検出力関数に基づき、</span></span>
<span id="cb13-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Thomas and Conlon (1991) のアルゴリズムを使用して効率的に計算します。</span></span>
<span id="cb13-49"></span>
<span id="cb13-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    検出力は以下の式で計算されます:</span></span>
<span id="cb13-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        β(n1, p1, p2) = Σ_{r=0}^{2n} Σ_{x∈C_r} C(n,x) * C(n,r-x) *</span></span>
<span id="cb13-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        p1^x * (1-p1)^{n-x} * p2^{r-x} * (1-p2)^{n-r+x}</span></span>
<span id="cb13-53"></span>
<span id="cb13-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ここで、rは両群の成功数の合計、xは第1群の成功数、</span></span>
<span id="cb13-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    C_rは超幾何分布による臨界領域です。</span></span>
<span id="cb13-56"></span>
<span id="cb13-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb13-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb13-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    p1 : float</span></span>
<span id="cb13-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        第1群の真の比率 (0 &lt; p1 &lt; 1)</span></span>
<span id="cb13-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    p2 : float</span></span>
<span id="cb13-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        第2群の真の比率 (0 &lt; p2 &lt; 1)</span></span>
<span id="cb13-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n1 : int</span></span>
<span id="cb13-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        第1群のサンプルサイズ</span></span>
<span id="cb13-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n2 : int</span></span>
<span id="cb13-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        第2群のサンプルサイズ</span></span>
<span id="cb13-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    alpha : float, optional</span></span>
<span id="cb13-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        有意水準 (デフォルト: 0.05)</span></span>
<span id="cb13-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    alternative : {"two-sided", "greater", "less"}, optional</span></span>
<span id="cb13-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        対立仮説の種類 (デフォルト: "two-sided")</span></span>
<span id="cb13-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    multi : bool, optional</span></span>
<span id="cb13-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        マルチプロセス並列化を使用するかどうか (デフォルト: False)</span></span>
<span id="cb13-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n_workers : int or None, optional</span></span>
<span id="cb13-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        ワーカー数 (デフォルト: CPU数)。multi=Trueの場合のみ有効</span></span>
<span id="cb13-75"></span>
<span id="cb13-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb13-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb13-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    float</span></span>
<span id="cb13-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        検出力 (0から1の間の値)</span></span>
<span id="cb13-80"></span>
<span id="cb13-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Examples</span></span>
<span id="cb13-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    --------</span></span>
<span id="cb13-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    &gt;&gt;&gt; power_fisher_exact(0.5, 0.9, 20, 20)</span></span>
<span id="cb13-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    0.7123  # 解析的に計算された検出力</span></span>
<span id="cb13-85"></span>
<span id="cb13-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    &gt;&gt;&gt; power_fisher_exact(0.5, 0.9, 100, 100, multi=True)</span></span>
<span id="cb13-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    0.9999  # マルチプロセスで高速化</span></span>
<span id="cb13-88"></span>
<span id="cb13-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Notes</span></span>
<span id="cb13-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -----</span></span>
<span id="cb13-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - シミュレーションと異なり、正確な値を返します</span></span>
<span id="cb13-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - 計算量は O(n1 * n2) であり、大きなサンプルサイズでも高速です</span></span>
<span id="cb13-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - multi=Trueにすると複数CPUコアを使用して高速化できます</span></span>
<span id="cb13-94"></span>
<span id="cb13-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    References</span></span>
<span id="cb13-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb13-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Mainland, D. and Sutcliffe, M.I. (1953). Statistical methods in</span></span>
<span id="cb13-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      medical research. Canadian Journal of Medical Sciences, 31, 406-416.</span></span>
<span id="cb13-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Thomas, R.G. and Conlon, M. (1991). Algorithm AS 259: Statistical</span></span>
<span id="cb13-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      Algorithms. Applied Statistics, 40(1), 258-261.</span></span>
<span id="cb13-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb13-102">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 入力値の検証</span></span>
<span id="cb13-103">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb13-104">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"p1は0より大きく1より小さい値である必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-105">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb13-106">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"p2は0より大きく1より小さい値である必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-107">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb13-108">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n1は正の整数である必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-109">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb13-110">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n2は正の整数である必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-111">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb13-112">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"alphaは0より大きく1より小さい値である必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>alpha<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> alternative <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"less"</span>]:</span>
<span id="cb13-114">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(</span>
<span id="cb13-115">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"alternativeは 'two-sided', 'greater', 'less' のいずれかである必要があります: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>alternative<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb13-116">        )</span>
<span id="cb13-117"></span>
<span id="cb13-118">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n2  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 総サンプルサイズ</span></span>
<span id="cb13-119">    M_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb13-120"></span>
<span id="cb13-121">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- single process ---</span></span>
<span id="cb13-122">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> multi:</span>
<span id="cb13-123">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _power_contribution(</span>
<span id="cb13-124">            M_values, n1, n2, p1, p2, alpha, alternative</span>
<span id="cb13-125">        )</span>
<span id="cb13-126"></span>
<span id="cb13-127">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- multi process ---</span></span>
<span id="cb13-128">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> n_workers <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb13-129">        n_workers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cpu_count()</span>
<span id="cb13-130"></span>
<span id="cb13-131">    chunks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [M_values[i::n_workers] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_workers)]</span>
<span id="cb13-132">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb13-133">        (chunk, n1, n2, p1, p2, alpha, alternative)</span>
<span id="cb13-134">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> chunks</span>
<span id="cb13-135">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> chunk</span>
<span id="cb13-136">    ]</span>
<span id="cb13-137"></span>
<span id="cb13-138">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> Pool(n_workers) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pool:</span>
<span id="cb13-139">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.starmap(_power_contribution, args)</span>
<span id="cb13-140"></span>
<span id="cb13-141">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(results)</span></code></pre></div></div>
</details>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (Power Analysis 動作の確認)</strong></span> <br></p>
<p>冒頭のECMO vs CMTの例を用いて，<code>power_fisher_exact</code> 関数の動作を確認します．</p>
<p>観測データは以下の通りです：</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Treatment</th>
<th>Die</th>
<th>Live</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ECMO</td>
<td>1</td>
<td>28</td>
<td>29</td>
</tr>
<tr class="even">
<td style="text-align: center;">CMT</td>
<td>4</td>
<td>6</td>
<td>10</td>
</tr>
<tr class="odd">
<td style="text-align: center;">total</td>
<td>5</td>
<td>34</td>
<td>39</td>
</tr>
</tbody>
</table>
<p>観測された死亡率は ECMO群で <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bp%7D_1%20=%201/29%20%5Capprox%200.034">，CMT群で <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bp%7D_2%20=%204/10%20=%200.4">．</p>
<p>この効果量（<img src="https://latex.codecogs.com/png.latex?p_1%20=%200.034,%20p_2%20=%200.4">）を真の値と仮定した場合，サンプルサイズ <img src="https://latex.codecogs.com/png.latex?(n_1,%20n_2)%20=%20(29,%2010)"> でどの程度の検出力が得られるかを計算します．</p>
<div id="fc9e67db" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 観測された効果量</span></span>
<span id="cb14-2">p1_observed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ECMO群の死亡率</span></span>
<span id="cb14-3">p2_observed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CMT群の死亡率</span></span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 実際のサンプルサイズ</span></span>
<span id="cb14-6">n1, n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 検出力を計算（片側検定：ECMOの方が死亡率が低い）</span></span>
<span id="cb14-9">power_less <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> power_fisher_exact(</span>
<span id="cb14-10">    p1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p1_observed,</span>
<span id="cb14-11">    p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p2_observed,</span>
<span id="cb14-12">    n1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n1,</span>
<span id="cb14-13">    n2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n2,</span>
<span id="cb14-14">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb14-15">    alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"less"</span></span>
<span id="cb14-16">)</span>
<span id="cb14-17"></span>
<span id="cb14-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 両側検定の検出力</span></span>
<span id="cb14-19">power_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> power_fisher_exact(</span>
<span id="cb14-20">    p1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p1_observed,</span>
<span id="cb14-21">    p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p2_observed,</span>
<span id="cb14-22">    n1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n1,</span>
<span id="cb14-23">    n2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n2,</span>
<span id="cb14-24">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb14-25">    alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span></span>
<span id="cb14-26">)</span>
<span id="cb14-27"></span>
<span id="cb14-28"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"観測された効果量: p1=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p1_observed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, p2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p2_observed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"サンプルサイズ: n1=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, n2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-30"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">検出力 (α=0.05):"</span>)</span>
<span id="cb14-31"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  片側検定 (less): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>power_less<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-32"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  両側検定: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>power_two_sided<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>観測された効果量: p1=0.0345, p2=0.4000
サンプルサイズ: n1=29, n2=10

検出力 (α=0.05):
  片側検定 (less): 0.7560
  両側検定: 0.7560</code></pre>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="appendix-超幾何分布" class="level2">
<h2 class="anchored" data-anchor-id="appendix-超幾何分布">Appendix: 超幾何分布</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Hypergeometric Distribution</span></p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?M">: ツボの中の赤いボールの個数</li>
<li><img src="https://latex.codecogs.com/png.latex?B(=%20N%20-%20M)">: ツボの中の青いボールの個数</li>
<li><img src="https://latex.codecogs.com/png.latex?N">: ツボの中のボールの個数</li>
</ul>
<p>上記のセットアップにおいて，ツボから <img src="https://latex.codecogs.com/png.latex?K%20(%5Cleq%20N)"> 個のボールを無作為に<span class="regmonkey-bold">非復元抽出(sampling without replacement)</span>したところ， 抽出できた赤いボールの個数を表す確率変数を <img src="https://latex.codecogs.com/png.latex?X"> とする．このとき，PMFは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdisplaylines%20P(X=%20x%20%7C%20N,%20M,%20K)%20=%20%5Cfrac%7B%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DM%5C%5C%20x%5Cend%7Barray%7D%5Cright)%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%20-%20M%5C%5C%20K-x%5Cend%7Barray%7D%5Cright)%7D%7B%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%5C%5C%20K%5Cend%7Barray%7D%5Cright)%7D%0A"></p>
<p>で与えられる。ただし，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmax(0,%20K%20-%20(N%20-%20M))%20%5Cle%20x%20%5Cle%20%5Cmin(M,%20K)%0A"></p>
<p>であり，それ以外の場合は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(X%20=%20x%20%5Cmid%20N,%20M,%20K)%20=%200%0A"></p>
<p>と定義する．</p>
</div>
<p><span class="mini-section">確率の公理</span></p>
<p>上記のPMFが確率の公理 <img src="https://latex.codecogs.com/png.latex?%5Csum%20P(X=%20x%20%7C%20N,%20M,%20K)%20=%201"> を満たすことを確認します．定義より示すべきは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%5C%5C%20K%5Cend%7Barray%7D%5Cright)%20=%20%5Csum%20%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DM%5C%5C%20x%5Cend%7Barray%7D%5Cright)%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%20-%20M%5C%5C%20K-x%5Cend%7Barray%7D%5Cright)%0A"></p>
<p>です．ヴァンデルモンドの畳み込みで明らかですが，ここでは組み合わせ的に考えてみます． 上記の式のLHSは赤と青を合わせた <img src="https://latex.codecogs.com/png.latex?N"> 個のボールから <img src="https://latex.codecogs.com/png.latex?K"> 個のボールを選ぶ組み合わせとなります． これは赤のボールの組み合わせをまず選び，その後青のボールの組み合わせを計算するという場合の数に相当します．つまり，</p>
<ol type="1">
<li>まず赤いボール <img src="https://latex.codecogs.com/png.latex?M"> 個の中から <img src="https://latex.codecogs.com/png.latex?x"> 個を選ぶ</li>
<li>次に残りの <img src="https://latex.codecogs.com/png.latex?K%20-%20x"> 個を，青いボール <img src="https://latex.codecogs.com/png.latex?N%E2%88%92R"> 個の中から選ぶ</li>
<li>赤いボールを <img src="https://latex.codecogs.com/png.latex?x"> 個選ぶすべての場合について和を取る</li>
</ol>
<p>つまり，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csum%20%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DM%5C%5C%20x%5Cend%7Barray%7D%5Cright)%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%20-%20M%5C%5C%20K-x%5Cend%7Barray%7D%5Cright)%0A"></p>
<p>これはRHSに相当するので, <img src="https://latex.codecogs.com/png.latex?%5Csum%20P(X=%20x%20%7C%20N,%20M,%20K)%20=%201"> を満たすことがわかる．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (赤ボールを <img src="https://latex.codecogs.com/png.latex?x"> drawする確率)</strong></span> <br></p>
<p>赤玉を <img src="https://latex.codecogs.com/png.latex?X"> 引く状況を <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202"> tableで整理したものが以下となります</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th>Red</th>
<th>Blue</th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Drawn</td>
<td><img src="https://latex.codecogs.com/png.latex?X"></td>
<td><img src="https://latex.codecogs.com/png.latex?K%20-%20X"></td>
<td><img src="https://latex.codecogs.com/png.latex?K"></td>
</tr>
<tr class="even">
<td>Not Drawn</td>
<td><img src="https://latex.codecogs.com/png.latex?M-X"></td>
<td><img src="https://latex.codecogs.com/png.latex?B-(K-X)"></td>
<td><img src="https://latex.codecogs.com/png.latex?M+B-K"></td>
</tr>
<tr class="odd">
<td>total</td>
<td><img src="https://latex.codecogs.com/png.latex?M"></td>
<td><img src="https://latex.codecogs.com/png.latex?B"></td>
<td><img src="https://latex.codecogs.com/png.latex?N%20=%20R+B"></td>
</tr>
</tbody>
</table>
<p>このとき，<img src="https://latex.codecogs.com/png.latex?X%20=%20x"> となる確率は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdisplaylines%20P(X=%20x%20%7C%20N,%20M,%20K)%20=%20%5Cfrac%7B%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DM%5C%5C%20x%5Cend%7Barray%7D%5Cright)%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%20-%20M%5C%5C%20K-x%5Cend%7Barray%7D%5Cright)%7D%7B%5Cleft(%5Cbegin%7Barray%7D%7Bc%7DN%5C%5C%20K%5Cend%7Barray%7D%5Cright)%7D%0A"></p>
<div id="53b88c9f" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb16-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> plotly.subplots <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_subplots</span>
<span id="cb16-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plotly.graph_objects <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> go</span>
<span id="cb16-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> hypergeom</span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ設定</span></span>
<span id="cb16-7">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全ボール数</span></span>
<span id="cb16-8">R <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 赤ボール数</span></span>
<span id="cb16-9">K_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 抽出数</span></span>
<span id="cb16-10"></span>
<span id="cb16-11">fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_subplots(rows<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, cols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, subplot_titles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'K=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> K_values], vertical_spacing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>)</span>
<span id="cb16-12"></span>
<span id="cb16-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(K_values):</span>
<span id="cb16-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x の範囲</span></span>
<span id="cb16-15">    x_min <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> R))</span>
<span id="cb16-16">    x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(R, K)</span>
<span id="cb16-17">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(x_min, x_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-18"></span>
<span id="cb16-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PMF の計算</span></span>
<span id="cb16-20">    pmf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypergeom.pmf(x, N, R, K)</span>
<span id="cb16-21"></span>
<span id="cb16-22">    fig.add_trace(</span>
<span id="cb16-23">        go.Bar(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pmf, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'K=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>),</span>
<span id="cb16-24">        row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb16-25">    )</span>
<span id="cb16-26"></span>
<span id="cb16-27">fig.update_layout(</span>
<span id="cb16-28">    title_text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Hypergeometric Distribution PMF (N=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, R=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>R<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>,</span>
<span id="cb16-29">    title_font_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,</span>
<span id="cb16-30">    title_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.98</span>,</span>
<span id="cb16-31">    margin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>),</span>
<span id="cb16-32">    showlegend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb16-33">    font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb16-34">)</span>
<span id="cb16-35"></span>
<span id="cb16-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># サブプロットタイトルのフォントサイズを大きく</span></span>
<span id="cb16-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> annotation <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fig[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layout'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'annotations'</span>]:</span>
<span id="cb16-38">    annotation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb16-39">fig.update_xaxes(title_text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x (Drawn red ball)'</span>, title_font_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb16-40">fig.update_yaxes(title_text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P(X = x)'</span>, col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, title_font_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb16-41"></span>
<span id="cb16-42">fig.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.1.1.min.js" integrity="sha256-HUEFyfiTnZJxCxur99FjbKYTvKSzwDaD3/x5TqHpFu4=" crossorigin="anonymous"></script>                <div id="2b97f44c-04e2-4631-9922-08d0cb6b8905" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("2b97f44c-04e2-4631-9922-08d0cb6b8905")) {                    Plotly.newPlot(                        "2b97f44c-04e2-4631-9922-08d0cb6b8905",                        [{"name":"K=15","opacity":0.7,"x":{"dtype":"i1","bdata":"AAECAwQFBgcICQoLDA0ODw=="},"y":{"dtype":"f8","bdata":"ECxU5doQEj+jo76EwCtVPwdgK9wytIQ\u002fCKjZw+Ftpj+rEL+8NRq+Px1MBPh2fco\u002fa04RGyyJzz9vV8ihUs3JPyXSqvniKr0\u002fVdyEF5Svpj9t3nmJzfSHP9wYI2CswGA\u002f+J3M407ILT+hTODnOWvvPs0Pn1ykVaE+Tw0MZJOVPT4="},"type":"bar","xaxis":"x","yaxis":"y"},{"name":"K=31","opacity":0.7,"x":{"dtype":"i1","bdata":"AQIDBAUGBwgJCgsMDQ4PEBESExQ="},"y":{"dtype":"f8","bdata":"04RmdKEkZz3gIZa+x8PpPQULisMRg1E+qR1jWiO1pT6lATntIk7tPlVRvmB8zyc\u002fZT\u002fG5HbNWD+4EArN8kWBPwVQ1FmzjaA\u002fKqorX1pBtj9tInvmYT7FPwmMM93598w\u002fzkYEo9I5zD8tpxYiforDP0jO4niQ+7I\u002fChPZS2tPmT+h4xlwIlV2PzM76k2jhUg\u002fhkBvDPXTDT\u002fRO57xVSS+Pg=="},"type":"bar","xaxis":"x2","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"xaxis":{"anchor":"y","domain":[0.0,0.45],"title":{"font":{"size":14},"text":"x (Drawn red ball)"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"font":{"size":14},"text":"P(X = x)"}},"xaxis2":{"anchor":"y2","domain":[0.55,1.0],"title":{"font":{"size":14},"text":"x (Drawn red ball)"}},"yaxis2":{"anchor":"x2","domain":[0.0,1.0]},"annotations":[{"font":{"size":16},"showarrow":false,"text":"K=15","x":0.225,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"K=31","x":0.775,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"}],"title":{"font":{"size":18},"text":"Hypergeometric Distribution PMF (N=50, R=20)","y":0.98},"margin":{"t":60},"font":{"size":14},"showlegend":false},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('2b97f44c-04e2-4631-9922-08d0cb6b8905');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };            </script>        </div>
</div>
</div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.scipy.org/doc/scipy/tutorial/stats/hypothesis_fisher_exact.html#hypothesis-fisher-exact">scipy &gt; Fisher’s exact test</a></li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Example 10.4.1 on p.412 in <em>Statistics for the Life Sciences</em> (5ed) by Samuels, Witmer, and Schaffner. Original study by O’Rourke et al.&nbsp;<em>Pediatrics</em>. 1989 Dec;84(6):957-63. PMID: 2685740. See also Ware, J. H. (1989). “Investigating Therapies of Potentially Great Benefit: ECMO”. <em>Statistical Science</em>, 4(4), 298–306. http://www.jstor.org/stable/2245829↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-19-fishers-exact-test/</guid>
  <pubDate>Fri, 19 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>中年男性の中性脂肪分布はLognormalで近似できるか？</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/</link>
  <description><![CDATA[ 






<section id="リサーチクエッション" class="level2">
<h2 class="anchored" data-anchor-id="リサーチクエッション">1. リサーチクエッション</h2>
<ul>
<li><strong>アメリカの中年男性（40-59歳）の血中中性脂肪（トリグリセリド）濃度は，Lognormal分布でどの程度近似できるか？</strong></li>
</ul>
<section id="背景" class="level3">
<h3 class="anchored" data-anchor-id="背景">背景</h3>
<p>血中脂質値は多くの場合，正規分布ではなく右に歪んだ分布を示します， 特に中性脂肪は，生活習慣や遺伝的要因により極端な高値を示す個人が存在するため，Lognormal分布での近似がしばしば用いられます． このノートでは，米国の代表的な健康調査データを用いて，この仮説を検証したいとおもいます．</p>
</section>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">2. Data</h2>
<p><span class="mini-section">データソース</span></p>
<ul>
<li><a href="https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Laboratory&amp;Cycle=2021-2023&amp;utm_source=chatgpt.com">NHANES (National Health and Nutrition Examination Survey) August 2021 - August 2023</a></li>
<li>アメリカCDCが実施する全国規模の健康・栄養調査データ．</li>
</ul>
<p><span class="mini-section">使用ファイル</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>ファイル</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>DEMO_L.xpt</code></td>
<td>人口統計学的データ（年齢，性別等）</td>
</tr>
<tr class="even">
<td><code>TRIGLY_L.xpt</code></td>
<td>中性脂肪・LDLコレステロールデータ</td>
</tr>
</tbody>
</table>
<p><span class="mini-section">対象者の選択基準</span></p>
<ol type="1">
<li><strong>性別</strong>: 男性 (<code>RIAGENDR = 1</code>)</li>
<li><strong>年齢</strong>: 40-59歳 (<code>RIDAGEYR</code>)</li>
<li><strong>中性脂肪データ</strong>: 欠損なし (<code>LBXTLG</code> is not null)</li>
<li><strong>サンプルウェイト</strong>: 有効 (<code>WTSAF2YR</code> &gt; 0)</li>
</ol>
<p><span class="mini-section">測定方法</span></p>
<ul>
<li>中性脂肪（Triglycerides）は，12歳以上の参加者のうち，8-24時間絶食という空腹条件を満たした部分標本（fasting subsample） に対してのみ測定</li>
</ul>
<p><span class="mini-section">サンプルウェイト</span></p>
<ul>
<li><strong>WTSAF2YR</strong>（空腹時サブサンプル2年MEC重み）を使用</li>
<li>see <a href="https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx">here</a></li>
</ul>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">WTSAF2YR</span></p>
<ul>
<li>「当該参加者が米国の民間非施設居住人口の何人規模のグループをを代表しているか」を表す設計ウェイト</li>
<li>ある参加者の<code>WTSAF2YR = 50,000</code> の場合，その参加者は母集団内の約50,000人グループを代表することを意味する</li>
</ul>
</div>
<p>ウェイトの基本的な考えは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bsample%20person's%20weight%7D%20=%20%5Cfrac%7B1%7D%7B%5Ctext%7Bprobability%20of%20selection%7D%7D%0A"></p>
<p>詳しい説明は省略しますが，</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/sampling.png" class="img-fluid figure-img"></p>
<figcaption>Four Stages of NHANES Sampling Procedure</figcaption>
</figure>
</div>
<ol type="1">
<li>米国全体を分割した一次抽出（PSU：郡または郡群）</li>
<li>選ばれた PSU 内で小地域（街区・セグメント）が選ばれる</li>
<li>選ばれたセグメント内で，世帯（household） が抽出される</li>
<li>世帯内の構成員のうち，調査対象者として個人が選ばれる</li>
</ol>
<p>という流れでNHANESでは層化抽出が行われ <code>probability of selection</code> が定まります．解釈としては</p>
<blockquote class="blockquote">
<p>“A sample weight is assigned to each sample person. <strong>It is a measure of the number of people in the population represented by that sample person in NHANES</strong>, reflecting the unequal probability of selection, an adjustment for sample person non-response, and adjustment to account for differences between the final sample and the total population based on independent population control totals.”</p>
</blockquote>
<p>したがって，母集団平均の推定には</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bweighted%20mean%7D%20=%20%5Cfrac%7B%5Csum%20%5Ctext%7BWTSAF2YR%7D%20%5Ctimes%20%5Ctext%7Bvalue%7D%7D%7B%5Csum%20%5Ctext%7BWTSAF2YR%7D%7D%0A"></p>
<p>となります．</p>
</section>
<section id="分析方針" class="level2">
<h2 class="anchored" data-anchor-id="分析方針">3. 分析方針</h2>
<p><span class="mini-section">Lognormal分布の仮定</span></p>
<p>血中中性脂肪濃度は以下の特徴を持つため，Lognormal分布での近似をおこないます：</p>
<ol type="1">
<li><strong>正の値のみ</strong>: 濃度は必ず正の値をとる</li>
<li><strong>右に歪んだ分布</strong>: 極端な高値を示す個人が存在</li>
<li><strong>乗法的な影響</strong>: 遺伝・食事・運動などの要因が乗法的に作用すると仮定</li>
</ol>
<p><span class="mini-section">適合度の評価方法</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>評価方法</th>
<th>目的</th>
<th>判断</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>重み付きヒストグラム vs PDF</td>
<td>視覚的な分布形状の比較</td>
<td>主観的判断</td>
</tr>
<tr class="even">
<td>Q-Qプロット</td>
<td>分位点の一致度を評価</td>
<td>主観的判断</td>
</tr>
<tr class="odd">
<td>Kolmogorov-Smirnov検定</td>
<td>統計的な適合度検定</td>
<td>統計的判定</td>
</tr>
</tbody>
</table>
</section>
<section id="推定関数" class="level2">
<h2 class="anchored" data-anchor-id="推定関数">4. 推定関数</h2>
<section id="重み付きqq-plot" class="level3">
<h3 class="anchored" data-anchor-id="重み付きqq-plot">重み付きQQ plot</h3>
<div id="98f4e493" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_quantiles(</span>
<span id="cb1-4">    values: np.ndarray, weights: np.ndarray, quantiles: np.ndarray</span>
<span id="cb1-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Compute weighted quantiles.</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : array-like</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Array of observed values.</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : array-like</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Sample weights corresponding to each observation.</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    quantiles : array-like</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Quantiles to compute (values between 0 and 1).</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ndarray</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Values corresponding to the specified quantiles.</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-23">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb1-24">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb1-25">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb1-26"></span>
<span id="cb1-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cumulative sum of weights, normalized to [0, 1]</span></span>
<span id="cb1-28">    cumsum_normalized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights)</span>
<span id="cb1-29"></span>
<span id="cb1-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.interp(quantiles, cumsum_normalized, sorted_values)</span></code></pre></div></div>
</details>
</div>
<section id="重み付きks検定の実装" class="level4">
<h4 class="anchored" data-anchor-id="重み付きks検定の実装">重み付きKS検定の実装</h4>
<ul>
<li>scipy の <code>ks_2samp</code> をベースに、両側からのCDF差を計算する方法を採用</li>
<li>effective sample sizeは <img src="https://latex.codecogs.com/png.latex?(%5Csum%20w_i)%5E2%20/%20%5Csum%20w_i%5E2"> で計算 (see Monahan, J. (2011). <em>Numerical Methods of Statistics</em>.)</li>
</ul>
<div id="789f86ab" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Callable</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_ks_1samp(</span>
<span id="cb2-5">    values: np.ndarray, weights: np.ndarray, cdf_func: Callable[[np.ndarray], np.ndarray]</span>
<span id="cb2-6">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb2-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform a one-sample weighted Kolmogorov–Smirnov test.</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    The p-value is computed using an effective sample size</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    (Kish's effective sample size), following the approach</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    proposed by Monahan.</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : np.ndarray</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Array of observed values.</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : np.ndarray</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Sample weights corresponding to each observation.</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    cdf_func : Callable[[np.ndarray], np.ndarray]</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        CDF function of the theoretical distribution. It takes</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        an array of values and returns cumulative probabilities.</span></span>
<span id="cb2-23"></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tuple[float, float]</span></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        (ks_stat, p_value) – the KS statistic and the asymptotic p-value.</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    References</span></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb2-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Monahan, J. (2011). *Numerical Methods of Statistics*.</span></span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-33">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb2-34">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb2-35">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb2-36"></span>
<span id="cb2-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weighted ECDF: F_n(x) = Σ w_i * I(X_i ≤ x) / Σ w_i</span></span>
<span id="cb2-38">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb2-39">    total_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-40">    ecdf_after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_weight          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># F_n(x) = P(X ≤ x)</span></span>
<span id="cb2-41">    ecdf_before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.concatenate([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], ecdf_after[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># F_n(x−)</span></span>
<span id="cb2-42"></span>
<span id="cb2-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Theoretical CDF</span></span>
<span id="cb2-44">    theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cdf_func(sorted_values)</span>
<span id="cb2-45"></span>
<span id="cb2-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># KS statistic: maximum deviation from both sides</span></span>
<span id="cb2-47">    d_plus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(ecdf_after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> theoretical_cdf)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sup(F_n − F)</span></span>
<span id="cb2-48">    d_minus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ecdf_before)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sup(F − F_n)</span></span>
<span id="cb2-49">    ks_stat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(d_plus, d_minus)</span>
<span id="cb2-50"></span>
<span id="cb2-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Effective sample size (Kish's effective sample size)</span></span>
<span id="cb2-52">    n_eff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_weight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-53"></span>
<span id="cb2-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Asymptotic p-value (Kolmogorov distribution)</span></span>
<span id="cb2-55">    p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kstwobign.sf(np.sqrt(n_eff) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ks_stat)</span>
<span id="cb2-56"></span>
<span id="cb2-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(ks_stat), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(np.clip(p_value, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div></div>
</details>
</div>
</section>
</section>
</section>
<section id="分析コード" class="level2">
<h2 class="anchored" data-anchor-id="分析コード">5. 分析コード</h2>
<div id="3c0a8d97" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">NHANES August 2021-August 2023 中年男性の中性脂肪分析</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">ヒストグラムとlognormal分布の比較</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">（サンプルウェイト WTSAF2YR を考慮）</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyreadstat</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-10"></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> load_data():</span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""DEMO_L と TRIGLY_L データを読み込み結合"""</span></span>
<span id="cb3-14">    demo_pd, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyreadstat.read_xport(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DEMO_L.xpt"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latin1"</span>)</span>
<span id="cb3-15">    trigly_pd, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyreadstat.read_xport(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRIGLY_L.xpt"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latin1"</span>)</span>
<span id="cb3-16"></span>
<span id="cb3-17">    demo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.from_pandas(demo_pd)</span>
<span id="cb3-18">    trigly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.from_pandas(trigly_pd)</span>
<span id="cb3-19"></span>
<span id="cb3-20">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> demo.join(trigly, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SEQN"</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inner"</span>)</span>
<span id="cb3-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb3-22"></span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> filter_middle_aged_men(df: pl.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pl.DataFrame:</span>
<span id="cb3-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    中年男性（40-59歳）をフィルタリング</span></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - RIAGENDR: 1 = Male</span></span>
<span id="cb3-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - RIDAGEYR: 年齢</span></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - LBXTLG: 中性脂肪 (mg/dL)</span></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - WTSAF2YR &gt; 0: 有効なサンプルウェイトを持つ参加者のみ</span></span>
<span id="cb3-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-32">    filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb3-33">        (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIAGENDR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIDAGEYR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb3-35">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIDAGEYR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">59</span>)</span>
<span id="cb3-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).is_not_null())</span>
<span id="cb3-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-38">    )</span>
<span id="cb3-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> filtered</span>
<span id="cb3-40"></span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_mean(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き平均"""</span></span>
<span id="cb3-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)</span>
<span id="cb3-45"></span>
<span id="cb3-46"></span>
<span id="cb3-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_std(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き標準偏差"""</span></span>
<span id="cb3-49">    mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_mean(values, weights)</span>
<span id="cb3-50">    variance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)</span>
<span id="cb3-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.sqrt(variance)</span>
<span id="cb3-52"></span>
<span id="cb3-53"></span>
<span id="cb3-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_median(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き中央値"""</span></span>
<span id="cb3-56">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb3-57">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb3-58">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb3-59">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb3-60">    cutoff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span></span>
<span id="cb3-61">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sorted_values[np.searchsorted(cumsum, cutoff)]</span>
<span id="cb3-62"></span>
<span id="cb3-63"></span>
<span id="cb3-64"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_histogram(values: np.ndarray, weights: np.ndarray, bins: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>):</span>
<span id="cb3-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付きヒストグラムのデータを計算"""</span></span>
<span id="cb3-66">    hist, bin_edges <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.histogram(values, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins, weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>weights, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> hist, bin_edges</span>
<span id="cb3-68"></span>
<span id="cb3-69"></span>
<span id="cb3-70"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_ecdf(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>:</span>
<span id="cb3-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き経験累積分布関数を計算"""</span></span>
<span id="cb3-72">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb3-73">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb3-74">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb3-75"></span>
<span id="cb3-76">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb3-77">    ecdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> cumsum[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-78"></span>
<span id="cb3-79">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sorted_values, ecdf</span>
<span id="cb3-80"></span>
<span id="cb3-81"></span>
<span id="cb3-82"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> filter_by_percentile(</span>
<span id="cb3-83">    values: np.ndarray,</span>
<span id="cb3-84">    weights: np.ndarray,</span>
<span id="cb3-85">    lower_pct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb3-86">    upper_pct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,</span>
<span id="cb3-87">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[np.ndarray, np.ndarray]:</span>
<span id="cb3-88">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    重み付きパーセンタイルでデータをフィルタリング</span></span>
<span id="cb3-90"></span>
<span id="cb3-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb3-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb3-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : np.ndarray</span></span>
<span id="cb3-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        観測値</span></span>
<span id="cb3-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : np.ndarray</span></span>
<span id="cb3-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        サンプルウェイト</span></span>
<span id="cb3-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    lower_pct : float</span></span>
<span id="cb3-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        下限パーセンタイル（0-1）</span></span>
<span id="cb3-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    upper_pct : float</span></span>
<span id="cb3-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        上限パーセンタイル（0-1）</span></span>
<span id="cb3-101"></span>
<span id="cb3-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb3-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb3-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    filtered_values : np.ndarray</span></span>
<span id="cb3-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        フィルタリング後の観測値</span></span>
<span id="cb3-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    filtered_weights : np.ndarray</span></span>
<span id="cb3-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        フィルタリング後のウェイト</span></span>
<span id="cb3-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-109">    quantile_bounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_quantiles(values, weights, np.array([lower_pct, upper_pct]))</span>
<span id="cb3-110">    lower_bound, upper_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quantile_bounds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], quantile_bounds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-111"></span>
<span id="cb3-112">    mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> lower_bound) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> upper_bound)</span>
<span id="cb3-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> values[mask], weights[mask], lower_bound, upper_bound</span>
<span id="cb3-114"></span>
<span id="cb3-115"></span>
<span id="cb3-116"></span>
<span id="cb3-117"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> analyze_and_plot(</span>
<span id="cb3-118">    triglyceride_values: np.ndarray,</span>
<span id="cb3-119">    weights: np.ndarray,</span>
<span id="cb3-120">    save_suffix: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb3-121">):</span>
<span id="cb3-122">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""ヒストグラムとlognormal分布の比較プロット（重み付き）"""</span></span>
<span id="cb3-123"></span>
<span id="cb3-124">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 重み付きパラメータ推定 ---</span></span>
<span id="cb3-125">    log_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log(triglyceride_values)</span>
<span id="cb3-126">    mu_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_mean(log_values, weights)</span>
<span id="cb3-127">    sigma_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_std(log_values, weights)</span>
<span id="cb3-128"></span>
<span id="cb3-129">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット作成</span></span>
<span id="cb3-130">    fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb3-131"></span>
<span id="cb3-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 左: ヒストグラムとlognormal PDF ---</span></span>
<span id="cb3-133">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-134"></span>
<span id="cb3-135">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付きヒストグラム</span></span>
<span id="cb3-136">    hist, bin_edges <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_histogram(triglyceride_values, weights, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb3-137">    bin_centers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bin_edges[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-138">    bin_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-139">    ax1.bar(</span>
<span id="cb3-140">        bin_centers,</span>
<span id="cb3-141">        hist,</span>
<span id="cb3-142">        width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bin_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb3-143">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb3-144">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,</span>
<span id="cb3-145">        edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb3-146">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted histogram"</span>,</span>
<span id="cb3-147">    )</span>
<span id="cb3-148"></span>
<span id="cb3-149">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lognormal PDF（重み付きパラメータ）</span></span>
<span id="cb3-150">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(triglyceride_values.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), triglyceride_values.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb3-151">    pdf_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.lognorm.pdf(x, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted))</span>
<span id="cb3-152">    ax1.plot(</span>
<span id="cb3-153">        x,</span>
<span id="cb3-154">        pdf_weighted,</span>
<span id="cb3-155">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r-"</span>,</span>
<span id="cb3-156">        linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb3-157">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Lognormal (weighted)</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">(μ=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, σ=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sigma_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>,</span>
<span id="cb3-158">    )</span>
<span id="cb3-159"></span>
<span id="cb3-160">    ax1.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Triglyceride (mg/dL)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-161">    ax1.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-162">    ax1.set_title(</span>
<span id="cb3-163">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Middle-aged Men (40-59 years) Triglyceride Distribution</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-164">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NHANES August 2021-August 2023 (Weighted by WTSAF2YR)"</span>,</span>
<span id="cb3-165">        fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb3-166">    )</span>
<span id="cb3-167">    ax1.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb3-168">    ax1.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-169"></span>
<span id="cb3-170">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 右: 重み付きQ-Qプロット ---</span></span>
<span id="cb3-171">    ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-172"></span>
<span id="cb3-173">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付き分位点を計算</span></span>
<span id="cb3-174">    n_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット用の分位点数</span></span>
<span id="cb3-175">    prob_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span>, n_quantiles)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.1%〜99.9%で裾もカバー</span></span>
<span id="cb3-176"></span>
<span id="cb3-177">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付き観測分位点</span></span>
<span id="cb3-178">    observed_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_quantiles(triglyceride_values, weights, prob_points)</span>
<span id="cb3-179"></span>
<span id="cb3-180">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論分位点（Lognormal）</span></span>
<span id="cb3-181">    theoretical_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.lognorm.ppf(</span>
<span id="cb3-182">        prob_points, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted)</span>
<span id="cb3-183">    )</span>
<span id="cb3-184"></span>
<span id="cb3-185">    ax2.scatter(</span>
<span id="cb3-186">        theoretical_quantiles, observed_quantiles, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span></span>
<span id="cb3-187">    )</span>
<span id="cb3-188">    min_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(theoretical_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), observed_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>())</span>
<span id="cb3-189">    max_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(theoretical_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), observed_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>())</span>
<span id="cb3-190">    ax2.plot(</span>
<span id="cb3-191">        [min_val, max_val], [min_val, max_val], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r--"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Perfect fit"</span></span>
<span id="cb3-192">    )</span>
<span id="cb3-193"></span>
<span id="cb3-194">    ax2.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theoretical Quantiles (Lognormal)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-195">    ax2.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted Observed Quantiles"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-196">    ax2.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted Q-Q Plot: Lognormal Distribution Fit"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-197">    ax2.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb3-198">    ax2.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-199"></span>
<span id="cb3-200">    plt.tight_layout()</span>
<span id="cb3-201">    plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"triglyceride_analysis</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>save_suffix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tight"</span>)</span>
<span id="cb3-202">    plt.show()</span>
<span id="cb3-203"></span>
<span id="cb3-204">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 統計情報を出力</span></span>
<span id="cb3-205">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-206">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Statistics: Middle-aged Men (40-59 years) Triglyceride"</span>)</span>
<span id="cb3-207">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NHANES August 2021-August 2023 (with sample weights)"</span>)</span>
<span id="cb3-208">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-209">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sample size (n): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-210">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sum of weights: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-211"></span>
<span id="cb3-212">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Descriptive Statistics - WEIGHTED (population estimates)]"</span>)</span>
<span id="cb3-213">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_mean(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-214">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_median(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-215">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Std Dev: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_std(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-216"></span>
<span id="cb3-217">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Descriptive Statistics - UNWEIGHTED (sample only)]"</span>)</span>
<span id="cb3-218">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-219">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>median(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-220">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Std Dev: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>std(triglyceride_values, ddof<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-221">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Min: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-222">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Max: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-223"></span>
<span id="cb3-224">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Lognormal Parameters - WEIGHTED]"</span>)</span>
<span id="cb3-225">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  μ (log-scale mean): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-226">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  σ (log-scale std): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sigma_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-227">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median from fit (exp(μ)): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>exp(mu_weighted)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-228"></span>
<span id="cb3-229"></span>
<span id="cb3-230">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 適合度検定 (Kolmogorov-Smirnov)</span></span>
<span id="cb3-231">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cdf_func(x):</span>
<span id="cb3-232">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> stats.lognorm.cdf(x, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted))</span>
<span id="cb3-233"></span>
<span id="cb3-234">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付きKS検定</span></span>
<span id="cb3-235">    ks_stat_weighted, ks_pvalue_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_ks_1samp(</span>
<span id="cb3-236">        triglyceride_values, weights, cdf_func</span>
<span id="cb3-237">    )</span>
<span id="cb3-238"></span>
<span id="cb3-239">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 有効サンプルサイズ（Kish's effective sample size）</span></span>
<span id="cb3-240">    n_eff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-241"></span>
<span id="cb3-242">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重みなしKS検定（参考）</span></span>
<span id="cb3-243">    ks_stat_unweighted, ks_pvalue_unweighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kstest(</span>
<span id="cb3-244">        triglyceride_values, cdf_func</span>
<span id="cb3-245">    )</span>
<span id="cb3-246"></span>
<span id="cb3-247">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">[Goodness-of-fit (Kolmogorov-Smirnov)]"</span>)</span>
<span id="cb3-248">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  [WEIGHTED]"</span>)</span>
<span id="cb3-249">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    KS statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_stat_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-250">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Asymptotic p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_pvalue_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-251">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Effective sample size (Kish): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_eff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-252">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    Note: p-value uses asymptotic approximation with n_eff"</span>)</span>
<span id="cb3-253">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ks_pvalue_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>:</span>
<span id="cb3-254">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &gt; 0.05: No significant difference from lognormal"</span>)</span>
<span id="cb3-255">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-256">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &lt; 0.05: Significantly different from lognormal"</span>)</span>
<span id="cb3-257"></span>
<span id="cb3-258">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  [UNWEIGHTED (reference)]"</span>)</span>
<span id="cb3-259">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    KS statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_stat_unweighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-260">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_pvalue_unweighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-261">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ks_pvalue_unweighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>:</span>
<span id="cb3-262">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &gt; 0.05: No significant difference from lognormal"</span>)</span>
<span id="cb3-263">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-264">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &lt; 0.05: Significantly different from lognormal"</span>)</span>
<span id="cb3-265">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-266"></span>
<span id="cb3-267"></span>
<span id="cb3-268"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb3-269">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loading NHANES data..."</span>)</span>
<span id="cb3-270">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb3-271"></span>
<span id="cb3-272">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filtering middle-aged men (40-59 years) with valid weights..."</span>)</span>
<span id="cb3-273">    middle_aged_men <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_middle_aged_men(df)</span>
<span id="cb3-274"></span>
<span id="cb3-275">    triglyceride_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).to_numpy().flatten()</span>
<span id="cb3-276">    weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>).to_numpy().flatten()</span>
<span id="cb3-277"></span>
<span id="cb3-278">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sample size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-279">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Excluded (WTSAF2YR = 0 or missing): checked"</span>)</span>
<span id="cb3-280"></span>
<span id="cb3-281">    analyze_and_plot(triglyceride_values, weights)</span>
<span id="cb3-282"></span>
<span id="cb3-283"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb3-284">    main()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading NHANES data...
Filtering middle-aged men (40-59 years) with valid weights...
Sample size: 362
Excluded (WTSAF2YR = 0 or missing): checked</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/index_files/figure-html/cell-4-output-2.png" width="1332" height="471" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Statistics: Middle-aged Men (40-59 years) Triglyceride
NHANES August 2021-August 2023 (with sample weights)
======================================================================
Sample size (n): 362
Sum of weights: 39,758,496

[Descriptive Statistics - WEIGHTED (population estimates)]
  Mean: 152.6 mg/dL
  Median: 111.0 mg/dL
  Std Dev: 180.6 mg/dL

[Descriptive Statistics - UNWEIGHTED (sample only)]
  Mean: 149.9 mg/dL
  Median: 108.5 mg/dL
  Std Dev: 160.2 mg/dL
  Min: 28.0 mg/dL
  Max: 1745.0 mg/dL

[Lognormal Parameters - WEIGHTED]
  μ (log-scale mean): 4.7800
  σ (log-scale std): 0.6062
  Median from fit (exp(μ)): 119.1 mg/dL

[Goodness-of-fit (Kolmogorov-Smirnov)]
  [WEIGHTED]
    KS statistic: 0.0893
    Asymptotic p-value: 0.0344
    Effective sample size (Kish): 254.8
    Note: p-value uses asymptotic approximation with n_eff
    -&gt; p &lt; 0.05: Significantly different from lognormal
  [UNWEIGHTED (reference)]
    KS statistic: 0.0892
    p-value: 0.0059
    -&gt; p &lt; 0.05: Significantly different from lognormal
======================================================================</code></pre>
</div>
</div>
</section>
<section id="結果解釈" class="level2">
<h2 class="anchored" data-anchor-id="結果解釈">6. 結果解釈</h2>
<section id="qq-plot" class="level3">
<h3 class="anchored" data-anchor-id="qq-plot">QQ plot</h3>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>観測点の位置</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>直線上</td>
<td>理論分布と一致</td>
</tr>
<tr class="even">
<td>直線より上</td>
<td>観測データの裾が厚い (heavy tail)</td>
</tr>
<tr class="odd">
<td>直線より下</td>
<td>観測データの裾が薄い (light tail)</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">今回のデータの特徴</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>領域</th>
<th>観察されたパターン</th>
<th>解釈</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>下側の裾（低値）</td>
<td>ほぼ直線上</td>
<td>Lognormalと良く一致</td>
</tr>
<tr class="even">
<td>中央部（50-300 mg/dL）</td>
<td>直線上</td>
<td>良好なフィット</td>
</tr>
<tr class="odd">
<td>上側の裾（高値）</td>
<td>直線より上に乖離</td>
<td><strong>Lognormalより裾が厚い</strong></td>
</tr>
</tbody>
</table>
<p><span class="mini-section">Insights</span></p>
<ol type="1">
<li><strong>全体的なフィット</strong>: Lognormal分布は中性脂肪分布の大部分（約95%）を良く近似する</li>
<li><strong>上側の裾の逸脱</strong>: 極端な高値（概ね400 mg/dL以上）の出現頻度がLognormal分布の予測より高い</li>
<li><strong>臨床的含意</strong>:
<ul>
<li>高トリグリセリド血症の有病率推定において、Lognormalモデルは過小評価のリスクがある</li>
<li>リスク評価では、より裾の厚い分布（例：一般化ガンマ分布）の検討も有用かも？</li>
</ul></li>
</ol>
</section>
</section>
<section id="追加分析" class="level2">
<h2 class="anchored" data-anchor-id="追加分析">7. 追加分析</h2>
<div id="17e5938a" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> additional_analysis():</span>
<span id="cb6-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loading NHANES data..."</span>)</span>
<span id="cb6-3">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb6-4"></span>
<span id="cb6-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filtering middle-aged men (40-59 years) with valid weights..."</span>)</span>
<span id="cb6-6">    middle_aged_men <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_middle_aged_men(df)</span>
<span id="cb6-7"></span>
<span id="cb6-8">    triglyceride_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).to_numpy().flatten()</span>
<span id="cb6-9">    weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>).to_numpy().flatten()</span>
<span id="cb6-10"></span>
<span id="cb6-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># === 5%-95%パーセンタイル範囲での分析 ===</span></span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb6-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ANALYSIS 2: Trimmed Data (5th-95th Percentile)"</span>)</span>
<span id="cb6-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb6-15">    trimmed_values, trimmed_weights, lower_bound, upper_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_by_percentile(</span>
<span id="cb6-16">        triglyceride_values, weights, lower_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, upper_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span></span>
<span id="cb6-17">    )</span>
<span id="cb6-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Percentile range: [</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lower_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>upper_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] mg/dL"</span>)</span>
<span id="cb6-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Trimmed sample size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trimmed_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (from </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Excluded: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trimmed_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> extreme values"</span>)</span>
<span id="cb6-21"></span>
<span id="cb6-22">    analyze_and_plot(trimmed_values, trimmed_weights, save_suffix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_trimmed_5_95"</span>)</span>
<span id="cb6-23"></span>
<span id="cb6-24">additional_analysis()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading NHANES data...
Filtering middle-aged men (40-59 years) with valid weights...

======================================================================
ANALYSIS 2: Trimmed Data (5th-95th Percentile)
======================================================================
Percentile range: [52.8, 351.4] mg/dL
Trimmed sample size: 326 (from 362)
Excluded: 36 extreme values</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/index_files/figure-html/cell-5-output-2.png" width="1334" height="471" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Statistics: Middle-aged Men (40-59 years) Triglyceride
NHANES August 2021-August 2023 (with sample weights)
======================================================================
Sample size (n): 326
Sum of weights: 35,785,691

[Descriptive Statistics - WEIGHTED (population estimates)]
  Mean: 126.0 mg/dL
  Median: 111.0 mg/dL
  Std Dev: 59.0 mg/dL

[Descriptive Statistics - UNWEIGHTED (sample only)]
  Mean: 127.4 mg/dL
  Median: 108.0 mg/dL
  Std Dev: 63.0 mg/dL
  Min: 53.0 mg/dL
  Max: 336.0 mg/dL

[Lognormal Parameters - WEIGHTED]
  μ (log-scale mean): 4.7400
  σ (log-scale std): 0.4308
  Median from fit (exp(μ)): 114.4 mg/dL

[Goodness-of-fit (Kolmogorov-Smirnov)]
  [WEIGHTED]
    KS statistic: 0.0688
    Asymptotic p-value: 0.2259
    Effective sample size (Kish): 230.1
    Note: p-value uses asymptotic approximation with n_eff
    -&gt; p &gt; 0.05: No significant difference from lognormal
  [UNWEIGHTED (reference)]
    KS statistic: 0.0704
    p-value: 0.0755
    -&gt; p &gt; 0.05: No significant difference from lognormal
======================================================================</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>追加分析解釈
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>log-scale が0.6062 → 0.0688に減少: 裾の極端な値を除外したことで分散が小さくなった</li>
<li>KS統計量も0.0893 → 0.4308に減少: 経験分布と理論分布の最大乖離が縮小</li>
<li>Q-Qプロットを見ても，トリミング後は理論直線（赤破線）にデータポイントがいい感じに乗っている．特に上側の裾の逸脱が解消</li>
<li>ただし，そもそも上位5%を異常値として除外できるかどうかは，適合度のみではわからない．
<ul>
<li><strong>分析目的などによりケースバイケースで判断が必要</strong></li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="appendix-トリグリセリド" class="level2">
<h2 class="anchored" data-anchor-id="appendix-トリグリセリド">Appendix: トリグリセリド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">中性脂肪 / トリグリセリド</span></p>
<ul>
<li>肉や魚・食用油など食品中の脂質や，体内の脂質の大部分を占める物質</li>
<li>中性脂肪は重要なエネルギー源であり，ビタミンの吸収を助けたり，必須脂肪酸（体内で合成されない脂肪酸）を摂取するという点においても不可欠なもの</li>
<li>とりすぎると体脂肪として蓄えられて肥満を招き，心筋梗塞などになりやすくなる</li>
<li>血液中の中性脂肪値は特定健診の検査項目に含まれており，空腹時150mg/dⅬ以上，随時175mg/dⅬ以上になると「高TG（トリグリセライド）血症」とされる</li>
</ul>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 30%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>測定項目</th>
<th>英語名</th>
<th>略称</th>
<th>単位</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>総コレステロール</td>
<td>Total Cholesterol</td>
<td>TC</td>
<td>mg/dL</td>
<td>血中コレステロールの総量．心血管疾患リスク評価の基本指標</td>
</tr>
<tr class="even">
<td>高比重リポ蛋白コレステロール</td>
<td>High-Density Lipoprotein Cholesterol</td>
<td>HDL-C</td>
<td>mg/dL</td>
<td>いわゆる「善玉」コレステロール．高値は心血管リスク低下と関連</td>
</tr>
<tr class="odd">
<td>低比重リポ蛋白コレステロール</td>
<td>Low-Density Lipoprotein Cholesterol</td>
<td>LDL-C</td>
<td>mg/dL</td>
<td>いわゆる「悪玉」コレステロール．動脈硬化リスクと強く関連</td>
</tr>
<tr class="even">
<td>中性脂肪</td>
<td>Triglycerides</td>
<td>TG</td>
<td>mg/dL</td>
<td>血中脂質の一種．エネルギー代謝やメタボリックリスクと関連</td>
</tr>
</tbody>
</table>
</section>
<section id="appendix-qq-plot" class="level2">
<h2 class="anchored" data-anchor-id="appendix-qq-plot">Appendix: QQ plot</h2>
<p><a href="https://www.kyoritsu-pub.co.jp/book/b10033628.html">データ解析のための数理統計入門</a>ベースで行くとQQ plotは以下のように定義されています．</p>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">QQ plot</span></p>
<p>確率変数 <img src="https://latex.codecogs.com/png.latex?X_1,%20%5Ccdots,%20X_n%20%5Coverset%7B%5Cmathrm%7Biid%7D%7D%7B%5Csim%7D%20F"> とし，その順序統計量を</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AX_%7B(1)%7D%20%5Cleq%20%5Ccdots%20%5Cleq%20X_%7B(n)%7D%0A"></p>
<p>とする．<img src="https://latex.codecogs.com/png.latex?X_%7B(j)%7D"> の実現値 <img src="https://latex.codecogs.com/png.latex?x_%7B(j)%7D"> として， <img src="https://latex.codecogs.com/png.latex?F"> の逆変換を施した点</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A(x_%7B(j)%7D,%20F%5E%7B-1%7D(j/(n+1)))%0A"></p>
<p>をplotしたものをQQ plotという．</p>
</div>
<p>この定義を正とすると，分析におけるQQ plotはQQ plotではない．ただ，久保川先生では</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AF(x_%7B(j)%7D,%20j/(n+1))%0A"></p>
<p>をplotしたものをPP plotと呼んでおり，分析におけるQQ plotは久保川流でいくならば PP plotということになります．PP plotの理論的根拠は， 確率積分変換により <img src="https://latex.codecogs.com/png.latex?F(X)"> は一様分布に従い，iid sampleは各点独立に</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5BF(X_%7B(j)%7D)%5D%20=%20%5Cfrac%7Bj%7D%7Bn+1%7D%0A"></p>
<p>になるはずという考えが背景にあります．</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://kennet.mhlw.go.jp/information/information/dictionary/metabolic/ym-045">厚生労働省 &gt; 健康日本21アクション支援システム ～健康づくりサポートネット～ &gt; 中性脂肪 / トリグリセリド</a></li>
<li><a href="https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Laboratory&amp;Cycle=2021-2023&amp;utm_source=chatgpt.com">NHANES (National Health and Nutrition Examination Survey) August 2021 - August 2023</a></li>
<li><a href="https://www.amazon.co.jp/-/en/Numerical-Statistics-Statistical-Probabilistic-Mathematics/dp/0521791685">Monahan, J. (2011). <em>Numerical Methods of Statistics</em>.</a></li>
<li><a href="https://numpy.org/devdocs/reference/generated/numpy.interp.html">numpy.interp</a></li>
<li><a href="https://www.kyoritsu-pub.co.jp/book/b10033628.html">データ解析のための数理統計入門</a></li>
</ul>


</section>

 ]]></description>
  <category>統計</category>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/</guid>
  <pubDate>Mon, 15 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>自分用GitHub Repository作成時のメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-10-github-repository-memo/</link>
  <description><![CDATA[ 






<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">🔨 Getting Started</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>あくまで共通項についてのメモです</li>
<li>厳密には下記のStep 3 ghコマンドの実行 の前にdocument や gitignoreなり他にもやることはあります</li>
</ul>
</div>
</div>
<p><span class="mini-section">minimum structure</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb1-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb1-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">├── .github/</span></span>
<span id="cb1-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   ├── repository_metadata/    # Repository configuration files</span></span>
<span id="cb1-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   │   ├── gh_repo.yml        # Repository metadata</span></span>
<span id="cb1-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   │   └── label_master.yml   # Label definitions</span></span>
<span id="cb1-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   └── workflows/             # GitHub Actions workflows</span></span>
<span id="cb1-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│       └── label-generator.yml # Label automation workflow</span></span>
<span id="cb1-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">└── README.md</span></span></code></pre></div></div>
<p><span class="mini-section">手順</span></p>
<ol type="1">
<li><p><strong>ディレクトリの作成と移動</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>repository-name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$_</span></span></code></pre></div></div></li>
<li><p><strong>Repositoryメタデータの作成</strong></p>
<p>以下のように <code>.github/repository_metadata/gh_repo.yml</code> に記述します</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>gh_repo.yml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="gh_repo.yml" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meta-data</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repository_name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> your-repo-name</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">       # Required: Repository name</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">visibility</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> private|public</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            # Required: Repository visibility</span></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">org-name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> YourOrgName</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                # Required: Organization name</span></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">homepage</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> YourURL</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    # Optional: e.g., https://ryonakagami.github.io/regmonkey-datascience-blog/</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                 # Optional: Repository tags</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> tag1</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> tag2</span></span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                       # Required: Repository description</span></span>
<span id="cb3-10">  A clear, concise description of your project.</span></code></pre></div></div>
</div></li>
</ol>
<div class="callout callout-style-default callout-caution callout-titled" style="margin-left: 2em;">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>'Required'</code> とされているフィールドは必ず入力して下さい</p>
</div>
</div>
<ol start="3" type="1">
<li><p><strong>ghコマンドの実行</strong></p>
<p>自分は <code>.gitconfig</code> で Alias 設定を行い <a href="https://github.com/RyoNakagami/regmonkey-gitcommand/blob/main/src/git-create-repo.sh">git create-repo</a> と <a href="https://github.com/RyoNakagami/regmonkey-gitcommand/blob/main/src/git-repo-update.sh">git update-repo</a> を実行できるようにしています．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step 1</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> create-repo   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only when the repository not created yet</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step 2</span></span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> update-repo   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reflecting tags, description, and homepage</span></span></code></pre></div></div></li>
<li><p><strong>（Optional）ラベルのカスタマイズ</strong></p>
<p><code>.github/repository_metadata/label_master.yml</code> を以下のフォーマットで編集．<code>main</code> へのpushが <code>label_master.yml</code> の変更を含んでいるときにラベルが作成される</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------------------------------------------</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GitHub Issue Labels aligned with Branch Naming Conventions</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------------------------------------------</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Development Workflows (Aligned with Branch Prefixes) ---</span></span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> environment</span></span>
<span id="cb5-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> EFDECD</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # almond</span></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> This issue is related to development repository structure etc</span></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> feature</span></span>
<span id="cb5-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 008000</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # green</span></span>
<span id="cb5-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> New feature development</span></span>
<span id="cb5-14"></span>
<span id="cb5-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> bugfix</span></span>
<span id="cb5-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DC143C</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # crimson</span></span>
<span id="cb5-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Bug fix or defect correction</span></span></code></pre></div></div></li>
</ol>
<section id="label-generator-workflow" class="level3">
<h3 class="anchored" data-anchor-id="label-generator-workflow">Label Generator Workflow</h3>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 24%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>イベント</th>
<th>Workflow が動作する？</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>main</code> への PR を作成</td>
<td>❌</td>
<td><code>push</code> ではないため</td>
</tr>
<tr class="even">
<td><code>main</code> への PR を更新（コミット追加）</td>
<td>❌</td>
<td>push は発生しているが，そのブランチで動くので <code>main</code> とは関係なし</td>
</tr>
<tr class="odd">
<td><code>main</code> への PR を merge</td>
<td>✅</td>
<td>merge commit が <code>main</code> に <code>push</code> されるため</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">ワークフローファイル</span></p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>label-generator.yml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="label-generator.yml" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Label Manager</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trigger: Runs when labels.yaml is modified</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">branches</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> main</span></span>
<span id="cb6-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paths</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> .github/repository_metadata/label_master.yml</span></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimal required permissions</span></span>
<span id="cb6-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permissions</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contents</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> read</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    # Read repository files</span></span>
<span id="cb6-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">issues</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> write</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     # Create/update/delete labels</span></span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jobs</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sync-labels</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runs-on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ubuntu-latest</span></span>
<span id="cb6-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb6-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">steps</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # SETUP: Install required tools and authenticate</span></span>
<span id="cb6-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Checkout repository</span></span>
<span id="cb6-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> actions/checkout@v4</span></span>
<span id="cb6-27"></span>
<span id="cb6-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Install uv</span></span>
<span id="cb6-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> astral-sh/setup-uv@v4</span></span>
<span id="cb6-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # uv is used to install Python tools like yamlcli</span></span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Install dependencies</span></span>
<span id="cb6-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-34">          # Update package lists quietly</span>
<span id="cb6-35">          sudo apt-get update -qq</span>
<span id="cb6-36">          </span>
<span id="cb6-37">          # Install jq (JSON processor) and gh (GitHub CLI)</span>
<span id="cb6-38">          sudo apt-get install -y -qq jq gh</span>
<span id="cb6-39">          </span>
<span id="cb6-40">          # Install yamlcli via uv to convert YAML to JSON</span>
<span id="cb6-41">          uv tool install git+https://github.com/RyoNakagami/yamlcli.git</span>
<span id="cb6-42"></span>
<span id="cb6-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Authenticate GitHub CLI</span></span>
<span id="cb6-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token</span></span>
<span id="cb6-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # Note: Not setting GH_TOKEN here allows gh to store credentials</span></span>
<span id="cb6-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # This prevents "To have GitHub CLI store credentials..." warning</span></span>
<span id="cb6-47"></span>
<span id="cb6-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # PARSE: Convert YAML configuration to JSON</span></span>
<span id="cb6-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-52"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Parse labels configuration</span></span>
<span id="cb6-53"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> parse</span></span>
<span id="cb6-54"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-55">          # Convert labels.yaml to JSON format and save to file</span>
<span id="cb6-56">          yamlcli --to-json .github/repository_metadata/label_master.yml &gt; /tmp/labels.json</span>
<span id="cb6-57">          echo "Labels configuration parsed successfully"</span>
<span id="cb6-58"></span>
<span id="cb6-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # SYNC: Create or update labels from configuration</span></span>
<span id="cb6-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-62"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-63"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Sync labels</span></span>
<span id="cb6-64"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-65">          # Exit on error, undefined variables, or pipe failures</span>
<span id="cb6-66">          set -euo pipefail</span>
<span id="cb6-67">          </span>
<span id="cb6-68">          # Get list of existing label names once to avoid repeated API calls</span>
<span id="cb6-69">          EXISTING_LABELS=$(gh label list --json name --jq '.[].name')</span>
<span id="cb6-70">          </span>
<span id="cb6-71">          # Process each label definition from the JSON array</span>
<span id="cb6-72">          jq -c '.[]' /tmp/labels.json | while IFS= read -r label; do</span>
<span id="cb6-73">            # Extract label properties</span>
<span id="cb6-74">            NAME=$(echo "$label" | jq -r '.name')</span>
<span id="cb6-75">            COLOR=$(echo "$label" | jq -r '.color')</span>
<span id="cb6-76">            DESC=$(echo "$label" | jq -r '.description // ""')  # Default to empty string if null</span>
<span id="cb6-77">            </span>
<span id="cb6-78">            echo "Processing label: $NAME"</span>
<span id="cb6-79">            </span>
<span id="cb6-80">            # Check if label already exists in repository</span>
<span id="cb6-81">            if echo "$EXISTING_LABELS" | grep -Fxq "$NAME"; then</span>
<span id="cb6-82">              # Update existing label</span>
<span id="cb6-83">              echo "  Updating existing label"</span>
<span id="cb6-84">              gh label edit "$NAME" --color "$COLOR" --description "$DESC"</span>
<span id="cb6-85">            else</span>
<span id="cb6-86">              # Create new label</span>
<span id="cb6-87">              echo "  Creating new label"</span>
<span id="cb6-88">              gh label create "$NAME" --color "$COLOR" --description "$DESC"</span>
<span id="cb6-89">            fi</span>
<span id="cb6-90">          done</span>
<span id="cb6-91"></span>
<span id="cb6-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # PRUNE: Remove labels not defined in configuration</span></span>
<span id="cb6-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-95"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-96"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Prune obsolete labels</span></span>
<span id="cb6-97"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-98">          # Exit on error, undefined variables, or pipe failures</span>
<span id="cb6-99">          set -euo pipefail</span>
<span id="cb6-100">          </span>
<span id="cb6-101">          # Get list of all existing labels in the repository</span>
<span id="cb6-102">          EXISTING_LABELS=$(gh label list --json name --jq '.[].name')</span>
<span id="cb6-103">          </span>
<span id="cb6-104">          # Get list of desired labels from configuration</span>
<span id="cb6-105">          DESIRED_LABELS=$(jq -r '.[].name' /tmp/labels.json)</span>
<span id="cb6-106">          </span>
<span id="cb6-107">          # Check each existing label</span>
<span id="cb6-108">          echo "$EXISTING_LABELS" | while IFS= read -r label; do</span>
<span id="cb6-109">            # Skip empty lines</span>
<span id="cb6-110">            if [[ -n "$label" ]] &amp;&amp; ! echo "$DESIRED_LABELS" | grep -Fxq "$label"; then</span>
<span id="cb6-111">              # Label exists in repo but not in config - delete it</span>
<span id="cb6-112">              echo "Deleting obsolete label: $label"</span>
<span id="cb6-113">              gh label delete "$label" --yes || echo "  Failed to delete $label (may be in use)"</span>
<span id="cb6-114">            fi</span>
<span id="cb6-115">          done</span>
<span id="cb6-116"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # gh CLI uses stored credentials from auth login step</span></span></code></pre></div></div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://github.com/RyoNakagami/regmonkey-gitcommand">regmonkey-gitcommand</a></li>
</ul>


</section>

 ]]></description>
  <category>環境構築</category>
  <category>github</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-10-github-repository-memo/</guid>
  <pubDate>Wed, 10 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>ISO 8601 カレンダーテーブルの作成</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-09-create-calendar-table/</link>
  <description><![CDATA[ 






<section id="iso-8601-とは" class="level2">
<h2 class="anchored" data-anchor-id="iso-8601-とは">ISO 8601 とは？</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">ISO 8601</span></p>
<ul>
<li>日付と時刻の表現形式に関する ISO の国際標準</li>
<li>グレゴリオ暦の西暦2016年3月25日は <code>2016-03-25</code> と表記する</li>
</ul>
</div>
<p>日付を <code>01/05/22</code> と数字で表す場合，</p>
<ul>
<li>2022-01-05</li>
<li>2022-05-01</li>
</ul>
<p>のどちらでも解釈できてしまいます．ISO 8601 は，このような混乱を解消するために日付の国際的な表記方法を定めた規格です． 日本では日本産業規格の JIS X 0301 にて，ISO 8601 と同等の内容が採用されています．</p>
<section id="日付表記-date" class="level3">
<h3 class="anchored" data-anchor-id="日付表記-date">日付表記 (Date)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">日付表記</span></p>
<ul>
<li>ISO 8601 では，日付は 年・月・日を左から順に並べる形式とし，半角数字・ハイフン区切りで表す</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb1-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">YYYY-MM-DD</span></span></code></pre></div></div>
<ul>
<li><code>YYYY</code>：西暦年（4桁．年の表記は 0000年～9999年 を想定）</li>
<li><code>MM</code>：月（2桁．1桁の場合は先頭に <code>0</code> を付与）</li>
<li><code>DD</code>：日（2桁．1桁の場合は先頭に <code>0</code> を付与）</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>0000年より前または9999年より後の年を表記する場合には，事前に通信の送信側と受信側との間での合意が必要</li>
<li><code>YYYYMMDD</code> という表記もあり得る</li>
</ul>
</div>
</div>
</section>
<section id="曜日表記-day-of-week" class="level3">
<h3 class="anchored" data-anchor-id="曜日表記-day-of-week">曜日表記 (Day of Week)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">曜日表記</span></p>
<ul>
<li>ISO 8601 では，週の始まりは月曜日（=1） と定められており，曜日は 1〜7 の整数値で表される</li>
<li>日本の商習慣では「日曜始まり」のカレンダーが多い点に注意</li>
</ul>
</div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>数値</th>
<th>曜日</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>月曜日</td>
</tr>
<tr class="even">
<td>2</td>
<td>火曜日</td>
</tr>
<tr class="odd">
<td>3</td>
<td>水曜日</td>
</tr>
<tr class="even">
<td>4</td>
<td>木曜日</td>
</tr>
<tr class="odd">
<td>5</td>
<td>金曜日</td>
</tr>
<tr class="even">
<td>6</td>
<td>土曜日</td>
</tr>
<tr class="odd">
<td>7</td>
<td>日曜日</td>
</tr>
</tbody>
</table>
</section>
<section id="時刻表記-time" class="level3">
<h3 class="anchored" data-anchor-id="時刻表記-time">時刻表記 (Time)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title">時刻表記</span></p>
<ul>
<li>ISO 8601 の時刻は 24 時間制で，コロン区切りとする</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb2-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">hh:mm:ss</span></span></code></pre></div></div>
<ul>
<li><code>hh</code>：時（00–24）</li>
<li><code>mm</code>：分（00–59）</li>
<li><code>ss</code>：秒（00–59，必要に応じて小数も可）</li>
</ul>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (ミリ秒とマイクロ秒)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb3-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">14:30:00.123   （ミリ秒）</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">14:30:00.123456（マイクロ秒）</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="日付と時刻の組み合わせdatetime" class="level3">
<h3 class="anchored" data-anchor-id="日付と時刻の組み合わせdatetime">日付と時刻の組み合わせ（Datetime）</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 5</strong></span> <span class="def-title">Datetime</span></p>
<ul>
<li>ISO 8601 では，日付と時刻を組み合わせる場合 <code>T</code> を連結文字として使用する</li>
<li>必要に応じて UTC との時差（オフセット）を付与する</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">YYYY-MM-DDThh:mm:ss</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[±hh:mm]</span></span></code></pre></div></div>
</div>
<p>タイムゾーン省略時は「ローカル時刻」とみなされるため，システム間連携ではオフセット付与版が望ましいとされます． というか<strong>プログラミングで扱うときは，基本的にはオフセット付与版を用いましょう</strong>．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb5-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025-12-09T14:30:00+09:00   # 日本標準時 (JST)</span></span>
<span id="cb5-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025-12-09T05:30:00Z        # UTC（Z は +00:00 と等価）</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="iso-week-date" class="level3">
<h3 class="anchored" data-anchor-id="iso-week-date">ISO week date</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 6</strong></span> <span class="def-title">ISOWEEK</span></p>
<ul>
<li>ISO-8601 という国際標準で定められた「週番号」の体系</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb6-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Date                2025-12-08</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Week                2025-W50</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Week with weekday   2025-W50-1</span></span></code></pre></div></div>
</div>
<p><span class="mini-section">ISOWEEK計算アルゴリズム</span></p>
<ol type="1">
<li>年初からの通算日（day of year）から，その日の ISO 曜日番号を引く</li>
<li>その結果に 10 を加える</li>
<li>7 で割り，余りを切り捨てる</li>
</ol>
<p>その後，次の判定を行う</p>
<ul>
<li>計算結果が 0 の場合: この日付は 前年の最終週（週番号 52 または 53）</li>
<li>計算結果が 53 の場合:
<ul>
<li>その年に ISO 週 53 が存在するか確認</li>
<li>存在しない年の場合，この日付は 翌年の週 1</li>
</ul></li>
</ul>
<div class="pseudocode-container quarto-float" data-line-number="true" data-no-end="false" data-line-number-punc=":" data-comment-delimiter="//" data-pseudocode-number="1" data-caption-prefix="Algorithm" data-indent-size="1.2em">
<div class="pseudocode">
\begin{algorithm} \caption{ISO Week Number Calculation} \begin{algorithmic} \Procedure{WeekdayOfDec31}{$y$} \State $p = (\, y + \lfloor y/4 \rfloor - \lfloor y/100 \rfloor + \lfloor y/400 \rfloor \,) \bmod 7$ \Return $p$ \EndProcedure \State \Procedure{WeeksInYear}{$y$} \State $p_y$ = \Call{WeekdayOfDec31}{$y$} \State $p_{y-1}$ = \Call{WeekdayOfDec31}{$y-1$} \If{$p_y = 4 \ OR \ p_{y-1} = 3$} \Return $53$ \Else \Return $52$ \EndIf \EndProcedure \State \Procedure{ISOWeek}{$date$} \State $y = year(date)$ \State $doy = doy(date)$ $\,\,\,\,\,$ \Comment{ day of year} \State $dow = dow(date)$ $\,\,\,\,\,$\Comment{ISO weekday: 1=Mon,...,7=Sun} \State $w = \left\lfloor \dfrac{10 + doy - dow}{7} \right\rfloor$ \If{$w &lt; 1$} \Return \Call{WeeksInYear}{$y-1$} \ElsIf{$w$ &gt; \Call{WeeksInYear}{$y$}} \Return $1$ \Else \Return $w$ \EndIf \EndProcedure \end{algorithmic} \end{algorithm}
</div>
</div>
</section>
</section>
<section id="カレンダーとプログラミング" class="level2">
<h2 class="anchored" data-anchor-id="カレンダーとプログラミング">カレンダーとプログラミング</h2>
<section id="シェルでisoweek計算" class="level3">
<h3 class="anchored" data-anchor-id="シェルでisoweek計算">シェルでISOWEEK計算</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 7</strong></span> <span class="def-title"><code>date</code> コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> +%V</span></code></pre></div></div>
<p>を実行すると，現在時刻のISO WEEKが表示される</p>
</div>
<p><span class="mini-section">関連オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>フォーマット</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>%V</code></td>
<td>ISO 8601 週番号（01–53）</td>
</tr>
<tr class="even">
<td><code>%G</code></td>
<td>ISO 年（week-based year）</td>
</tr>
<tr class="odd">
<td><code>%g</code></td>
<td>ISO 年（下2桁）</td>
</tr>
<tr class="even">
<td><code>%u</code></td>
<td>ISO 曜日（1=Mon〜7=Sun）</td>
</tr>
<tr class="odd">
<td><code>%a</code></td>
<td>曜日名（Mon, Tue, …）</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (UTC vs Asia/Tokyo)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date +%V <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-12-30T08:00:00.123213+09:00'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span></span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">52</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date +%V <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-12-30T08:00:00.123213+00:00'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span></span>
<span id="cb8-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">01</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="日付レンジからカレンダーテーブルの作成" class="level3">
<h3 class="anchored" data-anchor-id="日付レンジからカレンダーテーブルの作成">日付レンジからカレンダーテーブルの作成</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Goal
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>YYYY-MM-DD</code> 形式の２つの引数を入力すると，指定した開始日から終了日までの日付範囲を1日ずつ列挙したテーブル形式で出力する関数を作成</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date-table 2020-01-01 2020-01-10   </span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span>,weekday,iso_day_of_week,isoweek,day_of_year</span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-01,Wed,3,01,001</span></span>
<span id="cb9-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-02,Thu,4,01,002</span></span>
<span id="cb9-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-03,Fri,5,01,003</span></span>
<span id="cb9-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-04,Sat,6,01,004</span></span>
<span id="cb9-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-05,Sun,7,01,005</span></span>
<span id="cb9-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-06,Mon,1,02,006</span></span>
<span id="cb9-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-07,Tue,2,02,007</span></span>
<span id="cb9-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-08,Wed,3,02,008</span></span>
<span id="cb9-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-09,Thu,4,02,009</span></span>
<span id="cb9-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-10,Fri,5,02,010</span></span></code></pre></div></div>
</div>
</div>
<p><span class="mini-section">実装例</span></p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">Bash</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Python + datetimeモジュール</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">Pandas</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false" href="">Polars</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false" href="">BigQuery with UDF Table</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revised: 2025-12-09</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Script: date-table</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Description:</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Generates a CSV table of dates and their properties for a given date range.</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Outputs columns for date, weekday, ISO day of week, ISO week number, and</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   day of year, with options to select which columns to display.</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Steps:</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     1. Parse and validate command-line options and arguments.</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     2. Validate input dates (format and calendar existence).</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     3. Set output columns based on options (default: all columns).</span></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     4. Print CSV header.</span></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     5. Iterate from start to end date, printing each row with selected fields.</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Options:</span></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -a    Show weekday column</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -u    Show ISO day of week column</span></span>
<span id="cb10-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -V    Show ISO week number column</span></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -j    Show day of year column</span></span>
<span id="cb10-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -h    Show this help message</span></span>
<span id="cb10-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Usage:</span></span>
<span id="cb10-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./date-table [-a] [-u] [-V] [-j] &lt;start-date&gt; &lt;end-date&gt;</span></span>
<span id="cb10-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     # Outputs a CSV table for the date range, with selected columns.</span></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notes:</span></span>
<span id="cb10-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires bash, GNU date, and coreutils installed.</span></span>
<span id="cb10-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Dates must be in YYYY-MM-DD format.</span></span>
<span id="cb10-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Exits with error if dates are invalid or out of order.</span></span>
<span id="cb10-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb10-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-euo</span> pipefail</span>
<span id="cb10-35"></span>
<span id="cb10-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Validate YYYY-MM-DD ---</span></span>
<span id="cb10-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">validate_ymd()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb10-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">d</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-39"></span>
<span id="cb10-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format check</span></span>
<span id="cb10-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Invalid format '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'. Expected YYYY-MM-DD."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-43">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-45"></span>
<span id="cb10-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calendar existence check</span></span>
<span id="cb10-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">norm</span></span>
<span id="cb10-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">norm</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%Y-%m-%d <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>/dev/null<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-49">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' is not a real date."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-50">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-52"></span>
<span id="cb10-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reject auto-corrected dates (e.g., 2025-02-30 → 2025-03-02)</span></span>
<span id="cb10-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$norm</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-55">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' is not a valid calendar date."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-56">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-58"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span>
<span id="cb10-59"></span>
<span id="cb10-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Option parsing ---</span></span>
<span id="cb10-61"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-62"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-63"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-64"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-65"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt_specified</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-66"></span>
<span id="cb10-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getopts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auVj"</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb10-68">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt_specified</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">case</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb10-70">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">a</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-71">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">u</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-72">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">V</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-73">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">j</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">esac</span></span>
<span id="cb10-75"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span>
<span id="cb10-76"> </span>
<span id="cb10-77"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb10-78"></span>
<span id="cb10-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$#</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-ne</span> 2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-80">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Usage: </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$0</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> [-a] [-u] [-V] [-j] &lt;start-date&gt; &lt;end-date&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-81">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-82"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-83"></span>
<span id="cb10-84"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">start_date</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-85"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">end_date</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-86"></span>
<span id="cb10-87"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">validate_ymd</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-88"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">validate_ymd</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-89"></span>
<span id="cb10-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure start &lt;= end</span></span>
<span id="cb10-91"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-92">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: start_date &gt; end_date"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-93">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-94"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-95"></span>
<span id="cb10-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If no options specified → output all</span></span>
<span id="cb10-97"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt_specified</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-98">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-99">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-100">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-101">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-103"></span>
<span id="cb10-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Print header ---</span></span>
<span id="cb10-105"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span></span>
<span id="cb10-106"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_weekday</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",weekday"</span></span>
<span id="cb10-107"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_iso_day</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",iso_day_of_week"</span></span>
<span id="cb10-108"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_isoweek</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",isoweek"</span></span>
<span id="cb10-109"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_day_of_year</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",day_of_year"</span></span>
<span id="cb10-110"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"\n"</span></span>
<span id="cb10-111"></span>
<span id="cb10-112"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Generate rows ---</span></span>
<span id="cb10-113"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">current</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-114"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">true</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb10-115"></span>
<span id="cb10-116">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%a<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-117">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%u<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-118">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%V<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-119">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">doy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%j<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-120"></span>
<span id="cb10-121">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-122">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_weekday</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$weekday</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-123">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_iso_day</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$iso_day</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-124">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_isoweek</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$isoweek</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-125">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_day_of_year</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$doy</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-126"></span>
<span id="cb10-127">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"\n"</span></span>
<span id="cb10-128"></span>
<span id="cb10-129">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb10-130"></span>
<span id="cb10-131">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">current</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> +1 day"</span> +%Y-%m-%d<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-132"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span></code></pre></div></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime, timedelta</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb11-4">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.fromisoformat(start_date).date()</span>
<span id="cb11-5">    end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.fromisoformat(end_date).date()</span>
<span id="cb11-6"></span>
<span id="cb11-7">    delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start</span>
<span id="cb11-8"></span>
<span id="cb11-9">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(delta.days <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb11-11">        d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i)</span>
<span id="cb11-12">        result.append(</span>
<span id="cb11-13">            {</span>
<span id="cb11-14">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: d,</span>
<span id="cb11-15">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>: d.isoformat(),</span>
<span id="cb11-16">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>: d.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mon, Tue ...</span></span>
<span id="cb11-17">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>: d.isoweekday(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1=Mon ... 7=Sun</span></span>
<span id="cb11-18">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>: d.isocalendar()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ISO week number</span></span>
<span id="cb11-19">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>: d.timetuple().tm_yday,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1〜365/366</span></span>
<span id="cb11-20">            }</span>
<span id="cb11-21">        )</span>
<span id="cb11-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span></code></pre></div></div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb12-2"></span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table_pd(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb12-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date range</span></span>
<span id="cb12-6">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.date_range(start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start_date, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>end_date, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>)</span>
<span id="cb12-7"></span>
<span id="cb12-8">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(</span>
<span id="cb12-9">        {</span>
<span id="cb12-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: dates.date,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date object</span></span>
<span id="cb12-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>: dates.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb12-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>: dates.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mon, Tue, ...</span></span>
<span id="cb12-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>: dates.isocalendar().day.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1–7</span></span>
<span id="cb12-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>: dates.isocalendar().week.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ISO week number</span></span>
<span id="cb12-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>: dates.dayofyear.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1–366</span></span>
<span id="cb12-16">        }</span>
<span id="cb12-17">    )</span>
<span id="cb12-18"></span>
<span id="cb12-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span></code></pre></div></div>
<ul>
<li><code>dates.isocalendar().day</code> などは Date Index付 <code>pandas.core.series.Series</code> で返してしまうので <code>.values</code> を使用</li>
</ul>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> date</span>
<span id="cb13-3"></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table_pl(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pl.DataFrame:</span>
<span id="cb13-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reformat to date object</span></span>
<span id="cb13-7">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date.fromisoformat(start_date)</span>
<span id="cb13-8">    end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date.fromisoformat(end_date)</span>
<span id="cb13-9"></span>
<span id="cb13-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date range</span></span>
<span id="cb13-11">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.date_range(start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>end, interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1d"</span>, eager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb13-12"></span>
<span id="cb13-13">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: dates}).with_columns(</span>
<span id="cb13-14">        [</span>
<span id="cb13-15">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.to_string(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>),</span>
<span id="cb13-16">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>).alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>),</span>
<span id="cb13-17">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.weekday().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>),</span>
<span id="cb13-18">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.week().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>),</span>
<span id="cb13-19">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.ordinal_day().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>),</span>
<span id="cb13-20">        ]</span>
<span id="cb13-21">    )</span>
<span id="cb13-22"></span>
<span id="cb13-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span></code></pre></div></div>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<ol type="1">
<li>テーブル関数用のData setの作成</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SCHEMA</span> `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table`</span>
<span id="cb14-2">OPTIONS (location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"asia-northeast1"</span>);</span></code></pre></div></div>
<ol start="2" type="1">
<li>テーブル関数作成 (<code>CREATE TABLE FUNCTION</code>)</li>
</ol>
<p>BigQuery の <code>DAYOFWEEK</code> が <code>Sunday=1</code> であるのでISO8601形式に変換</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">OR</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">REPLACE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TABLE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FUNCTION</span></span>
<span id="cb15-2">  `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table.date_table`(start_date <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>, end_date <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>)</span>
<span id="cb15-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> (</span>
<span id="cb15-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span></span>
<span id="cb15-5">    d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">date</span>,</span>
<span id="cb15-6">    FORMAT_DATE(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%Y-%m-%d'</span>, d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> date_str,</span>
<span id="cb15-7">    FORMAT_DATE(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%a'</span>, d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> weekday,</span>
<span id="cb15-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MOD</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(DAYOFWEEK <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> iso_day_of_week,</span>
<span id="cb15-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(ISOWEEK <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> isoweek,</span>
<span id="cb15-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(DAYOFYEAR <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> day_of_year</span>
<span id="cb15-11">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span></span>
<span id="cb15-12">    UNNEST(GENERATE_DATE_ARRAY(start_date, end_date, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">INTERVAL</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DAY</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> d</span>
<span id="cb15-13">);</span></code></pre></div></div>
<ol start="3" type="1">
<li>実行</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> </span>
<span id="cb16-3">  `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table.date_table`(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2025-02-01'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2025-02-10'</span>);</span></code></pre></div></div>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.python.org/ja/3.14/library/datetime.html#">Python Documentation &gt; datetime — 基本的な日付と時間の型</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <category>SQL</category>
  <category>shell</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-09-create-calendar-table/</guid>
  <pubDate>Tue, 09 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>P-valueの考え方</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/</link>
  <description><![CDATA[ 






<section id="p-valueの定義" class="level2">
<h2 class="anchored" data-anchor-id="p-valueの定義">P-valueの定義</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">P value</span></p>
<p>データにばらつきがある場合，ばらつきだけの原因で評価指標が観測された以上の大きな値を取る確率</p>
</div>
<p>P値はNHSTの文脈で用いられる指標です．統計的文脈に則した定義を与えるとすると，</p>
<p><img src="https://latex.codecogs.com/png.latex?H_o:%20%20%5Ctheta%20%5Cin%20%5CTheta_0"> vs <img src="https://latex.codecogs.com/png.latex?H_o:%20%20%5Ctheta%20%5Cnotin%20%5CTheta_0"> なるNHSTにおいて，棄却域が</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5C%7B%5Cpmb%20x%20%7C%20W(%5Cpmb%20x)%20%3E%20c%5C%7D%0A"></p>
<p>で与えられる検定を考えます．このとき</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x)%20=%20%5Csup_%7B%5Ctheta%20%5Cin%20%5CTheta_0%7D%20P_%5Ctheta%20(W(%5Cpmb%20X)%20%5Cgeq%20W(%5Cpmb%20x))%0A"></p>
<p>をP値もしくは有意確率といいます．</p>
<div id="thm-bound" class="custom_problem blog-custom-border theorem">
<p><span class="theorem-title"><strong>Theorem 1</strong></span> <span class="def-title">Type I エラーのバウンド</span></p>
<p>すべての <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cin%20%5CTheta_0"> とすべての <img src="https://latex.codecogs.com/png.latex?%5Calpha%20%5Cin%20(0,%201)"> について</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20%5Calpha%0A"></p>
<p>が成り立つ．</p>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cin%20%5CTheta_0"> を任意に固定して</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x%20%7C%20%5Ctheta)%20=%20P_%5Ctheta(W(%5Cpmb%20X)%20%5Cgeq%20W(%5Cpmb%20x))%0A"></p>
<p>とおきます．<img src="https://latex.codecogs.com/png.latex?-W(%5Cpmb%20X)"> の分布関数を <img src="https://latex.codecogs.com/png.latex?F_%5Ctheta(w)"> とすると</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cpmb%20x%20%7C%20%5Ctheta)%0A%20%20&amp;=%20P_%5Ctheta(-W(%5Cpmb%20X)%20%5Cleq%20-W(%5Cpmb%20x))%5C%5C%5B5pt%5D%0A%20%20&amp;=%20F_%5Ctheta(-W(%5Cpmb%20x))%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p><img src="https://latex.codecogs.com/png.latex?F_%5Ctheta(-W(%5Cpmb%20X))"> は分布関数 <img src="https://latex.codecogs.com/png.latex?F_%5Ctheta"> に <img src="https://latex.codecogs.com/png.latex?-W(%5Cpmb%20X)"> を代入したものなので，<img src="https://latex.codecogs.com/png.latex?(0,%201)"> 上に一様分布します． したがって，確率測度 <img src="https://latex.codecogs.com/png.latex?P_%5Ctheta"> に対して</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X%20%7C%20%5Ctheta)%20%5Cleq%20%5Calpha)%20=%20P_%5Ctheta(F_%5Ctheta(-W(%5Cpmb%20X))%5Cleq%20%5Calpha)%20=%20%5Calpha%0A"></p>
<p>定義より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x)%20=%20%5Csup_%7B%5Ctheta%5E%5Cprime%20%5Cin%20%5CTheta_0%7D%20p(%5Cpmb%20x%20%7C%20%5Ctheta%5E%5Cprime)%20%5Cgeq%20p(%5Cpmb%20x%20%7C%20%5Ctheta)%0A"></p>
<p>であるので</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20P_%5Ctheta(p(%5Cpmb%20X%20%7C%20%5Ctheta)%20%5Cleq%20%5Calpha)%20=%20%5Calpha%0A"></p>
</div>
</div>
</div>
<p>この定理は，<strong>帰無仮説が真であるとき，p値が <img src="https://latex.codecogs.com/png.latex?%5Calpha"> 以下となる確率（＝Type I error rate）は高々 <img src="https://latex.codecogs.com/png.latex?%5Calpha"> である</strong>ことを保証しています．</p>
<p>わかりやすいイメージとして，指示関数 <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B1%7D%5C%7Bp(%5Cpmb%20X)%20%5Cleq%20%5Calpha%5C%7D"> を考えます．この関数は</p>
<ul>
<li>p値が <img src="https://latex.codecogs.com/png.latex?%5Calpha"> 以下のとき <img src="https://latex.codecogs.com/png.latex?1">（帰無仮説を棄却）</li>
<li>p値が <img src="https://latex.codecogs.com/png.latex?%5Calpha"> より大きいとき <img src="https://latex.codecogs.com/png.latex?0">（帰無仮説を棄却しない）</li>
</ul>
<p>を返します．帰無仮説が真のもとで繰り返しサンプリングを行い，この指示関数の値を記録すると，その平均（＝棄却する割合）は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE_%5Ctheta%5B%5Cmathbf%7B1%7D%5C%7Bp(%5Cpmb%20X)%20%5Cleq%20%5Calpha%5C%7D%5D%20=%20P_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20%5Calpha%0A"></p>
<p>となります．つまり，<strong>帰無仮説が真であるにもかかわらず誤って棄却してしまう割合は，長期的に見て <img src="https://latex.codecogs.com/png.latex?%5Calpha"> 以下に抑えられる</strong>ということです．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1</strong></span> <br></p>
<p><img src="https://latex.codecogs.com/png.latex?X_1,%20%5Ccdots.%20X_n%20%5Coverset%7B%5Cmathrm%7Biid%7D%7D%7B%5Csim%7D%20%20N(%5Cmu,%20%5Csigma%5E2_0)"> とし，<img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_0"> は既知であるとする．</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?H_0:%20%5Cmu%20=%20%5Cmu_0"></li>
<li><img src="https://latex.codecogs.com/png.latex?H_1:%20%5Cmu%20=%5Cneq%20%5Cmu_0"></li>
</ul>
<p>となる両側検定については，検定統計量は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AW(%5Cbar%20X)%20=%20%5Csqrt%7Bn%7D%7C%5Cbar%20X%20-%20%5Cmu_0%7C/%5Csigma_0%0A"></p>
<p>となり，有意水準 <img src="https://latex.codecogs.com/png.latex?%5Calpha"> について，対応する棄却域は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5C%7B%5Cbar%20x%20%7C%20W(%5Cbar%20x)%20%3E%20z_%7B%5Calpha/2%7D%5C%7D%0A"></p>
<p>このとき，<img src="https://latex.codecogs.com/png.latex?Z%20=%20%5Csqrt%7Bn%7D(%5Cbar%20X%20-%20%5Cmu_0)/%5Csigma_0"> とおくと，<img src="https://latex.codecogs.com/png.latex?W(%5Cbar%20X)%20=%20%7CZ%7C"> になります．また，<img src="https://latex.codecogs.com/png.latex?H_0"> のもとで <img src="https://latex.codecogs.com/png.latex?Z%20%5Csim%20N(0,%201)"> であるので</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cbar%20x)%0A%20%20&amp;=%20P_%7B%5Cmu_0%7D(W(%5Cbar%20X)%20%5Cgeq%20W(%5Cbar%20x))%5C%5C%0A%20%20&amp;=%20P(%7CZ%7C%20%5Cgeq%20%5Csqrt%7Bn%7D%7C%5Cbar%20x%20-%20%5Cmu%7C/%5Csigma_0)%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbar%20x%20%5Cin%20R"> のときは</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cbar%20x)%0A%20%20&amp;=%20P(%7CZ%7C%20%5Cgeq%20%5Csqrt%7Bn%7D%7C%5Cbar%20x%20-%20%5Cmu_0%7C/%5Csigma_0)%5C%5C%0A%20%20&amp;%5Cleq%20P(%7CZ%7C%20%5Cgeq%20z_%7B%5Calpha/2%7D)%20=%20%5Calpha%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>したがって，定理 Theorem&nbsp;1 より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%7B%5Cmu_0%7D(p(%5Cbar%20X)%20%5Cleq%20%5Calpha)%20=%20%5Calpha%0A"></p>
<p>となります．仮にデータを観測して <img src="https://latex.codecogs.com/png.latex?p(%5Cbar%20x)%20%3C%200.01"> となるとき．<img src="https://latex.codecogs.com/png.latex?H_0"> のもとで，P値が0.01より小さくなる確率は 0.01 より小さいことがわかります．</p>
</div>
<hr>
</section>
<section id="統計的判定とドメイン領域判定" class="level2">
<h2 class="anchored" data-anchor-id="統計的判定とドメイン領域判定">統計的判定とドメイン領域判定</h2>
<p>医薬品の臨床試験においては、<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bp-value%7D%3C%5Calpha"> のとき「統計的に有意である」と判定し，帰無仮説（処置効果が存在しない）を棄却する，というプロトコルが用いられます．</p>
<p>しかし，この判定は<span class="regmonnkey-bold">あくまで統計的判定であり，医学的に意味のある処置効果が存在することを直接示すものではない</span>です．P値はあくまで，</p>
<ul>
<li>データにばらつきがある場合，ばらつきだけの原因で評価指標が観測された以上の大きな値を取る確率</li>
</ul>
<p>を表す量であり，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20%5Calpha%20%5C,%20%5C%20(%5Ctheta%20%5Cin%20%5CTheta_0)%0A"></p>
<p>を用いたNeyman-Pearson流の意思決定フレームワークにおけるType I Error制御にすぎません．「医薬品の効果があった」という医学的判定とは異なります． 医学的判定において重要なのは，</p>
<ul>
<li>効果量の大きさが臨床的に意味のある水準か</li>
<li>副作用や安全性とのバランスは妥当か</li>
<li>除外すべき患者がデータに含まれていないか？</li>
</ul>
<p>といったP-valueの枠外の観点と照らし合わせて，結果を解釈して意思決定を行うことです．</p>
<p>統計的判定が得られなければ，医学的判断の対象にはなりえない，といったプロトコルを事前に作成して統計的判定の指標としてP値を用いるのはよいですが， P値そのものは医学的有効性や臨床的価値の判断とは切り分けて解釈されるべきです．</p>
</section>
<section id="p-valueをベイズ的に考える" class="level2">
<h2 class="anchored" data-anchor-id="p-valueをベイズ的に考える">p-valueをベイズ的に考える</h2>
<p>p-value を用いた統計的判定では、対立仮説 <img src="https://latex.codecogs.com/png.latex?H_1"> が成立すると結論づけるために，まず帰無仮説 <img src="https://latex.codecogs.com/png.latex?H_0"> を設定し，そのもとで観測データがどの程度「起こりにくいか」を評価する、という手続きを取ります．</p>
<p>ここで，p-valueをベイズ的な観点で考えてみます． データ確認前に持っている仮説に対する信念を事前確率 <img src="https://latex.codecogs.com/png.latex?P(H_0),%20P(H_1)"> として表すとして，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5Cfrac%7BP(H_1)%7D%7BP(H_0)%7D%0A"></p>
<p>という事前オッズを考えることができます．これはデータを観測する前の段階で，どちらの仮説を支持するかを表す量となります</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20%5Cgeq%201%0A"></p>
<p>であるならば，<img src="https://latex.codecogs.com/png.latex?H_0"> よりも <img src="https://latex.codecogs.com/png.latex?H_1"> のほうが起こりやすいと想定していることになります．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5C%7B%0A%20%20%5Cbegin%7Barray%7D%7Bc%7D%0A%20%20%20%20H_0:%20%5CDelta%20%5Cleq%200%5C%5C%0A%20%20%20%20H_1:%20%5CDelta%20%3E%200%5C%5C%0A%20%20%5Cend%7Barray%7D%5Cright.%0A"></p>
<p>および検定統計量を <img src="https://latex.codecogs.com/png.latex?T">, データから計算される <img src="https://latex.codecogs.com/png.latex?T"> の値を <img src="https://latex.codecogs.com/png.latex?t_0"> とする検定をおこなったとき，p-valueは定義より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bp-value%7D%20=%20Pr(T%20%5Cgeq%20t_0%20%7C%20H_0)%0A"></p>
<p>ここでベイズの定理を用いると</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Coperatorname%7BPr%7D%5Cleft(H_1%20%5Cmid%20T%20%5Cgeq%20t_0%5Cright)%20&amp;%0A%20%20=%5Cfrac%7B%5Coperatorname%7BPr%7D%5Cleft(H_1,%20T%20%5Cgeq%20t_0%5Cright)%7D%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%5Cright)%7D%20%5C%5C%0A%20%20&amp;%20=%5Cfrac%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%20%5Cmid%20H_1%5Cright)%20%5Coperatorname%7BPr%7D%5Cleft(H_1%5Cright)%7D%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%7CH_0%5Cright)%20%5Coperatorname%7BP%7D%5Cleft(H_0%5Cright)%20+%20%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%7CH_1%5Cright)%20%5Coperatorname%7BP%7D%5Cleft(H_1%5Cright)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%20%5Cmid%20H_1%5Cright)%20R%7D%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%7CH_0%5Cright)%20+%20%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%7CH_1%5Cright)%20R%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%20%5Cmid%20H_1%5Cright)%20R%7D%7B%5Ctext%7Bp-value%7D%20+%20%5Coperatorname%7BPr%7D%5Cleft(T%20%5Cgeq%20t_0%7CH_1%5Cright)%20R%7D%0A%5Cend%7Balign%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BPr%7D(T%5Cgeq%20t_0%20%7C%20H_1)"> は検出力に対応することを考えると，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BPr%7D%5Cleft(H_1%20%5Cmid%20T%20%5Cgeq%20t_0%5Cright)%20=%20%5Cfrac%7B%5Ctext%7Bpower%7D%20%5Ctimes%20R%7D%7B%5Ctext%7Bp-value%7D%20+%20%5Ctext%7Bpower%7D%20%5Ctimes%20R%7D%0A"></p>
<section id="シミュレーション-検出力p-value事前オッズと事後確率の関係" class="level3">
<h3 class="anchored" data-anchor-id="シミュレーション-検出力p-value事前オッズと事後確率の関係">シミュレーション: 検出力・p-value・事前オッズと事後確率の関係</h3>
<p>検出力（power），p-value，事前オッズ <img src="https://latex.codecogs.com/png.latex?R"> を動かしたときの <img src="https://latex.codecogs.com/png.latex?%5CPr(H_1%20%7C%20T%20%5Cgeq%20t_0)"> を計算してみます．</p>
<div id="c0193bf4" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>テーブル表示</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> posterior_prob(power, p_value, R):</span>
<span id="cb1-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Pr(H1 | T &gt;= t0) を計算"""</span></span>
<span id="cb1-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> R) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> R)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータの組み合わせ</span></span>
<span id="cb1-9">Rs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>]</span>
<span id="cb1-10">powers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>]</span>
<span id="cb1-11">p_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>]</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># マルチインデックステーブル作成</span></span>
<span id="cb1-14">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.MultiIndex.from_product([Rs, powers], names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Power"</span>])</span>
<span id="cb1-15">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>index, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> p_values])</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> R <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Rs:</span>
<span id="cb1-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> power <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> powers:</span>
<span id="cb1-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> p_values:</span>
<span id="cb1-20">            df.loc[(R, power), <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> posterior_prob(power, p, R)</span>
<span id="cb1-21"></span>
<span id="cb1-22">df.columns.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p-value"</span></span>
<span id="cb1-23">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-24">df</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">p-value</th>
<th data-quarto-table-cell-role="th">0.001</th>
<th data-quarto-table-cell-role="th">0.01</th>
<th data-quarto-table-cell-role="th">0.05</th>
<th data-quarto-table-cell-role="th">0.1</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">R</th>
<th data-quarto-table-cell-role="th">Power</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="6" data-quarto-table-cell-role="th" data-valign="top">0.5</th>
<th data-quarto-table-cell-role="th">0.05</th>
<td>0.962</td>
<td>0.714</td>
<td>0.333</td>
<td>0.200</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.10</th>
<td>0.980</td>
<td>0.833</td>
<td>0.500</td>
<td>0.333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.20</th>
<td>0.990</td>
<td>0.909</td>
<td>0.667</td>
<td>0.500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.40</th>
<td>0.995</td>
<td>0.952</td>
<td>0.800</td>
<td>0.667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.60</th>
<td>0.997</td>
<td>0.968</td>
<td>0.857</td>
<td>0.750</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.80</th>
<td>0.998</td>
<td>0.976</td>
<td>0.889</td>
<td>0.800</td>
</tr>
<tr class="odd">
<th rowspan="6" data-quarto-table-cell-role="th" data-valign="top">1.0</th>
<th data-quarto-table-cell-role="th">0.05</th>
<td>0.980</td>
<td>0.833</td>
<td>0.500</td>
<td>0.333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.10</th>
<td>0.990</td>
<td>0.909</td>
<td>0.667</td>
<td>0.500</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.20</th>
<td>0.995</td>
<td>0.952</td>
<td>0.800</td>
<td>0.667</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.40</th>
<td>0.998</td>
<td>0.976</td>
<td>0.889</td>
<td>0.800</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.60</th>
<td>0.998</td>
<td>0.984</td>
<td>0.923</td>
<td>0.857</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.80</th>
<td>0.999</td>
<td>0.988</td>
<td>0.941</td>
<td>0.889</td>
</tr>
<tr class="odd">
<th rowspan="6" data-quarto-table-cell-role="th" data-valign="top">2.0</th>
<th data-quarto-table-cell-role="th">0.05</th>
<td>0.990</td>
<td>0.909</td>
<td>0.667</td>
<td>0.500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.10</th>
<td>0.995</td>
<td>0.952</td>
<td>0.800</td>
<td>0.667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.20</th>
<td>0.998</td>
<td>0.976</td>
<td>0.889</td>
<td>0.800</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.40</th>
<td>0.999</td>
<td>0.988</td>
<td>0.941</td>
<td>0.889</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.60</th>
<td>0.999</td>
<td>0.992</td>
<td>0.960</td>
<td>0.923</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.80</th>
<td>0.999</td>
<td>0.994</td>
<td>0.970</td>
<td>0.941</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>上記テーブルから以下のことがわかります：</p>
<ul>
<li><strong>p-value が小さいほど</strong>：<img src="https://latex.codecogs.com/png.latex?%5CPr(H_1%20%7C%20T%20%5Cgeq%20t_0)"> は大きくなる</li>
<li><strong>検出力が高いほど</strong>：<img src="https://latex.codecogs.com/png.latex?%5CPr(H_1%20%7C%20T%20%5Cgeq%20t_0)"> は大きくなる</li>
<li><strong>事前オッズ <img src="https://latex.codecogs.com/png.latex?R"> が大きいほど</strong>：<img src="https://latex.codecogs.com/png.latex?%5CPr(H_1%20%7C%20T%20%5Cgeq%20t_0)"> は大きくなる</li>
</ul>
<p>特に，検出力が低い場合（power = 0.05）では，<img src="https://latex.codecogs.com/png.latex?R%20=%201">, p-value が 0.05 であっても事後確率は約 50% にとどまり，<img src="https://latex.codecogs.com/png.latex?H_1"> が正しいとは言い難い状況になります．</p>
</section>
</section>
<section id="シミュレーション-one-sample-t検定と-p-value-の分布" class="level2">
<h2 class="anchored" data-anchor-id="シミュレーション-one-sample-t検定と-p-value-の分布">シミュレーション: One-sample t検定と p-value の分布</h2>
<p>ガンマ分布からサンプルを生成して one-sample t 検定を行います．</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?H_0:%20%5Cmu%20=%200"></li>
<li><img src="https://latex.codecogs.com/png.latex?H_1:%20%5Cmu%20%5Cneq%200"></li>
</ul>
<p>真の分布として <img src="https://latex.codecogs.com/png.latex?X%20%5Csim%20%5Ctext%7BGamma%7D(2,%201)%20-%201.85"> を仮定します（<img src="https://latex.codecogs.com/png.latex?E%5BX%5D%20=%200.15%20%3E%200">，右に歪んだ分布）．</p>
<div id="3fc67948" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>真の分布</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シフトしたガンマ分布の確率密度関数</span></span>
<span id="cb2-6">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb2-7">shift <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span></span>
<span id="cb2-8">pdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.gamma.pdf(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shift, a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb2-11">ax.plot(x, pdf, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b-'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">X </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\s</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">im </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\m</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">athrm{Gamma}</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">2, 1</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> - 1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">85</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb2-12">ax.fill_between(x, pdf, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb2-13">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\m</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">u_0 = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb2-14">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">E</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[X]</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">15</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">true mean</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb2-15">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb2-16">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Density'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb2-17">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True Distribution (Shifted Gamma)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb2-18">ax.legend()</span>
<span id="cb2-19">ax.set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-20">ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb2-21">plt.tight_layout()</span>
<span id="cb2-22">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-3-output-1.png" width="663" height="375" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?H_1"> が真である状況で，サンプルサイズ <img src="https://latex.codecogs.com/png.latex?n"> を変えたときの p-value の分布を確認します．</p>
<p>まず，理論検出力を計算します．<img src="https://latex.codecogs.com/png.latex?H_0:%20%5Cmu%20=%200"> に対する片側 t 検定の検出力は，非心度パラメータ</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdelta%20=%20%5Cfrac%7B%5Cmu%20-%20%5Cmu_0%7D%7B%5Csigma%20/%20%5Csqrt%7Bn%7D%7D%20=%20%5Cfrac%7B0.15%7D%7B%5Csqrt%7B2%7D%20/%20%5Csqrt%7Bn%7D%7D%20=%200.15%20%5Csqrt%7Bn/2%7D%0A"></p>
<p>を用いて，非心 t 分布から計算できます（<img src="https://latex.codecogs.com/png.latex?%5Ctext%7BGamma%7D(2,1)"> の分散は 2）．</p>
<div id="92bce30c" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>理論検出力</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ</span></span>
<span id="cb3-4">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb3-5">mu_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span></span>
<span id="cb3-6">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gamma(2,1) の標準偏差</span></span>
<span id="cb3-7">sample_sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論検出力の計算</span></span>
<span id="cb3-10">power_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb3-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 非心度パラメータ</span></span>
<span id="cb3-13">    ncp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n))</span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 臨界値 (中心t分布)</span></span>
<span id="cb3-15">    t_crit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.t.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 検出力 (非心t分布)</span></span>
<span id="cb3-17">    power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stats.nct.cdf(t_crit, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ncp)</span>
<span id="cb3-18">    power_results.append({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>: n, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"非心度 $</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">delta$"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(ncp, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"理論検出力"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(power, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)})</span>
<span id="cb3-19"></span>
<span id="cb3-20">pl.DataFrame(power_results)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (6, 3)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">非心度 $\delta$</th>
<th data-quarto-table-cell-role="th">理論検出力</th>
</tr>
<tr class="even">
<td>i64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>50</td>
<td>0.75</td>
<td>0.11</td>
</tr>
<tr class="even">
<td>100</td>
<td>1.061</td>
<td>0.182</td>
</tr>
<tr class="odd">
<td>200</td>
<td>1.5</td>
<td>0.32</td>
</tr>
<tr class="even">
<td>300</td>
<td>1.837</td>
<td>0.449</td>
</tr>
<tr class="odd">
<td>500</td>
<td>2.372</td>
<td>0.658</td>
</tr>
<tr class="even">
<td>1000</td>
<td>3.354</td>
<td>0.918</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="e870e63e" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>p-value シミュレーション</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ</span></span>
<span id="cb4-4">sample_sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]</span>
<span id="cb4-5">n_simulations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーション</span></span>
<span id="cb4-7">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_simulations):</span>
<span id="cb4-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ガンマ分布からサンプル生成 (E[X] = 2 - 1.85 = 0.15, 右に歪んだ分布)</span></span>
<span id="cb4-12">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.gamma(shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span></span>
<span id="cb4-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># one-sample t検定 (H1: mean != 0)</span></span>
<span id="cb4-14">        t_stat, p_two_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_1samp(X, popmean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span>)</span>
<span id="cb4-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 片側検定に変換</span></span>
<span id="cb4-16">        results[n].append(p_two_sided)</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Box plot</span></span>
<span id="cb4-19">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb4-20">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [results[n] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes]</span>
<span id="cb4-21">bp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.boxplot(data, tick_labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes], patch_artist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 色設定</span></span>
<span id="cb4-24">colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.cm.viridis(np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sample_sizes)))</span>
<span id="cb4-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> patch, color <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(bp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"boxes"</span>], colors):</span>
<span id="cb4-26">    patch.set_facecolor(color)</span>
<span id="cb4-27">    patch.set_alpha(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span>
<span id="cb4-28"></span>
<span id="cb4-29">ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">05</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-30">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample Size"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb4-31">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p-value"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb4-32">ax.set_title(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"p-value Distribution under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">One-sample t-test</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb4-33">ax.legend()</span>
<span id="cb4-34">ax.set_ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb4-35"></span>
<span id="cb4-36">plt.tight_layout()</span>
<span id="cb4-37">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-5-output-1.png" width="759" height="566" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ee48743c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>p-value 分布のヒストグラム</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb5-2">axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.flatten()</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sample_sizes):</span>
<span id="cb5-5">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[idx]</span>
<span id="cb5-6">    bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.05刻み</span></span>
<span id="cb5-7">    ax.hist(</span>
<span id="cb5-8">        results[n],</span>
<span id="cb5-9">        bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins,</span>
<span id="cb5-10">        weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.ones(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(results[n])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(results[n]),</span>
<span id="cb5-11">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb5-12">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors[idx],</span>
<span id="cb5-13">        edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb5-14">    )</span>
<span id="cb5-15">    ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">05</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-16"></span>
<span id="cb5-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーションでの棄却率</span></span>
<span id="cb5-18">    rejection_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.mean(np.array(results[n]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb5-19">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (rejection rate: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rejection_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb5-20">    ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p-value"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-21">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-22">    ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-23">    ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb5-24"></span>
<span id="cb5-25">plt.suptitle(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"p-value Distribution under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>)</span>
<span id="cb5-26">plt.tight_layout()</span>
<span id="cb5-27">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-6-output-1.png" width="950" height="788" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?H_1"> が真である状況では，サンプルサイズが大きくなるほど検出力が上がり，p-value は小さい値に集中していきます．シミュレーションによる棄却率は理論検出力とほぼ一致することが確認できます．</p>
<section id="対数正規分布の場合" class="level3">
<h3 class="anchored" data-anchor-id="対数正規分布の場合">対数正規分布の場合</h3>
<p>より裾が重い分布として，<img src="https://latex.codecogs.com/png.latex?X%20%5Csim%20%5Ctext%7BLogNormal%7D(0,%201)%20-%201.5"> を考えます（<img src="https://latex.codecogs.com/png.latex?E%5BX%5D%20=%20e%5E%7B0.5%7D%20-%201.5%20%5Capprox%200.149%20%3E%200">）． この確率変数列に対して， one-sample t 検定を行います．</p>
<div id="2e76588d" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>対数正規分布の真の分布</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 対数正規分布 - 1.5 の確率密度関数</span></span>
<span id="cb6-2">shift_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb6-3">x_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb6-4">pdf_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.lognorm.pdf(x_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shift_ln, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb6-5"></span>
<span id="cb6-6">mu_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> shift_ln  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># E[X] = exp(mu + sigma^2/2) - shift</span></span>
<span id="cb6-7">sigma_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(</span>
<span id="cb6-8">    (np.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-9">)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Var[X] = (exp(sigma^2) - 1) * exp(2mu + sigma^2)</span></span>
<span id="cb6-10"></span>
<span id="cb6-11">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb6-12">ax.plot(x_ln, pdf_ln, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b-"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">X </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\s</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">im </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\m</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">athrm{LogNormal}</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">0, 1</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> - 1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">5</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-13">ax.fill_between(x_ln, pdf_ln, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb6-14">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\m</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">u_0 = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-15">ax.axvline(</span>
<span id="cb6-16">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mu_ln,</span>
<span id="cb6-17">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green"</span>,</span>
<span id="cb6-18">    linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>,</span>
<span id="cb6-19">    lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb6-20">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"$E[X] = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_ln<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$ (true mean)"</span>,</span>
<span id="cb6-21">)</span>
<span id="cb6-22">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb6-23">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb6-24">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Distribution (Shifted LogNormal)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb6-25">ax.legend()</span>
<span id="cb6-26">ax.set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-27">ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb6-28">plt.tight_layout()</span>
<span id="cb6-29">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-7-output-1.png" width="663" height="375" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a7920e69" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>理論検出力（対数正規分布）</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論検出力の計算</span></span>
<span id="cb7-2">power_results_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb7-4">    ncp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n))</span>
<span id="cb7-5">    t_crit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.t.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-6">    power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stats.nct.cdf(t_crit, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ncp)</span>
<span id="cb7-7">    power_results_ln.append(</span>
<span id="cb7-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>: n, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"非心度 $</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">delta$"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(ncp, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"理論検出力"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(power, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)}</span>
<span id="cb7-9">    )</span>
<span id="cb7-10"></span>
<span id="cb7-11">pl.DataFrame(power_results_ln)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (6, 3)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">非心度 $\delta$</th>
<th data-quarto-table-cell-role="th">理論検出力</th>
</tr>
<tr class="even">
<td>i64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>50</td>
<td>0.487</td>
<td>0.069</td>
</tr>
<tr class="even">
<td>100</td>
<td>0.688</td>
<td>0.101</td>
</tr>
<tr class="odd">
<td>200</td>
<td>0.973</td>
<td>0.161</td>
</tr>
<tr class="even">
<td>300</td>
<td>1.192</td>
<td>0.22</td>
</tr>
<tr class="odd">
<td>500</td>
<td>1.539</td>
<td>0.336</td>
</tr>
<tr class="even">
<td>1000</td>
<td>2.176</td>
<td>0.585</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="50f9dc96" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>p-value シミュレーション（対数正規分布）</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーション</span></span>
<span id="cb8-4">results_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb8-5">means_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb8-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_simulations):</span>
<span id="cb8-9">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.lognormal(mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb8-10">        means_ln[n].append(np.mean(X))</span>
<span id="cb8-11">        t_stat, p_one_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_1samp(X, popmean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two-sided"</span>)</span>
<span id="cb8-12">        results_ln[n].append(p_one_sided)</span>
<span id="cb8-13"></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヒストグラム</span></span>
<span id="cb8-15">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb8-16">axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.flatten()</span>
<span id="cb8-17"></span>
<span id="cb8-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sample_sizes):</span>
<span id="cb8-19">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[idx]</span>
<span id="cb8-20">    bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)</span>
<span id="cb8-21">    ax.hist(</span>
<span id="cb8-22">        results_ln[n],</span>
<span id="cb8-23">        bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins,</span>
<span id="cb8-24">        weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.ones(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(results_ln[n])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(results_ln[n]),</span>
<span id="cb8-25">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb8-26">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors[idx],</span>
<span id="cb8-27">        edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb8-28">    )</span>
<span id="cb8-29">    ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">05</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-30"></span>
<span id="cb8-31">    rejection_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.mean(np.array(results_ln[n]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb8-32">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (rejection rate: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rejection_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb8-33">    ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p-value"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb8-34">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb8-35">    ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-36">    ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb8-37"></span>
<span id="cb8-38">plt.suptitle(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"p-value Distribution under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">LogNormal - 1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">5</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>)</span>
<span id="cb8-39">plt.tight_layout()</span>
<span id="cb8-40">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-9-output-1.png" width="950" height="788" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7491a9a5" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>標本平均の分布（対数正規分布）</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb9-2">axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.flatten()</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sample_sizes):</span>
<span id="cb9-5">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[idx]</span>
<span id="cb9-6">    mean_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(means_ln[n])</span>
<span id="cb9-7"></span>
<span id="cb9-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヒストグラム</span></span>
<span id="cb9-9">    ax.hist(</span>
<span id="cb9-10">        mean_data,</span>
<span id="cb9-11">        bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb9-12">        density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-13">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb9-14">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors[idx],</span>
<span id="cb9-15">        edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb9-16">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simulation"</span>,</span>
<span id="cb9-17">    )</span>
<span id="cb9-18"></span>
<span id="cb9-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論的な正規分布（CLT）</span></span>
<span id="cb9-20">    se <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sigma_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n)</span>
<span id="cb9-21">    x_norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(mean_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), mean_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb9-22">    ax.plot(</span>
<span id="cb9-23">        x_norm,</span>
<span id="cb9-24">        stats.norm.pdf(x_norm, loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mu_ln, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>se),</span>
<span id="cb9-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r-"</span>,</span>
<span id="cb9-26">        lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb9-27">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"CLT: N(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_ln<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>se<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">²)"</span>,</span>
<span id="cb9-28">    )</span>
<span id="cb9-29"></span>
<span id="cb9-30">    ax.axvline(</span>
<span id="cb9-31">        x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mu_ln, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"True mean = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_ln<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb9-32">    )</span>
<span id="cb9-33">    ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\m</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">u_0 = 0</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-34">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb9-35">    ax.set_xlabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\b</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ar{X}</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb9-36">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb9-37">    ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb9-38"></span>
<span id="cb9-39">plt.suptitle(</span>
<span id="cb9-40">    <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"Sampling Distribution of </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\b</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ar{X}</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">LogNormal - 1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">5</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span></span>
<span id="cb9-41">)</span>
<span id="cb9-42">plt.tight_layout()</span>
<span id="cb9-43">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-10-output-1.png" width="950" height="983" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>対数正規分布はガンマ分布より裾が重く歪みも大きいため，t検定の正規性仮定からの乖離が大きくなります．標本平均の分布を見ると，サンプルサイズが小さいときは右に歪んでいますが，<img src="https://latex.codecogs.com/png.latex?n"> が大きくなるとCLTにより正規分布に近づいていくことが確認できます．</p>
</section>
</section>
<section id="appendix-h_1-mu-0-のときのp-valueの分布" class="level2">
<h2 class="anchored" data-anchor-id="appendix-h_1-mu-0-のときのp-valueの分布">Appendix: <img src="https://latex.codecogs.com/png.latex?H_1:%20%5Cmu%20%3E%200"> のときのp-valueの分布</h2>
<p><img src="https://latex.codecogs.com/png.latex?%5C%7BX_i%5C%7D_%7Bi=1%7D%5En%20%5Coverset%7B%5Cmathrm%7Biid%7D%7D%7B%5Csim%7D%20G(%5Cmu,%20%5Csigma%5E2)"> となる確率変数列に対するone-sample t testを考えます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5C%7B%5Cbegin%7Barray%7D%7Bc%7D%0AH_0:%20%5Cmu%20%5Cleq%200%5C%5C%0AH_1:%20%5Cmu%20%3E%200%0A%5Cend%7Barray%7D%5Cright.%0A"></p>
<p>と帰無仮説と対立仮説を設定し，検定統計量 <img src="https://latex.codecogs.com/png.latex?T"> は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AT%20=%20%5Cfrac%7B%5Cbar%20X%20-%20%5Cmu_0%7D%7B%5Chat%5Csigma%20/%20%5Csqrt%7Bn%7D%7D%0A"></p>
<p>とします．データから <img src="https://latex.codecogs.com/png.latex?T%20=%20t_0"> を得られたとして，このときのp-valueは定義より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bp-value%7D%20=%20%5Coperatorname%7BPr%7D(T%20%3E%20t_0%20%7C%20H_0)%20=%201%20-%20F_%7Bt(n-1)%7D(t_0)%0A"></p>
<p>CLTが成立するとすると</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbar%7BX%7D%20%5Csim%20N%5Cleft(%5Cmu,%20%5Cfrac%7B%5Csigma%5E2%7D%7Bn%7D%5Cright)%0A"></p>
<p>したがって，<img src="https://latex.codecogs.com/png.latex?H_1"> が真のときの <img src="https://latex.codecogs.com/png.latex?T"> は漸近的に</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AT%20=%20%5Cfrac%7B%5Cbar%7BX%7D%20-%20%5Cmu_1%7D%7B%5Csigma/%5Csqrt%7Bn%7D%7D%5Cfrac%7B%5Csigma%7D%7B%5Chat%5Csigma%7D%20+%20%5Cfrac%7B%5Cmu_1%20-%20%5Cmu_0%7D%7B%5Csigma/%5Csqrt%7Bn%7D%7D%5Cfrac%7B%5Csigma%7D%7B%5Chat%5Csigma%7D%0A"></p>
<p>RHSの第一項は連続写像定理およびSlutskyの定理より <img src="https://latex.codecogs.com/png.latex?N(0,%201)"> に分布収束．RHSの第二項が非心パラメータ <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> として</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdelta%20=%20%5Cfrac%7B%5Cmu_1%7D%7B%5Csigma/%5Csqrt%7Bn%7D%7D%0A"></p>
<p>したがって，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AT%20%5Csim%20N%5Cleft(%5Cfrac%7B%5Cmu_1%7D%7B%5Csigma/%5Csqrt%7Bn%7D%7D,%201%5Cright)%0A"></p>
<p>このとき，p-valueの分布関数 <img src="https://latex.codecogs.com/png.latex?F_p"> は</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AF_p(%5Calpha)%0A%20%20&amp;=%20%5Coperatorname%7BPr%7D(%5Ctext%7Bp-value%7D%5Cleq%20%5Calpha)%5C%5C%5B5pt%5D%0A%20%20&amp;=%20%5Coperatorname%7BPr%7D(1%20-%20F_%7Bt(n-1)%7D(T)%20%5Cleq%20%5Calpha)%5C%5C%5B5pt%5D%0A%20%20&amp;=%201%20-%20%5Coperatorname%7BPr%7D(F_%7Bt(n-1)%7D(T)%20%5Cleq%201-%20%5Calpha)%5C%5C%5B5pt%5D%0A%20%20&amp;=%201%20-%20%5Coperatorname%7BPr%7D(T%20%5Cleq%20F_%7Bt(n-1)%7D%5E%7B-1%7D(1-%20%5Calpha))%5C%5C%5B5pt%5D%0A%20%20&amp;=%201%20-%20%5CPhi%5Cleft(F_%7Bt(n-1)%7D%5E%7B-1%7D(1-%20%5Calpha)%20-%20%5Cfrac%7B%5Cmu_1%7D%7B%5Csigma/%5Csqrt%7Bn%7D%7D%5Cright)%0A%5Cend%7Balign%7D%0A"></p>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (ガンマ分布one-sample test p-value CDFのシミュレーション)</strong></span> <br></p>
<div id="44098671" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ（Gamma分布の場合）</span></span>
<span id="cb10-2">mu_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 真の平均</span></span>
<span id="cb10-3">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gamma(2,1) の標準偏差</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> theoretical_pvalue_cdf(alpha, n, mu_1, sigma):</span>
<span id="cb10-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    理論的なp-value分布のCDF（漸近近似）</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    F_p(alpha) = 1 - Φ(F_{t(n-1)}^{-1}(1-alpha) - μ_1/(σ/√n))</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-11">    delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 非心度</span></span>
<span id="cb10-12">    t_quantile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.t.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stats.norm.cdf(t_quantile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> delta)</span>
<span id="cb10-14"></span>
<span id="cb10-15"></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット</span></span>
<span id="cb10-17">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb10-18">axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.flatten()</span>
<span id="cb10-19"></span>
<span id="cb10-20">alpha_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーション</span></span>
<span id="cb10-23">results_one_sieded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb10-24"></span>
<span id="cb10-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb10-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_simulations):</span>
<span id="cb10-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ガンマ分布からサンプル生成 (E[X] = 2 - 1.85 = 0.15, 右に歪んだ分布)</span></span>
<span id="cb10-28">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.gamma(shape<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span></span>
<span id="cb10-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># one-sample t検定 (H1: mean != 0)</span></span>
<span id="cb10-30">        t_stat, p_one_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_1samp(X, popmean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>)</span>
<span id="cb10-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 片側検定に変換</span></span>
<span id="cb10-32">        results_one_sieded[n].append(p_one_sided)</span>
<span id="cb10-33"></span>
<span id="cb10-34"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sample_sizes):</span>
<span id="cb10-35">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[idx]</span>
<span id="cb10-36"></span>
<span id="cb10-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーションによる経験的CDF</span></span>
<span id="cb10-38">    sorted_pvals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sort(results_one_sieded[n])</span>
<span id="cb10-39">    empirical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sorted_pvals) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sorted_pvals)</span>
<span id="cb10-40">    ax.step(</span>
<span id="cb10-41">        sorted_pvals, empirical_cdf, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"post"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simulation (ECDF)"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb10-42">    )</span>
<span id="cb10-43"></span>
<span id="cb10-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論的CDF（漸近正規近似）</span></span>
<span id="cb10-45">    theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [theoretical_pvalue_cdf(a, n, mu_1, sigma) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> alpha_grid]</span>
<span id="cb10-46">    ax.plot(alpha_grid, theoretical_cdf, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theory (Normal approx)"</span>)</span>
<span id="cb10-47"></span>
<span id="cb10-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 非心t分布による理論CDF（より正確）</span></span>
<span id="cb10-49">    delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n))</span>
<span id="cb10-50">    t_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.t.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_grid, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-51">    theoretical_cdf_nct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stats.nct.cdf(t_quantiles, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>delta)</span>
<span id="cb10-52">    ax.plot(alpha_grid, theoretical_cdf_nct, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"g-"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theory (Noncentral-t)"</span>)</span>
<span id="cb10-53"></span>
<span id="cb10-54">    ax.set_xlabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb10-55">    ax.set_ylabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">F_p</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb10-56">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb10-57">    ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb10-58">    ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-59">    ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-60">    ax.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k:"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Uniform (under $H_0$)"</span>)</span>
<span id="cb10-61"></span>
<span id="cb10-62">plt.suptitle(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"CDF of p-value under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">Gamma distribution</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>)</span>
<span id="cb10-63">plt.tight_layout()</span>
<span id="cb10-64">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-11-output-1.png" width="948" height="984" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (対数正規分布 one-sample test p-value CDFのシミュレーション)</strong></span> <br></p>
<div id="46e58b42" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># パラメータ（対数正規分布の場合）</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mu_ln, sigma_ln は既に定義済み</span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット</span></span>
<span id="cb11-5">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb11-6">axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.flatten()</span>
<span id="cb11-7"></span>
<span id="cb11-8">alpha_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーション</span></span>
<span id="cb11-11">results_ln_one_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb11-12">means_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n: [] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes}</span>
<span id="cb11-13"></span>
<span id="cb11-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sample_sizes:</span>
<span id="cb11-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_simulations):</span>
<span id="cb11-16">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.lognormal(mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb11-17">        means_ln[n].append(np.mean(X))</span>
<span id="cb11-18">        t_stat, p_one_sided <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_1samp(X, popmean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>)</span>
<span id="cb11-19">        results_ln_one_sided[n].append(p_one_sided)</span>
<span id="cb11-20"></span>
<span id="cb11-21"></span>
<span id="cb11-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sample_sizes):</span>
<span id="cb11-23">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[idx]</span>
<span id="cb11-24"></span>
<span id="cb11-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># シミュレーションによる経験的CDF</span></span>
<span id="cb11-26">    sorted_pvals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sort(results_ln_one_sided[n])</span>
<span id="cb11-27">    empirical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sorted_pvals) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sorted_pvals)</span>
<span id="cb11-28">    ax.step(</span>
<span id="cb11-29">        sorted_pvals, empirical_cdf, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"post"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simulation (ECDF)"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb11-30">    )</span>
<span id="cb11-31"></span>
<span id="cb11-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論的CDF（漸近正規近似）</span></span>
<span id="cb11-33">    theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb11-34">        theoretical_pvalue_cdf(a, n, mu_ln, sigma_ln) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> alpha_grid</span>
<span id="cb11-35">    ]</span>
<span id="cb11-36">    ax.plot(alpha_grid, theoretical_cdf, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r--"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theory (Normal approx)"</span>)</span>
<span id="cb11-37"></span>
<span id="cb11-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 非心t分布による理論CDF（より正確）</span></span>
<span id="cb11-39">    delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma_ln <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(n))</span>
<span id="cb11-40">    t_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.t.ppf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_grid, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-41">    theoretical_cdf_nct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stats.nct.cdf(t_quantiles, df<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>delta)</span>
<span id="cb11-42">    ax.plot(alpha_grid, theoretical_cdf_nct, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"g-"</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theory (Noncentral-t)"</span>)</span>
<span id="cb11-43"></span>
<span id="cb11-44">    ax.set_xlabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb11-45">    ax.set_ylabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">F_p</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb11-46">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"n = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb11-47">    ax.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb11-48">    ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-49">    ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-50">    ax.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k:"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Uniform (under $H_0$)"</span>)</span>
<span id="cb11-51"></span>
<span id="cb11-52">plt.suptitle(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"CDF of p-value under </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">H_1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">LogNormal - 1</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">5</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>)</span>
<span id="cb11-53">plt.tight_layout()</span>
<span id="cb11-54">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/index_files/figure-html/cell-12-output-1.png" width="948" height="984" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.kyoritsu-pub.co.jp/book/b10003681.html">久保川 - 現代数理統計学の基礎, 7.5.4</a></li>
</ul>


</section>

 ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/</guid>
  <pubDate>Fri, 05 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>NW Regressionのメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</link>
  <description><![CDATA[ 






<section id="non-parametric-regression" class="level2">
<h2 class="anchored" data-anchor-id="non-parametric-regression">Non-parametric Regression</h2>
<p><img src="https://latex.codecogs.com/png.latex?(X_1,%20Y_1),%20%5Ccdots,%20(X_n,%20Y_n)%20%5Csim%20F"> というデータを観測したとき，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ar(x)%20=%20%5Cmathbb%20E%5BY%20%7C%20X%20=%20x%5D%0A"></p>
<p>というCEFを推定するのがゴールとなります．このとき，<img src="https://latex.codecogs.com/png.latex?%5Chat%20r(x)"> を回帰関数とすると <img src="https://latex.codecogs.com/png.latex?r(x)"> との距離を考える必要があります． 距離の一例として</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AL(%5Chat%20r,%20r)%20=%20%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p>とするとリスク関数は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cmathbb%20E%5Cleft%5B%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%5Cright%5D%0A"></p>
<ul>
<li>このとき，<img src="https://latex.codecogs.com/png.latex?r%5E%7B%5Cprime%5Cprime%7D(y)%20%3C%20%5Cinfty"> であると仮定しています</li>
</ul>
<p>回帰関数のBiasとVarianceを <img src="https://latex.codecogs.com/png.latex?b(x),%20v(x)"> とすると，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cint%20b%5E2(x)%20%5C,%5Cmathrm%7Bd%7Dx%20+%20%5Cint%20v(x)%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p><span class="mini-section">Non-parametric Regressionの方針</span></p>
<p>Non-parametric Regression推定の考え方は，データの「局所平均」をとることでです． ある点における回帰関数の推定値は、その点の近傍にある <img src="https://latex.codecogs.com/png.latex?Y"> の値の平均として求めることになります．</p>
<p>バンド幅は Bias と Variance に影響を与えますが，</p>
<ul>
<li>近傍が広すぎると，Bias が大きく Variance が小さい状態へ（oversmoothing）</li>
<li>逆に近傍が狭すぎると，Bias は小さいが Variance が大きい状態へ（undersmoothing）</li>
</ul>
</section>
<section id="kernel-regression" class="level2">
<h2 class="anchored" data-anchor-id="kernel-regression">Kernel Regression</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Kernel Regression Estimator</span></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%20r(x)%20=%20%5Csum_%7Bi=1%7D%5En%20w_i(x)%20Y_i%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?w_i(x)">: importance weight and the form is following</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw_i(x)%20=%20%5Cfrac%7BK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%7B%5Csum_%7Bi=1%7D%5EnK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%0A"></p>
</div>
<p>表記簡略化のため <img src="https://latex.codecogs.com/png.latex?K%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%20=%20K_h(X_i)"> とし，<img src="https://latex.codecogs.com/png.latex?X_i"> は １変数の場合とします．</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Chat%20r(x)%0A%20%20&amp;=%20%5Cfrac%7B%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Chat%20p(x)%7D%5C%5C%0A%20%20&amp;%5Capprox%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7Bp(x)%7D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき numerator 側の期待値を考えると</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%7BE%7D%5BY%20K_h(X%20-%20x)%5D%0A&amp;=%20%5Ciint%20y%20K_h(u%20-%20x)%20p(u,%20y)%5C,%20dy%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20%5Cleft(%20%5Cint%20y%20p(y%20%5Cmid%20u)%5C,%20dy%20%5Cright)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20r(u)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K(t)%5C,%20r(x%20+%20th)%5C,%20p(x%20+%20th)%5C,%20dt%20%5C%5C%0A&amp;%5Capprox%20%5Cint%20K(t)%0A%5Cleft%5B%20r(x)%20+%20th%20r'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20r''(x)%20%5Cright%5D%0A%5Cleft%5B%20p(x)%20+%20th%20p'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20p''(x)%20%5Cright%5D%20dt%20%5C%5C%0A&amp;=%20r(x)p(x)%20+%20%5Cfrac%7Bc%20h%5E2%7D%7B2%7D%20%5Cleft%5B%20r(x)p''(x)%20+%202%20r'(x)p'(x)%20+%20r''(x)p(x)%20%5Cright%5D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき <img src="https://latex.codecogs.com/png.latex?c%20=%20%5Cint%20t%5E2K(t)">．したがって，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5B%5Chat%20r(x)%5D%20=%20r(x)%20+%20Ch%5E2%0A"></p>
<p><span class="mini-section">分散の導出</span></p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D%0A%20%20&amp;=%20%5Cint%20%5Cmathbb%20E%5BY%5E2%20%7C%20X=u%5DK%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20(r%5E2(u)%20+%20%5Csigma%5E2(u))K%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x%20+%20th)%20+%20r%5E%7B2%7D(x%20+%20th)%20%5Cright)%0A%20%20%20%20%20%20%5Cfrac%7B1%7D%7Bh%5E%7B2%7D%7D%20K%5E%7B2%7D(t)%5C,%20p(x%20+%20th)%5C,%20h%5C,%20dt%20%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B1%7D%7Bh%7D%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x)%20+%20r%5E%7B2%7D(x)%20%5Cright)%0A%20%20%20%20%20%20p(x)%5C,%20K%5E%7B2%7D(t)%5C,%20dt%20+%20o%5C!%5Cleft(%5Cfrac%7B1%7D%7Bh%7D%5Cright).%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>したがって， <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(1/h)">. <img src="https://latex.codecogs.com/png.latex?h%5Cto%200"> の状況では <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D"> のオーダーが支配的になるので</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(Y%20K_h(X%20-%20x))%20%5Capprox%20%5Cmathcal%7BO%7D(1/h)%0A"></p>
<p>したがって，i.i.dと <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bi=1%7D%5En"> より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(%5Chat%20r(x))%20=%20%5Cfrac%7BC%7D%7Bnh%7D%0A"></p>
<p>これらを踏まえるとIMSEは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BIMSE%7D%20=%20ch%5E4%20+%20%5Cfrac%7Bc%7D%7Bnh%7D%0A"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Curse of dimensionality
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?d"> 次元を考えるとリスク関数は次のオーダーになります</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20%5Capprox%20n%5E%7B-4/(4%20+%20d)%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?d"> が大きくなるほど，IMSEのオーダーは悪くなることから curse of dimensionality と呼びます．</p>
</div>
</div>


</section>

 ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</guid>
  <pubDate>Thu, 04 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>UTF-8 の BOM 付き vs BOM なし</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</link>
  <description><![CDATA[ 






<section id="bombyte-order-mark" class="level2">
<h2 class="anchored" data-anchor-id="bombyte-order-mark">BOM(Byte Order Mark)</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">BOM</span></p>
<ul>
<li>バイト順序（エンディアン）を示すためのマーク</li>
<li>BOM は必ずテキストの先頭に付与される(= テキストの中間に置かれることはない)</li>
<li>UTF-8 はバイト順序がないので必要ないが，UTF-8であることの判定のためにUTF-8 with BOM となる場合がある</li>
</ul>
</div>
<p>プログラムがテキストデータを読み込む際に先頭の数バイトによりUnicodeのデータであることやどの種類の符号化形式を採用しているのかを判別しています． BOM付きのUTF-8であれば先頭の3バイトがBOMであり，<code>0xEF 0xBB 0xBF</code>というデータになります．</p>
<p><span class="mini-section">BOM一覧</span></p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 8%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>符号化形式（符号化スキーム）</th>
<th>エンディアン</th>
<th>バイト順マーク (BOM)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>UTF-8</td>
<td>なし</td>
<td><code>EF BB BF</code></td>
</tr>
<tr class="even">
<td>UTF-16</td>
<td>BE</td>
<td><code>FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-16</td>
<td>LE</td>
<td><code>FF FE</code></td>
</tr>
<tr class="even">
<td>UTF-32</td>
<td>BE</td>
<td><code>00 00 FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-32</td>
<td>LE</td>
<td><code>FF FE 00 00</code></td>
</tr>
</tbody>
</table>
<section id="xxd-コマンドでbomを確認する" class="level3">
<h3 class="anchored" data-anchor-id="xxd-コマンドでbomを確認する"><code>xxd</code> コマンドでBOMを確認する</h3>
<p>以下を内容とする <code>test.sh</code> というファイルがあるとします．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!"</span></span></code></pre></div></div>
<p>BOMが付与されていないと</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                </span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> 2321 2f62 696e 2f62 6173 680a 0a65 6368  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash..ech</span></span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6f20 2248 616c 6c6f 2057 6f72 6c64 2121  o <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 220a 0a                                  "</span>..</span></code></pre></div></div>
<p>となりますが，<code>vim "+set bomb" "+wq" test.sh</code> とBOMを付与すると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                 </span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> efbb bf23 212f 6269 6e2f 6261 7368 0a0a  ...#!/bin/bash..</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6563 686f 2022 4861 6c6c 6f20 576f 726c  echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo Worl</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 6421 2122 0a0a                           d!!"</span>..</span></code></pre></div></div>
<p>先頭バイトが <code>efbb bf</code> となっていることから UTF-8 with BOMであることがわかります．</p>
<p>BOMありの場合，<code>chmod +x test.sh</code> 実行後にランしてみると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> ./test.sh                    </span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./test.sh:</span> 1: ﻿#!/bin/bash: not found</span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Hallo</span> World!!</span></code></pre></div></div>
<p>となります．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><code>nkf</code> を用いた文字コード判定
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>nkf</code> コマンドと <code>--guess</code> オプションを組み合わせると，使用されている文字コードと改行コードの判定結果を表示することができます．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> nkf <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--guess</span> test.sh </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">UTF-8</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">BOM</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">LF</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
</div>
</div>
</section>
<section id="nkf-コマンドを用いてbomなしへ変換する" class="level3">
<h3 class="anchored" data-anchor-id="nkf-コマンドを用いてbomなしへ変換する"><code>nkf</code> コマンドを用いてBOMなしへ変換する</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>nkf</code> コマンド</span></p>
<ul>
<li><p>Network Kanji Filterの略</p></li>
<li><p>文字コードと改行コードを変換するためのコマンド</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">opttion</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">file</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div></li>
</ul>
</div>
<p><span class="mini-section">入力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-J</code></td>
<td>入力を ISO-2022-JP とみなす</td>
</tr>
<tr class="even">
<td><code>-S</code></td>
<td>入力を Shift_JIS とみなす</td>
</tr>
<tr class="odd">
<td><code>-E</code></td>
<td>入力を EUC-JP とみなす</td>
</tr>
<tr class="even">
<td><code>--ic=UTF-8</code></td>
<td>入力を UTF-8 とみなす</td>
</tr>
</tbody>
</table>
<p><span class="mini-section">出力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-j</code></td>
<td>出力を ISO-2022-JP</td>
</tr>
<tr class="even">
<td><code>-s</code></td>
<td>出力を Shift_JIS</td>
</tr>
<tr class="odd">
<td><code>-e</code></td>
<td>出力を EUC-JP</td>
</tr>
<tr class="even">
<td><code>-w</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>-w8</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>--oc=UTF-8-BOM</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
</tbody>
</table>
<section id="bomを取り除く" class="level4">
<h4 class="anchored" data-anchor-id="bomを取り除く">BOMを取り除く</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--overwrite</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--oc</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>UTF-8 test.sh</span></code></pre></div></div>
<p>とすることでBOMなしUTF-8へ変換することが出来ます．</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 82%">
</colgroup>
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--overwrite</code></td>
<td><strong>元ファイルを上書き</strong>して保存する</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力の文字コードを UTF-8 にする</td>
</tr>
</tbody>
</table>
<p>内部的には</p>
<ol type="1">
<li>元ファイルの文字コードが自動判定される</li>
<li>内容を UTF-8 に変換</li>
<li>BOM を持っていた場合は削除</li>
<li>変換後の内容で test.sh を上書き保存</li>
</ol>
<p>という処理が行われるので，もし思ったような挙動が確認できない場合は「<strong>元ファイルの文字コードが自動判定される</strong>」に問題があるかもなので 入力文字コード指定オプションを組み合わせたりします</p>
</section>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">UTF-8</span></p>
<ul>
<li>Unicodeで割り振ったコードポイントの文字符号化形式(encoding形式)の一種</li>
<li>ASCIIと同じ文字は1バイト，その他の文字については2～4バイトを用いて文字を表現する</li>
<li>ASCIIとの対応関係があるので 「ASCIIと上位互換性がある」 と言われる</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (Unicode と UTF-8 の対応)</strong></span> &nbsp;</p>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 19%">
<col style="width: 44%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>文字</th>
<th>Unicode</th>
<th>UTF-8</th>
<th>UTF-8の2進数表現</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td><code>U+0041</code></td>
<td><code>0x41</code></td>
<td><code>0100</code> <code>0001</code></td>
</tr>
<tr class="even">
<td>α</td>
<td><code>U+03B1</code></td>
<td><code>0xCE</code> <code>0xB1</code></td>
<td><code>1100</code> <code>1110</code> <code>1011</code> <code>0001</code></td>
</tr>
</tbody>
</table>
<p>AのUTF-8の2進数表現は 8 bit = 1 Byteであるので，「ASCIIと同じ文字は1バイト」であることがわかります．また， α は16 bitとなっていますが，ギリシャ文字は ASCII の範囲外なので 2 Bytes となります．</p>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1609/29/news016.html">【nkf】コマンド――文字コードと改行コードを変換する</a></li>
</ul>


</section>

 ]]></description>
  <category>文字コード</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</guid>
  <pubDate>Wed, 03 Dec 2025 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
