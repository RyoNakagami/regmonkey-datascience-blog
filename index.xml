<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>regmonkey datascience blog</title>
<link>https://ryonakagami.github.io/regmonkey-datascience-blog/</link>
<atom:link href="https://ryonakagami.github.io/regmonkey-datascience-blog/index.xml" rel="self" type="application/rss+xml"/>
<description>日々の徒然勉強日記</description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Thu, 04 Dec 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>NW Regressionのメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</link>
  <description><![CDATA[ 






<section id="non-parametric-regression" class="level2">
<h2 class="anchored" data-anchor-id="non-parametric-regression">Non-parametric Regression</h2>
<p><img src="https://latex.codecogs.com/png.latex?(X_1,%20Y_1),%20%5Ccdots,%20(X_n,%20Y_n)%20%5Csim%20F"> というデータを観測したとき，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ar(x)%20=%20%5Cmathbb%20E%5BY%20%7C%20X%20=%20x%5D%0A"></p>
<p>というCEFを推定するのがゴールとなります．このとき，<img src="https://latex.codecogs.com/png.latex?%5Chat%20r(x)"> を回帰関数とすると <img src="https://latex.codecogs.com/png.latex?r(x)"> との距離を考える必要があります． 距離の一例として</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AL(%5Chat%20r,%20r)%20=%20%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p>とするとリスク関数は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cmathbb%20E%5Cleft%5B%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%5Cright%5D%0A"></p>
<ul>
<li>このとき，<img src="https://latex.codecogs.com/png.latex?r%5E%7B%5Cprime%5Cprime%7D(y)%20%3C%20%5Cinfty"> であると仮定しています</li>
</ul>
<p>回帰関数のBiasとVarianceを <img src="https://latex.codecogs.com/png.latex?b(x),%20v(x)"> とすると，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cint%20b%5E2(x)%20%5C,%5Cmathrm%7Bd%7Dx%20+%20%5Cint%20v(x)%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p><span class="mini-section">Non-parametric Regressionの方針</span></p>
<p>Non-parametric Regression推定の考え方は，データの「局所平均」をとることでです． ある点における回帰関数の推定値は、その点の近傍にある <img src="https://latex.codecogs.com/png.latex?Y"> の値の平均として求めることになります．</p>
<p>バンド幅は Bias と Variance に影響を与えますが，</p>
<ul>
<li>近傍が広すぎると，Bias が大きく Variance が小さい状態へ（oversmoothing）</li>
<li>逆に近傍が狭すぎると，Bias は小さいが Variance が大きい状態へ（undersmoothing）</li>
</ul>
</section>
<section id="kernel-regression" class="level2">
<h2 class="anchored" data-anchor-id="kernel-regression">Kernel Regression</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Kernel Regression Estimator</span></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%20r(x)%20=%20%5Csum_%7Bi=1%7D%5En%20w_i(x)%20Y_i%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?w_i(x)">: importance weight and the form is following</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw_i(x)%20=%20%5Cfrac%7BK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%7B%5Csum_%7Bi=1%7D%5EnK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%0A"></p>
</div>
<p>表記簡略化のため <img src="https://latex.codecogs.com/png.latex?K%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%20=%20K_h(X_i)"> とし，<img src="https://latex.codecogs.com/png.latex?X_i"> は １変数の場合とします．</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Chat%20r(x)%0A%20%20&amp;=%20%5Cfrac%7B%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Chat%20p(x)%7D%5C%5C%0A%20%20&amp;%5Capprox%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7Bp(x)%7D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき numerator 側の期待値を考えると</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%7BE%7D%5BY%20K_h(X%20-%20x)%5D%0A&amp;=%20%5Ciint%20y%20K_h(u%20-%20x)%20p(u,%20y)%5C,%20dy%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20%5Cleft(%20%5Cint%20y%20p(y%20%5Cmid%20u)%5C,%20dy%20%5Cright)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20r(u)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K(t)%5C,%20r(x%20+%20th)%5C,%20p(x%20+%20th)%5C,%20dt%20%5C%5C%0A&amp;%5Capprox%20%5Cint%20K(t)%0A%5Cleft%5B%20r(x)%20+%20th%20r'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20r''(x)%20%5Cright%5D%0A%5Cleft%5B%20p(x)%20+%20th%20p'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20p''(x)%20%5Cright%5D%20dt%20%5C%5C%0A&amp;=%20r(x)p(x)%20+%20%5Cfrac%7Bc%20h%5E2%7D%7B2%7D%20%5Cleft%5B%20r(x)p''(x)%20+%202%20r'(x)p'(x)%20+%20r''(x)p(x)%20%5Cright%5D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき <img src="https://latex.codecogs.com/png.latex?c%20=%20%5Cint%20t%5E2K(t)">．したがって，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5B%5Chat%20r(x)%5D%20=%20r(x)%20+%20Ch%5E2%0A"></p>
<p><span class="mini-section">分散の導出</span></p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D%0A%20%20&amp;=%20%5Cint%20%5Cmathbb%20E%5BY%5E2%20%7C%20X=u%5DK%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20(r%5E2(u)%20+%20%5Csigma%5E2(u))K%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x%20+%20th)%20+%20r%5E%7B2%7D(x%20+%20th)%20%5Cright)%0A%20%20%20%20%20%20%5Cfrac%7B1%7D%7Bh%5E%7B2%7D%7D%20K%5E%7B2%7D(t)%5C,%20p(x%20+%20th)%5C,%20h%5C,%20dt%20%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B1%7D%7Bh%7D%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x)%20+%20r%5E%7B2%7D(x)%20%5Cright)%0A%20%20%20%20%20%20p(x)%5C,%20K%5E%7B2%7D(t)%5C,%20dt%20+%20o%5C!%5Cleft(%5Cfrac%7B1%7D%7Bh%7D%5Cright).%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>したがって， <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(1/h)">. <img src="https://latex.codecogs.com/png.latex?h%5Cto%200"> の状況では <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D"> のオーダーが支配的になるので</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(Y%20K_h(X%20-%20x))%20%5Capprox%20%5Cmathcal%7BO%7D(1/h)%0A"></p>
<p>したがって，i.i.dと <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bi=1%7D%5En"> より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(%5Chat%20r(x))%20=%20%5Cfrac%7BC%7D%7Bnh%7D%0A"></p>
<p>これらを踏まえるとIMSEは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BIMSE%7D%20=%20ch%5E4%20+%20%5Cfrac%7Bc%7D%7Bnh%7D%0A"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Curse of dimensionality
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?d"> 次元を考えるとリスク関数は次のオーダーになります</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20%5Capprox%20n%5E%7B-4/(4%20+%20d)%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?d"> が大きくなるほど，IMSEのオーダーは悪くなることから curse of dimensionality と呼びます．</p>
</div>
</div>


</section>

 ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</guid>
  <pubDate>Thu, 04 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>UTF-8 の BOM 付き vs BOM なし</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</link>
  <description><![CDATA[ 






<section id="bombyte-order-mark" class="level2">
<h2 class="anchored" data-anchor-id="bombyte-order-mark">BOM(Byte Order Mark)</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">BOM</span></p>
<ul>
<li>バイト順序（エンディアン）を示すためのマーク</li>
<li>BOM は必ずテキストの先頭に付与される(= テキストの中間に置かれることはない)</li>
<li>UTF-8 はバイト順序がないので必要ないが，UTF-8であることの判定のためにUTF-8 with BOM となる場合がある</li>
</ul>
</div>
<p>プログラムがテキストデータを読み込む際に先頭の数バイトによりUnicodeのデータであることやどの種類の符号化形式を採用しているのかを判別しています． BOM付きのUTF-8であれば先頭の3バイトがBOMであり，<code>0xEF 0xBB 0xBF</code>というデータになります．</p>
<p><span class="mini-section">BOM一覧</span></p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 8%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>符号化形式（符号化スキーム）</th>
<th>エンディアン</th>
<th>バイト順マーク (BOM)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>UTF-8</td>
<td>なし</td>
<td><code>EF BB BF</code></td>
</tr>
<tr class="even">
<td>UTF-16</td>
<td>BE</td>
<td><code>FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-16</td>
<td>LE</td>
<td><code>FF FE</code></td>
</tr>
<tr class="even">
<td>UTF-32</td>
<td>BE</td>
<td><code>00 00 FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-32</td>
<td>LE</td>
<td><code>FF FE 00 00</code></td>
</tr>
</tbody>
</table>
<section id="xxd-コマンドでbomを確認する" class="level3">
<h3 class="anchored" data-anchor-id="xxd-コマンドでbomを確認する"><code>xxd</code> コマンドでBOMを確認する</h3>
<p>以下を内容とする <code>test.sh</code> というファイルがあるとします．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!"</span></span></code></pre></div></div>
<p>BOMが付与されていないと</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                </span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> 2321 2f62 696e 2f62 6173 680a 0a65 6368  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash..ech</span></span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6f20 2248 616c 6c6f 2057 6f72 6c64 2121  o <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 220a 0a                                  "</span>..</span></code></pre></div></div>
<p>となりますが，<code>vim "+set bomb" "+wq" test.sh</code> とBOMを付与すると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                 </span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> efbb bf23 212f 6269 6e2f 6261 7368 0a0a  ...#!/bin/bash..</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6563 686f 2022 4861 6c6c 6f20 576f 726c  echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo Worl</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 6421 2122 0a0a                           d!!"</span>..</span></code></pre></div></div>
<p>先頭バイトが <code>efbb bf</code> となっていることから UTF-8 with BOMであることがわかります．</p>
<p>BOMありの場合，<code>chmod +x test.sh</code> 実行後にランしてみると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> ./test.sh                    </span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./test.sh:</span> 1: ﻿#!/bin/bash: not found</span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Hallo</span> World!!</span></code></pre></div></div>
<p>となります．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><code>nkf</code> を用いた文字コード判定
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>nkf</code> コマンドと <code>--guess</code> オプションを組み合わせると，使用されている文字コードと改行コードの判定結果を表示することができます．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> nkf <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--guess</span> test.sh </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">UTF-8</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">BOM</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">LF</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
</div>
</div>
</section>
<section id="nkf-コマンドを用いてbomなしへ変換する" class="level3">
<h3 class="anchored" data-anchor-id="nkf-コマンドを用いてbomなしへ変換する"><code>nkf</code> コマンドを用いてBOMなしへ変換する</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>nkf</code> コマンド</span></p>
<ul>
<li><p>Network Kanji Filterの略</p></li>
<li><p>文字コードと改行コードを変換するためのコマンド</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">opttion</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">file</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div></li>
</ul>
</div>
<p><span class="mini-section">入力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-J</code></td>
<td>入力を ISO-2022-JP とみなす</td>
</tr>
<tr class="even">
<td><code>-S</code></td>
<td>入力を Shift_JIS とみなす</td>
</tr>
<tr class="odd">
<td><code>-E</code></td>
<td>入力を EUC-JP とみなす</td>
</tr>
<tr class="even">
<td><code>--ic=UTF-8</code></td>
<td>入力を UTF-8 とみなす</td>
</tr>
</tbody>
</table>
<p><span class="mini-section">出力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-j</code></td>
<td>出力を ISO-2022-JP</td>
</tr>
<tr class="even">
<td><code>-s</code></td>
<td>出力を Shift_JIS</td>
</tr>
<tr class="odd">
<td><code>-e</code></td>
<td>出力を EUC-JP</td>
</tr>
<tr class="even">
<td><code>-w</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>-w8</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>--oc=UTF-8-BOM</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
</tbody>
</table>
<section id="bomを取り除く" class="level4">
<h4 class="anchored" data-anchor-id="bomを取り除く">BOMを取り除く</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--overwrite</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--oc</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>UTF-8 test.sh</span></code></pre></div></div>
<p>とすることでBOMなしUTF-8へ変換することが出来ます．</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 82%">
</colgroup>
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--overwrite</code></td>
<td><strong>元ファイルを上書き</strong>して保存する</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力の文字コードを UTF-8 にする</td>
</tr>
</tbody>
</table>
<p>内部的には</p>
<ol type="1">
<li>元ファイルの文字コードが自動判定される</li>
<li>内容を UTF-8 に変換</li>
<li>BOM を持っていた場合は削除</li>
<li>変換後の内容で test.sh を上書き保存</li>
</ol>
<p>という処理が行われるので，もし思ったような挙動が確認できない場合は「<strong>元ファイルの文字コードが自動判定される</strong>」に問題があるかもなので 入力文字コード指定オプションを組み合わせたりします</p>
</section>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">UTF-8</span></p>
<ul>
<li>Unicodeで割り振ったコードポイントの文字符号化形式(encoding形式)の一種</li>
<li>ASCIIと同じ文字は1バイト，その他の文字については2～4バイトを用いて文字を表現する</li>
<li>ASCIIとの対応関係があるので 「ASCIIと上位互換性がある」 と言われる</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (Unicode と UTF-8 の対応)</strong></span> &nbsp;</p>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 19%">
<col style="width: 44%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>文字</th>
<th>Unicode</th>
<th>UTF-8</th>
<th>UTF-8の2進数表現</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td><code>U+0041</code></td>
<td><code>0x41</code></td>
<td><code>0100</code> <code>0001</code></td>
</tr>
<tr class="even">
<td>α</td>
<td><code>U+03B1</code></td>
<td><code>0xCE</code> <code>0xB1</code></td>
<td><code>1100</code> <code>1110</code> <code>1011</code> <code>0001</code></td>
</tr>
</tbody>
</table>
<p>AのUTF-8の2進数表現は 8 bit = 1 Byteであるので，「ASCIIと同じ文字は1バイト」であることがわかります．また， α は16 bitとなっていますが，ギリシャ文字は ASCII の範囲外なので 2 Bytes となります．</p>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1609/29/news016.html">【nkf】コマンド――文字コードと改行コードを変換する</a></li>
</ul>


</section>

 ]]></description>
  <category>文字コード</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</guid>
  <pubDate>Wed, 03 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>乱数生成シェルスクリプト</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-28-generate-random-passwd/</link>
  <description><![CDATA[ 






<section id="シェルスクリプト概要" class="level2">
<h2 class="anchored" data-anchor-id="シェルスクリプト概要">シェルスクリプト概要</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>DOCSTRINGS
</div>
</div>
<div class="callout-body-container callout-body">
<div class="reveal_vspace" style="--vspace-height: 1em;"></div>
<ul>
<li><code>/dev/urandom</code>を活用して任意の長さの疑似ランダム文字列を生成</li>
<li>デフォルトは Base64 形式</li>
<li><code>-n</code> オプションを利用するとInteger型で疑似ランダム列を生成</li>
<li>出現文字列の一様性を保証するものではないので，あくまでsandbox環境での簡易的なpasswordの生成などに用途を限定</li>
</ul>
</div>
</div>
<p><span class="mini-section">シェルスクリプト全体</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revised: 2025-11-28</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Script: generate-random-passwd</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Description:</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Generates a random string of specified length in either base64 or</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   numeric-only format. Useful for passwords, tokens, or test data.</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Steps:</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     1. Parse command-line options (-n for numeric, -h for help).</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     2. Validate input length (must be integer, less than 77).</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     3. Generate random string using /dev/urandom:</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#        - base64 output by default</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#        - numeric-only if -n is specified</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Options:</span></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -n    Generate numeric-only random string</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -h    Show this help message</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Usage:</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd &lt;length&gt;      # Generates base64 string</span></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd -n &lt;length&gt;   # Generates numeric string</span></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd &lt;length&gt; -n   # Generates numeric string</span></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notes:</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires /dev/urandom device.</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires base64 and tr utilities.</span></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Sources lib/docstring.sh for usage_helper.</span></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Load library functions ----</span></span>
<span id="cb1-33"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${BASH_SOURCE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/../lib/docstring.sh"</span></span>
<span id="cb1-34"></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Default values ----</span></span>
<span id="cb1-36"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATTERN</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span></span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-z</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># call library function usage_helper</span></span>
<span id="cb1-40">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-41">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-42"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-43"></span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Parse command-line options ----</span></span>
<span id="cb1-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_opts()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb1-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getopts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hn"</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb1-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">case</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb1-49">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">h</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-50">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATTERN</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-51">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">esac</span></span>
<span id="cb1-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span>
<span id="cb1-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span>
<span id="cb1-55"></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- 1st pass: parse leading options ----</span></span>
<span id="cb1-57"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parse_opts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-58"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- NUMBER_INPUT might be here ----</span></span>
<span id="cb1-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">+</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-62">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NUMBER_INPUT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-63">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> 1</span>
<span id="cb1-64"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-65"></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Reset OPTIND and parse remaining options (after NUMBER_INPUT) ----</span></span>
<span id="cb1-67"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPTIND</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span>
<span id="cb1-68"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parse_opts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-69"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb1-70"></span>
<span id="cb1-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Validate input ----</span></span>
<span id="cb1-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if NUMBER_INPUT is a positive integer</span></span>
<span id="cb1-73"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-74">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Input must be a positive integer greater than 0."</span></span>
<span id="cb1-75">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-76">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-77"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-78"></span>
<span id="cb1-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">((</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NUMBER_INPUT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">));</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-80">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Input must be less than 77."</span></span>
<span id="cb1-81">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-82">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-83"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-84"></span>
<span id="cb1-85"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-86">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Invalid pattern specified."</span></span>
<span id="cb1-87">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-88">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-89"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-90"></span>
<span id="cb1-91"></span>
<span id="cb1-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate random string based on pattern ----</span></span>
<span id="cb1-93"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-94">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate random string ----</span></span>
<span id="cb1-95">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">base64</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-96">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span></span>
<span id="cb1-97">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0</span>
<span id="cb1-98"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate numeric-only random string ----</span></span>
<span id="cb1-100">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-dc</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0-9'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-101">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span></span>
<span id="cb1-102">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0</span>
<span id="cb1-103"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span></code></pre></div></div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (実行例)</strong></span> &nbsp;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd 10</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">zCJPhQxfr6</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd 10 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span></span>
<span id="cb2-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5711270805</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 10</span>
<span id="cb2-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">9843753838</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="devurandom-仮想デバイス" class="level2">
<h2 class="anchored" data-anchor-id="devurandom-仮想デバイス"><code>/dev/urandom</code> 仮想デバイス</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title"><code>/dev/urandom</code></span></p>
<ul>
<li><code>/dev/urandom</code>はハードウェア（キーボード・マウス・CPUなどの）動作から得られる環境ノイズを蓄積したデータ領域のこと（＝エントロピープール）</li>
<li>蓄積されたデータはバイナリーデータであるが，<code>base64</code> を利用することで乱数ジェネレーターとして利用できる</li>
<li>出力プールの最大周期(period)は <img src="https://latex.codecogs.com/png.latex?2%5E%7B26%5Ctimes%2032%7D%20-%201"></li>
<li>エントロピープールを再利用する仕組みを持つため，<span class="regmonkey-bold">エントロピー枯渇（entropy pool depletion）を心配する必要はない</span>（＝いつでも利用できる）</li>
<li>疑似乱数の再現性(reproducible seeding)はない</li>
</ul>
</div>
<p>エントロピープールを活用した疑似乱数ジェネレーターは <code>/dev/urandom</code> 以外に <code>dev/random</code> がありますが，動作の違いがあります． <code>dev/random</code> は乱数生成に使ったエントロピープール（= 内部状態）をそのまま再利用しないようにロックをかけるという設計になっています．</p>
<ul>
<li>乱数を出力 → プールが「公開された」とみなす</li>
<li>安全のためそのプールはすぐ使わない</li>
<li>新しい環境ノイズ（エントロピー）が十分に貯まるまで待つ</li>
</ul>
<p>そのため，連続した乱数生成を実施できない場合があります．</p>
<ul>
<li>連続した大量生成</li>
<li>実行環境が低エントロピー環境（仮想マシンなどのノイズが少ない環境）</li>
</ul>
<p>では，ロックがかかりやすいので <code>/dev/urandom</code> ベースの乱数ジェネレーターのほうが一般用途では良いとされます．</p>
<section id="base64-エンコード" class="level3">
<h3 class="anchored" data-anchor-id="base64-エンコード">Base64 エンコード</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>base64</code></span></p>
<ul>
<li>バイナリーデータをテキストに変換するための<span class="regmonkey-bold">エンコード方式</span></li>
<li>データを64種類の印字可能な英数字(<code>[A-Za-z0-9+/]</code>)に変換</li>
<li>MIMEの基準では76文字ごとに改行コードが入る</li>
</ul>
</div>
<p><code>base64 /dev/urandom</code> を実行シたときの流れは</p>
<ol type="1">
<li><code>/dev/urandom</code> (バイナリ)</li>
<li><code>base64</code> でエンコード</li>
<li>ランダムな Base64 文字列が出力される</li>
</ol>
<p>になります．</p>
</section>
</section>
<section id="head-コマンド" class="level2">
<h2 class="anchored" data-anchor-id="head-コマンド"><code>head</code> コマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title"><code>head</code> コマンド</span></p>
<ul>
<li>headはテキストファイルの最初の10行を表示するコマンド</li>
</ul>
</div>
<p><span class="mini-section">オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>短いオプション</th>
<th>長いオプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-c 数字</code></td>
<td><code>--bytes 数字</code></td>
<td>先頭から指定したバイト数のみ表示する．「<code>-c 5 b</code>」のように単位を付加することも可能（b=512, KB=1000, K=1024, MB=1000×1000, M=1024×1024…）</td>
</tr>
<tr class="even">
<td><code>-n 数字</code></td>
<td><code>--lines 数字</code></td>
<td>先頭から指定した行数のみ表示する</td>
</tr>
<tr class="odd">
<td><code>-q</code></td>
<td><code>--quiet</code>, <code>--silent</code></td>
<td>ファイルごとのヘッダ表示を行わない（複数ファイル指定時に使う）</td>
</tr>
<tr class="even">
<td><code>-v</code></td>
<td><code>--verbose</code></td>
<td>常にファイルごとのヘッダ出力を行う</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="tr-コマンド" class="level2">
<h2 class="anchored" data-anchor-id="tr-コマンド"><code>tr</code> コマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title"><code>tr</code> コマンド</span></p>
<ul>
<li>標準入力の文字を別の文字に置換したり，削除したりするコマンド</li>
</ul>
</div>
<p><span class="mini-section">オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>短いオプション</th>
<th>長いオプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-d</code></td>
<td><code>--delete</code></td>
<td>指定した文字を削除する</td>
</tr>
<tr class="even">
<td><code>-c</code></td>
<td><code>--complement</code></td>
<td>指定した文字セットの補集合を扱う（反転）</td>
</tr>
<tr class="odd">
<td><code>-s</code></td>
<td><code>--squeeze-repeats</code></td>
<td>連続する同一文字を1つに圧縮する</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (文字の置換)</strong></span> <code>tr 012 abc</code> を実行すると，</p>
<ul>
<li>「<code>0</code>」を「<code>a</code>」</li>
<li>「<code>1</code>」を「<code>b</code>」</li>
<li>「<code>2</code>」を「<code>c</code>」</li>
</ul>
<p>に置き換えます．「<code>012</code>」という連続した文字列を「<code>abc</code>」に置き換えるのではなく，常に1文字対1文字での置き換えとなるので，両者の長さはそろえる必要があります</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'012345'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> 012 abc</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">abc345</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0142345'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> 012 abc</span>
<span id="cb3-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ab4c345</span></span></code></pre></div></div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (<code>/dev/urandom</code> から数値のみを抽出)</strong></span> <br></p>
<p>数値のみのパスワードやトークン生成する場合は，<code>-d '0-9'</code> の補集合を取れば良いので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-dc</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0-9'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> 16</span></code></pre></div></div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (連続した改行を1つにする)</strong></span> <br></p>
<p><code>tr -s</code> は繰り返し文字の圧縮に使えるので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A\n\n\nA'</span> </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A\n\n\nA'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'\n'</span></span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span></code></pre></div></div>
<p><code>tr -s '\n'</code> は不要改行を削除するときに使いますが，同様に <code>tr -s '[:space:]</code> を用いて不要スペースをまとめたりします</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a   b   c"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[:space:]'</span></span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">a</span> b c</span></code></pre></div></div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://utakamo.com/article/linux/architecture/directory/dev/random-urandom.html">うたカモ技術ブログ &gt; Linux 乱数ジェネレーター（/dev/random、/dev/urandom、getrandom）</a></li>
<li><a href="https://stackoverflow.com/questions/32139660/is-dev-urandom-suitable-for-simulation-purpose">Is <code>/dev/urandom</code> suitable for simulation purpose?</a></li>
</ul>


</section>

 ]]></description>
  <category>shell</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-28-generate-random-passwd/</guid>
  <pubDate>Fri, 28 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>paperless-ngxによるセルフホスティングドキュメント管理システム</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-27-paperless-ngx/</link>
  <description><![CDATA[ 






<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>想定環境
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>実行環境は基本的に Ubuntu 24.04 LTSを想定</li>
<li>Docker engineは利用可能</li>
<li>port 8888 でホスト</li>
<li>Tailscaleは導入済み</li>
<li>tailnet serveはhttpsを用いてserve</li>
</ul>
</div>
</div>
<section id="paperless-ngxとは" class="level2">
<h2 class="anchored" data-anchor-id="paperless-ngxとは">Paperless-ngxとは？</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>TL;DRs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Paperless-ngxは，PDF 論文やレポートを自前サーバで全文検索付きライブラリ化するためのツール</li>
<li>「引用管理」「文献リスト生成」などの機能も欲しいなら，文献管理専用ソフトを使うのが無難</li>
</ul>
</div>
</div>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Paperless-ngx</span></p>
<ul>
<li>pdf, txtなどのドキュメントを検索可能なオンラインアーカイブとして管理できるオープンソースのセルフホスティング文書管理システム</li>
<li>サーバーサイドでPaperless-ngxを構築し，クライアント端末からアクセスしたり，コンテンツをダウンロードすることが可能</li>
<li>バックエンドはDjango</li>
</ul>
</div>
<p><span class="mini-section">Features</span></p>
<ul>
<li>タグ・差出人(Correspondence)・文書タイプ・カスタムフィールドでドキュメントを整理可能</li>
<li>アップロードしたドキュメントに対してOCRを用いた全文検索が可能</li>
<li>機械学習でタグ・差出人・文書タイプを 自動分類</li>
<li>PDF，画像，テキスト，Word/Excel/PowerPoint，LibreOffice など多くの形式に対応</li>
<li>Web UI を通じて，複数ユーザーでのアクセス管理，共有リンク発行が可能</li>
<li>文書ごとに権限管理設定可能</li>
<li>ワークフロー機能による自動処理</li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>文書管理システムであって文献管理ソフトではない
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Zoteroと違い学術論文データベースではないです</li>
<li>文献の著者情報，出版年，ジャーナル名，引用数，参照関係，BibTex形式でのメタ情報出力は標準では備わっていない</li>
<li>Paperless-ngxはファイルを独自フォルダ構成で管理するため，「元のファイルツリー構造をそのまま索引化だけしたい」という用途には向かない</li>
</ul>
</div>
</div>
</section>
<section id="paperless-ngxの設定" class="level2">
<h2 class="anchored" data-anchor-id="paperless-ngxの設定">Paperless-ngxの設定</h2>
<p>Paperless-ngxは Dockerベースで構築することが可能です．構築にあたって</p>
<ol type="1">
<li>シェルスクリプトを用いて，対話式でセットアップする</li>
<li>自分で <code>docker-compose.yml</code> を定義し，公式Paperless-ngx Docker imageを運用する</li>
</ol>
<section id="パターン１-シェルスクリプトを用いて対話式でセットアップする" class="level3">
<h3 class="anchored" data-anchor-id="パターン１-シェルスクリプトを用いて対話式でセットアップする">パターン１: シェルスクリプトを用いて，対話式でセットアップする</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bash</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--location</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--silent</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--show-error</span> https://raw.githubusercontent.com/paperless-ngx/paperless-ngx/main/install-paperless-ngx.sh<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
<p>を実行することで対話式でセットアップできます．また，Paperless-ngxの中で用いるrootアカウントの設定まで行ってくれます．</p>
</section>
<section id="パターン２自分で-docker-compose.yml-を定義" class="level3">
<h3 class="anchored" data-anchor-id="パターン２自分で-docker-compose.yml-を定義">パターン２：自分で <code>docker-compose.yml</code> を定義</h3>
<p>作業手順として</p>
<ol type="1">
<li>利用可能UID, GIDの確認</li>
<li>GIDの作成</li>
<li>UIDの作成</li>
<li>Docker設定用のdirectoryを作成(= volumn, 設定ファイルの管理用ディレクトリ)</li>
<li><code>docker-compose.env</code> の作成</li>
<li><code>docker-compose.yml</code> の作成</li>
<li>コンテナを起動</li>
</ol>
<p>です．</p>
<p><span class="mini-section">Step 1: paperless-ngx用UIDの作成</span></p>
<p>Ubuntuサーバー側でPaperless-ngxをホスティングするので，まずPaperless-ngx用non-humanアカウントを作成します． UIDとGIDは同じIDで基本的には作成されますが，連番の関係が崩れると違ったIDが割り当てられてしまう可能性があるので，利用可能なIDを確認します．</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド</th>
<th>挙動</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>getent passwd</code></td>
<td>UID一覧の確認コマンド</td>
</tr>
<tr class="even">
<td><code>getent group</code></td>
<td>GID一覧の確認コマンド</td>
</tr>
</tbody>
</table>
</div>
<p>上記のコマンドを叩いて目星をつけたならば(例として<code>120</code>が空いていたとする)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getent</span> passwd 120</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getent</span> group 120</span></code></pre></div></div>
<p>両方のコマンドを叩いて何も返ってこないことを確認します．</p>
<p><span class="mini-section">Step 2: GIDの作成</span></p>
<p>GIDの作成は <code>groupadd</code> コマンドを以下のように用います</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> groupadd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gid</span> 120 paperless-ngx</span></code></pre></div></div>
<p>GID作成後，意図した通りにGIDが作成されているか確認します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent group 120</span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:</span></span></code></pre></div></div>
<p>もし間違ったGIDで作成してしまった場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> groupdel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>group-name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p><span class="mini-section">Step 3: UIDの作成</span></p>
<p><code>paperless-ngx</code> ユーザーを作成します． 不特定多数が利用するサーバーでホスティングするので特定のhumanユーザーではなく， サービス専用のシステム用アカウント(ログイン不可のユーザー)として運用したいのが理由となります．</p>
<p>ユーザー作成コマンドは以下です</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> useradd <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--system</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-create-home</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--uid</span> 120 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gid</span> 120 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-6">  paperless-ngx</span></code></pre></div></div>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>useradd</code></td>
<td>新しいユーザーを作成するコマンド</td>
</tr>
<tr class="even">
<td><code>--system</code></td>
<td>システム専用ユーザーとして作成（ログイン不可，通常 UID 100 未満を使う場合もある）</td>
</tr>
<tr class="odd">
<td><code>--no-create-home</code></td>
<td>ホームディレクトリを作らない</td>
</tr>
<tr class="even">
<td><code>--uid 120</code></td>
<td>作成するユーザーの <strong>UID</strong> を 120 に指定</td>
</tr>
<tr class="odd">
<td><code>--gid 120</code></td>
<td>作成するユーザーの <strong>プライマリグループ</strong> を GID 120 に指定</td>
</tr>
</tbody>
</table>
</div>
<p>上記のコマンド実行後，home directoryを持たない <code>paperless-ngx</code> が作成されますが</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent passwd 120</span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:120::/home/paperless-ngx:/bin/sh</span></span></code></pre></div></div>
<p>となってると思います．ログインシェルと存在しないhome directoryが指定されているのは気持ち悪いので</p>
<ul>
<li><code>/nonexisent</code> ディレクトリをhome directoryとする</li>
<li><code>/usr/sbin/nologin</code> でログイン不可</li>
</ul>
<p>という設定更新をします．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> usermod <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> /nonexistent paperless-ngx</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> usermod <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /usr/sbin/nologin paperless-ngx</span></code></pre></div></div>
<p>上記のコマンド実行後は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent passwd 120</span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:120::/nonexistent:/usr/sbin/nologin</span></span></code></pre></div></div>
<p>となっているはずです．</p>
<p><span class="mini-section">Step 4: Docker設定用のdirectoryを作成</span></p>
<p>paperless-ngxサービス用のディレクトリを <code>/srv</code> 以下に以下のように作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> mkdir <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /srv/paperless-ngx</span></code></pre></div></div>
<p>作成後，所有権を以下のように変更しときます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> chown <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> paperless-ngx:paperless-ngx /srv/paperless-ngx</span></code></pre></div></div>
<p>また，サーバーサイドでの設定なのでパーミッションも以下のように変更しときます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> chmod 770 /srv/paperless-ngx</span></code></pre></div></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><code>/srv/paperless-ngx</code> に構築する理由
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngx が管理するファイル・設定・ボリューム用ディレクトリを一目でわかる場所で管理するのが望ましいですが，どこで管理するのかが問題となります． Ubuntuでは用途ごとに次のようなディレクトリが一般的に用いられます：</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 33%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>ディレクトリ</th>
<th>用途</th>
<th>コメント</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>/srv</code></td>
<td>サービス専用データ</td>
<td>標準的でわかりやすい</td>
</tr>
<tr class="even">
<td><code>/opt</code></td>
<td>サードパーティソフトのインストール先</td>
<td>バイナリやパッケージ向けでデータ管理向きではない</td>
</tr>
<tr class="odd">
<td><code>/var/lib</code></td>
<td>可変データ（ログ，DB，キャッシュ）</td>
<td>物理的に動的なデータ向け，サービスデータ全般にも可</td>
</tr>
</tbody>
</table>
</div>
<p>Paperless-ngx のデータをどこに置くかは最終的に任意ですが，サービス専用ユーザーに所有権を割り当てやすく，管理もしやすいという点から， <code>/srv</code> 配下にディレクトリを作成する方針にしました．</p>
</div>
</div>
<p>その後，Paperless-ngx用のexportとupload用ボリュームとして <code>export</code>, <code>consume</code> ディレクトリが必要となるのでそれぞれを作成します．</p>
<p><span class="mini-section">Step 5: <code>docker-compose.env</code> の作成</span></p>
<p>Dockerコンテナ用の環境変数を定義する <code>docker-compose.env</code> を <code>/srv/paperless-ngx</code> 以下に作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_UID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb13-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_GID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb13-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_TIME_ZONE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Asia/Tokyo</span></span>
<span id="cb13-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_LANGUAGE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">eng</span></span>
<span id="cb13-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_SECRET_KEY</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;適当な文字列&gt;'</span></span>
<span id="cb13-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_OUTPUT_TYPE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">pdf</span></span></code></pre></div></div>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 24%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>変数名</th>
<th>説明</th>
<th>備考（今回の重要ポイントを踏まえた補足）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>USERMAP_UID=120</code></td>
<td>Paperless コンテナ内部で使用するユーザーID（UID）をホスト側 UID に合わせるための設定</td>
<td>ホスト側のユーザー権限と揃えることで，生成ファイルの所有権が一致し，権限問題が発生しにくくなる</td>
</tr>
<tr class="even">
<td><code>USERMAP_GID=120</code></td>
<td>Paperless コンテナ内部で使用するグループID（GID）をホスト側 GID に合わせる設定</td>
<td>UID と同様，ホスト側のグループ権限と一致させることで，ファイルアクセスの整合性が取れる．</td>
</tr>
<tr class="odd">
<td><code>PAPERLESS_TIME_ZONE=Asia/Tokyo</code></td>
<td>Paperless 内部で使用するタイムゾーンを指定．</td>
<td>ログ，OCR のタイムスタンプ，タスクの実行時間管理に使用されるため，日本で利用するなら <code>Asia/Tokyo</code> が最適</td>
</tr>
<tr class="even">
<td><code>PAPERLESS_OCR_LANGUAGE=eng</code></td>
<td>OCR に使用する言語を指定する．複数指定も可能（例: <code>eng+jpn</code>）．</td>
<td>日本語を扱う場合は <code>jpn</code> の追加を推奨．英語のみなら <code>eng</code> のままでOK．</td>
</tr>
<tr class="odd">
<td><code>PAPERLESS_SECRET_KEY='&lt;適当な文字列&gt;'</code></td>
<td><strong>セッションを保護する秘密鍵（ユーザー認証に不可欠）．ランダムで長い文字列に必ず変更する必要がある．</strong></td>
<td>Paperless がインターネットに公開される場合，<strong>デフォルトの SECRET_KEY は広く知られているため危険</strong>．キーボードを適当に叩いた文字列でOK．覚える必要はない．長いほど安全．例: <code>a9$FJ!p92jaf(3)sa0fjasdf02398</code></td>
</tr>
<tr class="even">
<td><code>PAPERLESS_OCR_OUTPUT_TYPE=&lt;type&gt;</code></td>
<td>OCR 後に生成する PDF の種類を指定</td>
<td>- <code>pdf</code> : 元の PDF を極力変更せずに OCR を追加<br>- <code>pdfa</code> : PDF/A-2b に変換（長期保存向け）<br>- <code>pdfa-1</code>, <code>pdfa-2</code>, <code>pdfa-3</code> : PDF/A のバージョン指定<br>※ 指定しない場合は <code>pdfa</code> がデフォルト</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>PAPERLESS_OCR_LANGUAGE設定の注意点
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngxはOCR機能としてTesseractを利用しますが，デフォルトでインストールされていない言語を指定すると，</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb14-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">The selected ocr language jpn is not installed. Paperless cannot OCR your documents without it. Please fix PAPERLESS_OCR_LANGUAGE.</span></span></code></pre></div></div>
<p>というエラーを吐きます．日本語対応を含めるため <code>eng+jpn</code> を設定する場合は <code>Dockerfile</code> を設定して</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> tesseract-ocr-jpn <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div></div>
<p>というラインを加えた上でビルドの必要があります．</p>
</div>
</div>
<p><span class="mini-section">Step 6: <code>docker-compose.yml</code> の作成</span></p>
<p><code>/srv/paperless-ngx</code> にて <code>docker-compose.yml</code> を以下のように作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">services</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">broker</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker.io/library/redis:8</span></span>
<span id="cb16-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-redisdata:/data</span></span>
<span id="cb16-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb16-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">db</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker.io/library/postgres:18</span></span>
<span id="cb16-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-pgdata:/var/lib/postgresql</span></span>
<span id="cb16-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">environment</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_DB</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_USER</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_PASSWORD</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb16-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">webserver</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ghcr.io/paperless-ngx/paperless-ngx:latest</span></span>
<span id="cb16-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">depends_on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> db</span></span>
<span id="cb16-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> broker</span></span>
<span id="cb16-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ports</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8888:8000"</span></span>
<span id="cb16-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-data:/usr/src/paperless/data</span></span>
<span id="cb16-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-media:/usr/src/paperless/media</span></span>
<span id="cb16-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ./export:/usr/src/paperless/export</span></span>
<span id="cb16-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ./consume:/usr/src/paperless/consume</span></span>
<span id="cb16-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env_file</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker-compose.env</span></span>
<span id="cb16-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">environment</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PAPERLESS_REDIS</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> redis://broker:6379</span></span>
<span id="cb16-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PAPERLESS_DBHOST</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> db</span></span>
<span id="cb16-35"></span>
<span id="cb16-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-data</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-media</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-pgdata</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-redisdata</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span></code></pre></div></div>
<p><span class="mini-section">Step 7: コンテナを起動</span></p>
<p>コンテナは以下の手順で起動します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose up <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose ps</span></code></pre></div></div>
<p>エラーが発生した場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose logs <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> webserver</span></code></pre></div></div>
<p>でログを確認できます．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>uploadしたドキュメントのバックアップを取る
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngx コンテナ内の <code>export</code> ディレクトリにあるドキュメントをバックアップする場合</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> exec <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> ps <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aqf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name=paperless-ngx-webserver-1"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> document_exporter ../export</span></code></pre></div></div>
<ul>
<li><code>../export</code> はコンテナ内の相対パス</li>
<li>ホスト側ボリューム <code>/srv/paperless-ngx/export</code> にマウントしていれば，ホスト側からも直接アクセス可能</li>
</ul>
</div>
</div>
</section>
</section>
<section id="tailnet-serve設定" class="level2">
<h2 class="anchored" data-anchor-id="tailnet-serve設定">Tailnet serve設定</h2>
<p>設定手順は</p>
<ol type="1">
<li><code>docker-compose.env</code> の設定とコンテナの再起動</li>
<li>tailnet serve設定</li>
</ol>
<p>となります</p>
<p><span class="mini-section">Step 1: <code>docker-compose.env</code> の設定</span></p>
<p>Tailscale 経由で Paperless-ngx にアクセスする場合，Djangoにホスト名とプロトコル（HTTPS）を正しく伝えることが重要です． 設定項目としては</p>
<ul>
<li><code>PAPERLESS_URL</code>: Django の CSRF / CORS / ALLOWED_HOSTS を自動設定するための環境変数．末尾スラッシュなし</li>
</ul>
<p>今回は Port 8888 経由で公開するので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb20-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_URL</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">https://hogehoge.tail8ada9.ts.net:8888</span></span></code></pre></div></div>
<p>と設定します．<code>https://hogehoge.tail8ada9.ts.net:8888</code> はtailscale serve statusで確認できるものにします．</p>
<p>上記を踏まえると以下のような <code>docker-compose.env</code> となります</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_UID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb21-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_GID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb21-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_TIME_ZONE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Asia/Tokyo</span></span>
<span id="cb21-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_LANGUAGE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">eng+jpn</span></span>
<span id="cb21-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_SECRET_KEY</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hogehogehgoehgoeghoeh'</span></span>
<span id="cb21-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_URL</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">https://hogehoge.tail8ada9.ts.net:8888</span></span></code></pre></div></div>
<p><span class="mini-section">Step 2: <code>tailnet serve設定</code> の設定</span></p>
<p>Tailscale の HTTP/HTTPS リバースプロキシ機能をつかってローカルサービスをTailnet上で公開します．</p>
<p>サーバー側で以下のコマンドを実行します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tailscale serve <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--bg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--https</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>8888 8888</span></code></pre></div></div>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 33%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド部分</th>
<th>説明</th>
<th>ポイント / 注意点</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>tailscale serve</code></td>
<td>ローカルの HTTP/HTTPS サービスを Tailscale ネットワーク上で公開するリバースプロキシ機能</td>
<td>Tailscale 1.36 以降で利用可能</td>
</tr>
<tr class="even">
<td><code>--bg</code></td>
<td>バックグラウンドで実行</td>
<td>ターミナルを閉じてもプロセスは継続。デーモン的に動作</td>
</tr>
<tr class="odd">
<td><code>--https=8888</code></td>
<td>Tailscale 側で HTTPS を提供するポート番号</td>
<td>自動生成証明書で TLS 保護された HTTPS アクセスが可能</td>
</tr>
<tr class="even">
<td><code>8888</code> (最後の引数)</td>
<td>ローカルサービスのポート番号</td>
<td>ローカルの <code>localhost:8888</code> にあるサービスを Tailscale HTTPS ポートに接続</td>
</tr>
</tbody>
</table>
<p>上記コマンドの実行後， Tailscale 内から <code>https://&lt;tailscale-node&gt;:8888</code> でローカルサービスとしてのpaperless-ngxへアクセス可能となります．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>サービスを非公開にしたい場合
</div>
</div>
<div class="callout-body-container callout-body">
<p>Tailscale 内から Paperless-ngx にHTTPSでアクセス負荷にしたい場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tailscale serve <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--bg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--https</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>8888 off</span></code></pre></div></div>
<p>ポートは8888想定ですが，<code>sudo tailscale serve --bg --https=&lt;port&gt; 8888</code> の <code>&lt;port&gt;</code> に応じて変更して下さい．</p>
</div>
</div>
</section>
<section id="appendix-1-グループからユーザーを削除する方法" class="level2">
<h2 class="anchored" data-anchor-id="appendix-1-グループからユーザーを削除する方法">Appendix 1: グループからユーザーを削除する方法</h2>
<p>特定のユーザーをグループから削除するには <code>gpasswd</code> or <code>deluser</code> コマンドを使用します</p>
<p><span class="mini-section"><code>gpasswd</code>コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## long option</span></span>
<span id="cb24-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--delete</span> user1 papaerless-ngx</span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## short option</span></span>
<span id="cb24-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> user1 papaerless-ngx</span>
<span id="cb24-6"></span>
<span id="cb24-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 現在のユーザーをpaperless-ngxから除去</span></span>
<span id="cb24-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">whoami</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> paperless-ngx</span></code></pre></div></div>
<p><span class="mini-section"><code>deluser</code>コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## syntax</span></span>
<span id="cb25-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> deluser user1 paperless-ngx</span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 現在のユーザーをpaperless-ngxから除去</span></span>
<span id="cb25-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> deluser <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">whoami</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> paperless-ngx</span></code></pre></div></div>
</section>
<section id="appendix-2-zoteroとの併用方法" class="level2">
<h2 class="anchored" data-anchor-id="appendix-2-zoteroとの併用方法">Appendix 2: Zoteroとの併用方法</h2>
<p>基本コンセプトは，<span class="regmonkey-bold">Paperless-ngxを原本置き場，Zotero はメタデータ管理だけ</span></p>
<ul>
<li>PDF ファイルを Zotero に保存しない</li>
<li>PDF の原本はすべて Paperless に一元管理</li>
<li>Zotero は「文献管理ソフト」として最小限データだけ持つ</li>
<li>Zotero 内では Linked Attachment（リンクされた添付ファイル）を使い，Paperless の PDF を参照する</li>
</ul>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 27%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>役割</th>
<th>担当</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Paperless-ngx</strong></td>
<td>原本保管庫（PDF の全保管・OCR・タグ）</td>
<td>すべての PDF ファイルの実体を保管する（NAS代わり）</td>
</tr>
<tr class="even">
<td><strong>Zotero</strong></td>
<td>文献リスト＋引用情報</td>
<td>メタデータだけを管理し，PDF本体は保存しない</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">運用イメージ</span></p>
<ol type="1">
<li>PDF を Paperless-ngx に入れる</li>
<li>Paperless-ngx が OCR＋タグ整理</li>
<li>必要に応じて Zotero に 文献情報（DOI など）を登録</li>
<li>添付ファイルとして Paperless-ngx の PDF パスを貼る（手動 or 自動スクリプト）</li>
</ol>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.paperless-ngx.com/">Paperless-ngx公式ドキュメント</a></li>
<li><a href="https://packages.debian.org/bullseye/graphics/tesseract-ocr-jpn-vert">Package: tesseract-ocr-jpn-vert</a></li>
</ul>


</section>

 ]]></description>
  <category>環境構築</category>
  <category>paperless-ngx</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-27-paperless-ngx/</guid>
  <pubDate>Thu, 27 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Counterオブジェクト</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-16-counter-object/</link>
  <description><![CDATA[ 






<section id="counter-オブジェクト" class="level2">
<h2 class="anchored" data-anchor-id="counter-オブジェクト"><code>Counter</code> オブジェクト</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Counter</span></p>
<ul>
<li><code>Counter</code> は，ハッシュ可能なオブジェクトの出現回数を数えるための辞書サブクラス</li>
<li>要素を辞書のキーとして保持し，その出現回数を値として保持するコレクション</li>
<li>カウント値には <code>0</code> や負の値を含む任意の整数が使用可能</li>
</ul>
</div>
<p>リストの要素の出現回数を集計する場合，<code>Dict</code> を用いる場合</p>
<div id="308d2bd5" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>]</span>
<span id="cb1-2">count_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> word <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> words:</span>
<span id="cb1-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dict.get(key, default) returns default if key does not exist</span></span>
<span id="cb1-6">    count_dict[word] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> count_dict.get(word, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(count_dict)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{'red': 2, 'blue': 3, 'green': 1}</code></pre>
</div>
</div>
<p><code>Counter</code>を用いることで以下のようにより簡単に集計することが出来ます</p>
<div id="e9ae2908" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb3-2"></span>
<span id="cb3-3">word_counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(words)</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(word_counter)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'blue': 3, 'red': 2, 'green': 1})</code></pre>
</div>
</div>
<p>また，すべての要素の出現頻度の合計は <code>total()</code> メソッドを用いて表示できます</p>
<div id="ed36f359" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(word_counter.total())   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 6 = 3 + 2 + 1</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>6</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (単語出現頻度の計測)</strong></span> <br></p>
<p>ハムレットの一節を内容とする <code>hamlet.txt</code> を例に，出現単語のTop 5の計測を行います．<code>Counter</code> クラスには <code>most_common()</code> メソッドがあり，要素を出現頻度に応じて降順で返してくれます．引数として整数を指定すると，最上位から数えてその個数分だけを出力してくれるので</p>
<div id="2fe07e3d" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 単語を抽出（小文字化して正規表現でマッチ，句読点は除く）</span></span>
<span id="cb7-5">hamlet_words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\w</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hamlet.txt'</span>).read().lower())</span>
<span id="cb7-6">Counter(hamlet_words).most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>[('to', 4), ('the', 3), ('be', 2), ('or', 2), ('and', 2)]</code></pre>
</div>
</div>
<p>出現頻度下位Top 3を出力したい場合は</p>
<div id="12d1a10d" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb9-1">hamlet_counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(hamlet_words)</span>
<span id="cb9-2">hamlet_counter.most_common()[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[('them', 1), ('end', 1), ('opposing', 1)]</code></pre>
</div>
</div>
</div>
<hr>
<section id="counter-インスタンスの作成方法" class="level3">
<h3 class="anchored" data-anchor-id="counter-インスタンスの作成方法"><code>Counter</code> インスタンスの作成方法</h3>
<div id="536c9a4c" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 空の Counter を作る</span></span>
<span id="cb11-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()                           </span>
<span id="cb11-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter()</span></span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. イテラブルから作る</span></span>
<span id="cb11-8">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gallahad'</span>)                 </span>
<span id="cb11-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})</span></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 辞書（マッピング）から作る</span></span>
<span id="cb11-12">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>})      </span>
<span id="cb11-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'red': 1, 'blue': 2})</span></span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. キーワード引数から作る</span></span>
<span id="cb11-16">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(cats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, dogs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)     </span>
<span id="cb11-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'dogs': 8, 'cats': 4}) </span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter()
Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})
Counter({'blue': 2, 'red': 1})
Counter({'dogs': 8, 'cats': 4})</code></pre>
</div>
</div>
</section>
<section id="存在しないキーの取り扱い" class="level3">
<h3 class="anchored" data-anchor-id="存在しないキーの取り扱い">存在しないキーの取り扱い</h3>
<p><code>Counter</code> では存在しないキーにアクセスしても KeyError にはならず，<code>0</code> が返るのが特徴です</p>
<div id="659b7e87" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カウンター作成</span></span>
<span id="cb13-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ham'</span>])</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在するキー</span></span>
<span id="cb13-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>])    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1</span></span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在しないキー</span></span>
<span id="cb13-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bacon'</span>])   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 ← KeyError にはならない</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1
0</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (<code>dict</code> と KeyError)</strong></span> <br></p>
<div id="b05dcdf6" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb15-1">foods <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ham'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb15-4">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bacon:"</span>, foods[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bacon'</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在しないキーは KeyError</span></span>
<span id="cb15-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">KeyError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb15-6">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"KeyError: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>KeyError: 'bacon'</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="挿入順序の保持" class="level3">
<h3 class="anchored" data-anchor-id="挿入順序の保持">挿入順序の保持</h3>
<p>Python 3.7 以降，<code>Counter</code> は内部的には挿入順を保持しています．<code>print</code> などでkey-valueを出力するとvalueに応じた降順でソートされたように見えますが，<code>Counter.keys()</code> などでkeyの順番を確認すると，挿入順となっています</p>
<div id="eeca928f" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb17-2"></span>
<span id="cb17-3">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gallahad'</span>)</span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check display order</span></span>
<span id="cb17-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力は頻度順</span></span>
<span id="cb17-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c))              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 内部の挿入順</span></span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c.keys())             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 内部の挿入順</span></span>
<span id="cb17-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c.elements()))   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># elements順</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})
['g', 'a', 'l', 'h', 'd']
dict_keys(['g', 'a', 'l', 'h', 'd'])
['g', 'a', 'a', 'a', 'l', 'l', 'h', 'd']</code></pre>
</div>
</div>
<p><span class="mini-section">演算処理の順番</span></p>
<p><code>Counter</code> オブジェクトは，<code>+</code> を使った加算処理ができます．このとき，基本的なキーの順番は左オペラントとなり，新しいキーは右オペランドから追加されるという内部処理になります．</p>
<p>つまり，要素順は，<span class="regmonkey-bold">左オペランドの出現順 → 右オペランドで新規に現れた順</span>で決まります．</p>
<div id="70c59a4d" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb19-2"></span>
<span id="cb19-3">c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zbcaad'</span>)</span>
<span id="cb19-4">c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abcd'</span>)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 算術演算</span></span>
<span id="cb19-7">c3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c2</span>
<span id="cb19-8"></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力</span></span>
<span id="cb19-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c3)</span>
<span id="cb19-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c3.keys())</span>
<span id="cb19-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c3.elements()))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 3, 'b': 2, 'c': 2, 'd': 2, 'z': 1})
dict_keys(['z', 'b', 'c', 'a', 'd'])
['z', 'b', 'b', 'c', 'c', 'a', 'a', 'a', 'd', 'd']</code></pre>
</div>
</div>
</section>
</section>
<section id="counter-と算術演算" class="level2">
<h2 class="anchored" data-anchor-id="counter-と算術演算"><code>Counter</code> と算術演算</h2>
<p><span class="mini-section">TL;DRs</span></p>
<div id="483a5b43" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb21-2"></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2つのカウンターを作成</span></span>
<span id="cb21-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-5">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-6"></span>
<span id="cb21-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 算術演算と集合演算</span></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-10"></span>
<span id="cb21-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 足し算: 各キーの値を加算</span></span>
<span id="cb21-12"></span>
<span id="cb21-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c - d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 引き算: 正の値のみ保持, 0 は除外される</span></span>
<span id="cb21-14"></span>
<span id="cb21-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &amp; d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 積集合: min(c[x], d[x])</span></span>
<span id="cb21-16"></span>
<span id="cb21-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c | d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 和集合: max(c[x], d[x])</span></span>
<span id="cb21-18"></span>
<span id="cb21-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 比較演算</span></span>
<span id="cb21-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-22"></span>
<span id="cb21-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c == d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 等価判定</span></span>
<span id="cb21-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &lt;= d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 部分集合判定 (すべての要素が &lt;=)</span></span>
<span id="cb21-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &gt;= d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 部分集合判定 (すべての要素が &gt;=)</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>c + d = Counter({'a': 4, 'b': 3, 'c': 2})
c - d = Counter({'a': 2})
c &amp; d = Counter({'a': 1, 'b': 1, 'c': 1})
c | d = Counter({'a': 3, 'b': 2, 'c': 1})
c == d ? False
c &lt;= d ? False
c &gt;= d ? False</code></pre>
</div>
</div>
<section id="subtract-メソッド" class="level3">
<h3 class="anchored" data-anchor-id="subtract-メソッド"><code>subtract</code> メソッド</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">Counter.subtract</span></p>
<ul>
<li>ある <code>Counter</code> から別の <code>Counter</code> や <code>iterable</code> の要素を減算するメソッド</li>
<li>結果のカウント値は 負の値 になることもある</li>
<li>元の <code>Counter</code> が 変更される（新しいオブジェクトは返らない）</li>
</ul>
</div>
<p>基本的な使い方は</p>
<div id="373d1978" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb23-2"></span>
<span id="cb23-3">c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aabbcc'</span>)</span>
<span id="cb23-4">c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abc'</span>)</span>
<span id="cb23-5"></span>
<span id="cb23-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># c1 から c2 を減算</span></span>
<span id="cb23-7">c1.subtract(c2)</span>
<span id="cb23-8"></span>
<span id="cb23-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c1)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 1, 'b': 1, 'c': 1})</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (iterableからの減算)</strong></span> <br></p>
<div id="3a1c9f5c" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb25-1">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'banana'</span>)</span>
<span id="cb25-2">c.subtract(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'an'</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'a','n' をそれぞれ 1 ずつ減らす</span></span>
<span id="cb25-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 2, 'b': 1, 'n': 1})</code></pre>
</div>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (値は 0 未満になる場合)</strong></span> <br></p>
<div id="013785d7" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb27-1">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'banana2'</span>)</span>
<span id="cb27-2">c.subtract(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'and2'</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'a','n' , 'd'をそれぞれ 1 ずつ減らす</span></span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力</span></span>
<span id="cb27-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 演算結果の出力</span></span>
<span id="cb27-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0以上の要素のみ出力（0は含まない）</span></span>
<span id="cb27-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>c)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0未満の要素のみ出力</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 2, 'b': 1, 'n': 1, '2': 0, 'd': -1})
Counter({'a': 2, 'b': 1, 'n': 1})
Counter({'d': 1})</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="実行順番の注意" class="level3">
<h3 class="anchored" data-anchor-id="実行順番の注意">実行順番の注意</h3>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>Counter</code> の 算術演算は順序によって出力のキー順序が変わることがある</li>
<li><span class="regmonkey-bold">負の値の処理が関わる場合，結果の値自体も変わる</span></li>
</ul>
</div>
</div>
<div id="2f43f438" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3つのカウンターを作成</span></span>
<span id="cb29-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb29-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-6">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-7"></span>
<span id="cb29-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z)</span>
<span id="cb29-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 5, 'b': 5, 'c': 2, 'd': 1, 'e': 1})
Counter({'a': 5, 'b': 5, 'e': 1, 'c': 1, 'd': 1})</code></pre>
</div>
</div>
<p><span class="mini-section">ロバストな加算処理</span></p>
<p>値を置き換えるのではなく，順序ロバストにカウントを加算して計算したい場合は <code>update</code> メソッドを用いるほうが良いかもしれません</p>
<div id="e57e0c94" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb31-2"></span>
<span id="cb31-3">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb31-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-5">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-6"></span>
<span id="cb31-7">c_total_xyz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb31-8">c_total_xzy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb31-9"></span>
<span id="cb31-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [x, y, z]:</span>
<span id="cb31-11">    c_total_xyz.update(c1)</span>
<span id="cb31-12"></span>
<span id="cb31-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [x, z, y]:</span>
<span id="cb31-14">    c_total_xzy.update(c2)</span>
<span id="cb31-15"></span>
<span id="cb31-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 計算結果</span></span>
<span id="cb31-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"c_total_xyz: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>c_total_xyz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"c_total_xzy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>c_total_xzy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-19"></span>
<span id="cb31-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 比較</span></span>
<span id="cb31-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c_total_xyz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> c_total_xzy)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>c_total_xyz: Counter({'a': 5, 'b': 5, 'c': 1, 'd': 1, 'e': 1})
c_total_xzy: Counter({'a': 5, 'b': 5, 'c': 1, 'e': 1, 'd': 1})
True</code></pre>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.python.org/3/library/collections.html#collections.Counter">Counter objects</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-16-counter-object/</guid>
  <pubDate>Sun, 16 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>ETLメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-15-ETL-note/</link>
  <description><![CDATA[ 






<section id="etlとは" class="level2">
<h2 class="anchored" data-anchor-id="etlとは">ETLとは？</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">ETL</span></p>
<ul>
<li>Extract（抽出）・Transform（変換）・Load（格納） の略</li>
<li>要件として
<ul>
<li>自動化されていること</li>
<li>再現性があること</li>
<li>データがどのように加工されか追跡しやすいこと</li>
</ul></li>
</ul>
</div>
<p><span class="mini-section">PythonでETL toolを作成する場面</span></p>
<ul>
<li>ETL要件がシンプルなとき</li>
<li>既存ツールでは満たせない特殊要件があるとき</li>
</ul>
</section>
<section id="etl作業フロー" class="level2">
<h2 class="anchored" data-anchor-id="etl作業フロー">ETL作業フロー</h2>
<p><span class="mini-section">作業フロー</span></p>
<ol type="1">
<li>構造化されていないケースが多いファイル群からデータを抽出する</li>
<li>データクレンジングを実施</li>
<li>あるべきデータフォーマットに従うように型を付与する</li>
<li>データをDBなどに格納する</li>
</ol>
</section>
<section id="代表的なetl-tool" class="level2">
<h2 class="anchored" data-anchor-id="代表的なetl-tool">代表的なETL tool</h2>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>Apache Airflow</th>
<th>Luigi</th>
<th>pandas</th>
<th>petl</th>
<th>Bonobo</th>
<th>Bubbles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>種類</td>
<td>ワークフローオーケストレーション</td>
<td>パイプラインのタスクオーケストレーション</td>
<td>データ分析・変換ライブラリ</td>
<td>軽量ETLフレームワーク</td>
<td>軽量ETLフレームワーク</td>
<td>メタデータ駆動型ETLフレームワーク</td>
</tr>
<tr class="even">
<td>変換機能</td>
<td>Pythonオペレーター経由で間接的</td>
<td>あり（カスタムタスク）</td>
<td>豊富なDataFrame変換</td>
<td>基本的な行単位変換</td>
<td>あり（ノードによる変換）</td>
<td>限定的</td>
</tr>
<tr class="odd">
<td>リアルタイム対応</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
</tr>
<tr class="even">
<td>コネクタ</td>
<td>Python/コミュニティ製プラグイン</td>
<td>ファイルシステム、DB（拡張可能）</td>
<td>CSV, Excel, SQL, JSON など</td>
<td>CSV, Excel, JSON, SQL, XML</td>
<td>ファイル、API、DB</td>
<td>CSV, SQL, JSON, HTTP</td>
</tr>
<tr class="odd">
<td>スケジューリング</td>
<td>あり（リトライ・アラート対応）</td>
<td>あり（内部スケジューラ）</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
</tr>
<tr class="even">
<td>並列処理</td>
<td>あり（Celery, Kubernetes など）</td>
<td>あり</td>
<td>Pandas の並列オプション程度</td>
<td>なし</td>
<td>あり（マルチスレッド）</td>
<td>限定的</td>
</tr>
<tr class="odd">
<td>適している用途</td>
<td>複雑なパイプラインのオーケストレーション</td>
<td>依存関係のあるタスク管理</td>
<td>データクリーニング・分析・整形</td>
<td>軽量のETL作業</td>
<td>小規模ETL・パイプライン可視化</td>
<td>学術用途・プロトタイプETL</td>
</tr>
<tr class="even">
<td>制限</td>
<td>学習コスト高い、リアルタイム不可</td>
<td>UIが基本的、スケールに制限</td>
<td>メモリ内のみで大規模データは難しい</td>
<td>スケジューラ・オーケストレーションなし</td>
<td>エコシステム小、コミュニティ少</td>
<td>メンテナンスされておらず更新ほぼなし</td>
</tr>
<tr class="odd">
<td>サポート</td>
<td>活発なコミュニティ、商用サポートあり</td>
<td>コミュニティサポート</td>
<td>大規模コミュニティ、豊富なエコシステム</td>
<td>小規模コミュニティ</td>
<td>ニッチなコミュニティ</td>
<td>最小限のコミュニティ、更新もほぼなし</td>
</tr>
</tbody>
</table>
</div>


</section>

 ]]></description>
  <category>前処理</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-15-ETL-note/</guid>
  <pubDate>Sat, 15 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>watchコマンドを用いてGPUリソースを確認する</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-14-watch-gpu/</link>
  <description><![CDATA[ 






<section id="watch-コマンド" class="level2">
<h2 class="anchored" data-anchor-id="watch-コマンド"><code>watch</code> コマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">watch コマンド</span></p>
<ul>
<li><p><code>watch</code> は，指定したコマンドを 一定間隔で繰り返し実行し，結果をフルスクリーンで表示する Linux コマンド</p></li>
<li><p>実行中は <code>Ctrl + C</code> で終了できます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">オプション</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span> コマンド</span></code></pre></div></div></li>
</ul>
</div>
<p>用途として，</p>
<ul>
<li>ファイルやプロセスの状態を監視</li>
<li>GPU 使用率やメモリ使用量などの変化を追跡</li>
<li>ディレクトリ内の変化を監視</li>
</ul>
<p>をTerminal上でリアルタイムで確認することが出来ます．</p>
<p><span class="mini-section">Options</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 24%">
<col style="width: 53%">
</colgroup>
<thead>
<tr class="header">
<th>短いオプション</th>
<th>長いオプション</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-t</code></td>
<td><code>--no-title</code></td>
<td>ヘッダ（実行間隔・コマンド名・開始時刻）を非表示</td>
</tr>
<tr class="even">
<td><code>-e</code></td>
<td><code>--errexit</code></td>
<td>実行したコマンドがエラー（0以外）で終了したら watch も終了</td>
</tr>
<tr class="odd">
<td><code>-b</code></td>
<td><code>--beep</code></td>
<td>エラー時にビープ音を鳴らす</td>
</tr>
<tr class="even">
<td><code>-d</code></td>
<td><code>--differences</code></td>
<td>直前の結果と比較し，変化した箇所をハイライト</td>
</tr>
<tr class="odd">
<td><code>-d=permanent</code></td>
<td></td>
<td>初回実行から変化した箇所をハイライト表示</td>
</tr>
<tr class="even">
<td><code>-c</code></td>
<td><code>--color</code></td>
<td>ANSI カラー指定を有効にする</td>
</tr>
<tr class="odd">
<td><code>-g</code></td>
<td><code>--chgexit</code></td>
<td>実行結果が変化したら watch を終了</td>
</tr>
<tr class="even">
<td><code>-n 秒数</code></td>
<td><code>--interval 秒数</code></td>
<td>実行間隔（秒）を指定，最小 0.1 秒</td>
</tr>
<tr class="odd">
<td><code>-p</code></td>
<td><code>--precise</code></td>
<td>実行タイミングをより厳密に制御</td>
</tr>
<tr class="even">
<td><code>-x</code></td>
<td><code>--exec</code></td>
<td>コマンドを <code>exec</code> で実行（<code>sh -c</code> ではない）</td>
</tr>
</tbody>
</table>
</div>
<section id="コマンドパート動作の仕組み" class="level3">
<h3 class="anchored" data-anchor-id="コマンドパート動作の仕組み">コマンドパート動作の仕組み</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 45%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド</th>
<th>シェルによる展開のタイミング</th>
<th>表示される PID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>watch echo $$</code></td>
<td>入力した瞬間に展開される</td>
<td>常に「現在のシェルの PID」 → 変化しない</td>
</tr>
<tr class="even">
<td><code>watch echo '$$'</code></td>
<td>展開されずに watch に渡る → watch 内の sh が展開</td>
<td>毎回「新しい sh の PID」 → 変化する</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><code>watch</code> で実行されるコマンドは，そのまま実行されるのではな<span class="regmonkey-bold">sh -c &lt;コマンド文字列&gt;として新しいシェルに渡されてから実行</span>されています．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;command&gt;"</span></span></code></pre></div></div>
<p>このため，指定したコマンドの引数の中で環境変数やシェル変数を参照したいなど，引用符を使いたい場合は，適宜引用符を補う必要があります．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (<code>watch echo $$</code>の場合)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> echo <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$$</span></span></code></pre></div></div>
<p>とすると，シェルが先に <code>$$</code> を展開 してしまいます．つまり，実行時のシェルのPIDが1000なら</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> echo 1000</span></code></pre></div></div>
<p>と解釈され実行されます．毎回新しいシェルで展開されることを実現したいならば</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">wtach</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'$$'</span></span></code></pre></div></div>
<p>とすると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"echo </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
<p>と解釈され，sh が <code>$$</code> を展開し，実行時の sh の PID が表示されます．</p>
</div>
<hr>
</section>
</section>
<section id="watchコマンド実践" class="level2">
<h2 class="anchored" data-anchor-id="watchコマンド実践">watchコマンド実践</h2>
<section id="case-1-gpuリソースを監視する" class="level3">
<h3 class="anchored" data-anchor-id="case-1-gpuリソースを監視する">Case 1: GPUリソースを監視する</h3>
<p><span class="mini-section">Requirements</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> gpustat <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gpustat</span> 1.1.1</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> byobu <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span>
<span id="cb7-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">byobu</span> version 6.11</span>
<span id="cb7-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tmux</span> 3.4</span></code></pre></div></div>
<p><span class="mini-section">コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 1 nvidia-smi</span></code></pre></div></div>
<ul>
<li>毎秒（1秒間隔）で <code>nvidia-smi</code> を再実行し，GPUの状態を表示するコマンド</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 1 gpustat <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--color</span></span></code></pre></div></div>
<ul>
<li>毎秒（1秒間隔）で <code>gpustat</code> を再実行し，GPUの状態をカラー表示で更新するコマンド</li>
<li><code>nvidia-smi</code>と比べ表示がコンパクト</li>
</ul>
<p><span class="mini-section">Tips</span></p>
<ul>
<li><code>Byobu</code>を用いている場合は <code>Shift</code> + <code>F2</code> で上下にwindowをsplitして，<code>Alt</code> + <code>Shift</code> + <code>↑</code>/<code>↓</code> で表示を領域をコンパクトにできる</li>
<li><code>Gnome Terminator</code> の場合は <code>Ctrl</code> + <code>Shift</code> + <code>O</code> で上下split，その後 <code>Ctrl</code> + <code>Shift</code> + <code>↑</code>/<code>↓</code> で表示を領域をresize</li>
</ul>
</section>
<section id="case-2-メモリリソースを監視する" class="level3">
<h3 class="anchored" data-anchor-id="case-2-メモリリソースを監視する">Case 2: メモリリソースを監視する</h3>
<div class="reveal_vspace" style="--vspace-height: 0.5em;"></div>
<p><span class="mini-section">コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 1 free <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-h</span></span></code></pre></div></div>
<ul>
<li>毎秒（1秒間隔）で <code>free -h</code> を再実行し，メモリとSwapの使用状況を表示するコマンド</li>
<li>available 列を見ることで，アプリが実際に使えるメモリ量を把握できる</li>
</ul>
</section>
<section id="case-3-dockerの起動状態を確認する" class="level3">
<h3 class="anchored" data-anchor-id="case-3-dockerの起動状態を確認する">Case 3: Dockerの起動状態を確認する</h3>
<div class="reveal_vspace" style="--vspace-height: 0.5em;"></div>
<p><span class="mini-section">コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 30 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docker ps"</span></span></code></pre></div></div>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション/コマンド</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>watch</code></td>
<td>コマンドを定期実行</td>
</tr>
<tr class="even">
<td><code>-n 30</code></td>
<td>30秒ごとに実行</td>
</tr>
<tr class="odd">
<td><code>-t</code></td>
<td>ヘッダーを非表示</td>
</tr>
<tr class="even">
<td><code>docker ps</code></td>
<td>現在動作中の Docker コンテナを一覧表示</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>引用符 <code>"</code> はなくても僕の環境では動作しますが，常に安全に動かすには引用符で囲む方が安全とのことです．</li>
</ul>
</section>
<section id="case-4-memory-usageの確認" class="level3">
<h3 class="anchored" data-anchor-id="case-4-memory-usageの確認">Case 4: Memory Usageの確認</h3>
<div class="reveal_vspace" style="--vspace-height: 0.5em;"></div>
<p><span class="mini-section">コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">watch</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 1 free <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span></span></code></pre></div></div>
<p>表示結果例は以下</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">               total        used        free      shared  buff/cache   available</span></span>
<span id="cb13-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Mem:           63439        7314       46771         216        9898       56124</span></span>
<span id="cb13-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Swap:           8191           0        8191</span></span></code></pre></div></div>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 66%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>サイズ (MB)</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>total</td>
<td>63439</td>
<td>システム全体の物理メモリ量（約63GB）</td>
</tr>
<tr class="even">
<td>used</td>
<td>7314</td>
<td>OSやプロセスによって現在使用中のメモリ量（キャッシュ・バッファ含む）</td>
</tr>
<tr class="odd">
<td>free</td>
<td>46771</td>
<td>現在まったく使用されていない空きメモリ</td>
</tr>
<tr class="even">
<td>shared</td>
<td>216</td>
<td>プロセス間で共有されているメモリ（最近の Linux では重要度低め）</td>
</tr>
<tr class="odd">
<td>buff/cache</td>
<td>9898</td>
<td>ファイルキャッシュやバッファとして使われているメモリ（必要なら解放可能）</td>
</tr>
<tr class="even">
<td>available</td>
<td>56124</td>
<td>実際に新しいアプリが使えるメモリ（キャッシュ分も含めて計算済み）</td>
</tr>
</tbody>
</table>
</div>
<p>メモリの逼迫度や空き容量は基本的には <code>available</code> フィールドの値を見て判断します．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Cache領域
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>ディスクキャッシュは，最近アクセスしたファイルを RAM に保持する仕組み</li>
<li>Linuxは未使用のメモリをディスクキャッシュ用に利用する</li>
<li>キャッシュはアプリからメモリを奪うことはなく，性能向上にだけ使われる</li>
<li><code>used</code> にはキャッシュも含まれるので，見た目だけでは「メモリ不足」に見えることがあることに注意</li>
</ul>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://askubuntu.com/questions/155768/how-do-i-clean-or-disable-the-memory-cache/155771#155771">How do I clean or disable the memory cache?</a></li>
</ul>


</section>

 ]]></description>
  <category>Linux</category>
  <category>監視</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-14-watch-gpu/</guid>
  <pubDate>Fri, 14 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>自分用VSCodeショートカットシート: Git Rebase Message</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-11-vscode-shortcut-for-git-rebase-message/</link>
  <description><![CDATA[ 






<section id="設定内容の全体像" class="level2">
<h2 class="anchored" data-anchor-id="設定内容の全体像">🔧 設定内容の全体像</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Git</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Rebase</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Message</span></span>
<span id="cb1-3">  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+enter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"runCommands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"commands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"workbench.action.files.save"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"workbench.action.closeActiveEditor"</span></span>
<span id="cb1-10">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorTextFocus &amp;&amp; !editorReadonly &amp;&amp; editorLangId == 'git-rebase'"</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-14"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p><span class="mini-section">技術スペック</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>目的</strong></td>
<td>Git rebase 用メッセージ編集画面で，Ctrl+Enter により「保存＋エディタを閉じる」操作を自動化する</td>
</tr>
<tr class="even">
<td><strong>キー割り当て</strong></td>
<td><code>ctrl+enter</code></td>
</tr>
<tr class="odd">
<td><strong>コマンド</strong></td>
<td><code>runCommands</code>（複数コマンドの連続実行）</td>
</tr>
<tr class="even">
<td><strong>実行コマンド列</strong></td>
<td>1. <code>workbench.action.files.save</code>（ファイル保存）<br>2. <code>workbench.action.closeActiveEditor</code>（エディタを閉じる）</td>
</tr>
<tr class="odd">
<td><strong>動作条件</strong></td>
<td><code>editorTextFocus &amp;&amp; !editorReadonly &amp;&amp; editorLangId == 'git-rebase'</code><br>＝ 編集可能な Git rebase メッセージ編集中のみ有効</td>
</tr>
<tr class="even">
<td><strong>適用範囲</strong></td>
<td>言語モードが <code>git-rebase</code> のファイル（通常 <code>.git/rebase-merge/git-rebase-todo</code>）</td>
</tr>
</tbody>
</table>
</div>
<section id="設定詳細" class="level3">
<h3 class="anchored" data-anchor-id="設定詳細">設定詳細</h3>
<p><span class="mini-section">when条件</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 64%">
</colgroup>
<thead>
<tr class="header">
<th>条件</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>editorTextFocus</code></td>
<td>テキストエディタにフォーカスがある（＝テキスト入力できる状態）</td>
</tr>
<tr class="even">
<td><code>!editorReadonly</code></td>
<td>エディタが読み取り専用でない（＝編集可能）</td>
</tr>
<tr class="odd">
<td><code>editorLangId == 'git-rebase'</code></td>
<td>開いているファイルの言語モードが <code>"git-rebase"</code>（＝Git rebase メッセージ編集画面）</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="appendix-vscodeでのmultiple-commandsショートカットの設定" class="level2">
<h2 class="anchored" data-anchor-id="appendix-vscodeでのmultiple-commandsショートカットの設定">Appendix: VSCodeでのmultiple Commandsショートカットの設定</h2>
<p>VScodeでは <code>"command": "runCommands",</code> を設定することで，複数のコマンドを<span class="regmonkey-bold">順番に実行</span>するように設定できます．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (引数なしで複数のコマンドを実行)</strong></span> <br></p>
<ol type="1">
<li>現在の行を下にコピー</li>
<li>現在の行をコメント化</li>
<li>コピーした行にカーソルを移動</li>
</ol>
<p>という手順を実行するショートカットの場合，以下のように <code>keybindings.json</code> を設定します</p>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (引数付コマンドの実行)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+meta+l"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"runCommands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"commands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-6">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"workbench.action.terminal.focus"</span></span>
<span id="cb2-8">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-10">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"workbench.action.terminal.sendSequence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-11">          <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-12">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"text"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"git lastdiff ${file}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\u000D</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-13">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-14">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-15">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-17">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"when"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"editorFocus"</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">,</span></span></code></pre></div></div>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>"key": "ctrl+meta+l"</code></td>
<td>このショートカットを押したときに動作</td>
</tr>
<tr class="even">
<td><code>workbench.action.terminal.focus</code></td>
<td>ターミナルにフォーカスを移す</td>
</tr>
<tr class="odd">
<td><code>workbench.action.terminal.sendSequence</code></td>
<td>ターミナルに文字列を送信（<code>\u000D</code> は Enter キー）</td>
</tr>
<tr class="even">
<td><code>"when": "editorFocus"</code></td>
<td>エディタにフォーカスがあるときのみ有効</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (複数の引数を渡したい場合)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"key"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ctrl+shift+e"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"runCommands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"commands"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb3-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">        <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">command</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">invoked</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">with</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">arguments</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">vscode.executeCommand(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"myCommand"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"arg1"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"arg2"</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"myCommand"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arg1"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arg2"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-10">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-11">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://code.visualstudio.com/docs/configure/keybindings#_running-multiple-commands">Keyboard shortcuts for Visual Studio Code &gt; Running multiple commands</a></li>
</ul>


</section>

 ]]></description>
  <category>環境構築</category>
  <category>shortcuts</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-11-vscode-shortcut-for-git-rebase-message/</guid>
  <pubDate>Tue, 11 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>継承，メソッドオーバーライド，スーパーメソッドの呼び出し</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-04-python-class-rules/</link>
  <description><![CDATA[ 






<section id="継承inheritance" class="level2">
<h2 class="anchored" data-anchor-id="継承inheritance">継承(Inheritance)</h2>
<p>サブクラスが親クラスを継承すると，親クラスで定義されたすべてのプロパティとメソッドを引き継ぐことができます．</p>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">OOPにおける継承</span></p>
<ul>
<li>あるクラス（親クラス，スーパークラス，基底クラス）の機能を，別のクラス（子クラス，サブクラス，派生クラス）が引き継ぐ仕組み</li>
<li><strong>再利用性</strong>: 同じような処理を複数のクラスで書かかずに，親クラスにまとめてしまう</li>
<li><strong>拡張性</strong>: 親クラスの機能をそのまま使いつつ，新しい振る舞い（メソッドや属性）を追加・変更できる</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (初期化処理 <code>__init__</code> と継承)</strong></span> <br></p>
<div id="64aa513e" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Person:</span>
<span id="cb1-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, nationality):</span>
<span id="cb1-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb1-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nationality <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nationality</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> FootballPlayer(Person):</span>
<span id="cb1-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, nationality, position, club):</span>
<span id="cb1-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 親クラスの初期化（nameとnationalityを設定）</span></span>
<span id="cb1-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(name, nationality)</span>
<span id="cb1-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 子クラス独自の属性</span></span>
<span id="cb1-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> position</span>
<span id="cb1-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.club <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> club</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インスタンス生成</span></span>
<span id="cb1-15">player <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FootballPlayer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kylian Mbappé"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"France"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Forward"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Real Madrid"</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.name)</span>
<span id="cb1-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.nationality)</span>
<span id="cb1-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.position)</span>
<span id="cb1-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.club)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Kylian Mbappé
France
Forward
Real Madrid</code></pre>
</div>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (<code>dataclass</code> を用いた初期化処理と継承)</strong></span> <br></p>
<div id="e64f8143" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Person:</span>
<span id="cb3-5">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb3-6">    nationality: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> FootballPlayer(Person):</span>
<span id="cb3-10">    position: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb3-11">    club: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Arsenal'</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># デフォルト値OK</span></span>
<span id="cb3-12"></span>
<span id="cb3-13">player <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FootballPlayer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kylian Mbappé"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"France"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Forward"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Real Madrid"</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.name)</span>
<span id="cb3-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.nationality)</span>
<span id="cb3-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.position)</span>
<span id="cb3-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(player.club)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Kylian Mbappé
France
Forward
Real Madrid</code></pre>
</div>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (<code>dataclass</code> を用いた初期化処理と継承 with <code>__post_init__</code>)</strong></span> <br></p>
<ul>
<li><code>dataclass</code> は 親クラス → 子クラス の順にフィールドを結合して <code>__init__</code> を自動生成</li>
<li><code>super().__init__</code> の設定が <code>dataclass</code> 継承では不要になる</li>
<li>親クラスでデフォルト値を用いていると少し話がややこしくなる</li>
</ul>
<div id="d1ac8927" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb5-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Person:</span>
<span id="cb5-5">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb5-6"></span>
<span id="cb5-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_name(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb5-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name)</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb5-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MDPerson(Person):</span>
<span id="cb5-12">    affiliation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb5-13"></span>
<span id="cb5-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> __post_init__(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb5-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Doctor </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-16"></span>
<span id="cb5-17">John <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MDPerson(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'John'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'UT'</span>)</span>
<span id="cb5-18">John.print_name()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Doctor John</code></pre>
</div>
</div>
</div>
<hr>
<section id="メソッドのオーバーライド" class="level3">
<h3 class="anchored" data-anchor-id="メソッドのオーバーライド">メソッドのオーバーライド</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">メソッドのオーバーライド</span></p>
<ul>
<li>親クラス（スーパークラス）で定義されたメソッドを，子クラス（サブクラス）で再定義して振る舞いを変更すること</li>
<li>Pythonでは，基本的にすべてのメソッドがC++における「仮想関数」に相当 = <span class="regmonkey-bold">いつでもオーバーライド可能</span>
<ul>
<li><code>def __methodname(self)</code> などのようにprivate化である程度防ぐことは可能</li>
</ul></li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (親メソッドを部分的に再利用するオーバーライド)</strong></span> <br></p>
<div id="cf94dbb0" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Logger:</span>
<span id="cb7-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> log(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, msg):</span>
<span id="cb7-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[LOG] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>msg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> TimestampLogger(Logger):</span>
<span id="cb7-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> log(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, msg):</span>
<span id="cb7-7">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb7-8">        now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now().isoformat()</span>
<span id="cb7-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().log(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>now<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>msg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-10"></span>
<span id="cb7-11">TimestampLogger().log(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system started"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[LOG] 2025-12-09T00:38:40.727045 - system started</code></pre>
</div>
</div>
</div>
<hr>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Explicitly mark method overrides in subclasses using decorators or documentation.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>@override</code> デコレータ（Python 3.12以降 or <code>typing_extensions</code>経由）を使う, xor，docstring で「<code>"""Override of Base.process"""</code>」と明記する</li>
<li>明確な意図がない限り，基底クラスのメソッドや属性を再定義しない</li>
<li>実装を置き換えるのではなく拡張する場合は，<code>super()</code> を適切に呼び出す</li>
<li>基底クラス側でオーバーライドを想定していない場合は <code>__</code> を付与してprivate化する</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 5</strong></span> <br></p>
<div id="d5f19244" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from typing import override  # Python 3.12以降利用可能)</span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing_extensions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> override  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Python 3.11などではtyping_extensions経由</span></span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Base:</span>
<span id="cb9-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data):</span>
<span id="cb9-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Base processing:"</span>, data)</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Derived(Base):</span>
<span id="cb9-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@override</span></span>
<span id="cb9-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data):</span>
<span id="cb9-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Override of Base.process"""</span></span>
<span id="cb9-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Derived processing:"</span>, data)</span>
<span id="cb9-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().process(data)</span></code></pre></div></div>
</details>
</div>
</div>
<hr>
</section>
<section id="interface-inheritance-vs-implementation-inheritance" class="level3">
<h3 class="anchored" data-anchor-id="interface-inheritance-vs-implementation-inheritance">Interface Inheritance vs Implementation Inheritance</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">Implementation Inheritance（実装継承）</span></p>
<ul>
<li>既存の型を特殊化し，基底クラスのコードを再利用する継承のこと</li>
<li>インターフェース継承以外の継承は実装継承</li>
</ul>
</div>
<p><span class="mini-section">Pros</span></p>
<ul>
<li>基底クラスのコードを再利用するので，コード量を削減できる</li>
<li>継承関係はクラス定義時（コンパイル時相当）に明示されるため，静的解析ツールがその構造を理解しやすく，定義ミス（例: 未実装メソッドや誤ったオーバーライド）を早期に検出できる</li>
</ul>
<p><span class="mini-section">Cons</span></p>
<ul>
<li>基底クラスとサブクラスに実装が分散するため，クラス階層を追いかけなければ挙動を理解できない</li>
<li>「上書きすべきでないメソッド」を誤って上書きしてしまうリスクがある</li>
<li>実行時に<strong>メソッド解決順序（MRO）</strong>をたどるため，パフォーマンスが低下する可能性がある</li>
<li>多重継承時に，<strong>ダイヤモンド継承問題</strong>（同一祖先を複数経路で継承する形）が発生するリスクがある</li>
</ul>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Keep inheritance hierarchies as shallow as possible — ideally within one or two levels.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>継承階層はできるだけ浅く保ち，理想的には1〜2段階以内にとどめる</li>
<li>多重継承自体は許容されるが，多重実装継承は基本的には非推奨</li>
<li>ダイヤモンド継承は特に避けるべき</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 6 (アンチパターン)</strong></span> <br></p>
<div id="e5da6c2f" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Device:</span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> power_on(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Power on"</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> NetworkDevice(Device):</span>
<span id="cb10-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connect to network"</span>)</span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> SmartDevice(Device):</span>
<span id="cb10-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connect to app"</span>)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Diamond inheritance: both inherit from Device</span></span>
<span id="cb10-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> SmartNetworkDevice(SmartDevice, NetworkDevice):</span>
<span id="cb10-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sync(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Syncing data"</span>)</span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ambiguity: which connect() should be used?</span></span>
<span id="cb10-19">snd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SmartNetworkDevice()</span>
<span id="cb10-20">snd.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -&gt; Which one? Depends on MRO (method resolution order)</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Connect to app</code></pre>
</div>
</div>
</div>
<hr>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title">インターフェース継承</span></p>
<ul>
<li>抽象クラスを親クラスとする継承のこと</li>
<li>クラスに特定のメソッド群の実装を強制することもできる継承形態</li>
<li>同一APIを複数クラスで統一的に提供したいときに特に利用される</li>
<li>「何をできるか（what）」を宣言し，「どう実装するか（how）」はサブクラスに委ねる</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 7 (Abstract Base Classを用いたインターフェース継承)</strong></span> <br></p>
<div id="843ec87e" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> abc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ABC, abstractmethod</span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Serializer(ABC):</span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@abstractmethod</span></span>
<span id="cb12-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> serialize(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data):</span>
<span id="cb12-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> JsonSerializer(Serializer):</span>
<span id="cb12-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> serialize(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data):</span>
<span id="cb12-10">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb12-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> json.dumps(data)</span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> save_data(serializer: Serializer, data):</span>
<span id="cb12-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(serializer.serialize(data))</span>
<span id="cb12-15"></span>
<span id="cb12-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unified interface:</span></span>
<span id="cb12-17">save_data(JsonSerializer(), {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar"</span>})</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{"foo": "bar"}</code></pre>
</div>
</div>
</div>
<hr>
<p><span class="mini-section">Pros</span></p>
<ul>
<li>明示的なインターフェース契約により，APIの一貫性と可読性を高められる</li>
<li>IDE補完・型チェック・静的解析が機能する</li>
<li>設計段階で「実装漏れ」や「誤実装」を検出できる</li>
<li>ユニットテストケース準備が容易になる</li>
</ul>
<p><span class="mini-section">Cons</span></p>
<ul>
<li>小規模コードでは過剰設計になりがち(そもそも抽象クラスが必要ではない可能性がある)</li>
<li>抽象クラスが肥大化すると，不要なメソッド実装を強制される場合がある</li>
<li>API変更時に全実装クラスの修正が必要になる（保守コストの増大）</li>
<li>わざわざ継承を使うのではなく，ダックタイピング + コンポジションで十分なケースもある</li>
<li>実装継承と異なり，コード再利用による短縮効果はない</li>
</ul>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Define clear, minimal, and stable interfaces.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>インターフェースは必要最小限のメソッドにとどめる</li>
<li>共通APIを抽象クラスを用いて定義する場合は，説明用documentを用意すること</li>
</ul>
<p>例: すべての推定器・予測モデルは <code>BaseEstimator（ABC）</code>を継承し，最低限 <code>fit(X, y)</code>, <code>predict(X)</code> を定義し，必要に応じて<code>score(X, y)</code>を追加する</p>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 8 (統計推定量モジュール用の実装例)</strong></span> <br></p>
<div id="6a434fa3" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> abc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ABC, abstractmethod</span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> BaseEstimator(ABC):</span>
<span id="cb14-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Abstract base class for all estimators.</span></span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Rules:</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        - Require fit() and predict() methods</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        - Optionally define score()</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb14-11"></span>
<span id="cb14-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@abstractmethod</span></span>
<span id="cb14-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X: np.ndarray, y: np.ndarray):</span>
<span id="cb14-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Fit model to data."""</span></span>
<span id="cb14-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb14-16"></span>
<span id="cb14-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@abstractmethod</span></span>
<span id="cb14-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> predict(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb14-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Predict from model."""</span></span>
<span id="cb14-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb14-21"></span>
<span id="cb14-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X: np.ndarray, y: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb14-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Optional: default scoring by R^2."""</span></span>
<span id="cb14-24">        y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.predict(X)</span>
<span id="cb14-25">        u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_pred) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb14-26">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y.mean()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb14-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> v</span>
<span id="cb14-28"></span>
<span id="cb14-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> LinearRegression(BaseEstimator):</span>
<span id="cb14-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Ordinary Least Squares Estimator."""</span></span>
<span id="cb14-31"></span>
<span id="cb14-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb14-33">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coef_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-34">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.intercept_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-35"></span>
<span id="cb14-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X: np.ndarray, y: np.ndarray):</span>
<span id="cb14-37">        X_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.c_[np.ones(X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), X]</span>
<span id="cb14-38">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.pinv(X_.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> X_) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> X_.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> y</span>
<span id="cb14-39">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.intercept_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> beta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb14-40">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coef_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> beta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]</span>
<span id="cb14-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb14-42"></span>
<span id="cb14-43">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> predict(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb14-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coef_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.intercept_</span></code></pre></div></div>
</details>
</div>
<p>Then,</p>
<div id="7c26275d" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb15-1">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb15-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb15-3"></span>
<span id="cb15-4">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LinearRegression()</span>
<span id="cb15-5">model.fit(X, y)</span>
<span id="cb15-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R^2:"</span>, model.score(X, y))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R^2: 0.9875886061628938</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="インスタンス属性メソッドと-public-protected-private-の整理" class="level3">
<h3 class="anchored" data-anchor-id="インスタンス属性メソッドと-public-protected-private-の整理">インスタンス属性・メソッドと <code>public</code> / <code>protected</code> / <code>private</code> の整理</h3>
<p>継承の文脈において，C++では「<strong>データメンバーはprivateにすべき</strong>」とされますが，</p>
<ul>
<li>C++ と異なり，Pythonはすべての属性とメソッドが公開が基本</li>
<li>親クラスの属性を完全にprivate的に運用（名前マングリング）してしまうと継承の柔軟性が大きく失われる</li>
</ul>
<p>という理由から，private(<code>__name</code>) よりかはprotected(<code>_name</code>) という運用のほうが好ましいとされます．</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 20%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>目的</th>
<th>Pythonでの命名</th>
<th>サブクラスから</th>
<th>外部コードから</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>公開API</td>
<td><code>name</code></td>
<td>✅</td>
<td>✅</td>
<td>利用者向けのメソッドやプロパティ</td>
</tr>
<tr class="even">
<td>継承向け内部属性</td>
<td><code>_name</code></td>
<td>✅</td>
<td>⚠️（非推奨）</td>
<td>継承拡張で使うデータメンバー</td>
</tr>
<tr class="odd">
<td>完全に内部限定</td>
<td><code>__name</code></td>
<td>❌</td>
<td>❌</td>
<td>継承しない前提での内部実装用</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="propertyの活用" class="level3">
<h3 class="anchored" data-anchor-id="propertyの活用">Propertyの活用</h3>
<p>API設計の観点から読み取り専用の値や派生値を返す場合，<code>getter</code> だけのプロパティを作成して，<code>setter</code> を不要にすることもできます．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 9</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> abc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ABC, abstractmethod</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> BaseEstimator(ABC):</span>
<span id="cb17-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@abstractmethod</span></span>
<span id="cb17-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X, y):</span>
<span id="cb17-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb17-7"></span>
<span id="cb17-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@abstractmethod</span></span>
<span id="cb17-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> predict(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, X):</span>
<span id="cb17-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> LinearEstimator(BaseEstimator):</span>
<span id="cb17-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb17-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># protected属性として保持</span></span>
<span id="cb17-15"></span>
<span id="cb17-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb17-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weights(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb17-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""軽微な計算や検証を伴う派生値を返す"""</span></span>
<span id="cb17-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._weights <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb17-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimator has not been fitted yet"</span>)</span>
<span id="cb17-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._weights</span></code></pre></div></div>
<ul>
<li><code>weights</code> は計算や状態確認を伴うため プロパティとして提供</li>
<li><code>fit()</code> / <code>predict()</code> は必須の公開API</li>
<li>内部状態 <code>_weights</code> は protected とし，直接操作させない</li>
</ul>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Use Properties to expose minimal and predictable attribute APIs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>属性アクセスのAPIを提供する場合，プロパティは軽量な計算や制約チェックがある場合のみ使用</li>
<li>読み取り専用の値や派生値を返す場合，<code>getter</code> だけのプロパティを作成して，<code>setter</code> を不要にする</li>
</ul>
</div>
</div>
</section>
<section id="例外的な状況を覗いて-staticmethod-は使用しない" class="level3">
<h3 class="anchored" data-anchor-id="例外的な状況を覗いて-staticmethod-は使用しない">例外的な状況を覗いて <code>staticmethod</code> は使用しない</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 5</strong></span> <span class="def-title">staticmethod</span></p>
<ul>
<li>クラスに属するが，インスタンス (<code>self</code>) やクラス (<code>cls</code>) に依存しないメソッド</li>
<li>実際には単なる「モジュール関数」をクラス内に置いた形</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 10</strong></span> <br></p>
<ul>
<li><code>self.__class__</code> はインスタンスのクラスを参照するので，<code>staticmethod</code> も呼び出し可能</li>
<li><code>&lt;Class&gt;</code>でも参照可能(<code>CoyoteWeapon.commercial()</code>)</li>
</ul>
<div id="43e891cf" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb18-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CoyoteWeapon:</span>
<span id="cb18-5">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb18-6">    power: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb18-7"></span>
<span id="cb18-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb18-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> commercial():</span>
<span id="cb18-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This is Coyote Weapon"</span>)</span>
<span id="cb18-11"></span>
<span id="cb18-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> info(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb18-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__class__</span>.commercial()</span>
<span id="cb18-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Weapon: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Power: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>power<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-15"></span>
<span id="cb18-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># クラス名から staticmethod を呼び出す</span></span>
<span id="cb18-17">CoyoteWeapon.commercial()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># → This is Coyote Weapon</span></span>
<span id="cb18-18"></span>
<span id="cb18-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インスタンスを作ってメソッドを呼ぶ</span></span>
<span id="cb18-20">weapon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CoyoteWeapon(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rocket Launcher"</span>, power<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9000</span>)</span>
<span id="cb18-21">weapon.info()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>This is Coyote Weapon
This is Coyote Weapon
Weapon: Rocket Launcher, Power: 9000</code></pre>
</div>
</div>
</div>
<hr>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Avoid staticmethod unless API requires it
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>staticmethod</code> の乱用を避け，モジュールレベル関数で基本対応する</li>
<li>MLflowなどのAPI側が実装を要求する場合のみ利用する</li>
</ul>
</div>
</div>
</section>
<section id="classmethod-は限定的に利用する" class="level3">
<h3 class="anchored" data-anchor-id="classmethod-は限定的に利用する"><code>classmethod</code> は限定的に利用する</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 6</strong></span> <span class="def-title">classmethod</span></p>
<ul>
<li>クラス全体に影響を与えるmethod</li>
</ul>
</div>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Use classmethod only when writing a named constructor, or a class-specific routine that modifies necessary global state such as a process-wide cache.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>名前付きコンストラクタ や　クラス固有の処理（例: プロセス全体で使うキャッシュの初期化など）でのみ使用</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 11 (名前付きコンストラクタ)</strong></span> <br></p>
<ul>
<li>通常のコンストラクタ <code>__init__</code> とは別に，クラスを初期化する補助的なコンストラクタを作りたい場合に使う</li>
</ul>
<div id="cbb696dd" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb20-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Rectangle:</span>
<span id="cb20-5">    width: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb20-6">    height: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb20-7"></span>
<span id="cb20-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb20-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> from_square(cls, side_length: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb20-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""正方形から Rectangle を作る名前付きコンストラクタ"""</span></span>
<span id="cb20-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cls(width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>side_length, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>side_length)</span>
<span id="cb20-12"></span>
<span id="cb20-13"></span>
<span id="cb20-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用例</span></span>
<span id="cb20-15">r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Rectangle.from_square(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb20-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(r)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rectangle(width=5, height=5)</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rectangle(width=5, height=5)</code></pre>
</div>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 12</strong></span> <br></p>
<ul>
<li><code>_global_cache</code> はクラス全体で共有される状態</li>
<li><code>classmethod</code> を使うことで，インスタンスを生成せずにアクセス可能</li>
</ul>
<div id="d16933ba" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Cache:</span>
<span id="cb22-2">    _global_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb22-3"></span>
<span id="cb22-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb22-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(cls, key, value):</span>
<span id="cb22-6">        cls._global_cache[key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value</span>
<span id="cb22-7"></span>
<span id="cb22-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb22-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get(cls, key):</span>
<span id="cb22-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cls._global_cache.get(key)</span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用例</span></span>
<span id="cb22-13">Cache.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb22-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(Cache.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>)) </span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>100</code></pre>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="コンポジションcomposition" class="level2">
<h2 class="anchored" data-anchor-id="コンポジションcomposition">コンポジション(Composition)</h2>
<p>継承(Inhertitance)は，「class Aは class Bの一種」という思想が背景にありますが，</p>
<ul>
<li>アヒルは鳥であると同時にくちばしやしっぽを持っている</li>
</ul>
<p>というようなA(アヒル)はB(くちばしやしっぽ)を有している(A-has-B logic)の場合は，コンポジション（composition）を使うべきとされます．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 13 (🦆 コンポジション（A-has-B logic)</strong></span> <br></p>
<div id="6875d04e" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb24-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Bill:</span>
<span id="cb24-5">    length_cm: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb24-6">    color: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb24-7"></span>
<span id="cb24-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> quack_sound(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Quack!"</span></span>
<span id="cb24-10"></span>
<span id="cb24-11"></span>
<span id="cb24-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb24-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Tail:</span>
<span id="cb24-14">    length_cm: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb24-15">    fluffiness: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1〜10段階</span></span>
<span id="cb24-16"></span>
<span id="cb24-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> wag(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tail wagging gracefully"</span></span>
<span id="cb24-19"></span>
<span id="cb24-20"></span>
<span id="cb24-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb24-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Bird:</span>
<span id="cb24-23">    species: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb24-24"></span>
<span id="cb24-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fly(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>species<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is flying!"</span></span>
<span id="cb24-27"></span>
<span id="cb24-28"></span>
<span id="cb24-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb24-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Duck(Bird):</span>
<span id="cb24-31">    bill: Bill</span>
<span id="cb24-32">    tail: Tail</span>
<span id="cb24-33"></span>
<span id="cb24-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> describe(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (</span>
<span id="cb24-36">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is a </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>species<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb24-37">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Bill: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bill<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>length_cm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">cm, color </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>bill<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>color<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb24-38">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Tail: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tail<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>length_cm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">cm, fluffiness </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tail<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>fluffiness<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb24-39">        )</span>
<span id="cb24-40"></span>
<span id="cb24-41">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> quack(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bill.quack_sound()</span>
<span id="cb24-43"></span>
<span id="cb24-44">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> wag_tail(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb24-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tail.wag()</span>
<span id="cb24-46"></span>
<span id="cb24-47">duck <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Duck(</span>
<span id="cb24-48">    species<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mallard"</span>,</span>
<span id="cb24-49">    bill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Bill(length_cm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.5</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yellow"</span>),</span>
<span id="cb24-50">    tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Tail(length_cm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.0</span>, fluffiness<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb24-51">)</span>
<span id="cb24-52"></span>
<span id="cb24-53"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(duck.describe())</span>
<span id="cb24-54"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(duck.fly())</span>
<span id="cb24-55"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(duck.quack())</span>
<span id="cb24-56"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(duck.wag_tail())</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>This is a Mallard.
Bill: 6.5cm, color yellow
Tail: 8.0cm, fluffiness 7
Mallard is flying!
Quack!
Tail wagging gracefully</code></pre>
</div>
</div>
</div>
<hr>
<section id="composition-vs-inheritance" class="level3">
<h3 class="anchored" data-anchor-id="composition-vs-inheritance">Composition vs Inheritance</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OOP Style Guide: Composition is often more appropriate than inheritance
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>継承は慎重に使い，まずは「コンポジション（composition）」を考えるべき</li>
<li>「部品の入れ替え」が必要な場合や責務を分離したい」場合，Compositionが有効</li>
</ul>
</div>
</div>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>継承 (Inheritance)</th>
<th>コンポジション (Composition)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>関係</td>
<td>is-a（〜は〜である）</td>
<td>has-a（〜を持っている）</td>
</tr>
<tr class="even">
<td>再利用</td>
<td>親クラスの機能を引き継ぐ</td>
<td>他クラスの機能を内部で使う</td>
</tr>
<tr class="odd">
<td>柔軟性</td>
<td>低い（構造が固定）</td>
<td>高い（入れ替えや拡張が容易）</td>
</tr>
<tr class="even">
<td>結合度</td>
<td>強い</td>
<td>弱い（疎結合）</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<section id="ダックタイピング-vs-インターフェース継承" class="level3">
<h3 class="anchored" data-anchor-id="ダックタイピング-vs-インターフェース継承">ダックタイピング vs インターフェース継承</h3>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>観点</th>
<th>ダックタイピング</th>
<th>インターフェース継承</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>定義</strong></td>
<td>「<strong>見た目がアヒルならアヒル</strong>」の原則に基づき，オブジェクトの型ではなく<strong>振る舞い（メソッドや属性の存在）</strong>で判断する</td>
<td>抽象クラス（ABC）を介して，<strong>特定のメソッド群を必ず実装</strong>することを強制する仕組み</td>
</tr>
<tr class="even">
<td><strong>Python 的実装例</strong></td>
<td><code>fit()</code> と <code>predict()</code> を持っていれば Estimator として扱う（Scikit-Learn 流）</td>
<td><code>Estimator</code> 抽象基底クラスを継承し，<code>fit()</code>・<code>predict()</code> の定義を強制する</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://google.github.io/styleguide/cppguide.html">Google C++ Style Guide</a></li>
<li><a href="https://google.github.io/styleguide/pyguide.html">Google Python Style Guide</a></li>
<li><a href="../2025-11-03-python-class-101/index.html">Pythonにおけるオブジェクトとクラス</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-04-python-class-rules/</guid>
  <pubDate>Tue, 04 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Pythonにおけるオブジェクトとクラス</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-03-python-class-101/</link>
  <description><![CDATA[ 






<section id="オブジェクトとクラス" class="level2">
<h2 class="anchored" data-anchor-id="オブジェクトとクラス">オブジェクトとクラス</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">プログラミングにおけるオブジェクト</span></p>
<ul>
<li>「オブジェクト」はデータと，そのデータを操作する手続きをひとまとめにしたもの</li>
<li>データ部分は「属性（attribute）」または「データメンバー」と呼ばれる</li>
<li>手続き部分は「メソッド」と呼ばれ，オブジェクトの状態を操作する</li>
</ul>
</div>
<p>上記の意味でのオブジェクトを作るための設計図がPythonにおける「<span class="regmonkey-bold">クラス</span>」です．クラスを基にしてオブジェクトが生成されますが， 実際にデータ値が格納されたオブジェクトのことをインスタンスといいます．</p>
<div id="f39a3ceb" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Dog:</span>
<span id="cb1-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name):</span>
<span id="cb1-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb1-4"></span>
<span id="cb1-5">my_dog <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dog(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pochi"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ← これがインスタンス</span></span></code></pre></div></div>
</details>
</div>
<p>コード行 <code>my_dog = Dog("Pochi")</code> の挙動は以下のように分解できます</p>
<ol type="1">
<li><code>Dog</code> クラスの定義を探し出す</li>
<li>メモリ内に新しい新しいオブジェクト（空のインスタンスを作成する</li>
<li>新しく作ったオブジェクトを <code>self</code>，引数 <code>Pochi</code> を <code>name</code> として渡して，オブジェクトの <code>__init__</code> を呼び出す</li>
<li><code>name</code> の値をインスタンスに格納する．</li>
<li>初期化が完了したインスタンスを返し， そのインスタンスに対して<code>my_dog</code> という名前を与える（変数 <code>my_dog</code> に格納する）</li>
</ol>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (メモリから見たクラスとインスタンスの違い)</strong></span> <br></p>
<div id="750f247c" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(Dog)</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(my_dog)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class '__main__.Dog'&gt;
&lt;__main__.Dog object at 0x7f5894610490&gt;</code></pre>
</div>
</div>
<ul>
<li><code>Dog</code> は クラスオブジェクト（型そのもの）を指しており，<code>&lt;class '__main__.Dog'&gt;</code> のように表示される</li>
<li><code>my_dog</code> は <code>Dog</code>クラスから生成されたインスタンス（具体的な値を持つ実体）を指しており，メモリアドレスを伴って表示される</li>
</ul>
</div>
<hr>
</section>
<section id="クラス属性とインスタンス属性" class="level2">
<h2 class="anchored" data-anchor-id="クラス属性とインスタンス属性">クラス属性とインスタンス属性</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">クラス属性とインスタンス属性</span></p>
<ul>
<li><strong>クラス属性（class attribute）</strong> は，クラスそのものに属する属性．すべてのインスタンスで共有される．<br>
</li>
<li><strong>インスタンス属性（instance attribute）</strong> は，各インスタンス固有の属性．インスタンスごとに異なる値を持つ．<br>
</li>
<li>通常，インスタンス属性は <code>__init__()</code> メソッド内で <code>self.xxx = ...</code> の形で定義される．<br>
</li>
<li>クラス属性は，クラス定義の直下（メソッドの外側）で定義される．</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (<code>dataclass</code> とクラス変数)</strong></span> <br></p>
<ul>
<li><code>dataclass</code> でクラス変数を作る場合は <code>ClassVar</code> を使う</li>
<li><code>dataclass</code>はインスタンス変数を自動的に <code>__init__</code> 処理するための仕組みなので，<code>ClassVar</code> を付けないとクラス変数を用いるとき「インスタンス変数っぽく見える」という混乱が起こります</li>
<li>インスタンスメソッドからクラス変数を操作する場合は <code>self.__class__</code> を基本用いる</li>
</ul>
<div id="873f6258" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ClassVar</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb4-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Person:</span>
<span id="cb4-6">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インスタンス属性</span></span>
<span id="cb4-7">    age: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インスタンス属性</span></span>
<span id="cb4-8">    total_number_of_persons: ClassVar[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb4-9"></span>
<span id="cb4-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> __post_init__(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb4-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># クラス属性</span></span>
<span id="cb4-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__class__</span>.total_number_of_persons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-13"></span>
<span id="cb4-14">adam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Person(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Adam'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb4-15">john <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Person(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Jhon'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(Person.total_number_of_persons)</span>
<span id="cb4-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(adam.total_number_of_persons)</span>
<span id="cb4-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(john.total_number_of_persons)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>2
2
2</code></pre>
</div>
</div>
</div>
<hr>
<p><span class="mini-section">Coding Style Guide</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Avoid mutable global state.
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>クラス変数は「全インスタンスで共有される共通定義」にのみ使用</li>
<li>ミュータブルなオブジェクトは避け，必要な場合は <code>tuple</code> や <code>frozenset</code> を使う</li>
<li>外部アクセスはメソッド経由</li>
</ul>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3</strong></span> <br></p>
<div id="cf480ef6" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass, field</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Tuple, ClassVar</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb6-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Stats:</span>
<span id="cb6-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 不変のクラス変数（mutable global state を避ける）</span></span>
<span id="cb6-7">    _ATTRIBS: ClassVar[Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, ...]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'strength'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'speed'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'intellect'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tenacity'</span>)</span>
<span id="cb6-8"></span>
<span id="cb6-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># インスタンス属性</span></span>
<span id="cb6-10">    strength: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-11">    speed: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-12">    intellect: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-13">    tenacity: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-14"></span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># クラスメソッドで安全にアクセス</span></span>
<span id="cb6-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@classmethod</span></span>
<span id="cb6-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> attribs(cls) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, ...]:</span>
<span id="cb6-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return the immutable tuple of attribute names."""</span></span>
<span id="cb6-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cls._ATTRIBS</span>
<span id="cb6-20"></span>
<span id="cb6-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine メソッドは staticmethod</span></span>
<span id="cb6-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb6-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> combine(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stats'</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Stats'</span>:</span>
<span id="cb6-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Combine multiple Stats objects into a new Stats instance.</span></span>
<span id="cb6-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Uses the class-level attribute names safely.</span></span>
<span id="cb6-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb6-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(arg, Stats) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> arg <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> args), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All arguments must be Stats instances."</span></span>
<span id="cb6-29">        combined_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {stat: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> stat <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Stats.attribs()}</span>
<span id="cb6-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> stat <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Stats.attribs():</span>
<span id="cb6-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> obj <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> args:</span>
<span id="cb6-32">                combined_values[stat] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(obj, stat)</span>
<span id="cb6-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Stats(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>combined_values)</span>
<span id="cb6-34"></span>
<span id="cb6-35">s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stats(strength<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, speed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb6-36">s2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stats(intellect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, tenacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb6-37"></span>
<span id="cb6-38">s_total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stats.combine(s1, s2)</span>
<span id="cb6-39"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(s_total)</span>
<span id="cb6-40"></span>
<span id="cb6-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># クラス変数は不変なので安全</span></span>
<span id="cb6-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(Stats.attribs())  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ('strength', 'speed', 'intellect', 'tenacity')</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Stats(strength=10, speed=5, intellect=7, tenacity=3)
('strength', 'speed', 'intellect', 'tenacity')</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="マングリング" class="level2">
<h2 class="anchored" data-anchor-id="マングリング">マングリング</h2>
<p><code>__</code> をメソッドや属性名の先頭に付与することで，クラス定義の外からは見えづらくする命名方法があります．</p>
<div id="8908e1bc" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Cat:</span>
<span id="cb8-3">    __name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb8-4"></span>
<span id="cb8-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> say(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb8-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> says Meow!"</span>)</span>
<span id="cb8-7"></span>
<span id="cb8-8">my_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Cat(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tama'</span>)</span>
<span id="cb8-9">my_cat.say()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tama says Meow!</code></pre>
</div>
</div>
<p>このように<code>__name</code> 属性は内部経由だと利用できますが，<code>my_cat.__name</code> だとエラーができます．ただし，</p>
<div id="96c09ee9" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 外部access</span></span>
<span id="cb10-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(my_cat._Cat__name)</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 属性への直接write</span></span>
<span id="cb10-5">my_cat._Cat__name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tama2'</span></span>
<span id="cb10-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(my_cat._Cat__name)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tama
Tama2</code></pre>
</div>
</div>
<p>とすると一応アクセス(READ及びWRITE)が出来てしまいます．</p>
</section>
<section id="インスタンス属性へのアクセス制御" class="level2">
<h2 class="anchored" data-anchor-id="インスタンス属性へのアクセス制御">インスタンス属性へのアクセス制御</h2>
<p>ゲッターとセッターを用いて，インスタンス属性へのアクセスを制御したい場合は <code>@property</code>, <code>@&lt;property&gt;.setter</code> デコレーターという仕組みを使います．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (トラファルガー・ローとマングリングとゲッターとセッター)</strong></span> <br></p>
<p>ワンピースのトラファルガー・ローを例にすると</p>
<ul>
<li>トラファルガー家は，他の「D」の一族と違い，外部にDを名乗ることを避けていた</li>
<li>通称は本名から忌み名を除去したものを名乗っている</li>
<li>通称は変わりうるが，本名は変わらない</li>
<li>本名の外部アクセスは基本想定していない</li>
</ul>
<p>ということを踏まえてClassを定義すると</p>
<div id="573eae3a" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Waterloos:</span>
<span id="cb12-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, real_name):</span>
<span id="cb12-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__real_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> real_name</span>
<span id="cb12-4">        parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__real_name.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"･"</span>)</span>
<span id="cb12-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._nickname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>parts[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">･</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>parts[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__real_name</span>
<span id="cb12-6"></span>
<span id="cb12-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb12-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> name(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb12-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""通称（ニックネーム）を返す"""</span></span>
<span id="cb12-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._nickname</span>
<span id="cb12-11"></span>
<span id="cb12-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@name.setter</span></span>
<span id="cb12-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> name(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, value):</span>
<span id="cb12-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""通称を更新"""</span></span>
<span id="cb12-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(value, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb12-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nickname must be a string"</span>)</span>
<span id="cb12-17">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._nickname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># トラファルガー･ローの設定</span></span>
<span id="cb12-20">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Waterloos(real_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"トラファルガー･D･ワーテル･ロー"</span>)</span>
<span id="cb12-21"></span>
<span id="cb12-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"通称:"</span>, p.name)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># → トラファルガー･ロー</span></span>
<span id="cb12-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"本名:"</span>, p._Waterloos__real_name)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># → トラファルガー･D･ワーテル･ロー</span></span>
<span id="cb12-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print("本名:", p.__real_name)  # これではアクセスできない</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>通称: トラファルガー･ロー
本名: トラファルガー･D･ワーテル･ロー</code></pre>
</div>
</div>
<p>ワノ国に入国した後に，ワノ国風名前にアレンジしたとすると</p>
<div id="4816b4aa" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ワノ国に入国</span></span>
<span id="cb14-2">p.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"トラ男"</span></span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"通称:"</span>, p.name)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># → トラ男</span></span>
<span id="cb14-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"本名:"</span>, p._Waterloos__real_name)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># → トラファルガー･D･ワーテル･ロー</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>通称: トラ男
本名: トラファルガー･D･ワーテル･ロー</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://google.github.io/styleguide/pyguide.html">Google Python Style Guide</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-03-python-class-101/</guid>
  <pubDate>Mon, 03 Nov 2025 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
