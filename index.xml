<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>regmonkey datascience blog</title>
<link>https://ryonakagami.github.io/regmonkey-datascience-blog/</link>
<atom:link href="https://ryonakagami.github.io/regmonkey-datascience-blog/index.xml" rel="self" type="application/rss+xml"/>
<description>日々の徒然勉強日記</description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Mon, 15 Dec 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>中年男性の中性脂肪分布はLognormalで近似できるか？</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/</link>
  <description><![CDATA[ 






<section id="リサーチクエッション" class="level2">
<h2 class="anchored" data-anchor-id="リサーチクエッション">1. リサーチクエッション</h2>
<ul>
<li><strong>アメリカの中年男性（40-59歳）の血中中性脂肪（トリグリセリド）濃度は，Lognormal分布でどの程度近似できるか？</strong></li>
</ul>
<section id="背景" class="level3">
<h3 class="anchored" data-anchor-id="背景">背景</h3>
<p>血中脂質値は多くの場合，正規分布ではなく右に歪んだ分布を示す。特に中性脂肪は，生活習慣や遺伝的要因により極端な高値を示す個人が存在するため，Lognormal分布での近似がしばしば用いられます． このノートでは，米国の代表的な健康調査データを用いて，この仮説を検証したいとおもいます．</p>
</section>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">2. Data</h2>
<p><span class="mini-section">データソース</span></p>
<ul>
<li><a href="https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Laboratory&amp;Cycle=2021-2023&amp;utm_source=chatgpt.com">NHANES (National Health and Nutrition Examination Survey) August 2021 - August 2023</a></li>
<li>アメリカCDCが実施する全国規模の健康・栄養調査データ．</li>
</ul>
<p><span class="mini-section">使用ファイル</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>ファイル</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>DEMO_L.xpt</code></td>
<td>人口統計学的データ（年齢，性別等）</td>
</tr>
<tr class="even">
<td><code>TRIGLY_L.xpt</code></td>
<td>中性脂肪・LDLコレステロールデータ</td>
</tr>
</tbody>
</table>
<p><span class="mini-section">対象者の選択基準</span></p>
<ol type="1">
<li><strong>性別</strong>: 男性 (<code>RIAGENDR = 1</code>)</li>
<li><strong>年齢</strong>: 40-59歳 (<code>RIDAGEYR</code>)</li>
<li><strong>中性脂肪データ</strong>: 欠損なし (<code>LBXTLG</code> is not null)</li>
<li><strong>サンプルウェイト</strong>: 有効 (<code>WTSAF2YR</code> &gt; 0)</li>
</ol>
<p><span class="mini-section">測定方法</span></p>
<ul>
<li>中性脂肪（Triglycerides）は，12歳以上の参加者のうち，8-24時間絶食という空腹条件を満たした部分標本（fasting subsample） に対してのみ測定</li>
</ul>
<p><span class="mini-section">サンプルウェイト</span></p>
<ul>
<li><strong>WTSAF2YR</strong>（空腹時サブサンプル2年MEC重み）を使用</li>
<li>see <a href="https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx">here</a></li>
</ul>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">WTSAF2YR</span></p>
<ul>
<li>「当該参加者が米国の民間非施設居住人口の何人規模のグループをを代表しているか」を表す設計ウェイト</li>
<li>ある参加者の<code>WTSAF2YR = 50,000</code> の場合，その参加者は母集団内の約50,000人グループを代表することを意味する</li>
</ul>
</div>
<p>ウェイトの基本的な考えは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bsample%20person's%20weight%7D%20=%20%5Cfrac%7B1%7D%7B%5Ctext%7Bprobability%20of%20selection%7D%7D%0A"></p>
<p>詳しい説明は省略しますが，</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/sampling.png" class="img-fluid figure-img"></p>
<figcaption>Four Stages of NHANES Sampling Procedure</figcaption>
</figure>
</div>
<ol type="1">
<li>米国全体を分割した一次抽出（PSU：郡または郡群）</li>
<li>選ばれた PSU 内で小地域（街区・セグメント）が選ばれる</li>
<li>選ばれたセグメント内で，世帯（household） が抽出される</li>
<li>世帯内の構成員のうち，調査対象者として個人が選ばれる</li>
</ol>
<p>という流れでNHANESでは層化抽出が行われ <code>probability of selection</code> が定まります．解釈としては</p>
<blockquote class="blockquote">
<p>“A sample weight is assigned to each sample person. <strong>It is a measure of the number of people in the population represented by that sample person in NHANES</strong>, reflecting the unequal probability of selection, an adjustment for sample person non-response, and adjustment to account for differences between the final sample and the total population based on independent population control totals.”</p>
</blockquote>
<p>したがって，母集団平均の推定には</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bweighted%20mean%7D%20=%20%5Cfrac%7B%5Csum%20%5Ctext%7BWTSAF2YR%7D%20%5Ctimes%20%5Ctext%7Bvalue%7D%7D%7B%5Csum%20%5Ctext%7BWTSAF2YR%7D%7D%0A"></p>
<p>となります．</p>
</section>
<section id="分析方針" class="level2">
<h2 class="anchored" data-anchor-id="分析方針">3. 分析方針</h2>
<p><span class="mini-section">Lognormal分布の仮定</span></p>
<p>血中中性脂肪濃度は以下の特徴を持つため，Lognormal分布での近似をおこないます：</p>
<ol type="1">
<li><strong>正の値のみ</strong>: 濃度は必ず正の値をとる</li>
<li><strong>右に歪んだ分布</strong>: 極端な高値を示す個人が存在</li>
<li><strong>乗法的な影響</strong>: 遺伝・食事・運動などの要因が乗法的に作用すると仮定</li>
</ol>
<p><span class="mini-section">適合度の評価方法</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>評価方法</th>
<th>目的</th>
<th>判断</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>重み付きヒストグラム vs PDF</td>
<td>視覚的な分布形状の比較</td>
<td>主観的判断</td>
</tr>
<tr class="even">
<td>Q-Qプロット</td>
<td>分位点の一致度を評価</td>
<td>主観的判断</td>
</tr>
<tr class="odd">
<td>Kolmogorov-Smirnov検定</td>
<td>統計的な適合度検定</td>
<td>統計的判定</td>
</tr>
</tbody>
</table>
</section>
<section id="推定関数" class="level2">
<h2 class="anchored" data-anchor-id="推定関数">4. 推定関数</h2>
<section id="重み付きqq-plot" class="level3">
<h3 class="anchored" data-anchor-id="重み付きqq-plot">重み付きQQ plot</h3>
<div id="2ad309ac" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_quantiles(</span>
<span id="cb1-4">    values: np.ndarray, weights: np.ndarray, quantiles: np.ndarray</span>
<span id="cb1-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Compute weighted quantiles.</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : array-like</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Array of observed values.</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : array-like</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Sample weights corresponding to each observation.</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    quantiles : array-like</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Quantiles to compute (values between 0 and 1).</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ndarray</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Values corresponding to the specified quantiles.</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-23">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb1-24">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb1-25">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb1-26"></span>
<span id="cb1-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cumulative sum of weights, normalized to [0, 1]</span></span>
<span id="cb1-28">    cumsum_normalized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights)</span>
<span id="cb1-29"></span>
<span id="cb1-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.interp(quantiles, cumsum_normalized, sorted_values)</span></code></pre></div></div>
</details>
</div>
<section id="重み付きks検定の実装" class="level4">
<h4 class="anchored" data-anchor-id="重み付きks検定の実装">重み付きKS検定の実装</h4>
<ul>
<li>scipy の <code>ks_2samp</code> をベースに、両側からのCDF差を計算する方法を採用</li>
<li>effective sample sizeは <img src="https://latex.codecogs.com/png.latex?(%5Csum%20w_i)%5E2%20/%20%5Csum%20w_i%5E2"> で計算 (see Monahan, J. (2011). <em>Numerical Methods of Statistics</em>.)</li>
</ul>
<div id="9bb5b466" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Callable</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_ks_1samp(</span>
<span id="cb2-5">    values: np.ndarray, weights: np.ndarray, cdf_func: Callable[[np.ndarray], np.ndarray]</span>
<span id="cb2-6">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb2-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform a one-sample weighted Kolmogorov–Smirnov test.</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    The p-value is computed using an effective sample size</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    (Kish's effective sample size), following the approach</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    proposed by Monahan.</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : np.ndarray</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Array of observed values.</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : np.ndarray</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Sample weights corresponding to each observation.</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    cdf_func : Callable[[np.ndarray], np.ndarray]</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        CDF function of the theoretical distribution. It takes</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        an array of values and returns cumulative probabilities.</span></span>
<span id="cb2-23"></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tuple[float, float]</span></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        (ks_stat, p_value) – the KS statistic and the asymptotic p-value.</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    References</span></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb2-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Monahan, J. (2011). *Numerical Methods of Statistics*.</span></span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-33">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb2-34">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb2-35">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb2-36"></span>
<span id="cb2-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weighted ECDF: F_n(x) = Σ w_i * I(X_i ≤ x) / Σ w_i</span></span>
<span id="cb2-38">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb2-39">    total_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-40">    ecdf_after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_weight          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># F_n(x) = P(X ≤ x)</span></span>
<span id="cb2-41">    ecdf_before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.concatenate([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], ecdf_after[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># F_n(x−)</span></span>
<span id="cb2-42"></span>
<span id="cb2-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Theoretical CDF</span></span>
<span id="cb2-44">    theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cdf_func(sorted_values)</span>
<span id="cb2-45"></span>
<span id="cb2-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># KS statistic: maximum deviation from both sides</span></span>
<span id="cb2-47">    d_plus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(ecdf_after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> theoretical_cdf)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sup(F_n − F)</span></span>
<span id="cb2-48">    d_minus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(theoretical_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ecdf_before)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sup(F − F_n)</span></span>
<span id="cb2-49">    ks_stat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(d_plus, d_minus)</span>
<span id="cb2-50"></span>
<span id="cb2-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Effective sample size (Kish's effective sample size)</span></span>
<span id="cb2-52">    n_eff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_weight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-53"></span>
<span id="cb2-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Asymptotic p-value (Kolmogorov distribution)</span></span>
<span id="cb2-55">    p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kstwobign.sf(np.sqrt(n_eff) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ks_stat)</span>
<span id="cb2-56"></span>
<span id="cb2-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(ks_stat), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(np.clip(p_value, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div></div>
</details>
</div>
</section>
</section>
</section>
<section id="分析コード" class="level2">
<h2 class="anchored" data-anchor-id="分析コード">5. 分析コード</h2>
<div id="841a96ae" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">NHANES August 2021-August 2023 中年男性の中性脂肪分析</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">ヒストグラムとlognormal分布の比較</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">（サンプルウェイト WTSAF2YR を考慮）</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyreadstat</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-10"></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> load_data():</span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""DEMO_L と TRIGLY_L データを読み込み結合"""</span></span>
<span id="cb3-14">    demo_pd, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyreadstat.read_xport(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DEMO_L.xpt"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latin1"</span>)</span>
<span id="cb3-15">    trigly_pd, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pyreadstat.read_xport(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRIGLY_L.xpt"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latin1"</span>)</span>
<span id="cb3-16"></span>
<span id="cb3-17">    demo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.from_pandas(demo_pd)</span>
<span id="cb3-18">    trigly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.from_pandas(trigly_pd)</span>
<span id="cb3-19"></span>
<span id="cb3-20">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> demo.join(trigly, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SEQN"</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inner"</span>)</span>
<span id="cb3-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb3-22"></span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> filter_middle_aged_men(df: pl.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pl.DataFrame:</span>
<span id="cb3-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    中年男性（40-59歳）をフィルタリング</span></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - RIAGENDR: 1 = Male</span></span>
<span id="cb3-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - RIDAGEYR: 年齢</span></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - LBXTLG: 中性脂肪 (mg/dL)</span></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - WTSAF2YR &gt; 0: 有効なサンプルウェイトを持つ参加者のみ</span></span>
<span id="cb3-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-32">    filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb3-33">        (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIAGENDR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIDAGEYR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb3-35">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIDAGEYR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">59</span>)</span>
<span id="cb3-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).is_not_null())</span>
<span id="cb3-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-38">    )</span>
<span id="cb3-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> filtered</span>
<span id="cb3-40"></span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_mean(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き平均"""</span></span>
<span id="cb3-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)</span>
<span id="cb3-45"></span>
<span id="cb3-46"></span>
<span id="cb3-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_std(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き標準偏差"""</span></span>
<span id="cb3-49">    mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_mean(values, weights)</span>
<span id="cb3-50">    variance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)</span>
<span id="cb3-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.sqrt(variance)</span>
<span id="cb3-52"></span>
<span id="cb3-53"></span>
<span id="cb3-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_median(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き中央値"""</span></span>
<span id="cb3-56">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb3-57">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb3-58">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb3-59">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb3-60">    cutoff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(sorted_weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span></span>
<span id="cb3-61">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sorted_values[np.searchsorted(cumsum, cutoff)]</span>
<span id="cb3-62"></span>
<span id="cb3-63"></span>
<span id="cb3-64"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_histogram(values: np.ndarray, weights: np.ndarray, bins: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>):</span>
<span id="cb3-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付きヒストグラムのデータを計算"""</span></span>
<span id="cb3-66">    hist, bin_edges <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.histogram(values, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins, weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>weights, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> hist, bin_edges</span>
<span id="cb3-68"></span>
<span id="cb3-69"></span>
<span id="cb3-70"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> weighted_ecdf(values: np.ndarray, weights: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>:</span>
<span id="cb3-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""重み付き経験累積分布関数を計算"""</span></span>
<span id="cb3-72">    sorted_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argsort(values)</span>
<span id="cb3-73">    sorted_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> values[sorted_indices]</span>
<span id="cb3-74">    sorted_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights[sorted_indices]</span>
<span id="cb3-75"></span>
<span id="cb3-76">    cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.cumsum(sorted_weights)</span>
<span id="cb3-77">    ecdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cumsum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> cumsum[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-78"></span>
<span id="cb3-79">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sorted_values, ecdf</span>
<span id="cb3-80"></span>
<span id="cb3-81"></span>
<span id="cb3-82"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> filter_by_percentile(</span>
<span id="cb3-83">    values: np.ndarray,</span>
<span id="cb3-84">    weights: np.ndarray,</span>
<span id="cb3-85">    lower_pct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb3-86">    upper_pct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,</span>
<span id="cb3-87">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[np.ndarray, np.ndarray]:</span>
<span id="cb3-88">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    重み付きパーセンタイルでデータをフィルタリング</span></span>
<span id="cb3-90"></span>
<span id="cb3-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb3-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb3-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    values : np.ndarray</span></span>
<span id="cb3-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        観測値</span></span>
<span id="cb3-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    weights : np.ndarray</span></span>
<span id="cb3-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        サンプルウェイト</span></span>
<span id="cb3-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    lower_pct : float</span></span>
<span id="cb3-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        下限パーセンタイル（0-1）</span></span>
<span id="cb3-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    upper_pct : float</span></span>
<span id="cb3-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        上限パーセンタイル（0-1）</span></span>
<span id="cb3-101"></span>
<span id="cb3-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb3-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb3-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    filtered_values : np.ndarray</span></span>
<span id="cb3-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        フィルタリング後の観測値</span></span>
<span id="cb3-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    filtered_weights : np.ndarray</span></span>
<span id="cb3-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        フィルタリング後のウェイト</span></span>
<span id="cb3-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-109">    quantile_bounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_quantiles(values, weights, np.array([lower_pct, upper_pct]))</span>
<span id="cb3-110">    lower_bound, upper_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quantile_bounds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], quantile_bounds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-111"></span>
<span id="cb3-112">    mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> lower_bound) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> upper_bound)</span>
<span id="cb3-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> values[mask], weights[mask], lower_bound, upper_bound</span>
<span id="cb3-114"></span>
<span id="cb3-115"></span>
<span id="cb3-116"></span>
<span id="cb3-117"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> analyze_and_plot(</span>
<span id="cb3-118">    triglyceride_values: np.ndarray,</span>
<span id="cb3-119">    weights: np.ndarray,</span>
<span id="cb3-120">    save_suffix: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb3-121">):</span>
<span id="cb3-122">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""ヒストグラムとlognormal分布の比較プロット（重み付き）"""</span></span>
<span id="cb3-123"></span>
<span id="cb3-124">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 重み付きパラメータ推定 ---</span></span>
<span id="cb3-125">    log_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log(triglyceride_values)</span>
<span id="cb3-126">    mu_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_mean(log_values, weights)</span>
<span id="cb3-127">    sigma_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_std(log_values, weights)</span>
<span id="cb3-128"></span>
<span id="cb3-129">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット作成</span></span>
<span id="cb3-130">    fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb3-131"></span>
<span id="cb3-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 左: ヒストグラムとlognormal PDF ---</span></span>
<span id="cb3-133">    ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-134"></span>
<span id="cb3-135">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付きヒストグラム</span></span>
<span id="cb3-136">    hist, bin_edges <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_histogram(triglyceride_values, weights, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb3-137">    bin_centers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bin_edges[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-138">    bin_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bin_edges[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-139">    ax1.bar(</span>
<span id="cb3-140">        bin_centers,</span>
<span id="cb3-141">        hist,</span>
<span id="cb3-142">        width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bin_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb3-143">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb3-144">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,</span>
<span id="cb3-145">        edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb3-146">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted histogram"</span>,</span>
<span id="cb3-147">    )</span>
<span id="cb3-148"></span>
<span id="cb3-149">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lognormal PDF（重み付きパラメータ）</span></span>
<span id="cb3-150">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(triglyceride_values.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), triglyceride_values.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb3-151">    pdf_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.lognorm.pdf(x, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted))</span>
<span id="cb3-152">    ax1.plot(</span>
<span id="cb3-153">        x,</span>
<span id="cb3-154">        pdf_weighted,</span>
<span id="cb3-155">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r-"</span>,</span>
<span id="cb3-156">        linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb3-157">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Lognormal (weighted)</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">(μ=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, σ=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sigma_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>,</span>
<span id="cb3-158">    )</span>
<span id="cb3-159"></span>
<span id="cb3-160">    ax1.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Triglyceride (mg/dL)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-161">    ax1.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-162">    ax1.set_title(</span>
<span id="cb3-163">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Middle-aged Men (40-59 years) Triglyceride Distribution</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-164">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NHANES August 2021-August 2023 (Weighted by WTSAF2YR)"</span>,</span>
<span id="cb3-165">        fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb3-166">    )</span>
<span id="cb3-167">    ax1.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb3-168">    ax1.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-169"></span>
<span id="cb3-170">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 右: 重み付きQ-Qプロット ---</span></span>
<span id="cb3-171">    ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-172"></span>
<span id="cb3-173">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付き分位点を計算</span></span>
<span id="cb3-174">    n_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロット用の分位点数</span></span>
<span id="cb3-175">    prob_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span>, n_quantiles)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.1%〜99.9%で裾もカバー</span></span>
<span id="cb3-176"></span>
<span id="cb3-177">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付き観測分位点</span></span>
<span id="cb3-178">    observed_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_quantiles(triglyceride_values, weights, prob_points)</span>
<span id="cb3-179"></span>
<span id="cb3-180">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 理論分位点（Lognormal）</span></span>
<span id="cb3-181">    theoretical_quantiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.lognorm.ppf(</span>
<span id="cb3-182">        prob_points, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted)</span>
<span id="cb3-183">    )</span>
<span id="cb3-184"></span>
<span id="cb3-185">    ax2.scatter(</span>
<span id="cb3-186">        theoretical_quantiles, observed_quantiles, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span></span>
<span id="cb3-187">    )</span>
<span id="cb3-188">    min_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(theoretical_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), observed_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>())</span>
<span id="cb3-189">    max_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(theoretical_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), observed_quantiles.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>())</span>
<span id="cb3-190">    ax2.plot(</span>
<span id="cb3-191">        [min_val, max_val], [min_val, max_val], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r--"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Perfect fit"</span></span>
<span id="cb3-192">    )</span>
<span id="cb3-193"></span>
<span id="cb3-194">    ax2.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Theoretical Quantiles (Lognormal)"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-195">    ax2.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted Observed Quantiles"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-196">    ax2.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weighted Q-Q Plot: Lognormal Distribution Fit"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb3-197">    ax2.legend(fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb3-198">    ax2.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-199"></span>
<span id="cb3-200">    plt.tight_layout()</span>
<span id="cb3-201">    plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"triglyceride_analysis</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>save_suffix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tight"</span>)</span>
<span id="cb3-202">    plt.show()</span>
<span id="cb3-203"></span>
<span id="cb3-204">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 統計情報を出力</span></span>
<span id="cb3-205">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-206">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Statistics: Middle-aged Men (40-59 years) Triglyceride"</span>)</span>
<span id="cb3-207">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NHANES August 2021-August 2023 (with sample weights)"</span>)</span>
<span id="cb3-208">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-209">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sample size (n): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-210">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sum of weights: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-211"></span>
<span id="cb3-212">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Descriptive Statistics - WEIGHTED (population estimates)]"</span>)</span>
<span id="cb3-213">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_mean(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-214">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_median(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-215">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Std Dev: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weighted_std(triglyceride_values, weights)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-216"></span>
<span id="cb3-217">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Descriptive Statistics - UNWEIGHTED (sample only)]"</span>)</span>
<span id="cb3-218">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-219">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>median(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-220">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Std Dev: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>std(triglyceride_values, ddof<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-221">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Min: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-222">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Max: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-223"></span>
<span id="cb3-224">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Lognormal Parameters - WEIGHTED]"</span>)</span>
<span id="cb3-225">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  μ (log-scale mean): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mu_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-226">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  σ (log-scale std): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sigma_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-227">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Median from fit (exp(μ)): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>exp(mu_weighted)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mg/dL"</span>)</span>
<span id="cb3-228"></span>
<span id="cb3-229"></span>
<span id="cb3-230">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 適合度検定 (Kolmogorov-Smirnov)</span></span>
<span id="cb3-231">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cdf_func(x):</span>
<span id="cb3-232">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> stats.lognorm.cdf(x, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma_weighted, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(mu_weighted))</span>
<span id="cb3-233"></span>
<span id="cb3-234">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重み付きKS検定</span></span>
<span id="cb3-235">    ks_stat_weighted, ks_pvalue_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weighted_ks_1samp(</span>
<span id="cb3-236">        triglyceride_values, weights, cdf_func</span>
<span id="cb3-237">    )</span>
<span id="cb3-238"></span>
<span id="cb3-239">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 有効サンプルサイズ（Kish's effective sample size）</span></span>
<span id="cb3-240">    n_eff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-241"></span>
<span id="cb3-242">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 重みなしKS検定（参考）</span></span>
<span id="cb3-243">    ks_stat_unweighted, ks_pvalue_unweighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kstest(</span>
<span id="cb3-244">        triglyceride_values, cdf_func</span>
<span id="cb3-245">    )</span>
<span id="cb3-246"></span>
<span id="cb3-247">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">[Goodness-of-fit (Kolmogorov-Smirnov)]"</span>)</span>
<span id="cb3-248">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  [WEIGHTED]"</span>)</span>
<span id="cb3-249">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    KS statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_stat_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-250">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Asymptotic p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_pvalue_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-251">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Effective sample size (Kish): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_eff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-252">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    Note: p-value uses asymptotic approximation with n_eff"</span>)</span>
<span id="cb3-253">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ks_pvalue_weighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>:</span>
<span id="cb3-254">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &gt; 0.05: No significant difference from lognormal"</span>)</span>
<span id="cb3-255">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-256">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &lt; 0.05: Significantly different from lognormal"</span>)</span>
<span id="cb3-257"></span>
<span id="cb3-258">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  [UNWEIGHTED (reference)]"</span>)</span>
<span id="cb3-259">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    KS statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_stat_unweighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-260">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ks_pvalue_unweighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-261">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> ks_pvalue_unweighted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>:</span>
<span id="cb3-262">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &gt; 0.05: No significant difference from lognormal"</span>)</span>
<span id="cb3-263">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-264">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"    -&gt; p &lt; 0.05: Significantly different from lognormal"</span>)</span>
<span id="cb3-265">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb3-266"></span>
<span id="cb3-267"></span>
<span id="cb3-268"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb3-269">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loading NHANES data..."</span>)</span>
<span id="cb3-270">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb3-271"></span>
<span id="cb3-272">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filtering middle-aged men (40-59 years) with valid weights..."</span>)</span>
<span id="cb3-273">    middle_aged_men <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_middle_aged_men(df)</span>
<span id="cb3-274"></span>
<span id="cb3-275">    triglyceride_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).to_numpy().flatten()</span>
<span id="cb3-276">    weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>).to_numpy().flatten()</span>
<span id="cb3-277"></span>
<span id="cb3-278">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sample size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-279">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Excluded (WTSAF2YR = 0 or missing): checked"</span>)</span>
<span id="cb3-280"></span>
<span id="cb3-281">    analyze_and_plot(triglyceride_values, weights)</span>
<span id="cb3-282"></span>
<span id="cb3-283"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb3-284">    main()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading NHANES data...
Filtering middle-aged men (40-59 years) with valid weights...
Sample size: 362
Excluded (WTSAF2YR = 0 or missing): checked</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/index_files/figure-html/cell-4-output-2.png" width="1332" height="471" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Statistics: Middle-aged Men (40-59 years) Triglyceride
NHANES August 2021-August 2023 (with sample weights)
======================================================================
Sample size (n): 362
Sum of weights: 39,758,496

[Descriptive Statistics - WEIGHTED (population estimates)]
  Mean: 152.6 mg/dL
  Median: 111.0 mg/dL
  Std Dev: 180.6 mg/dL

[Descriptive Statistics - UNWEIGHTED (sample only)]
  Mean: 149.9 mg/dL
  Median: 108.5 mg/dL
  Std Dev: 160.2 mg/dL
  Min: 28.0 mg/dL
  Max: 1745.0 mg/dL

[Lognormal Parameters - WEIGHTED]
  μ (log-scale mean): 4.7800
  σ (log-scale std): 0.6062
  Median from fit (exp(μ)): 119.1 mg/dL

[Goodness-of-fit (Kolmogorov-Smirnov)]
  [WEIGHTED]
    KS statistic: 0.0893
    Asymptotic p-value: 0.0344
    Effective sample size (Kish): 254.8
    Note: p-value uses asymptotic approximation with n_eff
    -&gt; p &lt; 0.05: Significantly different from lognormal
  [UNWEIGHTED (reference)]
    KS statistic: 0.0892
    p-value: 0.0059
    -&gt; p &lt; 0.05: Significantly different from lognormal
======================================================================</code></pre>
</div>
</div>
</section>
<section id="結果解釈" class="level2">
<h2 class="anchored" data-anchor-id="結果解釈">6. 結果解釈</h2>
<section id="qq-plot" class="level3">
<h3 class="anchored" data-anchor-id="qq-plot">QQ plot</h3>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>観測点の位置</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>直線上</td>
<td>理論分布と一致</td>
</tr>
<tr class="even">
<td>直線より上</td>
<td>観測データの裾が厚い (heavy tail)</td>
</tr>
<tr class="odd">
<td>直線より下</td>
<td>観測データの裾が薄い (light tail)</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">今回のデータの特徴</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>領域</th>
<th>観察されたパターン</th>
<th>解釈</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>下側の裾（低値）</td>
<td>ほぼ直線上</td>
<td>Lognormalと良く一致</td>
</tr>
<tr class="even">
<td>中央部（50-300 mg/dL）</td>
<td>直線上</td>
<td>良好なフィット</td>
</tr>
<tr class="odd">
<td>上側の裾（高値）</td>
<td>直線より上に乖離</td>
<td><strong>Lognormalより裾が厚い</strong></td>
</tr>
</tbody>
</table>
<p><span class="mini-section">Insights</span></p>
<ol type="1">
<li><strong>全体的なフィット</strong>: Lognormal分布は中性脂肪分布の大部分（約95%）を良く近似する</li>
<li><strong>上側の裾の逸脱</strong>: 極端な高値（概ね400 mg/dL以上）の出現頻度がLognormal分布の予測より高い</li>
<li><strong>臨床的含意</strong>:
<ul>
<li>高トリグリセリド血症の有病率推定において、Lognormalモデルは過小評価のリスクがある</li>
<li>リスク評価では、より裾の厚い分布（例：一般化ガンマ分布）の検討も有用かも？</li>
</ul></li>
</ol>
</section>
</section>
<section id="追加分析" class="level2">
<h2 class="anchored" data-anchor-id="追加分析">7. 追加分析</h2>
<div id="9d3c515b" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> additional_analysis():</span>
<span id="cb6-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loading NHANES data..."</span>)</span>
<span id="cb6-3">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb6-4"></span>
<span id="cb6-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filtering middle-aged men (40-59 years) with valid weights..."</span>)</span>
<span id="cb6-6">    middle_aged_men <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_middle_aged_men(df)</span>
<span id="cb6-7"></span>
<span id="cb6-8">    triglyceride_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LBXTLG"</span>).to_numpy().flatten()</span>
<span id="cb6-9">    weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> middle_aged_men.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WTSAF2YR"</span>).to_numpy().flatten()</span>
<span id="cb6-10"></span>
<span id="cb6-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># === 5%-95%パーセンタイル範囲での分析 ===</span></span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb6-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ANALYSIS 2: Trimmed Data (5th-95th Percentile)"</span>)</span>
<span id="cb6-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)</span>
<span id="cb6-15">    trimmed_values, trimmed_weights, lower_bound, upper_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_by_percentile(</span>
<span id="cb6-16">        triglyceride_values, weights, lower_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, upper_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span></span>
<span id="cb6-17">    )</span>
<span id="cb6-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Percentile range: [</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lower_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>upper_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] mg/dL"</span>)</span>
<span id="cb6-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Trimmed sample size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trimmed_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (from </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Excluded: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(triglyceride_values) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trimmed_values)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> extreme values"</span>)</span>
<span id="cb6-21"></span>
<span id="cb6-22">    analyze_and_plot(trimmed_values, trimmed_weights, save_suffix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_trimmed_5_95"</span>)</span>
<span id="cb6-23"></span>
<span id="cb6-24">additional_analysis()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading NHANES data...
Filtering middle-aged men (40-59 years) with valid weights...

======================================================================
ANALYSIS 2: Trimmed Data (5th-95th Percentile)
======================================================================
Percentile range: [52.8, 351.4] mg/dL
Trimmed sample size: 326 (from 362)
Excluded: 36 extreme values</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/index_files/figure-html/cell-5-output-2.png" width="1334" height="471" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Statistics: Middle-aged Men (40-59 years) Triglyceride
NHANES August 2021-August 2023 (with sample weights)
======================================================================
Sample size (n): 326
Sum of weights: 35,785,691

[Descriptive Statistics - WEIGHTED (population estimates)]
  Mean: 126.0 mg/dL
  Median: 111.0 mg/dL
  Std Dev: 59.0 mg/dL

[Descriptive Statistics - UNWEIGHTED (sample only)]
  Mean: 127.4 mg/dL
  Median: 108.0 mg/dL
  Std Dev: 63.0 mg/dL
  Min: 53.0 mg/dL
  Max: 336.0 mg/dL

[Lognormal Parameters - WEIGHTED]
  μ (log-scale mean): 4.7400
  σ (log-scale std): 0.4308
  Median from fit (exp(μ)): 114.4 mg/dL

[Goodness-of-fit (Kolmogorov-Smirnov)]
  [WEIGHTED]
    KS statistic: 0.0688
    Asymptotic p-value: 0.2259
    Effective sample size (Kish): 230.1
    Note: p-value uses asymptotic approximation with n_eff
    -&gt; p &gt; 0.05: No significant difference from lognormal
  [UNWEIGHTED (reference)]
    KS statistic: 0.0704
    p-value: 0.0755
    -&gt; p &gt; 0.05: No significant difference from lognormal
======================================================================</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>追加分析解釈
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>log-scale が0.6062 → 0.0688に減少: 裾の極端な値を除外したことで分散が小さくなった</li>
<li>KS統計量も0.0893 → 0.4308に減少: 経験分布と理論分布の最大乖離が縮小</li>
<li>Q-Qプロットを見ても，トリミング後は理論直線（赤破線）にデータポイントがいい感じに乗っている．特に上側の裾の逸脱が解消</li>
<li>ただし，そもそも上位5%を異常値として除外できるかどうかは，適合度のみではわからない．
<ul>
<li><strong>分析目的などによりケースバイケースで判断が必要</strong></li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="appendix-トリグリセリド" class="level2">
<h2 class="anchored" data-anchor-id="appendix-トリグリセリド">Appendix: トリグリセリド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">中性脂肪 / トリグリセリド</span></p>
<ul>
<li>肉や魚・食用油など食品中の脂質や，体内の脂質の大部分を占める物質</li>
<li>中性脂肪は重要なエネルギー源であり，ビタミンの吸収を助けたり，必須脂肪酸（体内で合成されない脂肪酸）を摂取するという点においても不可欠なもの</li>
<li>とりすぎると体脂肪として蓄えられて肥満を招き，心筋梗塞などになりやすくなる</li>
<li>血液中の中性脂肪値は特定健診の検査項目に含まれており，空腹時150mg/dⅬ以上，随時175mg/dⅬ以上になると「高TG（トリグリセライド）血症」とされる</li>
</ul>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 30%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>測定項目</th>
<th>英語名</th>
<th>略称</th>
<th>単位</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>総コレステロール</td>
<td>Total Cholesterol</td>
<td>TC</td>
<td>mg/dL</td>
<td>血中コレステロールの総量．心血管疾患リスク評価の基本指標</td>
</tr>
<tr class="even">
<td>高比重リポ蛋白コレステロール</td>
<td>High-Density Lipoprotein Cholesterol</td>
<td>HDL-C</td>
<td>mg/dL</td>
<td>いわゆる「善玉」コレステロール．高値は心血管リスク低下と関連</td>
</tr>
<tr class="odd">
<td>低比重リポ蛋白コレステロール</td>
<td>Low-Density Lipoprotein Cholesterol</td>
<td>LDL-C</td>
<td>mg/dL</td>
<td>いわゆる「悪玉」コレステロール．動脈硬化リスクと強く関連</td>
</tr>
<tr class="even">
<td>中性脂肪</td>
<td>Triglycerides</td>
<td>TG</td>
<td>mg/dL</td>
<td>血中脂質の一種．エネルギー代謝やメタボリックリスクと関連</td>
</tr>
</tbody>
</table>
</section>
<section id="appendix-qq-plot" class="level2">
<h2 class="anchored" data-anchor-id="appendix-qq-plot">Appendix: QQ plot</h2>
<p><a href="https://www.kyoritsu-pub.co.jp/book/b10033628.html">データ解析のための数理統計入門</a>ベースで行くとQQ plotは以下のように定義されています．</p>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">QQ plot</span></p>
<p>確率変数 <img src="https://latex.codecogs.com/png.latex?X_1,%20%5Ccdots,%20X_n%20%5Coverset%7B%5Cmathrm%7Biid%7D%7D%7B%5Csim%7D%20F"> とし，その順序統計量を</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AX_%7B(1)%7D%20%5Cleq%20%5Ccdots%20%5Cleq%20X_%7B(n)%7D%0A"></p>
<p>とする．<img src="https://latex.codecogs.com/png.latex?X_%7B(j)%7D"> の実現値 <img src="https://latex.codecogs.com/png.latex?x_%7B(j)%7D"> として， <img src="https://latex.codecogs.com/png.latex?F"> の逆変換を施した点</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A(x_%7B(j)%7D,%20F%5E%7B-1%7D(j/(n+1)))%0A"></p>
<p>をplotしたものをQQ plotという．</p>
</div>
<p>この定義を正とすると，分析におけるQQ plotはQQ plotではない．ただ，久保川先生では</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AF(x_%7B(j)%7D,%20j/(n+1))%0A"></p>
<p>をplotしたものをPP plotと呼んでおり，分析におけるQQ plotは久保川流でいくならば PP plotということになります．PP plotの理論的根拠は， 確率積分変換により <img src="https://latex.codecogs.com/png.latex?F(X)"> は一様分布に従い，iid sampleは各点独立に</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5BF(X_%7B(j)%7D)%5D%20=%20%5Cfrac%7Bj%7D%7Bn+1%7D%0A"></p>
<p>になるはずという考えが背景にあります．</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://kennet.mhlw.go.jp/information/information/dictionary/metabolic/ym-045">厚生労働省 &gt; 健康日本21アクション支援システム ～健康づくりサポートネット～ &gt; 中性脂肪 / トリグリセリド</a></li>
<li><a href="https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Laboratory&amp;Cycle=2021-2023&amp;utm_source=chatgpt.com">NHANES (National Health and Nutrition Examination Survey) August 2021 - August 2023</a></li>
<li><a href="https://www.amazon.co.jp/-/en/Numerical-Statistics-Statistical-Probabilistic-Mathematics/dp/0521791685">Monahan, J. (2011). <em>Numerical Methods of Statistics</em>.</a></li>
<li><a href="https://numpy.org/devdocs/reference/generated/numpy.interp.html">numpy.interp</a></li>
<li><a href="https://www.kyoritsu-pub.co.jp/book/b10033628.html">データ解析のための数理統計入門</a></li>
</ul>


</section>

 ]]></description>
  <category>統計</category>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-15-statistical-inference/</guid>
  <pubDate>Mon, 15 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>自分用GitHub Repository作成時のメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-10-github-repository-memo/</link>
  <description><![CDATA[ 






<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">🔨 Getting Started</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>あくまで共通項についてのメモです</li>
<li>厳密には下記のStep 3 ghコマンドの実行 の前にdocument や gitignoreなり他にもやることはあります</li>
</ul>
</div>
</div>
<p><span class="mini-section">minimum structure</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb1-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb1-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">├── .github/</span></span>
<span id="cb1-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   ├── repository_metadata/    # Repository configuration files</span></span>
<span id="cb1-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   │   ├── gh_repo.yml        # Repository metadata</span></span>
<span id="cb1-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   │   └── label_master.yml   # Label definitions</span></span>
<span id="cb1-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│   └── workflows/             # GitHub Actions workflows</span></span>
<span id="cb1-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">│       └── label-generator.yml # Label automation workflow</span></span>
<span id="cb1-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">└── README.md</span></span></code></pre></div></div>
<p><span class="mini-section">手順</span></p>
<ol type="1">
<li><p><strong>ディレクトリの作成と移動</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>repository-name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$_</span></span></code></pre></div></div></li>
<li><p><strong>Repositoryメタデータの作成</strong></p>
<p>以下のように <code>.github/repository_metadata/gh_repo.yml</code> に記述します</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>gh_repo.yml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" data-filename="gh_repo.yml" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">meta-data</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repository_name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> your-repo-name</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">       # Required: Repository name</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">visibility</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> private|public</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            # Required: Repository visibility</span></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">org-name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> YourOrgName</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                # Required: Organization name</span></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">homepage</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> YourURL</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    # Optional: e.g., https://ryonakagami.github.io/regmonkey-datascience-blog/</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tag</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                 # Optional: Repository tags</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> tag1</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> tag2</span></span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                       # Required: Repository description</span></span>
<span id="cb3-10">  A clear, concise description of your project.</span></code></pre></div></div>
</div></li>
</ol>
<div class="callout callout-style-default callout-caution callout-titled" style="margin-left: 2em;">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>'Required'</code> とされているフィールドは必ず入力して下さい</p>
</div>
</div>
<ol start="3" type="1">
<li><p><strong>ghコマンドの実行</strong></p>
<p>自分は <code>.gitconfig</code> で Alias 設定を行い <a href="https://github.com/RyoNakagami/regmonkey-gitcommand/blob/main/src/git-create-repo.sh">git create-repo</a> と <a href="https://github.com/RyoNakagami/regmonkey-gitcommand/blob/main/src/git-repo-update.sh">git update-repo</a> を実行できるようにしています．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step 1</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> create-repo   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only when the repository not created yet</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step 2</span></span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> update-repo   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reflecting tags, description, and homepage</span></span></code></pre></div></div></li>
<li><p><strong>（Optional）ラベルのカスタマイズ</strong></p>
<p><code>.github/repository_metadata/label_master.yml</code> を以下のフォーマットで編集．<code>main</code> へのpushが <code>label_master.yml</code> の変更を含んでいるときにラベルが作成される</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------------------------------------------</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GitHub Issue Labels aligned with Branch Naming Conventions</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------------------------------------------</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Development Workflows (Aligned with Branch Prefixes) ---</span></span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> environment</span></span>
<span id="cb5-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> EFDECD</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # almond</span></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> This issue is related to development repository structure etc</span></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> feature</span></span>
<span id="cb5-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 008000</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # green</span></span>
<span id="cb5-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> New feature development</span></span>
<span id="cb5-14"></span>
<span id="cb5-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> bugfix</span></span>
<span id="cb5-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">color</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DC143C</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">         # crimson</span></span>
<span id="cb5-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Bug fix or defect correction</span></span></code></pre></div></div></li>
</ol>
<section id="label-generator-workflow" class="level3">
<h3 class="anchored" data-anchor-id="label-generator-workflow">Label Generator Workflow</h3>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 24%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>イベント</th>
<th>Workflow が動作する？</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>main</code> への PR を作成</td>
<td>❌</td>
<td><code>push</code> ではないため</td>
</tr>
<tr class="even">
<td><code>main</code> への PR を更新（コミット追加）</td>
<td>❌</td>
<td>push は発生しているが，そのブランチで動くので <code>main</code> とは関係なし</td>
</tr>
<tr class="odd">
<td><code>main</code> への PR を merge</td>
<td>✅</td>
<td>merge commit が <code>main</code> に <code>push</code> されるため</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">ワークフローファイル</span></p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>label-generator.yml</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="label-generator.yml" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Label Manager</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trigger: Runs when labels.yaml is modified</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">branches</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> main</span></span>
<span id="cb6-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paths</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> .github/repository_metadata/label_master.yml</span></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimal required permissions</span></span>
<span id="cb6-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permissions</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">contents</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> read</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    # Read repository files</span></span>
<span id="cb6-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">issues</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> write</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     # Create/update/delete labels</span></span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jobs</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sync-labels</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runs-on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ubuntu-latest</span></span>
<span id="cb6-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb6-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">steps</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # SETUP: Install required tools and authenticate</span></span>
<span id="cb6-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Checkout repository</span></span>
<span id="cb6-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> actions/checkout@v4</span></span>
<span id="cb6-27"></span>
<span id="cb6-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Install uv</span></span>
<span id="cb6-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> astral-sh/setup-uv@v4</span></span>
<span id="cb6-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # uv is used to install Python tools like yamlcli</span></span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Install dependencies</span></span>
<span id="cb6-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-34">          # Update package lists quietly</span>
<span id="cb6-35">          sudo apt-get update -qq</span>
<span id="cb6-36">          </span>
<span id="cb6-37">          # Install jq (JSON processor) and gh (GitHub CLI)</span>
<span id="cb6-38">          sudo apt-get install -y -qq jq gh</span>
<span id="cb6-39">          </span>
<span id="cb6-40">          # Install yamlcli via uv to convert YAML to JSON</span>
<span id="cb6-41">          uv tool install git+https://github.com/RyoNakagami/yamlcli.git</span>
<span id="cb6-42"></span>
<span id="cb6-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Authenticate GitHub CLI</span></span>
<span id="cb6-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token</span></span>
<span id="cb6-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # Note: Not setting GH_TOKEN here allows gh to store credentials</span></span>
<span id="cb6-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # This prevents "To have GitHub CLI store credentials..." warning</span></span>
<span id="cb6-47"></span>
<span id="cb6-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # PARSE: Convert YAML configuration to JSON</span></span>
<span id="cb6-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-52"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Parse labels configuration</span></span>
<span id="cb6-53"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> parse</span></span>
<span id="cb6-54"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-55">          # Convert labels.yaml to JSON format and save to file</span>
<span id="cb6-56">          yamlcli --to-json .github/repository_metadata/label_master.yml &gt; /tmp/labels.json</span>
<span id="cb6-57">          echo "Labels configuration parsed successfully"</span>
<span id="cb6-58"></span>
<span id="cb6-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # SYNC: Create or update labels from configuration</span></span>
<span id="cb6-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-62"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-63"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Sync labels</span></span>
<span id="cb6-64"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-65">          # Exit on error, undefined variables, or pipe failures</span>
<span id="cb6-66">          set -euo pipefail</span>
<span id="cb6-67">          </span>
<span id="cb6-68">          # Get list of existing label names once to avoid repeated API calls</span>
<span id="cb6-69">          EXISTING_LABELS=$(gh label list --json name --jq '.[].name')</span>
<span id="cb6-70">          </span>
<span id="cb6-71">          # Process each label definition from the JSON array</span>
<span id="cb6-72">          jq -c '.[]' /tmp/labels.json | while IFS= read -r label; do</span>
<span id="cb6-73">            # Extract label properties</span>
<span id="cb6-74">            NAME=$(echo "$label" | jq -r '.name')</span>
<span id="cb6-75">            COLOR=$(echo "$label" | jq -r '.color')</span>
<span id="cb6-76">            DESC=$(echo "$label" | jq -r '.description // ""')  # Default to empty string if null</span>
<span id="cb6-77">            </span>
<span id="cb6-78">            echo "Processing label: $NAME"</span>
<span id="cb6-79">            </span>
<span id="cb6-80">            # Check if label already exists in repository</span>
<span id="cb6-81">            if echo "$EXISTING_LABELS" | grep -Fxq "$NAME"; then</span>
<span id="cb6-82">              # Update existing label</span>
<span id="cb6-83">              echo "  Updating existing label"</span>
<span id="cb6-84">              gh label edit "$NAME" --color "$COLOR" --description "$DESC"</span>
<span id="cb6-85">            else</span>
<span id="cb6-86">              # Create new label</span>
<span id="cb6-87">              echo "  Creating new label"</span>
<span id="cb6-88">              gh label create "$NAME" --color "$COLOR" --description "$DESC"</span>
<span id="cb6-89">            fi</span>
<span id="cb6-90">          done</span>
<span id="cb6-91"></span>
<span id="cb6-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # PRUNE: Remove labels not defined in configuration</span></span>
<span id="cb6-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      # ============================================================</span></span>
<span id="cb6-95"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span></span>
<span id="cb6-96"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Prune obsolete labels</span></span>
<span id="cb6-97"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb6-98">          # Exit on error, undefined variables, or pipe failures</span>
<span id="cb6-99">          set -euo pipefail</span>
<span id="cb6-100">          </span>
<span id="cb6-101">          # Get list of all existing labels in the repository</span>
<span id="cb6-102">          EXISTING_LABELS=$(gh label list --json name --jq '.[].name')</span>
<span id="cb6-103">          </span>
<span id="cb6-104">          # Get list of desired labels from configuration</span>
<span id="cb6-105">          DESIRED_LABELS=$(jq -r '.[].name' /tmp/labels.json)</span>
<span id="cb6-106">          </span>
<span id="cb6-107">          # Check each existing label</span>
<span id="cb6-108">          echo "$EXISTING_LABELS" | while IFS= read -r label; do</span>
<span id="cb6-109">            # Skip empty lines</span>
<span id="cb6-110">            if [[ -n "$label" ]] &amp;&amp; ! echo "$DESIRED_LABELS" | grep -Fxq "$label"; then</span>
<span id="cb6-111">              # Label exists in repo but not in config - delete it</span>
<span id="cb6-112">              echo "Deleting obsolete label: $label"</span>
<span id="cb6-113">              gh label delete "$label" --yes || echo "  Failed to delete $label (may be in use)"</span>
<span id="cb6-114">            fi</span>
<span id="cb6-115">          done</span>
<span id="cb6-116"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        # gh CLI uses stored credentials from auth login step</span></span></code></pre></div></div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://github.com/RyoNakagami/regmonkey-gitcommand">regmonkey-gitcommand</a></li>
</ul>


</section>

 ]]></description>
  <category>環境構築</category>
  <category>github</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-10-github-repository-memo/</guid>
  <pubDate>Wed, 10 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>ISO 8601 カレンダーテーブルの作成</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-09-create-calendar-table/</link>
  <description><![CDATA[ 






<section id="iso-8601-とは" class="level2">
<h2 class="anchored" data-anchor-id="iso-8601-とは">ISO 8601 とは？</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">ISO 8601</span></p>
<ul>
<li>日付と時刻の表現形式に関する ISO の国際標準</li>
<li>グレゴリオ暦の西暦2016年3月25日は <code>2016-03-25</code> と表記する</li>
</ul>
</div>
<p>日付を <code>01/05/22</code> と数字で表す場合，</p>
<ul>
<li>2022-01-05</li>
<li>2022-05-01</li>
</ul>
<p>のどちらでも解釈できてしまいます．ISO 8601 は，このような混乱を解消するために日付の国際的な表記方法を定めた規格です． 日本では日本産業規格の JIS X 0301 にて，ISO 8601 と同等の内容が採用されています．</p>
<section id="日付表記-date" class="level3">
<h3 class="anchored" data-anchor-id="日付表記-date">日付表記 (Date)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">日付表記</span></p>
<ul>
<li>ISO 8601 では，日付は 年・月・日を左から順に並べる形式とし，半角数字・ハイフン区切りで表す</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb1-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">YYYY-MM-DD</span></span></code></pre></div></div>
<ul>
<li><code>YYYY</code>：西暦年（4桁．年の表記は 0000年～9999年 を想定）</li>
<li><code>MM</code>：月（2桁．1桁の場合は先頭に <code>0</code> を付与）</li>
<li><code>DD</code>：日（2桁．1桁の場合は先頭に <code>0</code> を付与）</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>0000年より前または9999年より後の年を表記する場合には，事前に通信の送信側と受信側との間での合意が必要</li>
<li><code>YYYYMMDD</code> という表記もあり得る</li>
</ul>
</div>
</div>
</section>
<section id="曜日表記-day-of-week" class="level3">
<h3 class="anchored" data-anchor-id="曜日表記-day-of-week">曜日表記 (Day of Week)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">曜日表記</span></p>
<ul>
<li>ISO 8601 では，週の始まりは月曜日（=1） と定められており，曜日は 1〜7 の整数値で表される</li>
<li>日本の商習慣では「日曜始まり」のカレンダーが多い点に注意</li>
</ul>
</div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>数値</th>
<th>曜日</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>月曜日</td>
</tr>
<tr class="even">
<td>2</td>
<td>火曜日</td>
</tr>
<tr class="odd">
<td>3</td>
<td>水曜日</td>
</tr>
<tr class="even">
<td>4</td>
<td>木曜日</td>
</tr>
<tr class="odd">
<td>5</td>
<td>金曜日</td>
</tr>
<tr class="even">
<td>6</td>
<td>土曜日</td>
</tr>
<tr class="odd">
<td>7</td>
<td>日曜日</td>
</tr>
</tbody>
</table>
</section>
<section id="時刻表記-time" class="level3">
<h3 class="anchored" data-anchor-id="時刻表記-time">時刻表記 (Time)</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title">時刻表記</span></p>
<ul>
<li>ISO 8601 の時刻は 24 時間制で，コロン区切りとする</li>
</ul>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb2-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">hh:mm:ss</span></span></code></pre></div></div>
<ul>
<li><code>hh</code>：時（00–24）</li>
<li><code>mm</code>：分（00–59）</li>
<li><code>ss</code>：秒（00–59，必要に応じて小数も可）</li>
</ul>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (ミリ秒とマイクロ秒)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb3-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">14:30:00.123   （ミリ秒）</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">14:30:00.123456（マイクロ秒）</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="日付と時刻の組み合わせdatetime" class="level3">
<h3 class="anchored" data-anchor-id="日付と時刻の組み合わせdatetime">日付と時刻の組み合わせ（Datetime）</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 5</strong></span> <span class="def-title">Datetime</span></p>
<ul>
<li>ISO 8601 では，日付と時刻を組み合わせる場合 <code>T</code> を連結文字として使用する</li>
<li>必要に応じて UTC との時差（オフセット）を付与する</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">YYYY-MM-DDThh:mm:ss</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[±hh:mm]</span></span></code></pre></div></div>
</div>
<p>タイムゾーン省略時は「ローカル時刻」とみなされるため，システム間連携ではオフセット付与版が望ましいとされます． というか<strong>プログラミングで扱うときは，基本的にはオフセット付与版を用いましょう</strong>．</p>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb5-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025-12-09T14:30:00+09:00   # 日本標準時 (JST)</span></span>
<span id="cb5-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025-12-09T05:30:00Z        # UTC（Z は +00:00 と等価）</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="iso-week-date" class="level3">
<h3 class="anchored" data-anchor-id="iso-week-date">ISO week date</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 6</strong></span> <span class="def-title">ISOWEEK</span></p>
<ul>
<li>ISO-8601 という国際標準で定められた「週番号」の体系</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb6-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Date                2025-12-08</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Week                2025-W50</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Week with weekday   2025-W50-1</span></span></code></pre></div></div>
</div>
<p><span class="mini-section">ISOWEEK計算アルゴリズム</span></p>
<ol type="1">
<li>年初からの通算日（day of year）から，その日の ISO 曜日番号を引く</li>
<li>その結果に 10 を加える</li>
<li>7 で割り，余りを切り捨てる</li>
</ol>
<p>その後，次の判定を行う</p>
<ul>
<li>計算結果が 0 の場合: この日付は 前年の最終週（週番号 52 または 53）</li>
<li>計算結果が 53 の場合:
<ul>
<li>その年に ISO 週 53 が存在するか確認</li>
<li>存在しない年の場合，この日付は 翌年の週 1</li>
</ul></li>
</ul>
<div class="pseudocode-container quarto-float" data-caption-prefix="Algorithm" data-pseudocode-number="1" data-comment-delimiter="//" data-indent-size="1.2em" data-line-number="true" data-line-number-punc=":" data-no-end="false">
<div class="pseudocode">
\begin{algorithm} \caption{ISO Week Number Calculation} \begin{algorithmic} \Procedure{WeekdayOfDec31}{$y$} \State $p = (\, y + \lfloor y/4 \rfloor - \lfloor y/100 \rfloor + \lfloor y/400 \rfloor \,) \bmod 7$ \Return $p$ \EndProcedure \State \Procedure{WeeksInYear}{$y$} \State $p_y$ = \Call{WeekdayOfDec31}{$y$} \State $p_{y-1}$ = \Call{WeekdayOfDec31}{$y-1$} \If{$p_y = 4 \ OR \ p_{y-1} = 3$} \Return $53$ \Else \Return $52$ \EndIf \EndProcedure \State \Procedure{ISOWeek}{$date$} \State $y = year(date)$ \State $doy = doy(date)$ $\,\,\,\,\,$ \Comment{ day of year} \State $dow = dow(date)$ $\,\,\,\,\,$\Comment{ISO weekday: 1=Mon,...,7=Sun} \State $w = \left\lfloor \dfrac{10 + doy - dow}{7} \right\rfloor$ \If{$w &lt; 1$} \Return \Call{WeeksInYear}{$y-1$} \ElsIf{$w$ &gt; \Call{WeeksInYear}{$y$}} \Return $1$ \Else \Return $w$ \EndIf \EndProcedure \end{algorithmic} \end{algorithm}
</div>
</div>
</section>
</section>
<section id="カレンダーとプログラミング" class="level2">
<h2 class="anchored" data-anchor-id="カレンダーとプログラミング">カレンダーとプログラミング</h2>
<section id="シェルでisoweek計算" class="level3">
<h3 class="anchored" data-anchor-id="シェルでisoweek計算">シェルでISOWEEK計算</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 7</strong></span> <span class="def-title"><code>date</code> コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> +%V</span></code></pre></div></div>
<p>を実行すると，現在時刻のISO WEEKが表示される</p>
</div>
<p><span class="mini-section">関連オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<thead>
<tr class="header">
<th>フォーマット</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>%V</code></td>
<td>ISO 8601 週番号（01–53）</td>
</tr>
<tr class="even">
<td><code>%G</code></td>
<td>ISO 年（week-based year）</td>
</tr>
<tr class="odd">
<td><code>%g</code></td>
<td>ISO 年（下2桁）</td>
</tr>
<tr class="even">
<td><code>%u</code></td>
<td>ISO 曜日（1=Mon〜7=Sun）</td>
</tr>
<tr class="odd">
<td><code>%a</code></td>
<td>曜日名（Mon, Tue, …）</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (UTC vs Asia/Tokyo)</strong></span> <br></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date +%V <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-12-30T08:00:00.123213+09:00'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span></span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">52</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date +%V <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-12-30T08:00:00.123213+00:00'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span></span>
<span id="cb8-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">01</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="日付レンジからカレンダーテーブルの作成" class="level3">
<h3 class="anchored" data-anchor-id="日付レンジからカレンダーテーブルの作成">日付レンジからカレンダーテーブルの作成</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Goal
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>YYYY-MM-DD</code> 形式の２つの引数を入力すると，指定した開始日から終了日までの日付範囲を1日ずつ列挙したテーブル形式で出力する関数を作成</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> date-table 2020-01-01 2020-01-10   </span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span>,weekday,iso_day_of_week,isoweek,day_of_year</span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-01,Wed,3,01,001</span></span>
<span id="cb9-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-02,Thu,4,01,002</span></span>
<span id="cb9-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-03,Fri,5,01,003</span></span>
<span id="cb9-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-04,Sat,6,01,004</span></span>
<span id="cb9-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-05,Sun,7,01,005</span></span>
<span id="cb9-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-06,Mon,1,02,006</span></span>
<span id="cb9-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-07,Tue,2,02,007</span></span>
<span id="cb9-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-08,Wed,3,02,008</span></span>
<span id="cb9-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-09,Thu,4,02,009</span></span>
<span id="cb9-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2020-01-10,Fri,5,02,010</span></span></code></pre></div></div>
</div>
</div>
<p><span class="mini-section">実装例</span></p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">Bash</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Python + datetimeモジュール</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">Pandas</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false" href="">Polars</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false" href="">BigQuery with UDF Table</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revised: 2025-12-09</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Script: date-table</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Description:</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Generates a CSV table of dates and their properties for a given date range.</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Outputs columns for date, weekday, ISO day of week, ISO week number, and</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   day of year, with options to select which columns to display.</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Steps:</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     1. Parse and validate command-line options and arguments.</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     2. Validate input dates (format and calendar existence).</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     3. Set output columns based on options (default: all columns).</span></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     4. Print CSV header.</span></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     5. Iterate from start to end date, printing each row with selected fields.</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Options:</span></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -a    Show weekday column</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -u    Show ISO day of week column</span></span>
<span id="cb10-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -V    Show ISO week number column</span></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -j    Show day of year column</span></span>
<span id="cb10-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -h    Show this help message</span></span>
<span id="cb10-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Usage:</span></span>
<span id="cb10-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./date-table [-a] [-u] [-V] [-j] &lt;start-date&gt; &lt;end-date&gt;</span></span>
<span id="cb10-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     # Outputs a CSV table for the date range, with selected columns.</span></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notes:</span></span>
<span id="cb10-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires bash, GNU date, and coreutils installed.</span></span>
<span id="cb10-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Dates must be in YYYY-MM-DD format.</span></span>
<span id="cb10-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Exits with error if dates are invalid or out of order.</span></span>
<span id="cb10-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb10-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-euo</span> pipefail</span>
<span id="cb10-35"></span>
<span id="cb10-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Validate YYYY-MM-DD ---</span></span>
<span id="cb10-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">validate_ymd()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb10-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">d</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-39"></span>
<span id="cb10-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format check</span></span>
<span id="cb10-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Invalid format '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'. Expected YYYY-MM-DD."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-43">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-45"></span>
<span id="cb10-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calendar existence check</span></span>
<span id="cb10-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">norm</span></span>
<span id="cb10-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">norm</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%Y-%m-%d <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>/dev/null<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-49">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' is not a real date."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-50">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-52"></span>
<span id="cb10-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reject auto-corrected dates (e.g., 2025-02-30 → 2025-03-02)</span></span>
<span id="cb10-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$norm</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-55">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' is not a valid calendar date."</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-56">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-58"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span>
<span id="cb10-59"></span>
<span id="cb10-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Option parsing ---</span></span>
<span id="cb10-61"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-62"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-63"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-64"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-65"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt_specified</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false</span>
<span id="cb10-66"></span>
<span id="cb10-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getopts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auVj"</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb10-68">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt_specified</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">case</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb10-70">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">a</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-71">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">u</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-72">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">V</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-73">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">j</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb10-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">esac</span></span>
<span id="cb10-75"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span>
<span id="cb10-76"> </span>
<span id="cb10-77"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb10-78"></span>
<span id="cb10-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$#</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-ne</span> 2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-80">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Usage: </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$0</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> [-a] [-u] [-V] [-j] &lt;start-date&gt; &lt;end-date&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-81">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-82"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-83"></span>
<span id="cb10-84"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">start_date</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-85"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">end_date</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-86"></span>
<span id="cb10-87"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">validate_ymd</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-88"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">validate_ymd</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-89"></span>
<span id="cb10-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure start &lt;= end</span></span>
<span id="cb10-91"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-92">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: start_date &gt; end_date"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-93">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb10-94"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-95"></span>
<span id="cb10-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If no options specified → output all</span></span>
<span id="cb10-97"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt_specified</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb10-98">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-99">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-100">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-101">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">show_day_of_year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb10-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb10-103"></span>
<span id="cb10-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Print header ---</span></span>
<span id="cb10-105"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span></span>
<span id="cb10-106"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_weekday</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",weekday"</span></span>
<span id="cb10-107"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_iso_day</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",iso_day_of_week"</span></span>
<span id="cb10-108"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_isoweek</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",isoweek"</span></span>
<span id="cb10-109"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_day_of_year</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",day_of_year"</span></span>
<span id="cb10-110"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"\n"</span></span>
<span id="cb10-111"></span>
<span id="cb10-112"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Generate rows ---</span></span>
<span id="cb10-113"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">current</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$start_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-114"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">true</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb10-115"></span>
<span id="cb10-116">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">weekday</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%a<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-117">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso_day</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%u<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-118">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">isoweek</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%V<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-119">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">doy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> +%j<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-120"></span>
<span id="cb10-121">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-122">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_weekday</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$weekday</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-123">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_iso_day</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$iso_day</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-124">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_isoweek</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$isoweek</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-125">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$show_day_of_year</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",%s"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$doy</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-126"></span>
<span id="cb10-127">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">printf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"\n"</span></span>
<span id="cb10-128"></span>
<span id="cb10-129">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$end_date</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]]</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb10-130"></span>
<span id="cb10-131">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">current</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$current</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> +1 day"</span> +%Y-%m-%d<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-132"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span></code></pre></div></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime, timedelta</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb11-4">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.fromisoformat(start_date).date()</span>
<span id="cb11-5">    end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.fromisoformat(end_date).date()</span>
<span id="cb11-6"></span>
<span id="cb11-7">    delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start</span>
<span id="cb11-8"></span>
<span id="cb11-9">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(delta.days <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb11-11">        d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i)</span>
<span id="cb11-12">        result.append(</span>
<span id="cb11-13">            {</span>
<span id="cb11-14">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: d,</span>
<span id="cb11-15">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>: d.isoformat(),</span>
<span id="cb11-16">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>: d.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mon, Tue ...</span></span>
<span id="cb11-17">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>: d.isoweekday(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1=Mon ... 7=Sun</span></span>
<span id="cb11-18">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>: d.isocalendar()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ISO week number</span></span>
<span id="cb11-19">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>: d.timetuple().tm_yday,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1〜365/366</span></span>
<span id="cb11-20">            }</span>
<span id="cb11-21">        )</span>
<span id="cb11-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span></code></pre></div></div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb12-2"></span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table_pd(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb12-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date range</span></span>
<span id="cb12-6">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.date_range(start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start_date, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>end_date, freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>)</span>
<span id="cb12-7"></span>
<span id="cb12-8">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(</span>
<span id="cb12-9">        {</span>
<span id="cb12-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: dates.date,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date object</span></span>
<span id="cb12-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>: dates.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb12-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>: dates.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mon, Tue, ...</span></span>
<span id="cb12-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>: dates.isocalendar().day.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1–7</span></span>
<span id="cb12-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>: dates.isocalendar().week.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ISO week number</span></span>
<span id="cb12-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>: dates.dayofyear.values.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1–366</span></span>
<span id="cb12-16">        }</span>
<span id="cb12-17">    )</span>
<span id="cb12-18"></span>
<span id="cb12-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span></code></pre></div></div>
<ul>
<li><code>dates.isocalendar().day</code> などは Date Index付 <code>pandas.core.series.Series</code> で返してしまうので <code>.values</code> を使用</li>
</ul>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> polars <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pl</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> date</span>
<span id="cb13-3"></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> date_table_pl(start_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, end_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pl.DataFrame:</span>
<span id="cb13-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reformat to date object</span></span>
<span id="cb13-7">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date.fromisoformat(start_date)</span>
<span id="cb13-8">    end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> date.fromisoformat(end_date)</span>
<span id="cb13-9"></span>
<span id="cb13-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># date range</span></span>
<span id="cb13-11">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.date_range(start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>start, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>end, interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1d"</span>, eager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb13-12"></span>
<span id="cb13-13">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pl.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: dates}).with_columns(</span>
<span id="cb13-14">        [</span>
<span id="cb13-15">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.to_string(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date_str"</span>),</span>
<span id="cb13-16">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a"</span>).alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weekday"</span>),</span>
<span id="cb13-17">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.weekday().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iso_day_of_week"</span>),</span>
<span id="cb13-18">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.week().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"isoweek"</span>),</span>
<span id="cb13-19">            pl.col(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>).dt.ordinal_day().alias(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day_of_year"</span>),</span>
<span id="cb13-20">        ]</span>
<span id="cb13-21">    )</span>
<span id="cb13-22"></span>
<span id="cb13-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span></code></pre></div></div>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<ol type="1">
<li>テーブル関数用のData setの作成</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SCHEMA</span> `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table`</span>
<span id="cb14-2">OPTIONS (location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"asia-northeast1"</span>);</span></code></pre></div></div>
<ol start="2" type="1">
<li>テーブル関数作成 (<code>CREATE TABLE FUNCTION</code>)</li>
</ol>
<p>BigQuery の <code>DAYOFWEEK</code> が <code>Sunday=1</code> であるのでISO8601形式に変換</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">OR</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">REPLACE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TABLE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FUNCTION</span></span>
<span id="cb15-2">  `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table.date_table`(start_date <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>, end_date <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>)</span>
<span id="cb15-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> (</span>
<span id="cb15-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span></span>
<span id="cb15-5">    d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">date</span>,</span>
<span id="cb15-6">    FORMAT_DATE(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%Y-%m-%d'</span>, d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> date_str,</span>
<span id="cb15-7">    FORMAT_DATE(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%a'</span>, d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> weekday,</span>
<span id="cb15-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MOD</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(DAYOFWEEK <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> iso_day_of_week,</span>
<span id="cb15-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(ISOWEEK <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> isoweek,</span>
<span id="cb15-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(DAYOFYEAR <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> d) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> day_of_year</span>
<span id="cb15-11">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span></span>
<span id="cb15-12">    UNNEST(GENERATE_DATE_ARRAY(start_date, end_date, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">INTERVAL</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DAY</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> d</span>
<span id="cb15-13">);</span></code></pre></div></div>
<ol start="3" type="1">
<li>実行</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> </span>
<span id="cb16-3">  `hogehoge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>project.utility_table.date_table`(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2025-02-01'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2025-02-10'</span>);</span></code></pre></div></div>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.python.org/ja/3.14/library/datetime.html#">Python Documentation &gt; datetime — 基本的な日付と時間の型</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <category>SQL</category>
  <category>shell</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-09-create-calendar-table/</guid>
  <pubDate>Tue, 09 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>P-valueの考え方</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/</link>
  <description><![CDATA[ 






<section id="p-valueの定義" class="level2">
<h2 class="anchored" data-anchor-id="p-valueの定義">P-valueの定義</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">P value</span></p>
<p>データにばらつきがある場合，ばらつきだけの原因で評価指標が観測された以上の大きな値を取る確率</p>
</div>
<p>P値はNHSTの文脈で用いられる指標です．統計的文脈に則した定義を与えるとすると，</p>
<p><img src="https://latex.codecogs.com/png.latex?H_o:%20%20%5Ctheta%20%5Cin%20%5CTheta_0"> vs <img src="https://latex.codecogs.com/png.latex?H_o:%20%20%5Ctheta%20%5Cnotin%20%5CTheta_0"> なるNHSTにおいて，棄却域が</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5C%7B%5Cpmb%20x%20%7C%20W(%5Cpmb%20x)%20%3E%20c%5C%7D%0A"></p>
<p>で与えられる検定を考えます．このとき</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x)%20=%20%5Csup_%7B%5Ctheta%20%5Cin%20%5CTheta_0%7D%20P_%5Ctheta%20(W(%5Cpmb%20X)%20%5Cgeq%20W(%5Cpmb%20x))%0A"></p>
<p>をP値もしくは有意確率といいます．</p>
<div id="thm-bound" class="custom_problem blog-custom-border theorem">
<p><span class="theorem-title"><strong>Theorem 1</strong></span> <span class="def-title">Type I エラーのバウンド</span></p>
<p>すべての <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cin%20%5CTheta_0"> とすべての <img src="https://latex.codecogs.com/png.latex?%5Calpha%20%5Cin%20(0,%201)"> について</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20%5Calpha%0A"></p>
<p>が成り立つ．</p>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cin%20%5CTheta_0"> を任意に固定して</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x%20%7C%20%5Ctheta)%20=%20P_%5Ctheta(W(%5Cpmb%20X)%20%5Cgeq%20W(%5Cpmb%20x))%0A"></p>
<p>とおきます．<img src="https://latex.codecogs.com/png.latex?-W(%5Cpmb%20X)"> の分布関数を <img src="https://latex.codecogs.com/png.latex?F_%5Ctheta(w)"> とすると</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cpmb%20x%20%7C%20%5Ctheta)%0A%20%20&amp;=%20P_%5Ctheta(-W(%5Cpmb%20X)%20%5Cgeq%20-W(%5Cpmb%20x))%5C%5C%5B5pt%5D%0A%20%20&amp;=%20F_%5Ctheta(-W(%5Cpmb%20x))%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p><img src="https://latex.codecogs.com/png.latex?F_%5Ctheta(-W(%5Cpmb%20X))"> は分布関数 <img src="https://latex.codecogs.com/png.latex?F_%5Ctheta"> に <img src="https://latex.codecogs.com/png.latex?-W(%5Cpmb%20X)"> を代入したものなので，<img src="https://latex.codecogs.com/png.latex?(0,%201)"> 上に一様分布します． したがって，確率測度 <img src="https://latex.codecogs.com/png.latex?P_%5Ctheta"> に対して</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X%20%7C%20%5Ctheta)%20%5Cleq%20%5Calpha)%20=%20P_%5Ctheta(F_%5Ctheta(-W(%5Cpmb%20X)))%20=%20%5Calpha%0A"></p>
<p>定義より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cpmb%20x)%20=%20%5Csup_%7B%5Ctheta%5E%5Cprime%20%5Cin%20%5CTheta_0%7D%20p(%5Cpmb%20x%20%7C%20%5Ctheta%5E%5Cprime)%20%5Cgeq%20p(%5Cpmb%20x%20%7C%20%5Ctheta)%0A"></p>
<p>であるので</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20P_%5Ctheta(p(%5Cpmb%20X%20%7C%20%5Ctheta)%20%5Cleq%20%5Calpha)%20=%20%5Calpha%0A"></p>
</div>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1</strong></span> <br></p>
<p><img src="https://latex.codecogs.com/png.latex?X_1,%20%5Ccdots.%20X_n%20%5Coverset%7B%5Cmathrm%7Biid%7D%7D%7B%5Csim%7D%20%20N(%5Cmu,%20%5Csigma%5E2_0)"> とし，<img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_0"> は既知であるとする．</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?H_0:%20%5Cmu%20=%20%5Cmu_0"></li>
<li><img src="https://latex.codecogs.com/png.latex?H_1:%20%5Cmu%20=%5Cneq%20%5Cmu_0"></li>
</ul>
<p>となる両側検定については，検定統計量は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AW(%5Cbar%20X)%20=%20%5Csqrt%7Bn%7D%7C%5Cbar%20X%20-%20%5Cmu_0%7C/%5Csigma_0%0A"></p>
<p>となり，有意水準 <img src="https://latex.codecogs.com/png.latex?%5Calpha"> について，対応する棄却域は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5C%7B%5Cbar%20x%20%7C%20W(%5Cbar%20x)%20%3E%20z_%7B%5Calpha/2%7D%5C%7D%0A"></p>
<p>このとき，<img src="https://latex.codecogs.com/png.latex?Z%20=%20%5Csqrt%7Bn%7D(%5Cbar%20X%20-%20%5Cmu_0)/%5Csigma_0"> とおくと，<img src="https://latex.codecogs.com/png.latex?W(%5Cbar%20X)%20=%20%7CZ%7C"> になります．また，<img src="https://latex.codecogs.com/png.latex?H_0"> のもとで <img src="https://latex.codecogs.com/png.latex?Z%20%5Csim%20N(0,%201)"> であるので</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cbar%20x)%0A%20%20&amp;=%20P_%7B%5Cmu_0%7D(W(%5Cbar%20X)%20%5Cgeq%20W(%5Cbar%20x))%5C%5C%0A%20%20&amp;=%20P(%7CZ%7C%20%5Cgeq%20%5Csqrt%7Bn%7D%7C%5Cbar%20x%20-%20%5Cmu%7C/%5Csigma_0)%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbar%20x%20%5Cin%20R"> のときは</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%5Cbar%20x)%0A%20%20&amp;=%20P(%7CZ%7C%20%5Cgeq%20%5Csqrt%7Bn%7D%7C%5Cbar%20x%20-%20%5Cmu_0%7C/%5Csigma_0)%5C%5C%0A%20%20&amp;%5Cleq%20P(%7CZ%7C%20%5Cgeq%20z_%7B%5Calpha/2%7D)%20=%20%5Calpha%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>したがって，定理 Theorem&nbsp;1 より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%7B%5Cmu_0%7D(p(%5Cbar%20X)%20%5Cleq%20%5Calpha)%20=%20%5Calpha%0A"></p>
<p>となります．仮にデータを観測して <img src="https://latex.codecogs.com/png.latex?p(%5Cbar%20x)%20%3C%200.01"> となるとき．<img src="https://latex.codecogs.com/png.latex?H_0"> のもとで，P値が0.01より小さくなる確率は 0.01 より小さいことがわかります．</p>
</div>
<hr>
</section>
<section id="統計的判定とドメイン領域判定" class="level2">
<h2 class="anchored" data-anchor-id="統計的判定とドメイン領域判定">統計的判定とドメイン領域判定</h2>
<p>医薬品の臨床試験においては、<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bp-value%7D%3C%5Calpha"> のとき「統計的に有意である」と判定し，帰無仮説（処置効果が存在しない）を棄却する，というプロトコルが用いられます．</p>
<p>しかし，この判定は<span class="regmonnkey-bold">あくまで統計的判定であり，医学的に意味のある処置効果が存在することを直接示すものではない</span>です．P値はあくまで，</p>
<ul>
<li>データにばらつきがある場合，ばらつきだけの原因で評価指標が観測された以上の大きな値を取る確率</li>
</ul>
<p>を表す量であり，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP_%5Ctheta(p(%5Cpmb%20X)%20%5Cleq%20%5Calpha)%20%5Cleq%20%5Calpha%20%5C,%20%5C%20(%5Ctheta%20%5Cin%20%5CTheta_0)%0A"></p>
<p>を用いたNeyman-Pearson流の意思決定フレームワークにおけるType I Error制御にすぎません．「医薬品の効果があった」という医学的判定とは異なります． 医学的判定において重要なのは，</p>
<ul>
<li>効果量の大きさが臨床的に意味のある水準か</li>
<li>副作用や安全性とのバランスは妥当か</li>
<li>除外すべき患者がデータに含まれていないか？</li>
</ul>
<p>といったP-valueの枠外の観点と照らし合わせて，結果を解釈して意思決定を行うことです．</p>
<p>統計的判定が得られなければ，医学的判断の対象にはなりえない，といったプロトコルを事前に作成して統計的判定の指標としてP値を用いるのはよいですが， P値そのものは医学的有効性や臨床的価値の判断とは切り分けて解釈されるべきです．</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.kyoritsu-pub.co.jp/book/b10003681.html">久保川 - 現代数理統計学の基礎, 7.5.4</a></li>
</ul>


</section>

 ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-05-p-value/</guid>
  <pubDate>Fri, 05 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>NW Regressionのメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</link>
  <description><![CDATA[ 






<section id="non-parametric-regression" class="level2">
<h2 class="anchored" data-anchor-id="non-parametric-regression">Non-parametric Regression</h2>
<p><img src="https://latex.codecogs.com/png.latex?(X_1,%20Y_1),%20%5Ccdots,%20(X_n,%20Y_n)%20%5Csim%20F"> というデータを観測したとき，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ar(x)%20=%20%5Cmathbb%20E%5BY%20%7C%20X%20=%20x%5D%0A"></p>
<p>というCEFを推定するのがゴールとなります．このとき，<img src="https://latex.codecogs.com/png.latex?%5Chat%20r(x)"> を回帰関数とすると <img src="https://latex.codecogs.com/png.latex?r(x)"> との距離を考える必要があります． 距離の一例として</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AL(%5Chat%20r,%20r)%20=%20%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p>とするとリスク関数は</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cmathbb%20E%5Cleft%5B%5Cint%20(%5Chat%20r(x)%20-%20r(x))%5E2%20%5C,%5Cmathrm%7Bd%7Dx%5Cright%5D%0A"></p>
<ul>
<li>このとき，<img src="https://latex.codecogs.com/png.latex?r%5E%7B%5Cprime%5Cprime%7D(y)%20%3C%20%5Cinfty"> であると仮定しています</li>
</ul>
<p>回帰関数のBiasとVarianceを <img src="https://latex.codecogs.com/png.latex?b(x),%20v(x)"> とすると，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20=%20%5Cint%20b%5E2(x)%20%5C,%5Cmathrm%7Bd%7Dx%20+%20%5Cint%20v(x)%5C,%5Cmathrm%7Bd%7Dx%0A"></p>
<p><span class="mini-section">Non-parametric Regressionの方針</span></p>
<p>Non-parametric Regression推定の考え方は，データの「局所平均」をとることでです． ある点における回帰関数の推定値は、その点の近傍にある <img src="https://latex.codecogs.com/png.latex?Y"> の値の平均として求めることになります．</p>
<p>バンド幅は Bias と Variance に影響を与えますが，</p>
<ul>
<li>近傍が広すぎると，Bias が大きく Variance が小さい状態へ（oversmoothing）</li>
<li>逆に近傍が狭すぎると，Bias は小さいが Variance が大きい状態へ（undersmoothing）</li>
</ul>
</section>
<section id="kernel-regression" class="level2">
<h2 class="anchored" data-anchor-id="kernel-regression">Kernel Regression</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Kernel Regression Estimator</span></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%20r(x)%20=%20%5Csum_%7Bi=1%7D%5En%20w_i(x)%20Y_i%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?w_i(x)">: importance weight and the form is following</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw_i(x)%20=%20%5Cfrac%7BK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%7B%5Csum_%7Bi=1%7D%5EnK%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%7D%0A"></p>
</div>
<p>表記簡略化のため <img src="https://latex.codecogs.com/png.latex?K%5Cleft(%5Cfrac%7Bx%20-%20X_i%7D%7Bh%7D%5Cright)%20=%20K_h(X_i)"> とし，<img src="https://latex.codecogs.com/png.latex?X_i"> は １変数の場合とします．</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Chat%20r(x)%0A%20%20&amp;=%20%5Cfrac%7B%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20K_h(X_i)%7D%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7B%5Chat%20p(x)%7D%5C%5C%0A%20%20&amp;%5Capprox%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum%20Y_i%20K_h(X_i)%7D%7Bp(x)%7D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき numerator 側の期待値を考えると</p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%7BE%7D%5BY%20K_h(X%20-%20x)%5D%0A&amp;=%20%5Ciint%20y%20K_h(u%20-%20x)%20p(u,%20y)%5C,%20dy%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20%5Cleft(%20%5Cint%20y%20p(y%20%5Cmid%20u)%5C,%20dy%20%5Cright)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K_h(u%20-%20x)%20r(u)%20p(u)%5C,%20du%20%5C%5C%0A&amp;=%20%5Cint%20K(t)%5C,%20r(x%20+%20th)%5C,%20p(x%20+%20th)%5C,%20dt%20%5C%5C%0A&amp;%5Capprox%20%5Cint%20K(t)%0A%5Cleft%5B%20r(x)%20+%20th%20r'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20r''(x)%20%5Cright%5D%0A%5Cleft%5B%20p(x)%20+%20th%20p'(x)%20+%20%5Cfrac%7Bt%5E2%20h%5E2%7D%7B2%7D%20p''(x)%20%5Cright%5D%20dt%20%5C%5C%0A&amp;=%20r(x)p(x)%20+%20%5Cfrac%7Bc%20h%5E2%7D%7B2%7D%20%5Cleft%5B%20r(x)p''(x)%20+%202%20r'(x)p'(x)%20+%20r''(x)p(x)%20%5Cright%5D%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>このとき <img src="https://latex.codecogs.com/png.latex?c%20=%20%5Cint%20t%5E2K(t)">．したがって，</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%20E%5B%5Chat%20r(x)%5D%20=%20r(x)%20+%20Ch%5E2%0A"></p>
<p><span class="mini-section">分散の導出</span></p>
<div class="math display" style="overflow: auto">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D%0A%20%20&amp;=%20%5Cint%20%5Cmathbb%20E%5BY%5E2%20%7C%20X=u%5DK%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20(r%5E2(u)%20+%20%5Csigma%5E2(u))K%5E2_h(u%20-%20x)p(u)%5C,%20du%20%5C%5C%0A%20%20&amp;=%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x%20+%20th)%20+%20r%5E%7B2%7D(x%20+%20th)%20%5Cright)%0A%20%20%20%20%20%20%5Cfrac%7B1%7D%7Bh%5E%7B2%7D%7D%20K%5E%7B2%7D(t)%5C,%20p(x%20+%20th)%5C,%20h%5C,%20dt%20%5C%5C%0A%20%20&amp;=%20%5Cfrac%7B1%7D%7Bh%7D%20%5Cint%20%5Cleft(%20%5Csigma%5E%7B2%7D(x)%20+%20r%5E%7B2%7D(x)%20%5Cright)%0A%20%20%20%20%20%20p(x)%5C,%20K%5E%7B2%7D(t)%5C,%20dt%20+%20o%5C!%5Cleft(%5Cfrac%7B1%7D%7Bh%7D%5Cright).%0A%5Cend%7Balign%7D%0A"></p>
</div>
<p>したがって， <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(1/h)">. <img src="https://latex.codecogs.com/png.latex?h%5Cto%200"> の状況では <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%20E%5BY%5E2K%5E2_h(X%20-%20x)%5D"> のオーダーが支配的になるので</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(Y%20K_h(X%20-%20x))%20%5Capprox%20%5Cmathcal%7BO%7D(1/h)%0A"></p>
<p>したがって，i.i.dと <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bi=1%7D%5En"> より</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVar%7D(%5Chat%20r(x))%20=%20%5Cfrac%7BC%7D%7Bnh%7D%0A"></p>
<p>これらを踏まえるとIMSEは</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BIMSE%7D%20=%20ch%5E4%20+%20%5Cfrac%7Bc%7D%7Bnh%7D%0A"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Curse of dimensionality
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?d"> 次元を考えるとリスク関数は次のオーダーになります</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(%5Chat%20r,%20r)%20%5Capprox%20n%5E%7B-4/(4%20+%20d)%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?d"> が大きくなるほど，IMSEのオーダーは悪くなることから curse of dimensionality と呼びます．</p>
</div>
</div>


</section>

 ]]></description>
  <category>統計</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-04-kernel-regression/</guid>
  <pubDate>Thu, 04 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>UTF-8 の BOM 付き vs BOM なし</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</link>
  <description><![CDATA[ 






<section id="bombyte-order-mark" class="level2">
<h2 class="anchored" data-anchor-id="bombyte-order-mark">BOM(Byte Order Mark)</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">BOM</span></p>
<ul>
<li>バイト順序（エンディアン）を示すためのマーク</li>
<li>BOM は必ずテキストの先頭に付与される(= テキストの中間に置かれることはない)</li>
<li>UTF-8 はバイト順序がないので必要ないが，UTF-8であることの判定のためにUTF-8 with BOM となる場合がある</li>
</ul>
</div>
<p>プログラムがテキストデータを読み込む際に先頭の数バイトによりUnicodeのデータであることやどの種類の符号化形式を採用しているのかを判別しています． BOM付きのUTF-8であれば先頭の3バイトがBOMであり，<code>0xEF 0xBB 0xBF</code>というデータになります．</p>
<p><span class="mini-section">BOM一覧</span></p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 8%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>符号化形式（符号化スキーム）</th>
<th>エンディアン</th>
<th>バイト順マーク (BOM)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>UTF-8</td>
<td>なし</td>
<td><code>EF BB BF</code></td>
</tr>
<tr class="even">
<td>UTF-16</td>
<td>BE</td>
<td><code>FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-16</td>
<td>LE</td>
<td><code>FF FE</code></td>
</tr>
<tr class="even">
<td>UTF-32</td>
<td>BE</td>
<td><code>00 00 FE FF</code></td>
</tr>
<tr class="odd">
<td>UTF-32</td>
<td>LE</td>
<td><code>FF FE 00 00</code></td>
</tr>
</tbody>
</table>
<section id="xxd-コマンドでbomを確認する" class="level3">
<h3 class="anchored" data-anchor-id="xxd-コマンドでbomを確認する"><code>xxd</code> コマンドでBOMを確認する</h3>
<p>以下を内容とする <code>test.sh</code> というファイルがあるとします．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!"</span></span></code></pre></div></div>
<p>BOMが付与されていないと</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                </span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> 2321 2f62 696e 2f62 6173 680a 0a65 6368  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash..ech</span></span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6f20 2248 616c 6c6f 2057 6f72 6c64 2121  o <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo World!!</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 220a 0a                                  "</span>..</span></code></pre></div></div>
<p>となりますが，<code>vim "+set bomb" "+wq" test.sh</code> とBOMを付与すると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> xxd test.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>                 </span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000000:</span> efbb bf23 212f 6269 6e2f 6261 7368 0a0a  ...#!/bin/bash..</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">00000010:</span> 6563 686f 2022 4861 6c6c 6f20 576f 726c  echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hallo Worl</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">00000020: 6421 2122 0a0a                           d!!"</span>..</span></code></pre></div></div>
<p>先頭バイトが <code>efbb bf</code> となっていることから UTF-8 with BOMであることがわかります．</p>
<p>BOMありの場合，<code>chmod +x test.sh</code> 実行後にランしてみると</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> ./test.sh                    </span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./test.sh:</span> 1: ﻿#!/bin/bash: not found</span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Hallo</span> World!!</span></code></pre></div></div>
<p>となります．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><code>nkf</code> を用いた文字コード判定
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>nkf</code> コマンドと <code>--guess</code> オプションを組み合わせると，使用されている文字コードと改行コードの判定結果を表示することができます．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> nkf <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--guess</span> test.sh </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">UTF-8</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">BOM</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">LF</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div></div>
</div>
</div>
</section>
<section id="nkf-コマンドを用いてbomなしへ変換する" class="level3">
<h3 class="anchored" data-anchor-id="nkf-コマンドを用いてbomなしへ変換する"><code>nkf</code> コマンドを用いてBOMなしへ変換する</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>nkf</code> コマンド</span></p>
<ul>
<li><p>Network Kanji Filterの略</p></li>
<li><p>文字コードと改行コードを変換するためのコマンド</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">opttion</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">file</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div></li>
</ul>
</div>
<p><span class="mini-section">入力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-J</code></td>
<td>入力を ISO-2022-JP とみなす</td>
</tr>
<tr class="even">
<td><code>-S</code></td>
<td>入力を Shift_JIS とみなす</td>
</tr>
<tr class="odd">
<td><code>-E</code></td>
<td>入力を EUC-JP とみなす</td>
</tr>
<tr class="even">
<td><code>--ic=UTF-8</code></td>
<td>入力を UTF-8 とみなす</td>
</tr>
</tbody>
</table>
<p><span class="mini-section">出力文字コードオプション</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-j</code></td>
<td>出力を ISO-2022-JP</td>
</tr>
<tr class="even">
<td><code>-s</code></td>
<td>出力を Shift_JIS</td>
</tr>
<tr class="odd">
<td><code>-e</code></td>
<td>出力を EUC-JP</td>
</tr>
<tr class="even">
<td><code>-w</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>-w8</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力を UTF-8（BOMなし）</td>
</tr>
<tr class="odd">
<td><code>--oc=UTF-8-BOM</code></td>
<td>出力を UTF-8（BOM付き）</td>
</tr>
</tbody>
</table>
<section id="bomを取り除く" class="level4">
<h4 class="anchored" data-anchor-id="bomを取り除く">BOMを取り除く</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nkf</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--overwrite</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--oc</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>UTF-8 test.sh</span></code></pre></div></div>
<p>とすることでBOMなしUTF-8へ変換することが出来ます．</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 82%">
</colgroup>
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--overwrite</code></td>
<td><strong>元ファイルを上書き</strong>して保存する</td>
</tr>
<tr class="even">
<td><code>--oc=UTF-8</code></td>
<td>出力の文字コードを UTF-8 にする</td>
</tr>
</tbody>
</table>
<p>内部的には</p>
<ol type="1">
<li>元ファイルの文字コードが自動判定される</li>
<li>内容を UTF-8 に変換</li>
<li>BOM を持っていた場合は削除</li>
<li>変換後の内容で test.sh を上書き保存</li>
</ol>
<p>という処理が行われるので，もし思ったような挙動が確認できない場合は「<strong>元ファイルの文字コードが自動判定される</strong>」に問題があるかもなので 入力文字コード指定オプションを組み合わせたりします</p>
</section>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title">UTF-8</span></p>
<ul>
<li>Unicodeで割り振ったコードポイントの文字符号化形式(encoding形式)の一種</li>
<li>ASCIIと同じ文字は1バイト，その他の文字については2～4バイトを用いて文字を表現する</li>
<li>ASCIIとの対応関係があるので 「ASCIIと上位互換性がある」 と言われる</li>
</ul>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (Unicode と UTF-8 の対応)</strong></span> &nbsp;</p>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 19%">
<col style="width: 44%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>文字</th>
<th>Unicode</th>
<th>UTF-8</th>
<th>UTF-8の2進数表現</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td><code>U+0041</code></td>
<td><code>0x41</code></td>
<td><code>0100</code> <code>0001</code></td>
</tr>
<tr class="even">
<td>α</td>
<td><code>U+03B1</code></td>
<td><code>0xCE</code> <code>0xB1</code></td>
<td><code>1100</code> <code>1110</code> <code>1011</code> <code>0001</code></td>
</tr>
</tbody>
</table>
<p>AのUTF-8の2進数表現は 8 bit = 1 Byteであるので，「ASCIIと同じ文字は1バイト」であることがわかります．また， α は16 bitとなっていますが，ギリシャ文字は ASCII の範囲外なので 2 Bytes となります．</p>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1609/29/news016.html">【nkf】コマンド――文字コードと改行コードを変換する</a></li>
</ul>


</section>

 ]]></description>
  <category>文字コード</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-12-03-BOM/</guid>
  <pubDate>Wed, 03 Dec 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>乱数生成シェルスクリプト</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-28-generate-random-passwd/</link>
  <description><![CDATA[ 






<section id="シェルスクリプト概要" class="level2">
<h2 class="anchored" data-anchor-id="シェルスクリプト概要">シェルスクリプト概要</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>DOCSTRINGS
</div>
</div>
<div class="callout-body-container callout-body">
<div class="reveal_vspace" style="--vspace-height: 1em;"></div>
<ul>
<li><code>/dev/urandom</code>を活用して任意の長さの疑似ランダム文字列を生成</li>
<li>デフォルトは Base64 形式</li>
<li><code>-n</code> オプションを利用するとInteger型で疑似ランダム列を生成</li>
<li>出現文字列の一様性を保証するものではないので，あくまでsandbox環境での簡易的なpasswordの生成などに用途を限定</li>
</ul>
</div>
</div>
<p><span class="mini-section">シェルスクリプト全体</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Author: Ryo Nakagami</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revised: 2025-11-28</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Script: generate-random-passwd</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Description:</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Generates a random string of specified length in either base64 or</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   numeric-only format. Useful for passwords, tokens, or test data.</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   Steps:</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     1. Parse command-line options (-n for numeric, -h for help).</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     2. Validate input length (must be integer, less than 77).</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     3. Generate random string using /dev/urandom:</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#        - base64 output by default</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#        - numeric-only if -n is specified</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Options:</span></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -n    Generate numeric-only random string</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    -h    Show this help message</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Usage:</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd &lt;length&gt;      # Generates base64 string</span></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd -n &lt;length&gt;   # Generates numeric string</span></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ./generate-random-passwd &lt;length&gt; -n   # Generates numeric string</span></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notes:</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires /dev/urandom device.</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Requires base64 and tr utilities.</span></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   - Sources lib/docstring.sh for usage_helper.</span></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------</span></span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Load library functions ----</span></span>
<span id="cb1-33"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${BASH_SOURCE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/../lib/docstring.sh"</span></span>
<span id="cb1-34"></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Default values ----</span></span>
<span id="cb1-36"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATTERN</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span></span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-z</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># call library function usage_helper</span></span>
<span id="cb1-40">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-41">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-42"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-43"></span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Parse command-line options ----</span></span>
<span id="cb1-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_opts()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb1-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getopts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hn"</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">opt</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">do</span></span>
<span id="cb1-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">case</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$opt</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span></span>
<span id="cb1-49">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">h</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-50">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATTERN</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-51">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;;</span></span>
<span id="cb1-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">esac</span></span>
<span id="cb1-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">done</span></span>
<span id="cb1-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span>
<span id="cb1-55"></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- 1st pass: parse leading options ----</span></span>
<span id="cb1-57"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parse_opts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-58"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- NUMBER_INPUT might be here ----</span></span>
<span id="cb1-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">+</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-62">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NUMBER_INPUT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-63">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> 1</span>
<span id="cb1-64"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-65"></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Reset OPTIND and parse remaining options (after NUMBER_INPUT) ----</span></span>
<span id="cb1-67"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPTIND</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>1</span>
<span id="cb1-68"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">parse_opts</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-69"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">shift</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$((OPTIND</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb1-70"></span>
<span id="cb1-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Validate input ----</span></span>
<span id="cb1-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if NUMBER_INPUT is a positive integer</span></span>
<span id="cb1-73"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">! </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=~</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-74">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Input must be a positive integer greater than 0."</span></span>
<span id="cb1-75">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-76">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-77"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-78"></span>
<span id="cb1-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">((</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NUMBER_INPUT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">));</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-80">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Input must be less than 77."</span></span>
<span id="cb1-81">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-82">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-83"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-84"></span>
<span id="cb1-85"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-86">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error: Invalid pattern specified."</span></span>
<span id="cb1-87">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usage_helper</span></span>
<span id="cb1-88">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 1</span>
<span id="cb1-89"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-90"></span>
<span id="cb1-91"></span>
<span id="cb1-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate random string based on pattern ----</span></span>
<span id="cb1-93"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BASE64"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-94">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate random string ----</span></span>
<span id="cb1-95">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">base64</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-96">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span></span>
<span id="cb1-97">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0</span>
<span id="cb1-98"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATTERN</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NUMERIC"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Generate numeric-only random string ----</span></span>
<span id="cb1-100">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-dc</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0-9'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$NUMBER_INPUT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-101">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span></span>
<span id="cb1-102">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exit</span> 0</span>
<span id="cb1-103"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span></code></pre></div></div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (実行例)</strong></span> &nbsp;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd 10</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">zCJPhQxfr6</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd 10 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span></span>
<span id="cb2-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5711270805</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> generate-random-passwd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-n</span> 10</span>
<span id="cb2-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">9843753838</span></span></code></pre></div></div>
</div>
<hr>
</section>
<section id="devurandom-仮想デバイス" class="level2">
<h2 class="anchored" data-anchor-id="devurandom-仮想デバイス"><code>/dev/urandom</code> 仮想デバイス</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title"><code>/dev/urandom</code></span></p>
<ul>
<li><code>/dev/urandom</code>はハードウェア（キーボード・マウス・CPUなどの）動作から得られる環境ノイズを蓄積したデータ領域のこと（＝エントロピープール）</li>
<li>蓄積されたデータはバイナリーデータであるが，<code>base64</code> を利用することで乱数ジェネレーターとして利用できる</li>
<li>出力プールの最大周期(period)は <img src="https://latex.codecogs.com/png.latex?2%5E%7B26%5Ctimes%2032%7D%20-%201"></li>
<li>エントロピープールを再利用する仕組みを持つため，<span class="regmonkey-bold">エントロピー枯渇（entropy pool depletion）を心配する必要はない</span>（＝いつでも利用できる）</li>
<li>疑似乱数の再現性(reproducible seeding)はない</li>
</ul>
</div>
<p>エントロピープールを活用した疑似乱数ジェネレーターは <code>/dev/urandom</code> 以外に <code>dev/random</code> がありますが，動作の違いがあります． <code>dev/random</code> は乱数生成に使ったエントロピープール（= 内部状態）をそのまま再利用しないようにロックをかけるという設計になっています．</p>
<ul>
<li>乱数を出力 → プールが「公開された」とみなす</li>
<li>安全のためそのプールはすぐ使わない</li>
<li>新しい環境ノイズ（エントロピー）が十分に貯まるまで待つ</li>
</ul>
<p>そのため，連続した乱数生成を実施できない場合があります．</p>
<ul>
<li>連続した大量生成</li>
<li>実行環境が低エントロピー環境（仮想マシンなどのノイズが少ない環境）</li>
</ul>
<p>では，ロックがかかりやすいので <code>/dev/urandom</code> ベースの乱数ジェネレーターのほうが一般用途では良いとされます．</p>
<section id="base64-エンコード" class="level3">
<h3 class="anchored" data-anchor-id="base64-エンコード">Base64 エンコード</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title"><code>base64</code></span></p>
<ul>
<li>バイナリーデータをテキストに変換するための<span class="regmonkey-bold">エンコード方式</span></li>
<li>データを64種類の印字可能な英数字(<code>[A-Za-z0-9+/]</code>)に変換</li>
<li>MIMEの基準では76文字ごとに改行コードが入る</li>
</ul>
</div>
<p><code>base64 /dev/urandom</code> を実行シたときの流れは</p>
<ol type="1">
<li><code>/dev/urandom</code> (バイナリ)</li>
<li><code>base64</code> でエンコード</li>
<li>ランダムな Base64 文字列が出力される</li>
</ol>
<p>になります．</p>
</section>
</section>
<section id="head-コマンド" class="level2">
<h2 class="anchored" data-anchor-id="head-コマンド"><code>head</code> コマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> <span class="def-title"><code>head</code> コマンド</span></p>
<ul>
<li>headはテキストファイルの最初の10行を表示するコマンド</li>
</ul>
</div>
<p><span class="mini-section">オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>短いオプション</th>
<th>長いオプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-c 数字</code></td>
<td><code>--bytes 数字</code></td>
<td>先頭から指定したバイト数のみ表示する．「<code>-c 5 b</code>」のように単位を付加することも可能（b=512, KB=1000, K=1024, MB=1000×1000, M=1024×1024…）</td>
</tr>
<tr class="even">
<td><code>-n 数字</code></td>
<td><code>--lines 数字</code></td>
<td>先頭から指定した行数のみ表示する</td>
</tr>
<tr class="odd">
<td><code>-q</code></td>
<td><code>--quiet</code>, <code>--silent</code></td>
<td>ファイルごとのヘッダ表示を行わない（複数ファイル指定時に使う）</td>
</tr>
<tr class="even">
<td><code>-v</code></td>
<td><code>--verbose</code></td>
<td>常にファイルごとのヘッダ出力を行う</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="tr-コマンド" class="level2">
<h2 class="anchored" data-anchor-id="tr-コマンド"><code>tr</code> コマンド</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> <span class="def-title"><code>tr</code> コマンド</span></p>
<ul>
<li>標準入力の文字を別の文字に置換したり，削除したりするコマンド</li>
</ul>
</div>
<p><span class="mini-section">オプション</span></p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>短いオプション</th>
<th>長いオプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-d</code></td>
<td><code>--delete</code></td>
<td>指定した文字を削除する</td>
</tr>
<tr class="even">
<td><code>-c</code></td>
<td><code>--complement</code></td>
<td>指定した文字セットの補集合を扱う（反転）</td>
</tr>
<tr class="odd">
<td><code>-s</code></td>
<td><code>--squeeze-repeats</code></td>
<td>連続する同一文字を1つに圧縮する</td>
</tr>
</tbody>
</table>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (文字の置換)</strong></span> <code>tr 012 abc</code> を実行すると，</p>
<ul>
<li>「<code>0</code>」を「<code>a</code>」</li>
<li>「<code>1</code>」を「<code>b</code>」</li>
<li>「<code>2</code>」を「<code>c</code>」</li>
</ul>
<p>に置き換えます．「<code>012</code>」という連続した文字列を「<code>abc</code>」に置き換えるのではなく，常に1文字対1文字での置き換えとなるので，両者の長さはそろえる必要があります</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'012345'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> 012 abc</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">abc345</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0142345'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> 012 abc</span>
<span id="cb3-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ab4c345</span></span></code></pre></div></div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (<code>/dev/urandom</code> から数値のみを抽出)</strong></span> <br></p>
<p>数値のみのパスワードやトークン生成する場合は，<code>-d '0-9'</code> の補集合を取れば良いので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-dc</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0-9'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> /dev/urandom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> 16</span></code></pre></div></div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (連続した改行を1つにする)</strong></span> <br></p>
<p><code>tr -s</code> は繰り返し文字の圧縮に使えるので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A\n\n\nA'</span> </span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A\n\n\nA'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'\n'</span></span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span>
<span id="cb5-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">A</span></span></code></pre></div></div>
<p><code>tr -s '\n'</code> は不要改行を削除するときに使いますが，同様に <code>tr -s '[:space:]</code> を用いて不要スペースをまとめたりします</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">%</span> echo <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a   b   c"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[:space:]'</span></span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">a</span> b c</span></code></pre></div></div>
</div>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://utakamo.com/article/linux/architecture/directory/dev/random-urandom.html">うたカモ技術ブログ &gt; Linux 乱数ジェネレーター（/dev/random、/dev/urandom、getrandom）</a></li>
<li><a href="https://stackoverflow.com/questions/32139660/is-dev-urandom-suitable-for-simulation-purpose">Is <code>/dev/urandom</code> suitable for simulation purpose?</a></li>
</ul>


</section>

 ]]></description>
  <category>shell</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-28-generate-random-passwd/</guid>
  <pubDate>Fri, 28 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>paperless-ngxによるセルフホスティングドキュメント管理システム</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-27-paperless-ngx/</link>
  <description><![CDATA[ 






<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>想定環境
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>実行環境は基本的に Ubuntu 24.04 LTSを想定</li>
<li>Docker engineは利用可能</li>
<li>port 8888 でホスト</li>
<li>Tailscaleは導入済み</li>
<li>tailnet serveはhttpsを用いてserve</li>
</ul>
</div>
</div>
<section id="paperless-ngxとは" class="level2">
<h2 class="anchored" data-anchor-id="paperless-ngxとは">Paperless-ngxとは？</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>TL;DRs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Paperless-ngxは，PDF 論文やレポートを自前サーバで全文検索付きライブラリ化するためのツール</li>
<li>「引用管理」「文献リスト生成」などの機能も欲しいなら，文献管理専用ソフトを使うのが無難</li>
</ul>
</div>
</div>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Paperless-ngx</span></p>
<ul>
<li>pdf, txtなどのドキュメントを検索可能なオンラインアーカイブとして管理できるオープンソースのセルフホスティング文書管理システム</li>
<li>サーバーサイドでPaperless-ngxを構築し，クライアント端末からアクセスしたり，コンテンツをダウンロードすることが可能</li>
<li>バックエンドはDjango</li>
</ul>
</div>
<p><span class="mini-section">Features</span></p>
<ul>
<li>タグ・差出人(Correspondence)・文書タイプ・カスタムフィールドでドキュメントを整理可能</li>
<li>アップロードしたドキュメントに対してOCRを用いた全文検索が可能</li>
<li>機械学習でタグ・差出人・文書タイプを 自動分類</li>
<li>PDF，画像，テキスト，Word/Excel/PowerPoint，LibreOffice など多くの形式に対応</li>
<li>Web UI を通じて，複数ユーザーでのアクセス管理，共有リンク発行が可能</li>
<li>文書ごとに権限管理設定可能</li>
<li>ワークフロー機能による自動処理</li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>文書管理システムであって文献管理ソフトではない
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Zoteroと違い学術論文データベースではないです</li>
<li>文献の著者情報，出版年，ジャーナル名，引用数，参照関係，BibTex形式でのメタ情報出力は標準では備わっていない</li>
<li>Paperless-ngxはファイルを独自フォルダ構成で管理するため，「元のファイルツリー構造をそのまま索引化だけしたい」という用途には向かない</li>
</ul>
</div>
</div>
</section>
<section id="paperless-ngxの設定" class="level2">
<h2 class="anchored" data-anchor-id="paperless-ngxの設定">Paperless-ngxの設定</h2>
<p>Paperless-ngxは Dockerベースで構築することが可能です．構築にあたって</p>
<ol type="1">
<li>シェルスクリプトを用いて，対話式でセットアップする</li>
<li>自分で <code>docker-compose.yml</code> を定義し，公式Paperless-ngx Docker imageを運用する</li>
</ol>
<section id="パターン１-シェルスクリプトを用いて対話式でセットアップする" class="level3">
<h3 class="anchored" data-anchor-id="パターン１-シェルスクリプトを用いて対話式でセットアップする">パターン１: シェルスクリプトを用いて，対話式でセットアップする</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bash</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--location</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--silent</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--show-error</span> https://raw.githubusercontent.com/paperless-ngx/paperless-ngx/main/install-paperless-ngx.sh<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
<p>を実行することで対話式でセットアップできます．また，Paperless-ngxの中で用いるrootアカウントの設定まで行ってくれます．</p>
</section>
<section id="パターン２自分で-docker-compose.yml-を定義" class="level3">
<h3 class="anchored" data-anchor-id="パターン２自分で-docker-compose.yml-を定義">パターン２：自分で <code>docker-compose.yml</code> を定義</h3>
<p>作業手順として</p>
<ol type="1">
<li>利用可能UID, GIDの確認</li>
<li>GIDの作成</li>
<li>UIDの作成</li>
<li>Docker設定用のdirectoryを作成(= volumn, 設定ファイルの管理用ディレクトリ)</li>
<li><code>docker-compose.env</code> の作成</li>
<li><code>docker-compose.yml</code> の作成</li>
<li>コンテナを起動</li>
</ol>
<p>です．</p>
<p><span class="mini-section">Step 1: paperless-ngx用UIDの作成</span></p>
<p>Ubuntuサーバー側でPaperless-ngxをホスティングするので，まずPaperless-ngx用non-humanアカウントを作成します． UIDとGIDは同じIDで基本的には作成されますが，連番の関係が崩れると違ったIDが割り当てられてしまう可能性があるので，利用可能なIDを確認します．</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド</th>
<th>挙動</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>getent passwd</code></td>
<td>UID一覧の確認コマンド</td>
</tr>
<tr class="even">
<td><code>getent group</code></td>
<td>GID一覧の確認コマンド</td>
</tr>
</tbody>
</table>
</div>
<p>上記のコマンドを叩いて目星をつけたならば(例として<code>120</code>が空いていたとする)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getent</span> passwd 120</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getent</span> group 120</span></code></pre></div></div>
<p>両方のコマンドを叩いて何も返ってこないことを確認します．</p>
<p><span class="mini-section">Step 2: GIDの作成</span></p>
<p>GIDの作成は <code>groupadd</code> コマンドを以下のように用います</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> groupadd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gid</span> 120 paperless-ngx</span></code></pre></div></div>
<p>GID作成後，意図した通りにGIDが作成されているか確認します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent group 120</span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:</span></span></code></pre></div></div>
<p>もし間違ったGIDで作成してしまった場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> groupdel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>group-name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div></div>
<p><span class="mini-section">Step 3: UIDの作成</span></p>
<p><code>paperless-ngx</code> ユーザーを作成します． 不特定多数が利用するサーバーでホスティングするので特定のhumanユーザーではなく， サービス専用のシステム用アカウント(ログイン不可のユーザー)として運用したいのが理由となります．</p>
<p>ユーザー作成コマンドは以下です</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> useradd <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--system</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-create-home</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--uid</span> 120 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gid</span> 120 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-6">  paperless-ngx</span></code></pre></div></div>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>オプション</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>useradd</code></td>
<td>新しいユーザーを作成するコマンド</td>
</tr>
<tr class="even">
<td><code>--system</code></td>
<td>システム専用ユーザーとして作成（ログイン不可，通常 UID 100 未満を使う場合もある）</td>
</tr>
<tr class="odd">
<td><code>--no-create-home</code></td>
<td>ホームディレクトリを作らない</td>
</tr>
<tr class="even">
<td><code>--uid 120</code></td>
<td>作成するユーザーの <strong>UID</strong> を 120 に指定</td>
</tr>
<tr class="odd">
<td><code>--gid 120</code></td>
<td>作成するユーザーの <strong>プライマリグループ</strong> を GID 120 に指定</td>
</tr>
</tbody>
</table>
</div>
<p>上記のコマンド実行後，home directoryを持たない <code>paperless-ngx</code> が作成されますが</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent passwd 120</span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:120::/home/paperless-ngx:/bin/sh</span></span></code></pre></div></div>
<p>となってると思います．ログインシェルと存在しないhome directoryが指定されているのは気持ち悪いので</p>
<ul>
<li><code>/nonexisent</code> ディレクトリをhome directoryとする</li>
<li><code>/usr/sbin/nologin</code> でログイン不可</li>
</ul>
<p>という設定更新をします．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> usermod <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> /nonexistent paperless-ngx</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> usermod <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /usr/sbin/nologin paperless-ngx</span></code></pre></div></div>
<p>上記のコマンド実行後は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> getent passwd 120</span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">paperless-ngx:x:120:120::/nonexistent:/usr/sbin/nologin</span></span></code></pre></div></div>
<p>となっているはずです．</p>
<p><span class="mini-section">Step 4: Docker設定用のdirectoryを作成</span></p>
<p>paperless-ngxサービス用のディレクトリを <code>/srv</code> 以下に以下のように作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> mkdir <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /srv/paperless-ngx</span></code></pre></div></div>
<p>作成後，所有権を以下のように変更しときます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> chown <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> paperless-ngx:paperless-ngx /srv/paperless-ngx</span></code></pre></div></div>
<p>また，サーバーサイドでの設定なのでパーミッションも以下のように変更しときます</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> chmod 770 /srv/paperless-ngx</span></code></pre></div></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><code>/srv/paperless-ngx</code> に構築する理由
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngx が管理するファイル・設定・ボリューム用ディレクトリを一目でわかる場所で管理するのが望ましいですが，どこで管理するのかが問題となります． Ubuntuでは用途ごとに次のようなディレクトリが一般的に用いられます：</p>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 33%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>ディレクトリ</th>
<th>用途</th>
<th>コメント</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>/srv</code></td>
<td>サービス専用データ</td>
<td>標準的でわかりやすい</td>
</tr>
<tr class="even">
<td><code>/opt</code></td>
<td>サードパーティソフトのインストール先</td>
<td>バイナリやパッケージ向けでデータ管理向きではない</td>
</tr>
<tr class="odd">
<td><code>/var/lib</code></td>
<td>可変データ（ログ，DB，キャッシュ）</td>
<td>物理的に動的なデータ向け，サービスデータ全般にも可</td>
</tr>
</tbody>
</table>
</div>
<p>Paperless-ngx のデータをどこに置くかは最終的に任意ですが，サービス専用ユーザーに所有権を割り当てやすく，管理もしやすいという点から， <code>/srv</code> 配下にディレクトリを作成する方針にしました．</p>
</div>
</div>
<p>その後，Paperless-ngx用のexportとupload用ボリュームとして <code>export</code>, <code>consume</code> ディレクトリが必要となるのでそれぞれを作成します．</p>
<p><span class="mini-section">Step 5: <code>docker-compose.env</code> の作成</span></p>
<p>Dockerコンテナ用の環境変数を定義する <code>docker-compose.env</code> を <code>/srv/paperless-ngx</code> 以下に作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_UID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb13-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_GID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb13-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_TIME_ZONE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Asia/Tokyo</span></span>
<span id="cb13-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_LANGUAGE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">eng</span></span>
<span id="cb13-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_SECRET_KEY</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;適当な文字列&gt;'</span></span>
<span id="cb13-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_OUTPUT_TYPE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">pdf</span></span></code></pre></div></div>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 24%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>変数名</th>
<th>説明</th>
<th>備考（今回の重要ポイントを踏まえた補足）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>USERMAP_UID=120</code></td>
<td>Paperless コンテナ内部で使用するユーザーID（UID）をホスト側 UID に合わせるための設定</td>
<td>ホスト側のユーザー権限と揃えることで，生成ファイルの所有権が一致し，権限問題が発生しにくくなる</td>
</tr>
<tr class="even">
<td><code>USERMAP_GID=120</code></td>
<td>Paperless コンテナ内部で使用するグループID（GID）をホスト側 GID に合わせる設定</td>
<td>UID と同様，ホスト側のグループ権限と一致させることで，ファイルアクセスの整合性が取れる．</td>
</tr>
<tr class="odd">
<td><code>PAPERLESS_TIME_ZONE=Asia/Tokyo</code></td>
<td>Paperless 内部で使用するタイムゾーンを指定．</td>
<td>ログ，OCR のタイムスタンプ，タスクの実行時間管理に使用されるため，日本で利用するなら <code>Asia/Tokyo</code> が最適</td>
</tr>
<tr class="even">
<td><code>PAPERLESS_OCR_LANGUAGE=eng</code></td>
<td>OCR に使用する言語を指定する．複数指定も可能（例: <code>eng+jpn</code>）．</td>
<td>日本語を扱う場合は <code>jpn</code> の追加を推奨．英語のみなら <code>eng</code> のままでOK．</td>
</tr>
<tr class="odd">
<td><code>PAPERLESS_SECRET_KEY='&lt;適当な文字列&gt;'</code></td>
<td><strong>セッションを保護する秘密鍵（ユーザー認証に不可欠）．ランダムで長い文字列に必ず変更する必要がある．</strong></td>
<td>Paperless がインターネットに公開される場合，<strong>デフォルトの SECRET_KEY は広く知られているため危険</strong>．キーボードを適当に叩いた文字列でOK．覚える必要はない．長いほど安全．例: <code>a9$FJ!p92jaf(3)sa0fjasdf02398</code></td>
</tr>
<tr class="even">
<td><code>PAPERLESS_OCR_OUTPUT_TYPE=&lt;type&gt;</code></td>
<td>OCR 後に生成する PDF の種類を指定</td>
<td>- <code>pdf</code> : 元の PDF を極力変更せずに OCR を追加<br>- <code>pdfa</code> : PDF/A-2b に変換（長期保存向け）<br>- <code>pdfa-1</code>, <code>pdfa-2</code>, <code>pdfa-3</code> : PDF/A のバージョン指定<br>※ 指定しない場合は <code>pdfa</code> がデフォルト</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>PAPERLESS_OCR_LANGUAGE設定の注意点
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngxはOCR機能としてTesseractを利用しますが，デフォルトでインストールされていない言語を指定すると，</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb14-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">The selected ocr language jpn is not installed. Paperless cannot OCR your documents without it. Please fix PAPERLESS_OCR_LANGUAGE.</span></span></code></pre></div></div>
<p>というエラーを吐きます．日本語対応を含めるため <code>eng+jpn</code> を設定する場合は <code>Dockerfile</code> を設定して</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> tesseract-ocr-jpn <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div></div>
<p>というラインを加えた上でビルドの必要があります．</p>
</div>
</div>
<p><span class="mini-section">Step 6: <code>docker-compose.yml</code> の作成</span></p>
<p><code>/srv/paperless-ngx</code> にて <code>docker-compose.yml</code> を以下のように作成します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">services</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">broker</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker.io/library/redis:8</span></span>
<span id="cb16-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-redisdata:/data</span></span>
<span id="cb16-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb16-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">db</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker.io/library/postgres:18</span></span>
<span id="cb16-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-pgdata:/var/lib/postgresql</span></span>
<span id="cb16-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">environment</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_DB</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_USER</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POSTGRES_PASSWORD</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless</span></span>
<span id="cb16-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb16-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">webserver</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ghcr.io/paperless-ngx/paperless-ngx:latest</span></span>
<span id="cb16-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">restart</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> unless-stopped</span></span>
<span id="cb16-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">depends_on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> db</span></span>
<span id="cb16-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> broker</span></span>
<span id="cb16-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ports</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8888:8000"</span></span>
<span id="cb16-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-data:/usr/src/paperless/data</span></span>
<span id="cb16-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> paperless-media:/usr/src/paperless/media</span></span>
<span id="cb16-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ./export:/usr/src/paperless/export</span></span>
<span id="cb16-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ./consume:/usr/src/paperless/consume</span></span>
<span id="cb16-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env_file</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker-compose.env</span></span>
<span id="cb16-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">environment</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PAPERLESS_REDIS</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> redis://broker:6379</span></span>
<span id="cb16-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PAPERLESS_DBHOST</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> db</span></span>
<span id="cb16-35"></span>
<span id="cb16-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-data</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-media</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-pgdata</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb16-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paperless-redisdata</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span></code></pre></div></div>
<p><span class="mini-section">Step 7: コンテナを起動</span></p>
<p>コンテナは以下の手順で起動します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose up <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose ps</span></code></pre></div></div>
<p>エラーが発生した場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker compose logs <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> webserver</span></code></pre></div></div>
<p>でログを確認できます．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>uploadしたドキュメントのバックアップを取る
</div>
</div>
<div class="callout-body-container callout-body">
<p>Paperless-ngx コンテナ内の <code>export</code> ディレクトリにあるドキュメントをバックアップする場合</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> exec <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> ps <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aqf</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name=paperless-ngx-webserver-1"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> document_exporter ../export</span></code></pre></div></div>
<ul>
<li><code>../export</code> はコンテナ内の相対パス</li>
<li>ホスト側ボリューム <code>/srv/paperless-ngx/export</code> にマウントしていれば，ホスト側からも直接アクセス可能</li>
</ul>
</div>
</div>
</section>
</section>
<section id="tailnet-serve設定" class="level2">
<h2 class="anchored" data-anchor-id="tailnet-serve設定">Tailnet serve設定</h2>
<p>設定手順は</p>
<ol type="1">
<li><code>docker-compose.env</code> の設定とコンテナの再起動</li>
<li>tailnet serve設定</li>
</ol>
<p>となります</p>
<p><span class="mini-section">Step 1: <code>docker-compose.env</code> の設定</span></p>
<p>Tailscale 経由で Paperless-ngx にアクセスする場合，Djangoにホスト名とプロトコル（HTTPS）を正しく伝えることが重要です． 設定項目としては</p>
<ul>
<li><code>PAPERLESS_URL</code>: Django の CSRF / CORS / ALLOWED_HOSTS を自動設定するための環境変数．末尾スラッシュなし</li>
</ul>
<p>今回は Port 8888 経由で公開するので</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb20-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_URL</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">https://hogehoge.tail8ada9.ts.net:8888</span></span></code></pre></div></div>
<p>と設定します．<code>https://hogehoge.tail8ada9.ts.net:8888</code> はtailscale serve statusで確認できるものにします．</p>
<p>上記を踏まえると以下のような <code>docker-compose.env</code> となります</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_UID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb21-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">USERMAP_GID</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span></span>
<span id="cb21-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_TIME_ZONE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Asia/Tokyo</span></span>
<span id="cb21-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_OCR_LANGUAGE</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">eng+jpn</span></span>
<span id="cb21-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_SECRET_KEY</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hogehogehgoehgoeghoeh'</span></span>
<span id="cb21-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PAPERLESS_URL</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">https://hogehoge.tail8ada9.ts.net:8888</span></span></code></pre></div></div>
<p><span class="mini-section">Step 2: <code>tailnet serve設定</code> の設定</span></p>
<p>Tailscale の HTTP/HTTPS リバースプロキシ機能をつかってローカルサービスをTailnet上で公開します．</p>
<p>サーバー側で以下のコマンドを実行します</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tailscale serve <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--bg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--https</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>8888 8888</span></code></pre></div></div>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 33%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th>コマンド部分</th>
<th>説明</th>
<th>ポイント / 注意点</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>tailscale serve</code></td>
<td>ローカルの HTTP/HTTPS サービスを Tailscale ネットワーク上で公開するリバースプロキシ機能</td>
<td>Tailscale 1.36 以降で利用可能</td>
</tr>
<tr class="even">
<td><code>--bg</code></td>
<td>バックグラウンドで実行</td>
<td>ターミナルを閉じてもプロセスは継続。デーモン的に動作</td>
</tr>
<tr class="odd">
<td><code>--https=8888</code></td>
<td>Tailscale 側で HTTPS を提供するポート番号</td>
<td>自動生成証明書で TLS 保護された HTTPS アクセスが可能</td>
</tr>
<tr class="even">
<td><code>8888</code> (最後の引数)</td>
<td>ローカルサービスのポート番号</td>
<td>ローカルの <code>localhost:8888</code> にあるサービスを Tailscale HTTPS ポートに接続</td>
</tr>
</tbody>
</table>
<p>上記コマンドの実行後， Tailscale 内から <code>https://&lt;tailscale-node&gt;:8888</code> でローカルサービスとしてのpaperless-ngxへアクセス可能となります．</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>サービスを非公開にしたい場合
</div>
</div>
<div class="callout-body-container callout-body">
<p>Tailscale 内から Paperless-ngx にHTTPSでアクセス負荷にしたい場合は</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tailscale serve <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--bg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--https</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>8888 off</span></code></pre></div></div>
<p>ポートは8888想定ですが，<code>sudo tailscale serve --bg --https=&lt;port&gt; 8888</code> の <code>&lt;port&gt;</code> に応じて変更して下さい．</p>
</div>
</div>
</section>
<section id="appendix-1-グループからユーザーを削除する方法" class="level2">
<h2 class="anchored" data-anchor-id="appendix-1-グループからユーザーを削除する方法">Appendix 1: グループからユーザーを削除する方法</h2>
<p>特定のユーザーをグループから削除するには <code>gpasswd</code> or <code>deluser</code> コマンドを使用します</p>
<p><span class="mini-section"><code>gpasswd</code>コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## long option</span></span>
<span id="cb24-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--delete</span> user1 papaerless-ngx</span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## short option</span></span>
<span id="cb24-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> user1 papaerless-ngx</span>
<span id="cb24-6"></span>
<span id="cb24-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 現在のユーザーをpaperless-ngxから除去</span></span>
<span id="cb24-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> gpasswd <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">whoami</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> paperless-ngx</span></code></pre></div></div>
<p><span class="mini-section"><code>deluser</code>コマンド</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## syntax</span></span>
<span id="cb25-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> deluser user1 paperless-ngx</span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 現在のユーザーをpaperless-ngxから除去</span></span>
<span id="cb25-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> deluser <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">whoami</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> paperless-ngx</span></code></pre></div></div>
</section>
<section id="appendix-2-zoteroとの併用方法" class="level2">
<h2 class="anchored" data-anchor-id="appendix-2-zoteroとの併用方法">Appendix 2: Zoteroとの併用方法</h2>
<p>基本コンセプトは，<span class="regmonkey-bold">Paperless-ngxを原本置き場，Zotero はメタデータ管理だけ</span></p>
<ul>
<li>PDF ファイルを Zotero に保存しない</li>
<li>PDF の原本はすべて Paperless に一元管理</li>
<li>Zotero は「文献管理ソフト」として最小限データだけ持つ</li>
<li>Zotero 内では Linked Attachment（リンクされた添付ファイル）を使い，Paperless の PDF を参照する</li>
</ul>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 27%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>役割</th>
<th>担当</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Paperless-ngx</strong></td>
<td>原本保管庫（PDF の全保管・OCR・タグ）</td>
<td>すべての PDF ファイルの実体を保管する（NAS代わり）</td>
</tr>
<tr class="even">
<td><strong>Zotero</strong></td>
<td>文献リスト＋引用情報</td>
<td>メタデータだけを管理し，PDF本体は保存しない</td>
</tr>
</tbody>
</table>
</div>
<p><span class="mini-section">運用イメージ</span></p>
<ol type="1">
<li>PDF を Paperless-ngx に入れる</li>
<li>Paperless-ngx が OCR＋タグ整理</li>
<li>必要に応じて Zotero に 文献情報（DOI など）を登録</li>
<li>添付ファイルとして Paperless-ngx の PDF パスを貼る（手動 or 自動スクリプト）</li>
</ol>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.paperless-ngx.com/">Paperless-ngx公式ドキュメント</a></li>
<li><a href="https://packages.debian.org/bullseye/graphics/tesseract-ocr-jpn-vert">Package: tesseract-ocr-jpn-vert</a></li>
</ul>


</section>

 ]]></description>
  <category>環境構築</category>
  <category>paperless-ngx</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-27-paperless-ngx/</guid>
  <pubDate>Thu, 27 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Counterオブジェクト</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-16-counter-object/</link>
  <description><![CDATA[ 






<section id="counter-オブジェクト" class="level2">
<h2 class="anchored" data-anchor-id="counter-オブジェクト"><code>Counter</code> オブジェクト</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">Counter</span></p>
<ul>
<li><code>Counter</code> は，ハッシュ可能なオブジェクトの出現回数を数えるための辞書サブクラス</li>
<li>要素を辞書のキーとして保持し，その出現回数を値として保持するコレクション</li>
<li>カウント値には <code>0</code> や負の値を含む任意の整数が使用可能</li>
</ul>
</div>
<p>リストの要素の出現回数を集計する場合，<code>Dict</code> を用いる場合</p>
<div id="45db965f" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb1-1">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>]</span>
<span id="cb1-2">count_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> word <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> words:</span>
<span id="cb1-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dict.get(key, default) returns default if key does not exist</span></span>
<span id="cb1-6">    count_dict[word] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> count_dict.get(word, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(count_dict)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{'red': 2, 'blue': 3, 'green': 1}</code></pre>
</div>
</div>
<p><code>Counter</code>を用いることで以下のようにより簡単に集計することが出来ます</p>
<div id="df2924e4" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb3-2"></span>
<span id="cb3-3">word_counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(words)</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(word_counter)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'blue': 3, 'red': 2, 'green': 1})</code></pre>
</div>
</div>
<p>また，すべての要素の出現頻度の合計は <code>total()</code> メソッドを用いて表示できます</p>
<div id="28c4f8c1" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(word_counter.total())   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 6 = 3 + 2 + 1</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>6</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 1 (単語出現頻度の計測)</strong></span> <br></p>
<p>ハムレットの一節を内容とする <code>hamlet.txt</code> を例に，出現単語のTop 5の計測を行います．<code>Counter</code> クラスには <code>most_common()</code> メソッドがあり，要素を出現頻度に応じて降順で返してくれます．引数として整数を指定すると，最上位から数えてその個数分だけを出力してくれるので</p>
<div id="1fd0fc7b" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 単語を抽出（小文字化して正規表現でマッチ，句読点は除く）</span></span>
<span id="cb7-5">hamlet_words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\w</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hamlet.txt'</span>).read().lower())</span>
<span id="cb7-6">Counter(hamlet_words).most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>[('to', 4), ('the', 3), ('be', 2), ('or', 2), ('and', 2)]</code></pre>
</div>
</div>
<p>出現頻度下位Top 3を出力したい場合は</p>
<div id="2d708405" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb9-1">hamlet_counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(hamlet_words)</span>
<span id="cb9-2">hamlet_counter.most_common()[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[('them', 1), ('end', 1), ('opposing', 1)]</code></pre>
</div>
</div>
</div>
<hr>
<section id="counter-インスタンスの作成方法" class="level3">
<h3 class="anchored" data-anchor-id="counter-インスタンスの作成方法"><code>Counter</code> インスタンスの作成方法</h3>
<div id="44c7fb40" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 空の Counter を作る</span></span>
<span id="cb11-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()                           </span>
<span id="cb11-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter()</span></span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. イテラブルから作る</span></span>
<span id="cb11-8">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gallahad'</span>)                 </span>
<span id="cb11-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})</span></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 辞書（マッピング）から作る</span></span>
<span id="cb11-12">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>})      </span>
<span id="cb11-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'red': 1, 'blue': 2})</span></span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. キーワード引数から作る</span></span>
<span id="cb11-16">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(cats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, dogs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)     </span>
<span id="cb11-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Counter({'dogs': 8, 'cats': 4}) </span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter()
Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})
Counter({'blue': 2, 'red': 1})
Counter({'dogs': 8, 'cats': 4})</code></pre>
</div>
</div>
</section>
<section id="存在しないキーの取り扱い" class="level3">
<h3 class="anchored" data-anchor-id="存在しないキーの取り扱い">存在しないキーの取り扱い</h3>
<p><code>Counter</code> では存在しないキーにアクセスしても KeyError にはならず，<code>0</code> が返るのが特徴です</p>
<div id="b6b3518a" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カウンター作成</span></span>
<span id="cb13-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ham'</span>])</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在するキー</span></span>
<span id="cb13-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>])    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1</span></span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在しないキー</span></span>
<span id="cb13-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bacon'</span>])   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 ← KeyError にはならない</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1
0</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 2 (<code>dict</code> と KeyError)</strong></span> <br></p>
<div id="9aeadc38" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb15-1">foods <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eggs'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ham'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb15-4">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bacon:"</span>, foods[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bacon'</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 存在しないキーは KeyError</span></span>
<span id="cb15-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">KeyError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb15-6">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"KeyError: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>KeyError: 'bacon'</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="挿入順序の保持" class="level3">
<h3 class="anchored" data-anchor-id="挿入順序の保持">挿入順序の保持</h3>
<p>Python 3.7 以降，<code>Counter</code> は内部的には挿入順を保持しています．<code>print</code> などでkey-valueを出力するとvalueに応じた降順でソートされたように見えますが，<code>Counter.keys()</code> などでkeyの順番を確認すると，挿入順となっています</p>
<div id="a722f812" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb17-2"></span>
<span id="cb17-3">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gallahad'</span>)</span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check display order</span></span>
<span id="cb17-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力は頻度順</span></span>
<span id="cb17-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c))              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 内部の挿入順</span></span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c.keys())             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 内部の挿入順</span></span>
<span id="cb17-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c.elements()))   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># elements順</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 3, 'l': 2, 'g': 1, 'h': 1, 'd': 1})
['g', 'a', 'l', 'h', 'd']
dict_keys(['g', 'a', 'l', 'h', 'd'])
['g', 'a', 'a', 'a', 'l', 'l', 'h', 'd']</code></pre>
</div>
</div>
<p><span class="mini-section">演算処理の順番</span></p>
<p><code>Counter</code> オブジェクトは，<code>+</code> を使った加算処理ができます．このとき，基本的なキーの順番は左オペラントとなり，新しいキーは右オペランドから追加されるという内部処理になります．</p>
<p>つまり，要素順は，<span class="regmonkey-bold">左オペランドの出現順 → 右オペランドで新規に現れた順</span>で決まります．</p>
<div id="83ef367f" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb19-2"></span>
<span id="cb19-3">c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'zbcaad'</span>)</span>
<span id="cb19-4">c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abcd'</span>)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 算術演算</span></span>
<span id="cb19-7">c3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c2</span>
<span id="cb19-8"></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力</span></span>
<span id="cb19-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c3)</span>
<span id="cb19-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c3.keys())</span>
<span id="cb19-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(c3.elements()))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 3, 'b': 2, 'c': 2, 'd': 2, 'z': 1})
dict_keys(['z', 'b', 'c', 'a', 'd'])
['z', 'b', 'b', 'c', 'c', 'a', 'a', 'a', 'd', 'd']</code></pre>
</div>
</div>
</section>
</section>
<section id="counter-と算術演算" class="level2">
<h2 class="anchored" data-anchor-id="counter-と算術演算"><code>Counter</code> と算術演算</h2>
<p><span class="mini-section">TL;DRs</span></p>
<div id="f4d69910" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb21-2"></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2つのカウンターを作成</span></span>
<span id="cb21-4">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-5">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-6"></span>
<span id="cb21-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 算術演算と集合演算</span></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-10"></span>
<span id="cb21-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 足し算: 各キーの値を加算</span></span>
<span id="cb21-12"></span>
<span id="cb21-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c - d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 引き算: 正の値のみ保持, 0 は除外される</span></span>
<span id="cb21-14"></span>
<span id="cb21-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &amp; d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 積集合: min(c[x], d[x])</span></span>
<span id="cb21-16"></span>
<span id="cb21-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c | d ="</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> d)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 和集合: max(c[x], d[x])</span></span>
<span id="cb21-18"></span>
<span id="cb21-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 比較演算</span></span>
<span id="cb21-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------</span></span>
<span id="cb21-22"></span>
<span id="cb21-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c == d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 等価判定</span></span>
<span id="cb21-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &lt;= d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 部分集合判定 (すべての要素が &lt;=)</span></span>
<span id="cb21-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c &gt;= d ?"</span>, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> d)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 部分集合判定 (すべての要素が &gt;=)</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>c + d = Counter({'a': 4, 'b': 3, 'c': 2})
c - d = Counter({'a': 2})
c &amp; d = Counter({'a': 1, 'b': 1, 'c': 1})
c | d = Counter({'a': 3, 'b': 2, 'c': 1})
c == d ? False
c &lt;= d ? False
c &gt;= d ? False</code></pre>
</div>
</div>
<section id="subtract-メソッド" class="level3">
<h3 class="anchored" data-anchor-id="subtract-メソッド"><code>subtract</code> メソッド</h3>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> <span class="def-title">Counter.subtract</span></p>
<ul>
<li>ある <code>Counter</code> から別の <code>Counter</code> や <code>iterable</code> の要素を減算するメソッド</li>
<li>結果のカウント値は 負の値 になることもある</li>
<li>元の <code>Counter</code> が 変更される（新しいオブジェクトは返らない）</li>
</ul>
</div>
<p>基本的な使い方は</p>
<div id="43eea737" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb23-2"></span>
<span id="cb23-3">c1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aabbcc'</span>)</span>
<span id="cb23-4">c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abc'</span>)</span>
<span id="cb23-5"></span>
<span id="cb23-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># c1 から c2 を減算</span></span>
<span id="cb23-7">c1.subtract(c2)</span>
<span id="cb23-8"></span>
<span id="cb23-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c1)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 1, 'b': 1, 'c': 1})</code></pre>
</div>
</div>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 3 (iterableからの減算)</strong></span> <br></p>
<div id="3402bc4d" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb25-1">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'banana'</span>)</span>
<span id="cb25-2">c.subtract(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'an'</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'a','n' をそれぞれ 1 ずつ減らす</span></span>
<span id="cb25-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 2, 'b': 1, 'n': 1})</code></pre>
</div>
</div>
</div>
<hr>
<div id="exm-" class="custom_problem theorem example">
<p><span class="theorem-title"><strong>Example 4 (値は 0 未満になる場合)</strong></span> <br></p>
<div id="bbebe708" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb27-1">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'banana2'</span>)</span>
<span id="cb27-2">c.subtract(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'and2'</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'a','n' , 'd'をそれぞれ 1 ずつ減らす</span></span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力</span></span>
<span id="cb27-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 演算結果の出力</span></span>
<span id="cb27-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0以上の要素のみ出力（0は含まない）</span></span>
<span id="cb27-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>c)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0未満の要素のみ出力</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 2, 'b': 1, 'n': 1, '2': 0, 'd': -1})
Counter({'a': 2, 'b': 1, 'n': 1})
Counter({'d': 1})</code></pre>
</div>
</div>
</div>
<hr>
</section>
<section id="実行順番の注意" class="level3">
<h3 class="anchored" data-anchor-id="実行順番の注意">実行順番の注意</h3>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>Counter</code> の 算術演算は順序によって出力のキー順序が変わることがある</li>
<li><span class="regmonkey-bold">負の値の処理が関わる場合，結果の値自体も変わる</span></li>
</ul>
</div>
</div>
<div id="137699c7" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3つのカウンターを作成</span></span>
<span id="cb29-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb29-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-6">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-7"></span>
<span id="cb29-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z)</span>
<span id="cb29-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Counter({'a': 5, 'b': 5, 'c': 2, 'd': 1, 'e': 1})
Counter({'a': 5, 'b': 5, 'e': 1, 'c': 1, 'd': 1})</code></pre>
</div>
</div>
<p><span class="mini-section">ロバストな加算処理</span></p>
<p>値を置き換えるのではなく，順序ロバストにカウントを加算して計算したい場合は <code>update</code> メソッドを用いるほうが良いかもしれません</p>
<div id="cf79b90b" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb31-2"></span>
<span id="cb31-3">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb31-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-5">z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-6"></span>
<span id="cb31-7">c_total_xyz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb31-8">c_total_xzy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb31-9"></span>
<span id="cb31-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [x, y, z]:</span>
<span id="cb31-11">    c_total_xyz.update(c1)</span>
<span id="cb31-12"></span>
<span id="cb31-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [x, z, y]:</span>
<span id="cb31-14">    c_total_xzy.update(c2)</span>
<span id="cb31-15"></span>
<span id="cb31-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 計算結果</span></span>
<span id="cb31-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"c_total_xyz: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>c_total_xyz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"c_total_xzy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>c_total_xzy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-19"></span>
<span id="cb31-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 比較</span></span>
<span id="cb31-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(c_total_xyz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> c_total_xzy)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>c_total_xyz: Counter({'a': 5, 'b': 5, 'c': 1, 'd': 1, 'e': 1})
c_total_xzy: Counter({'a': 5, 'b': 5, 'c': 1, 'e': 1, 'd': 1})
True</code></pre>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://docs.python.org/3/library/collections.html#collections.Counter">Counter objects</a></li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-16-counter-object/</guid>
  <pubDate>Sun, 16 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>ETLメモ</title>
  <dc:creator>Ryo Nakagami</dc:creator>
  <link>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-15-ETL-note/</link>
  <description><![CDATA[ 






<section id="etlとは" class="level2">
<h2 class="anchored" data-anchor-id="etlとは">ETLとは？</h2>
<div id="def-" class="custom_problem blog-custom-border theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> <span class="def-title">ETL</span></p>
<ul>
<li>Extract（抽出）・Transform（変換）・Load（格納） の略</li>
<li>要件として
<ul>
<li>自動化されていること</li>
<li>再現性があること</li>
<li>データがどのように加工されか追跡しやすいこと</li>
</ul></li>
</ul>
</div>
<p><span class="mini-section">PythonでETL toolを作成する場面</span></p>
<ul>
<li>ETL要件がシンプルなとき</li>
<li>既存ツールでは満たせない特殊要件があるとき</li>
</ul>
</section>
<section id="etl作業フロー" class="level2">
<h2 class="anchored" data-anchor-id="etl作業フロー">ETL作業フロー</h2>
<p><span class="mini-section">作業フロー</span></p>
<ol type="1">
<li>構造化されていないケースが多いファイル群からデータを抽出する</li>
<li>データクレンジングを実施</li>
<li>あるべきデータフォーマットに従うように型を付与する</li>
<li>データをDBなどに格納する</li>
</ol>
</section>
<section id="代表的なetl-tool" class="level2">
<h2 class="anchored" data-anchor-id="代表的なetl-tool">代表的なETL tool</h2>
<div class="no-border-top-table">
<table class="caption-top table">
<colgroup>
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>項目</th>
<th>Apache Airflow</th>
<th>Luigi</th>
<th>pandas</th>
<th>petl</th>
<th>Bonobo</th>
<th>Bubbles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>種類</td>
<td>ワークフローオーケストレーション</td>
<td>パイプラインのタスクオーケストレーション</td>
<td>データ分析・変換ライブラリ</td>
<td>軽量ETLフレームワーク</td>
<td>軽量ETLフレームワーク</td>
<td>メタデータ駆動型ETLフレームワーク</td>
</tr>
<tr class="even">
<td>変換機能</td>
<td>Pythonオペレーター経由で間接的</td>
<td>あり（カスタムタスク）</td>
<td>豊富なDataFrame変換</td>
<td>基本的な行単位変換</td>
<td>あり（ノードによる変換）</td>
<td>限定的</td>
</tr>
<tr class="odd">
<td>リアルタイム対応</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
</tr>
<tr class="even">
<td>コネクタ</td>
<td>Python/コミュニティ製プラグイン</td>
<td>ファイルシステム、DB（拡張可能）</td>
<td>CSV, Excel, SQL, JSON など</td>
<td>CSV, Excel, JSON, SQL, XML</td>
<td>ファイル、API、DB</td>
<td>CSV, SQL, JSON, HTTP</td>
</tr>
<tr class="odd">
<td>スケジューリング</td>
<td>あり（リトライ・アラート対応）</td>
<td>あり（内部スケジューラ）</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
<td>なし</td>
</tr>
<tr class="even">
<td>並列処理</td>
<td>あり（Celery, Kubernetes など）</td>
<td>あり</td>
<td>Pandas の並列オプション程度</td>
<td>なし</td>
<td>あり（マルチスレッド）</td>
<td>限定的</td>
</tr>
<tr class="odd">
<td>適している用途</td>
<td>複雑なパイプラインのオーケストレーション</td>
<td>依存関係のあるタスク管理</td>
<td>データクリーニング・分析・整形</td>
<td>軽量のETL作業</td>
<td>小規模ETL・パイプライン可視化</td>
<td>学術用途・プロトタイプETL</td>
</tr>
<tr class="even">
<td>制限</td>
<td>学習コスト高い、リアルタイム不可</td>
<td>UIが基本的、スケールに制限</td>
<td>メモリ内のみで大規模データは難しい</td>
<td>スケジューラ・オーケストレーションなし</td>
<td>エコシステム小、コミュニティ少</td>
<td>メンテナンスされておらず更新ほぼなし</td>
</tr>
<tr class="odd">
<td>サポート</td>
<td>活発なコミュニティ、商用サポートあり</td>
<td>コミュニティサポート</td>
<td>大規模コミュニティ、豊富なエコシステム</td>
<td>小規模コミュニティ</td>
<td>ニッチなコミュニティ</td>
<td>最小限のコミュニティ、更新もほぼなし</td>
</tr>
</tbody>
</table>
</div>


</section>

 ]]></description>
  <category>前処理</category>
  <guid>https://ryonakagami.github.io/regmonkey-datascience-blog/posts/2025-11-15-ETL-note/</guid>
  <pubDate>Sat, 15 Nov 2025 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
