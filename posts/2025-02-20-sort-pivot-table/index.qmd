---
title: "pivot tableã®column, rowã®sort"
author: "Ryo Nakagami"
date: "2025-02-20"
format: 
  html:
    embed-resources: false
categories: [python, å‰å‡¦ç†]
listing_category: datascience-preprocess-series
comments:
    utterances:
             repo: RyoNakagami/regmonkey-datascience-blog
             label: discussion
             issue-term: title
---

## å•é¡Œè¨­å®š

<div class="blog-custom-border" style="margin-top: 1rem; margin-bottom: 1rem;">
::: {#exr- .custom_problem }
<br>

```{python}
import numpy as np
import pandas as pd

np.random.seed(42)

def random_choice_from_list(
    candidate: list | np.ndarray,
    sampling_size: int,
    p: list | tuple | np.ndarray = None,
):
    if sampling_size <= 0:
        raise ValueError("sampling_size must be greater than 0.")

    if p is None:
        p = np.repeat(1 / len(candidate), sampling_size)

    if min(p) < 0 or max(p) > 1:
        raise ValueError("All probabilities in 'p' must be between 0 and 1 inclusive.")

    if not np.isclose(sum(p), 1):
        raise ValueError("The probabilities in 'p' must sum to 1.")

    return np.random.choice(candidate, size=sampling_size, p=p)


# Params
N = 100
A_list = ["H", "He", "Li", "Be", "B", "C", "N", "O", "F", "Ne"]
A_prob = np.array([1, 4, 3, 4, 1, 6, 7, 8, 9, 10])
A_prob = A_prob / sum(A_prob)

B_list = ["one", "two", "three", "four"]
B_prob = np.array([7, 8, 6, 1])
B_prob = B_prob / sum(B_prob)


# DGP
df = pd.DataFrame(
    {
        "element": random_choice_from_list(A_list, N, A_prob),
        "class": random_choice_from_list(B_list, N, B_prob),
        "density": np.random.uniform(0, 1, N),
    }
)

df.head()
```

<strong > &#9654;&nbsp; å•é¡Œè¨­å®š</strong>

- [ ] ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ `(element, class)` ã‚’keyï¼Œfrequencyã‚’valueã¨ã—ãŸäºŒæ¬¡å…ƒåˆ†å‰²è¡¨ã‚’ä½œæˆã™ã‚‹
- [ ] äºŒæ¬¡å…ƒåˆ†å‰²è¡¨ã‚’column, rowãã‚Œãã‚Œã®æ–¹å‘ã«ã¤ã„ã¦ï¼Œåˆè¨ˆfrequencyã«åŸºã¥ã„ãŸsortã‚’è¡Œã†

:::

</div>

## Solution with `pandas`

<!--::: {.callout-note collapse="true" icon=false}-->
::: {.callout-note collapse="false" icon=false}
## Task 1: `(element, class)` ã‚’keyï¼Œfrequencyã‚’valueã¨ã—ãŸäºŒæ¬¡å…ƒåˆ†å‰²è¡¨ã‚’ä½œæˆã™ã‚‹

`pandas.pivot_table`ã‚’ç”¨ã„ã‚Œã°ã‹ã‚“ãŸã‚“ã«å®Ÿè¡Œã§ãã¾ã™ï¼

```{python}
#| code-fold: show
# Compute the pivot table
pivot_table = pd.pivot_table(
    df,
    index="element",  # Rows
    columns="class",  # Columns
    aggfunc="size",  # Frequency count
    fill_value=0,  # Fill missing values with 0
)

pivot_table
```

:::


<!--::: {.callout-note collapse="true" icon=false}-->
::: {.callout-note collapse="false" icon=false}
## Task 2: äºŒæ¬¡å…ƒåˆ†å‰²è¡¨ã‚’column, rowãã‚Œãã‚Œã®æ–¹å‘ã«ã¤ã„ã¦ï¼Œåˆè¨ˆfrequencyã«åŸºã¥ã„ãŸsortã‚’è¡Œã†

pivot tableåŒ–ã•ã‚ŒãŸ `pandas.DataFrame` ã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆæ“ä½œã¯

- rowæ“ä½œ ; `.loc` ã®indexã®æ“ä½œ
- columnæ“ä½œ: `.loc` ã®columnã®æ“ä½œ

ã¨ãªã‚Šã¾ã™ï¼

<strong > &#9654;&nbsp; rowã®sort</strong>

```{python}
#| code-fold: show
pivot_table = pivot_table.loc[
    pivot_table.sum(axis=1).sort_values(ascending=False).index
]
pivot_table
```

<strong > &#9654;&nbsp; columnã®sort</strong>

```{python}
#| code-fold: show
pivot_table = pivot_table.loc[:, pivot_table.sum(axis=0).sort_values(ascending=False).index]
pivot_table
```

<strong > &#9654;&nbsp; æ¤œè¨¼</strong>

```{python}
pivot_table_total = pivot_table.copy()

# row sum
pivot_table_total['total'] = pivot_table_total.sum(axis=1)

# column sum
pivot_table_total.loc['column_sum'] =  pivot_table_total.sum(axis=0)

# æ¤œè¨¼
pivot_table_total
```

:::

## Visualization

<div class="blog-custom-border" style="margin-top: 1rem; margin-bottom: 1rem;">
<strong>å¯è¦–åŒ–æ–¹é‡</strong> <br>

- `class`å‡ºç¾å‰²åˆã¯`element`æ¯ã«å¤§ããç•°ãªã‚‹ã®ã‹ã¿ãŸã„
- frequencyãã®ã¾ã¾ã§æ¯”è¼ƒã™ã‚‹ã¨å‡ºç¾å‰²åˆæ¯”è¼ƒã«ãªã‚‰ãªã„ã®ã§ï¼Œ`axis = 1`ã®æ–¹å‘ã§å‰²åˆã¨ã—ã¦è¨ˆç®—ã™ã‚‹(ä»¥å¾Œï¼Œ`normalized_pivot`ã¨å‘¼ã¶)
- `normalized_pivot`ã‚’heatmapã§å¯è¦–åŒ–ã™ã‚‹ï¼Œå¯è¦–åŒ–ã®éš›ã«å‡ºç¾é »åº¦ã‚’å³å´ã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹(sample sizeãŒå°ã•ã„ã¨ã“ã‚ã¯ç„¡è¦–ã—ãŸã„)

</div>

<strong > &#9654;&nbsp; `normalized_pivot` ã®ä½œæˆ</strong>

```{python}
#| code-fold: show
normalized_pivot = pivot_table.div(pivot_table.sum(axis=1), axis=0)
normalized_pivot
```

<strong > &#9654;&nbsp; å¯è¦–åŒ–ã‚³ãƒ¼ãƒ‰</strong>

```{python}
# | code-fold: show
import seaborn as sns
import matplotlib.pyplot as plt

# Plot heatmap
fig, ax = plt.subplots(1, 2, figsize=(10, 6), gridspec_kw={"width_ratios": [3, 1]})

sns.heatmap(normalized_pivot, annot=True, fmt=".2f", cmap="PuBu", ax=ax[0])
ax[0].set_title("Heatmap of Normalized Pivot Table")
ax[0].set_ylabel("Element")
ax[0].set_xlabel("Class")

sns.barplot(
    y=pivot_table.index,
    x=pivot_table.sum(axis=1),
    alpha=0.8,
    color="#0047AB",
    orient="h",
    ax=ax[1],
)
ax[1].set_title("Element Frequency Barplot")
ax[1].set_xlabel("Frequency")

plt.tight_layout()
plt.show()
```

::: {.nte- .callout-tip icon="false"}
# ğŸµ color mapã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

color sequenceã‚’lightcoral, ivory, Dodgersblue ã¨ã„ã†é †ç•ªã«ã—ãŸã„å ´åˆã¯

```{python}
# | code-fold: show
from matplotlib.colors import LinearSegmentedColormap

custom_cpam = LinearSegmentedColormap.from_list("lightcoral_ivory_blue", ["#F08080", "#FFFFF0", "#1E90FF"])
```

ã¨ã™ã‚‹ã“ã¨ã§è‡ªåˆ†å¥½ã¿ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```{python}
# Plot heatmap
fig, ax = plt.subplots(1, 2, figsize=(10, 6), gridspec_kw={"width_ratios": [3, 1]})

sns.heatmap(normalized_pivot, annot=True, fmt=".2f", cmap=custom_cpam , ax=ax[0])
ax[0].set_title("Heatmap of Normalized Pivot Table")
ax[0].set_ylabel("Element")
ax[0].set_xlabel("Class")

sns.barplot(
    y=pivot_table.index,
    x=pivot_table.sum(axis=1),
    alpha=1,
    color="#6699CC",
    orient="h",
    ax=ax[1],
)
ax[1].set_title("Element Frequency Barplot")
ax[1].set_xlabel("Frequency")

plt.tight_layout()
plt.show()
```

:::
